
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ray Modeler</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 511.987 511.987'><rect x='66.717' y='204.027' transform='matrix(-0.2411 -0.9705 0.9705 -0.2411 -177.6681 420.4137)' fill='%23B6F2FC' width='17.648' height='151.29'/><polygon fill='%238ED7E0' points='235.67,98.502 417.524,413.484 53.815,413.484'/><polygon fill='%23F4BD64' points='511.987,268.44 511.987,315.737 368.184,337.491 344.872,329.255 296.635,235.133'/><polygon fill='%234EB79B' points='511.987,315.737 511.987,363.022 384.886,356.939 384.874,356.939 344.872,329.255 356.814,308.325'/><polygon fill='%23E88158' points='511.987,221.156 511.987,268.44 328.73,259.687 276.634,248.075 300.658,211.061'/><polygon fill='%23B6F2FC' points='384.874,356.939 385.874,358.669 113.88,263.558 300.658,211.061 328.73,259.687 356.802,308.325 356.814,308.325'/></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="styles.css">

    <style>
        #render-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
            background-color: var(--bg-main);
        }
        #render-container.quad-view-active {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        gap: 2px;
        background-color: var(--text-secondary);
        }
        .label-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        .viewport {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border: 1px solid var(--grid-color);
            box-sizing: border-box; /* Important for grid layout with borders */
            pointer-events: auto; /* Make sure the viewport divs can receive mouse events */
        }
        .viewport canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
        /* Hide the extra viewports by default */
        #viewport-top, #viewport-front, #viewport-side {
            display: none;
        }
        /* Show them when quad view is active */
        #render-container.quad-view-active > .viewport {
            display: block;
        }
        .viewport-label {
            position: absolute;
            top: 8px;
            left: 8px;
            color: var(--text-primary);
            background-color: rgba(0,0,0,0.4);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>
    <div id="welcome-screen">
    <div id="glow-portal"></div>
    <canvas id="glow-canvas"></canvas>
    <div class="welcome-content">
        <div class="welcome-header">
            <div id="welcome-logo-container">
                <svg id="welcome-logo-light" class="welcome-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.987 511.987" xml:space="preserve">
                    <path transform="rotate(-103.951 75.54 279.672)" style="fill:#cccccc" d="M66.717 204.027h17.648v151.29H66.717z"/>
                    <path style="fill:#858585" d="m235.67 98.502 181.854 314.982H53.815z"/>
                    <path style="fill:#ffbf00" d="M511.987 268.44v47.297l-143.803 21.754-23.312-8.236-48.237-94.122z"/>
                    <path style="fill:#3b82f6" d="M511.987 315.737v47.285l-127.101-6.083h-.012l-40.002-27.684 11.942-20.93z"/>
                    <path style="fill:#fa2c15" d="M511.987 221.156v47.284l-183.257-8.753-52.096-11.612 24.024-37.014z"/>
                    <path style="fill:#cccccc" d="m384.874 356.939 1 1.73-271.994-95.111 186.778-52.497 28.072 48.626 28.072 48.638h.012z"/>
                </svg>
                <svg id="welcome-logo-dark" class="welcome-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.987 511.987" xml:space="preserve">
                    <path transform="rotate(-103.951 75.54 279.672)" style="fill:#616161" d="M66.717 204.027h17.648v151.29H66.717z"/>
                    <path style="fill:#bdbdbd" d="m235.67 98.502 181.854 314.982H53.815z"/>
                    <path style="fill:#ffff00" d="M511.987 268.44v47.297l-143.803 21.754-23.312-8.236-48.237-94.122z"/>
                    <path style="fill:#3b82f6" d="M511.987 315.737v47.285l-127.101-6.083h-.012l-40.002-27.684 11.942-20.93z"/>
                    <path style="fill:#fa2c15" d="M511.987 221.156v47.284l-183.257-8.753-52.096-11.612 24.024-37.014z"/>
                    <path style="fill:#616161" d="m384.874 356.939 1 1.73-271.994-95.111 186.778-52.497 28.072 48.626 28.072 48.638h.012z"/>
                </svg>
                <svg id="welcome-logo-cyber" class="welcome-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.987 511.987" xml:space="preserve">
                    <path transform="rotate(-103.951 75.54 279.672)" style="fill:#4d8bee" d="M66.717 204.027h17.648v151.29H66.717z"/>
                    <path style="fill:#11215e" d="m235.67 98.502 181.854 314.982H53.815z"/>
                    <path style="fill:#ffd400" d="M511.987 268.44v47.297l-143.803 21.754-23.312-8.236-48.237-94.122z"/>
                    <path style="fill:#00f6ff" d="M511.987 315.737v47.285l-127.101-6.083h-.012l-40.002-27.684 11.942-20.93z"/>
                    <path style="fill:#ff2e97" d="M511.987 221.156v47.284l-183.257-8.753-52.096-11.612 24.024-37.014z"/>
                    <path style="fill:#4d8bee" d="m384.874 356.939 1 1.73-271.994-95.111 186.778-52.497 28.072 48.626 28.072 48.638h.012z"/>
                </svg>
                <svg id="welcome-logo-cafe58" class="welcome-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.987 511.987" xml:space="preserve">
                    <path transform="rotate(-103.951 75.54 279.672)" style="fill:#707C8A" d="M66.717 204.027h17.648v151.29H66.717z"/>
                    <path style="fill:#26303D" d="m235.67 98.502 181.854 314.982H53.815z"/>
                    <path style="fill:#FFA518" d="M511.987 268.44v47.297l-143.803 21.754-23.312-8.236-48.237-94.122z"/>
                    <path style="fill:#FF6D1D" d="M511.987 315.737v47.285l-127.101-6.083h-.012l-40.002-27.684 11.942-20.93z"/>
                    <path style="fill:#5a687a" d="M511.987 221.156v47.284l-183.257-8.753-52.096-11.612 24.024-37.014z"/>
                    <path style="fill:#707C8A" d="m384.874 356.939 1 1.73-271.994-95.111 186.778-52.497 28.072 48.626 28.072 48.638h.012z"/>
                </svg>
            </div>
            <div class="welcome-text-container">
            <h1 class="welcome-title">Ray Modeler</h1>
        </div>
    </div>
    <p class="welcome-subheader">Your AI Assistant for Advanced Daylighting Simulation</p>
    <p class="welcome-description text-center max-w-lg text-lg text-[--text-secondary]">
                Choose how you'd like to begin your modeling project. You can start with a predefined parametric shape or import your own custom model.
            </p>
        <div class="welcome-options">
                <button id="start-with-shoebox" class="welcome-option-card">
                    <svg xmlns="http://www.w3.org/2000/svg" class="option-icon" viewBox="0 0 100 100" fill="currentColor">
                        <path d="M94.924 5.62A1 1 0 0 0 94 5H30a1 1 0 0 0-.707.293l-24 24A1 1 0 0 0 5 30v64a1 1 0 0 0 1 1h64l.01-.002a1 1 0 0 0 .697-.29l24-24A1 1 0 0 0 95 70V6a1 1 0 0 0-.076-.38M29.07 8.344A.995.995 0 0 0 31 8V7h60.586l-22 22H8.414ZM8.3 93A1 1 0 0 0 7 91.7V31h22v1a1 1 0 0 0 2 0v-1h38v38h-1a1 1 0 0 0 0 2h1v22ZM71 30.414l22-22V69h-1a.995.995 0 0 0-.345 1.93L71 91.586Z"/>
                        <path d="M30 61a1 1 0 0 0-1 1v2a1 1 0 0 0 2 0v-2a1 1 0 0 0-1-1m0-8a1 1 0 0 0-1 1v2a1 1 0 0 0 2 0v-2a1 1 0 0 0-1-1m0-36a1 1 0 0 0 1-1v-2a1 1 0 0 0-2 0v2a1 1 0 0 0 1 1m0 28a1 1 0 0 0-1 1v2a1 1 0 0 0 2 0v-2a1 1 0 0 0-1-1m1-21v-2a1 1 0 0 0-2 0v2a1 1 0 0 0 2 0m-1 13a1 1 0 0 0-1 1v2a1 1 0 0 0 2 0v-2a1 1 0 0 0-1-1m24 32h-2a1 1 0 0 0 0 2h2a1 1 0 0 0 0-2m8 0h-2a1 1 0 0 0 0 2h2a1 1 0 0 0 0-2m16 0h-2a1 1 0 0 0 0 2h2a1 1 0 0 0 0-2m8 0h-2a1 1 0 0 0 0 2h2a1 1 0 0 0 0-2m-40 0h-2a1 1 0 0 0 0 2h2a1 1 0 0 0 0-2m-8 0h-2a1 1 0 0 0 0 2h2a1 1 0 0 0 0-2m-7.077.618a1 1 0 0 0-1.626-.328l-.004.003-1.414 1.414a1 1 0 1 0 1.414 1.414l1.414-1.414a1 1 0 0 0 .216-1.09m-7.287 5.333-1.414 1.414a1 1 0 0 0 1.414 1.414l1.414-1.414a1 1 0 0 0-1.414-1.414m-5.656 5.657-1.415 1.414a1 1 0 0 0 1.414 1.414l1.414-1.414a1 1 0 0 0-1.414-1.414m-5.657 5.656-1.414 1.415a1 1 0 0 0 1.414 1.414l1.414-1.414a1 1 0 1 0-1.414-1.415"/>
                    </svg>
                    <div class="option-text-wrapper">
                        <h3 class="option-title">Parametric Model</h3>
                        <p class="option-description">Start with a customizable box shape.</p>
                    </div>
                </button>
                <button id="start-with-import" class="welcome-option-card">
                    <svg xmlns="http://www.w3.org/2000/svg" class="option-icon" viewBox="0 0 24 24" fill="none">
                        <rect x="5" y="15" width="14" height="4" rx="2" fill="currentColor" fill-opacity=".24"/>
                        <path d="m12 14-.424.424.424.425.424-.425zm.6-9a.6.6 0 1 0-1.2 0zM6.576 9.424l5 5 .848-.848-5-5zm5.848 5 5-5-.848-.848-5 5zM12.6 14V5h-1.2v9z" fill="currentColor"/>
                        <path d="M5 16v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1" stroke="currentColor" stroke-width="1.2"/>
                    </svg>
                    <div class="option-text-wrapper">
                        <h3 class="option-title">Import Model</h3>
                        <p class="option-description">Bring in your own .obj file.</p>
                    </div>
                </button>
            </div>
    </div>
</div>

    <div id="theme-switcher-container" class="fixed top-10 left-6 z-[10001] pointer-events-auto">
    <button id="theme-btn-cafe58" class="theme-btn" style="display: none;" aria-label="Switch to Cafe 58 Theme">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M3 14c.83 .642 2.077 1.017 3.5 1c1.423 .017 2.67 -.358 3.5 -1c.83 -.642 2.077 -1.017 3.5 -1c1.423 -.017 2.67 .358 3.5 1"></path>
        <path d="M8 3a2.4 2.4 0 0 0 -1 2a2.4 2.4 0 0 0 1 2"></path>
        <path d="M12 3a2.4 2.4 0 0 0 -1 2a2.4 2.4 0 0 0 1 2"></path>
        <path d="M3 10h14v5a6 6 0 0 1 -6 6h-2a6 6 0 0 1 -6 -6v-5z"></path>
        <path d="M16.746 16.726a3 3 0 1 0 .252 -5.555"></path>
        </svg>
    </button>
    <button id="theme-btn-cyber" class="theme-btn" style="display: none;" aria-label="Switch to Cyber Theme">
        <svg width="800" height="800" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8m0 15c-3.9 0-7-3.1-7-7 0-2.4 1.2-4.6 3.2-5.9C4.1 2.7 4 3.4 4 4c0 4.9 4 8.9 8.9 9-1.3 1.3-3 2-4.9 2"/>
        </svg>
    </button>
    <button id="theme-btn-light" class="theme-btn" aria-label="Switch to Light Theme">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        </button>
        <button id="theme-btn-dark" class="theme-btn" style="display: none;" aria-label="Switch to Dark Theme">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
    </div>

    <div id="render-container">
    <div id="viewport-main" class="viewport">
        <div class="viewport-label">Perspective</div>
        <div class="label-container"></div>
    </div>
    <div id="viewport-top" class="viewport">
        <div class="viewport-label">Top</div>
        <div class="label-container"></div>
    </div>
    <div id="viewport-front" class="viewport">
        <div class="viewport-label">Front</div>
        <div class="label-container"></div>
    </div>
    <div id="viewport-side" class="viewport">
        <div class="viewport-label">Right</div>
        <div class="label-container"></div>
    </div>
</div>
    
    <div id="left-controls-container" class="absolute top-1/2 -translate-y-1/2 left-4 z-50 pointer-events-auto flex flex-col gap-4">
    <div id="left-toolbar" class="ui-panel p-1">
        <div class="btn-group flex-col">

                <div class="action-button-container">
                    <button id="toggle-panel-project-btn" class="btn" aria-label="Project Setup">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 567.917 567.917" xml:space="preserve" fill="currentColor" stroke="none"><path d="M32.902 161.491h502.106l4.302-35.974c1.004-8.39-5.033-15.192-13.482-15.192H287.017c-8.448 0-21.019-3.767-28.075-8.415l-46.175-30.417c-7.056-4.648-19.627-8.415-28.079-8.415H35.109c-8.449 0-14.397 6.79-13.284 15.166zm32.547 328.412c1.833 8.25 10.168 14.936 18.62 14.936h399.777c8.448 0 16.787-6.686 18.62-14.936l65.092-292.913c1.833-8.25-3.531-14.936-11.979-14.936H12.339c-8.449 0-13.813 6.686-11.98 14.936z"/></svg>
                </button>
                <span class="tooltip" role="tooltip">Project Setup</span>
                </div>

                <div class="action-button-container">
                    <button id="toggle-panel-dimensions-btn" class="btn" aria-label="Dimensions">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xml:space="preserve"><path d="M160 213.333c-5.888 0-10.667-4.779-10.667-10.667H0v202.667C0 411.221 4.779 416 10.667 416h330.667v-85.333c-5.888 0-10.667-4.779-10.667-10.667s4.779-10.667 10.667-10.667V202.667H170.667c0 5.888-4.779 10.666-10.667 10.666m-10.667 32c0-5.888 4.779-10.667 10.667-10.667s10.667 4.779 10.667 10.667v21.333c0 5.888-4.779 10.667-10.667 10.667s-10.667-4.779-10.667-10.667zM46.592 398.507l-9.216 5.376a10.64 10.64 0 0 1-5.355 1.451 10.66 10.66 0 0 1-9.216-5.291c-2.965-5.077-1.259-11.605 3.84-14.592l9.216-5.376c5.099-2.965 11.627-1.259 14.592 3.84 2.923 5.077 1.216 11.626-3.861 14.592m65.749-38.336L90.432 372.95a10.64 10.64 0 0 1-5.355 1.451 10.72 10.72 0 0 1-9.237-5.291c-2.965-5.099-1.237-11.627 3.84-14.592l21.909-12.779c5.099-2.944 11.627-1.237 14.592 3.84 2.944 5.077 1.238 11.626-3.84 14.592m164.992-50.838h21.333c5.888 0 10.667 4.779 10.667 10.667s-4.779 10.667-10.667 10.667h-21.333c-5.888 0-10.667-4.779-10.667-10.667s4.779-10.667 10.667-10.667m-64 0h21.333c5.888 0 10.667 4.779 10.667 10.667s-4.779 10.667-10.667 10.667h-21.333c-5.888 0-10.667-4.779-10.667-10.667s4.779-10.667 10.667-10.667M181.355 320c0 5.888-4.8 10.667-10.688 10.667h-7.787l-6.72 3.925a10.64 10.64 0 0 1-5.355 1.451 10.66 10.66 0 0 1-9.216-5.291c-2.965-5.077-1.259-11.605 3.84-14.592l3.925-2.283v-4.544c0-5.888 4.779-10.667 10.667-10.667s10.667 4.779 10.667 10.667c5.888 0 10.667 4.779 10.667 10.667m181.312-121.771v111.104c5.888 0 10.667 4.779 10.667 10.667s-4.779 10.667-10.667 10.667v80.853l143.957-82.261A10.67 10.67 0 0 0 512 320V114.24zm64 132.438h-21.333c-5.888 0-10.667-4.779-10.667-10.667s4.779-10.667 10.667-10.667h21.333c5.888 0 10.667 4.779 10.667 10.667s-4.779 10.667-10.667 10.667m53.333 0h-10.667c-5.888 0-10.667-4.779-10.667-10.667s4.779-10.667 10.667-10.667H480c5.888 0 10.667 4.779 10.667 10.667s-4.779 10.667-10.667 10.667M160 96c-1.856 0-3.669.491-5.291 1.408L7.829 181.333h141.504c0-5.888 4.779-10.667 10.667-10.667s10.667 4.779 10.667 10.667h178.539L500.907 96zm10.667 42.667c0 5.888-4.779 10.667-10.667 10.667s-10.667-4.779-10.667-10.667V128c0-5.888 4.779-10.667 10.667-10.667s10.667 4.779 10.667 10.667z"/></svg>
                        </button>
                    <span class="tooltip" role="tooltip">Dimensions & Geometry</span>
                </div>
                
                <div class="action-button-container">
                <button id="toggle-panel-aperture-btn" class="btn" aria-label="Apertures & Shading">
                    <svg viewBox="0 0 51 51" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="none"><path d="m8.375 8 .098.098L8.57 8zm3.117 0L9.934 9.559l1.46 1.46L14.413 8zm5.842 0-4.479 4.48 1.46 1.46L20.254 8zm5.844 0-7.403 7.4 1.461 1.461L26.1 8zm5.84 0-10.32 10.322 1.46 1.461L31.94 8Zm5.843 0L21.62 21.244l1.46 1.46L37.782 8Zm5.844 0L24.54 24.164 26 25.625l17-17V8zM27.461 27.086 11.547 43h2.922l14.453-14.453Zm2.92 2.92L17.387 43h2.922l11.533-11.533Zm2.922 2.922L23.23 43h2.922l8.612-8.611zm2.922 2.922L29.075 43h2.921l5.69-5.69zm2.92 2.92L34.915 43h2.92l2.77-2.77zm2.921 2.921L40.758 43H43v-.375z"/><path d="m8 7.625 18 18-18 18z"/><path d="M4 4v43h43V4Zm4 4h35v35H8Z"/></svg>
                </button>
                <span class="tooltip" role="tooltip">Apertures & Shading</span>
            </div>
                
            <div class="action-button-container">
                <button id="toggle-panel-lighting-btn" class="btn" aria-label="Artificial Lighting">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 569.16 569.16" xml:space="preserve" fill="currentColor" stroke="none"><path d="M220.875 515.154H348.29c10.549 0 19.08-8.534 19.08-19.079s-8.535-19.079-19.08-19.079H220.875c-10.545 0-19.079 8.534-19.079 19.079s8.532 19.079 19.079 19.079m0 54.006H348.29c10.549 0 19.08-8.534 19.08-19.079s-8.535-19.079-19.08-19.079H220.875c-10.545 0-19.079 8.534-19.079 19.079s8.532 19.079 19.079 19.079M284.582 0C179.195 0 93.784 85.411 93.784 190.797c0 66.962 34.896 125.234 87.143 159.251 4.489 2.922 8.256 9.434 8.256 14.792v54.915c0 21.092 17.068 38.158 38.158 38.158h114.478c21.053 0 38.158-17.069 38.158-38.158v-54.918c0-5.358 3.77-11.867 8.262-14.789 52.242-33.987 87.137-92.29 87.137-159.251C475.378 85.411 389.968 0 284.582 0"/></svg>
                </button>
                <span class="tooltip" role="tooltip">Artificial Lighting</span>
            </div>
                
                <div class="action-button-container">
                    <button id="toggle-panel-materials-btn" class="btn" aria-label="Material Properties">
                        <svg viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="none"><path d="m35.435 9.494 7.071 7.071.002-.002a4 4 0 0 1 0 5.657l-.002.002L24 40.703V15.264l5.777-5.771h.001a4 4 0 0 1 5.656.002zM50 36v10a4 4 0 0 1-4 4H21l18-18h7a4 4 0 0 1 4 4M2 41.046V6a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v35.046a9 9 0 0 1-18 0M11 45a4 4 0 1 0 0-8 4 4 0 0 0 0 8"/></svg>
                    </button>
                    <span class="tooltip" role="tooltip">Material Properties</span>
                </div>
                
                <div class="action-button-container">
                    <button id="toggle-panel-sensor-btn" class="btn" aria-label="Sensor Grid">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M23.584 47.441a3.5 3.5 0 0 0-2.393 1.024l-4.949 4.95a3.5 3.5 0 0 0 0 4.948l7.746 7.746-7.746 7.746a3.5 3.5 0 0 0 0 4.95l4.95 4.95a3.5 3.5 0 0 0 4.95 0l7.747-7.743 7.744 7.744a3.5 3.5 0 0 0 4.951 0l4.951-4.951a3.5 3.5 0 0 0 0-4.95L43.79 66.11l7.746-7.746a3.5 3.5 0 0 0-.002-4.949l-4.951-4.95a3.5 3.5 0 0 0-4.95 0l-7.743 7.747-7.746-7.746a3.5 3.5 0 0 0-2.559-1.024z" fill-rule="evenodd"/>
                    <path d="M11.896 12h12.041v12.041h-12.04zm16.041 0H39.98v12.041H27.938zm16.042 0h12.04v12.041H43.98zm16.04 0h12.042v12.041H60.02zm16.042 0H88.1v12.041H76.06zM11.896 28.041h12.041v12.041h-12.04zm16.041 0H39.98v12.041H27.938zm16.042 0h12.04v12.041H43.98zm16.04 0h12.042v12.041H60.02zm16.042 0H88.1v12.041H76.06zM60.02 44.082h12.04v12.041H60.02zm16.04 0h12.042v12.041H76.06zM60.02 60.123h12.04v12.041H60.02zm16.04 0h12.042v12.041H76.06zM60.02 76.164h12.04v12.041H60.02zm16.04 0h12.042v12.041H76.06zM7.897.102V8H0v4h7.896v12.041H0v4h7.896v12.041H0v4h7.896v12.041H0v4h7.896v12.041H0v4h7.896v12.041H0v4h7.896v7.897h4v-7.897h12.041v7.897h4v-7.897H39.98v7.897h4v-7.897h12.04v7.897h4v-7.897h12.042v7.897h4v-7.897H88.1v7.897h4v-7.897h7.9v-4h-7.898v-12.04H100v-4h-7.898V60.122H100v-4h-7.898v-12.04H100v-4h-7.898V28.041H100v-4h-7.898V12H100V8h-7.898V.102h-4V8H76.06V.102h-4V8H60.02V.102h-4V8H43.979V.102h-4V8H27.938V.102h-4V8H11.896V.102zm4 43.98h12.041v1.373a5.6 5.6 0 0 1 2.442.707c.55.392 1.062.836 1.558 1.295v-3.375H39.98v3.186a5.84 5.84 0 0 1 4-1.797v-1.389h12.04v12.041h-1.5c-.025.84-.215 1.674-.632 2.418-.395.56-.846 1.078-1.31 1.582h3.443v12.041h-3.325a5.84 5.84 0 0 1 1.836 4h1.489v12.041H43.979v-1.46c-.87-.01-1.737-.2-2.508-.63a15 15 0 0 1-1.492-1.222v3.312H27.938v-3.4c-1.007 1.152-2.484 1.854-4 1.947v1.453H11.896v-12.04h1.36c.015-.85.2-1.693.613-2.448a15 15 0 0 1 1.27-1.553h-3.243V60.123h3.26c-1.137-1.014-1.815-2.487-1.898-4h-1.362z" fill-rule="evenodd" fill-opacity="0.4"/>
                    </svg>
                </button>
                <span class="tooltip" role="tooltip">Sensor Grid</span>
            </div>

            <div class="action-button-container">
                <button id="toggle-panel-viewpoint-btn" class="btn" aria-label="Viewpoint">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" xml:space="preserve" fill="currentColor" stroke="none"><path d="M32 5.074v21.854a.5.5 0 0 1-.807.396l-7.939-6.121v3.129a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5V7.667c0-.275.225-.5.5-.5h22.254c.275 0 .5.225.5.5v3.899l7.918-6.872a.5.5 0 0 1 .537-.078.51.51 0 0 1 .291.458"/></svg>
                </button>
                <span class="tooltip" role="tooltip">Viewpoint</span>
            </div>
                
             <div class="action-button-container">
                <button id="toggle-panel-scene-btn" class="btn" aria-label="Scene Elements">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 294.004 294.004" xml:space="preserve" fill="currentColor" stroke="none"><path d="M0 10.27v273.465h294.004V10.27zm61.01 26.058c19.873 0 35.983 16.11 35.983 35.983s-16.11 35.983-35.983 35.983-35.983-16.11-35.983-35.983c-.001-19.872 16.11-35.983 35.983-35.983m43.87 216.14H25.429l61.286-122.869 61.286 122.869zm73.293 0-45.368-87.972 47.4-95.031 91.281 183.004z"/></svg>
                </button>
                <span class="tooltip" role="tooltip">Scene Elements</span>
                </div>

                <div class="w-full my-1 border-t border-[--grid-color]"></div>

                <div class="action-button-container">
                    <button id="toggle-modules-btn" class="btn" aria-label="Simulation Modules">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="none"><path d="M16 0 0 8l4.7 1.6L5 15l2.5-2.8L10 16zM7.5 10.4l4.3-5.9-6.2 4.3-3-1L14.2 2 9.7 13.8z"/></svg>
                    </button>
                    <span class="tooltip" role="tooltip">Simulation</span>
                </div>

                <div class="action-button-container">
                    <button id="toggle-analysis-btn" class="btn" aria-label="Analysis">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 495.421 495.421" xml:space="preserve" fill="currentColor" stroke="none"><path d="M490.531 188.099a7.27 7.27 0 0 0-8.089 2.393l-85.909 110.192a15.1 15.1 0 0 1-14.407 5.619l-93.674-15.672c-4.783-.8-9.668.742-13.123 4.159l-85.609 84.633a15.1 15.1 0 0 1-9.148 4.291l-111.28 10.993a15.14 15.14 0 0 0-9.523 4.679L2.414 460.344a8.85 8.85 0 0 0-1.685 9.589 8.87 8.87 0 0 0 8.138 5.339h468.591c9.924 0 17.963-8.036 17.963-17.957V194.956a7.25 7.25 0 0 0-4.89-6.857M29.334 275.472c4.504 0 8.978-1.782 12.312-5.314l24.096-25.411c3.535 1.03 7.229 1.758 11.093 1.758 18.997 0 34.859-13.296 39.018-31.04l38.148-3.762c6.584 13.213 20.086 22.397 35.833 22.397 22.116 0 40.138-18.007 40.138-40.141 0-4.952-1.02-9.648-2.669-14.03l34.049-33.384c5.579 2.947 11.833 4.771 18.567 4.771 14.987 0 27.945-8.368 34.828-20.584l22.137 3.707c5.129 16.25 20.185 28.15 38.108 28.15 22.136 0 40.143-18.007 40.143-40.143 0-6.286-1.585-12.162-4.159-17.462l44.862-57.555c5.743-7.361 4.423-17.983-2.941-23.718-7.328-5.719-17.956-4.417-23.715 2.938l-44.848 56.869c-3.004-.725-6.108-1.212-9.343-1.212-14.192 0-26.605 7.443-33.733 18.584l-23.937-4.002c-5.794-15.077-20.316-25.855-37.403-25.855-22.131 0-40.138 18.007-40.138 40.141 0 2.691.295 5.316.79 7.858l-37.733 37.136c-4.089-1.42-8.434-2.352-13.003-2.352-16.392 0-30.469 9.895-36.708 24l-44.438 4.39c-7.328-9.648-18.817-15.984-31.854-15.984-22.116 0-40.142 18.007-40.142 40.141 0 5.729 1.254 11.157 3.434 16.084l-23.091 24.535c-6.404 6.802-6.073 17.497.71 23.895a16.85 16.85 0 0 0 11.589 4.595m345.658-167.813c8.153 0 14.792 6.634 14.792 14.787 0 8.156-6.639 14.79-14.792 14.79s-14.788-6.634-14.788-14.79c0-8.153 6.635-14.787 14.788-14.787m-95.073-11.272c8.153 0 14.793 6.634 14.793 14.787s-6.64 14.79-14.793 14.79c-8.154 0-14.787-6.637-14.787-14.79s6.633-14.787 14.787-14.787m-90.084 82.782c8.154 0 14.787 6.637 14.787 14.79s-6.633 14.79-14.787 14.79-14.792-6.637-14.792-14.79 6.639-14.79 14.792-14.79m-113 12.405c8.153 0 14.788 6.634 14.788 14.788s-6.634 14.789-14.788 14.789-14.787-6.636-14.787-14.789c0-8.154 6.633-14.788 14.787-14.788"/></svg>
                    </button>
                    <span class="tooltip" role="tooltip">Analysis</span>
                </div>

            </div>
        </div>
    </div>

    <div id="view-controls" class="absolute top-4 left-1/2 -translate-x-1/2 z-50 pointer-events-auto">
        <div class="ui-panel p-1">
            <div class="btn-group">
                <div class="action-button-container"><button id="view-btn-persp" class="btn active" aria-label="Perspective View"><svg viewBox="0 0 24 24"><path d="M3 8l8-4 8 4-8 4-8-4z" /><path d="M11 8v8M19 12l-8 4" /><path d="M3 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Perspective View</span></div>
                <div class="action-button-container"><button id="view-btn-ortho" class="btn" aria-label="Orthographic View"><svg viewBox="0 0 24 24"><path d="M4,8 L12,4 L20,8 L12,12 L4,8 Z" /><path d="M4,8 L4,16 L12,20 L12,12 Z" /><path d="M12,12 L12,20 L20,16 L20,8 Z" /></svg></button><span class="tooltip" role="tooltip">Orthographic View</span></div>
                <div class="action-button-container"><button id="view-btn-top" class="btn" aria-label="Top View"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="4,8 12,4 20,8 12,12" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Top View</span></div>
                <div class="action-button-container"><button id="view-btn-front" class="btn" aria-label="Front View (South)"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="4,16 12,20 12,12 4,8" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Front View (South)</span></div>
                <div class="action-button-container"><button id="view-btn-back" class="btn" aria-label="Back View (North)"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="12,4 20,8 20,16 12,12" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Back View (North)</span></div>
                <div class="action-button-container"><button id="view-btn-left" class="btn" aria-label="Left View (West)"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="4,8 12,4 12,12 4,16" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Left View (West)</span></div>
                <div class="action-button-container"><button id="view-btn-right" class="btn" aria-label="Right View (East)"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="12,4 20,8 20,16 12,20" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Right View (East)</span></div>
                <div class="action-button-container"><button id="view-btn-quad" class="btn" aria-label="Quad View"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="12" x2="21" y2="12"></line><line x1="12" y1="3" x2="12" y2="21"></line></svg></button><span class="tooltip" role="tooltip">Quad View</span></div>
            </div>
        </div>
    </div>

    <main id="window-container" class="relative">
        <div id="panel-project" class="floating-window ui-panel hidden">
            <div class="window-header">
                <span>Project Setup</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content">
                <div class="form-grid">
                    <div class="form-column">
                        <div><label for="project-name" class="label">Project Name</label><input type="text" id="project-name" placeholder="e.g., Simple Office Room"></div>
                        <div><label for="project-desc" class="label">Project Description (Optional)</label><textarea id="project-desc" rows="3" placeholder="Enter your project description"></textarea></div>
                        <div><label for="building-type" class="label">Building Type</label><select id="building-type"><option value="" disabled selected>Select Building Type</option><option>Office</option><option>Classroom</option><option>Laboratory</option><option>Libraries</option><option>Lobbies</option><option>Residential</option><option>Creative Arts</option></select></div>
                        <div><label for="radiance-path" class="label">Radiance Installation Path</label><input type="text" id="radiance-path" placeholder="Path is OS-dependent..."></div>
                    </div>
                <div class="form-column">
                    <div style="flex-grow: 1; display: flex; flex-direction: column;">
                        <label class="label">Climate Data Source</label>
                        <div class="flex items-center">
                            <button id="upload-epw-btn" class="btn btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span>Upload EPW File</span></button>
                            <p id="epw-file-name" class="text-sm text-gray-500 ml-4 truncate max-w-[150px]"></p>
                        </div>
                        <input type="file" id="epw-file-input" class="hidden" accept=".epw" style="display: none;">
                    </div>
                    <div id="location-inputs-container" style="display: none;">
                        <label class="label">Location</label>
                        <div class="location-grid">
                            <input type="text" id="latitude" placeholder="Latitude e.g., 40.71">
                            <input type="text" id="longitude" placeholder="Longitude e.g., -74.00">
                        </div>
                    </div>
                    <div style="flex-grow: 1; display: flex; flex-direction: column;">
                        <label class="label">Map</label>
                        <div id="map"></div>
                    </div>
                        <div class="space-y-3 pt-4 mt-4 border-t border-[--grid-color]">
                            <label for="occupancy-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="occupancy-toggle">
                                <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">
                                    Generate Occupancy Schedule
                                </span>
                            </label>
                            <div id="occupancy-controls" class="hidden pt-2 space-y-4">
                                <div>
                                    <label class="label text-xs" for="occupancy-schedule-filename">Schedule Filename</label>
                                    <input type="text" id="occupancy-schedule-filename" class="w-full mt-1" value="occupancy.csv">
                                </div>
                                <div>
                                    <label class="label text-xs">Occupied Days</label>
                                    <div class="grid grid-cols-4 gap-2 text-sm mt-1">
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="0"> Sun</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="1" checked> Mon</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="2" checked> Tue</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="3" checked> Wed</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="4" checked> Thu</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="5" checked> Fri</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="6"> Sat</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="label text-xs flex justify-between">
                                        <span>Occupancy Time Range</span>
                                        <span id="occupancy-time-range-display" class="data-value font-mono">08:00 - 18:00</span>
                                    </label>
                                    <div id="occupancy-time-slider-container" class="relative h-5 mt-2 time-range-slider-container">
                                        <input type="range" id="occupancy-time-range-start" min="0" max="23.75" value="8" step="0.25">
                                        <input type="range" id="occupancy-time-range-end" min="0" max="23.75" value="18" step="0.25">
                                    </div>
                                </div>
                                <div class="mb-4"></div>
                                <button id="generate-occupancy-btn" class="btn btn-secondary w-full mt-6">Generate & Save Schedule</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
</div>
<div id="panel-dimensions" class="floating-window ui-panel hidden">
  <div class="window-header">
    <span>Dimensions & Geometry</span>
        <div class="window-controls">
            <div class="window-icon-max"></div>
                <div class="collapse-icon"></div>
                <div class="window-icon-close"></div>
            </div>
            </div>
    <div class="window-content space-y-4">

        <div id="import-controls" class="hidden space-y-4">
            <p class="info-box !text-xs !py-2 !px-3">Import a .obj model. Parametric controls will be disabled. Ensure your model is in meters.</p>
            <div>
                <label class="label" for="import-obj-file">OBJ Model File</label>
                <input type="file" id="import-obj-file" accept=".obj,.mtl" class="w-full text-sm" multiple>
                <span data-file-display-for="import-obj-file" class="text-xs text-[--text-secondary] truncate block mt-1">Select .obj and .mtl files.</span>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label text-xs" for="import-scale">Scale Factor</label>
                    <input type="number" id="import-scale" value="1.0" step="0.01" class="w-full mt-1">
                </div>
                <label for="import-center-toggle" class="flex items-center cursor-pointer mt-4">
                    <input type="checkbox" id="import-center-toggle" checked>
                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Center Model</span>
                </label>
            </div>
            <button id="load-model-btn" class="btn btn-secondary w-full">Load & Tag Surfaces</button>
        </div>

       <div id="parametric-controls">
            <div><label class="label" for="width">Width (X)</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="width" min="1" max="50" value="3.4" step="0.1"><span id="width-val" class="data-value font-mono w-12 text-left">3.4m</span></div></div>
            <div><label class="label" for="length">Length (Z)</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="length" min="1" max="50" value="5.4" step="0.1"><span id="length-val" class="data-value font-mono w-12 text-left">5.4m</span></div></div>
            <div><label class="label" for="height">Height (Y)</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="height" min="1" max="10" value="2.8" step="0.1"><span id="height-val" class="data-value font-mono w-12 text-left">2.8m</span></div></div>
            <div><label class="label" for="elevation">Elevation</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="elevation" min="0" max="20" value="0.0" step="0.1"><span id="elevation-val" class="data-value font-mono w-12 text-left">0.0m</span></div></div>
            <div><label class="label" for="room-orientation">Orientation</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="room-orientation" min="0" max="359" value="0" step="1"><span id="room-orientation-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
            <div class="pt-4 mt-4 border-t border-[--grid-color]">
                    <label for="resize-mode-toggle" class="flex items-center cursor-pointer w-full">
                        <input type="checkbox" id="resize-mode-toggle">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">
                            Enable 3D Resize Handles
                        </span>
                    </label>
                    <p class="info-box !text-xs !py-2 !px-3 mt-2 hidden" id="resize-mode-info">
                        Click and drag the transparent handles on the exterior of the room to adjust its dimensions.
                    </p>
                </div>
                <div class="pt-4 mt-4 border-t border-[--grid-color]">
                <div>
                    <label class="label" for="surface-thickness">Surface Thickness</label>
                <div class="flex items-center space-x-4 mt-1">
                    <input type="range" id="surface-thickness" min="0.00" max="1.0" value="0.20" step="0.01">
                    <span id="surface-thickness-val" class="data-value font-mono w-12 text-left">0.20m</span>
                </div>
            </div>
        </div>
        <div class="pt-4 mt-4 border-t border-[--grid-color] space-y-4">
            <h3 class="font-semibold text-sm uppercase">Scene Display</h3>
            <div class="space-y-3">
                <label for="transparent-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="transparent-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Transparent Surfaces</span></label>
                <div id="transparency-controls" class="mt-4 pl-4">
                    <label class="label text-xs" for="surface-opacity">Surface Opacity</label>
                    <div class="flex items-center space-x-3 mt-1">
                        <input type="range" id="surface-opacity" min="0.05" max="1.0" value="0.15" step="0.01">
                        <span id="surface-opacity-val" class="data-value font-mono w-12 text-left">0.5</span>
                    </div>
                </div>
            </div>
            <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                <label for="ground-plane-toggle" class="flex items-center cursor-pointer">
                    <input type="checkbox" id="ground-plane-toggle" checked>
                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Show Ground Plane</span>
                </label>
                <div id="ground-grid-controls" class="hidden mt-4 pl-4 space-y-3">
                    <div>
                        <label class="label text-xs" for="ground-grid-size">Grid Size (m)</label>
                        <div class="flex items-center space-x-3 mt-1">
                            <input type="range" id="ground-grid-size" min="10" max="200" value="50" step="1">
                            <span id="ground-grid-size-val" class="data-value font-mono w-12 text-left">50m</span>
                        </div>
                    </div>
                    <div>
                        <label class="label text-xs" for="ground-grid-divisions">Grid Divisions</label>
                        <div class="flex items-center space-x-3 mt-1">
                            <input type="range" id="ground-grid-divisions" min="2" max="400" value="50" step="1">
                            <span id="ground-grid-divisions-val" class="data-value font-mono w-12 text-left">50</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                <label for="world-axes-toggle" class="flex items-center cursor-pointer">
                    <input type="checkbox" id="world-axes-toggle" checked>
                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Show World Axes</span>
                </label>
                <div id="world-axes-controls" class="mt-2">
                    <label class="label text-xs" for="world-axes-size">Axes Size</label>
                    <div class="flex items-center space-x-3 mt-1">
                        <input type="range" id="world-axes-size" min="0.5" max="10" value="1.5" step="0.1">
                        <span id="world-axes-size-val" class="data-value font-mono w-12 text-left">1.5x</span>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
    </div>

    <div id="panel-aperture" class="floating-window ui-panel hidden">
        <div class="window-header">
            <span>Apertures & Shading</span>
            <div class="window-controls">
                <div class="window-icon-max"></div>
                <div class="collapse-icon"></div>
                <div class="window-icon-close"></div>
            </div>
        </div>
        <div class="window-content space-y-5">
            <div class="space-y-2 pb-3">
                <h3 class="font-semibold text-sm uppercase">Wall Selection</h3>
                <p class="info-box !text-xs !py-2 !px-3">Click a wall in the 3D view to select it.</p>
                <div class="flex justify-between items-center pt-2">
                <span class="label">Selected Wall:</span>
                <div id="wall-selection-status" class="flex items-center gap-3">
                    <span id="selected-wall-display" class="data-value font-mono">None</span>
                    <button id="wall-select-lock-btn" class="hidden" aria-label="Lock wall selection">
                        <svg id="lock-icon-unlocked" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
                        <svg id="lock-icon-locked" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </button>
                </div>
            </div>
        </div>

            <div id="sun-ray-trace-section" class="hidden space-y-3 pt-4 mt-4 border-t-2 border-[--grid-color]">
                <h3 class="font-semibold text-sm uppercase">Sun Ray Tracing</h3>
                <p class="info-box !text-xs !py-2 !px-3">Visualize direct sun penetration and bounces. Requires an EPW file to be loaded.</p>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="sun-ray-date" class="label text-xs">Date</label>
                        <input type="text" id="sun-ray-date" class="w-full mt-1 flatpickr-input" placeholder="Select date...">
                    </div>
                        <div>
                            <label for="sun-ray-time" class="label text-xs">Time</label>
                            <input type="time" id="sun-ray-time" value="12:00" class="w-full mt-1">
                        </div>
                    </div>
                        <div>
                            <label class="label text-xs flex justify-between" for="sun-ray-count">
                                <span>Ray Count</span>
                                <span id="sun-ray-count-val" class="data-value font-mono">200</span>
                            </label>
                            <input type="range" id="sun-ray-count" min="10" max="1000" value="100" step="10">
                        </div>
                    <div>
                        <label class="label text-xs flex justify-between" for="sun-ray-bounces">
                            <span>Max Bounces</span>
                            <span id="sun-ray-bounces-val" class="data-value font-mono">1</span>
                        </label>
                        <input type="range" id="sun-ray-bounces" min="0" max="10" value="1" step="1">
                    </div>

                    <div class="pt-2">
                    <label for="sun-rays-visibility-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="sun-rays-visibility-toggle" checked>
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Show Traced Rays</span>
                    </label>
                </div>

                    <div id="sun-ray-info-display" class="hidden mt-4 pt-4 border-t border-dashed border-[--grid-color] space-y-2">
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Solar Data at Selected Time</h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <span class="text-[--text-secondary]">Sun Altitude:</span>
                        <span id="sun-altitude-val" class="data-value font-mono text-right">--</span>
                        <span class="text-[--text-secondary]">Sun Azimuth:</span>
                        <span id="sun-azimuth-val" class="data-value font-mono text-right">--</span>
                        <span class="text-[--text-secondary]">Direct Normal Irradiance:</span>
                        <span id="sun-dni-val" class="data-value font-mono text-right">--</span>
                        <span class="text-[--text-secondary]">Diffuse Horizontal Irradiance:</span>
                        <span id="sun-dhi-val" class="data-value font-mono text-right">--</span>
                    </div>
                </div>

                <button id="trace-sun-rays-btn" class="btn btn-primary w-full mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span>Trace Sun Rays</span>
                </button>
            </div>

            <div id="aperture-controls-n" class="aperture-controls hidden space-y-5 pt-4 border-t border-[--grid-color]">
                <h3 class="font-semibold text-sm uppercase">North Wall Apertures</h3>
                <div><label class="label" for="win-count-n"># of Windows</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-count-n" min="0" max="10" value="0" step="1"><span id="win-count-n-val" class="data-value font-mono w-12 text-left">0</span></div></div>
                <div><label class="label">Mode</label><div class="btn-group mt-1"><button id="mode-wwr-btn-n" class="btn active">WWR</button><button id="mode-manual-btn-n" class="btn">Manual</button></div></div>
                <div id="wwr-controls-n" class="space-y-5">
                    <div><label class="label" for="wwr-n">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-n" min="0" max="0.99" value="0.4" step="0.01"><span id="wwr-n-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                    <div><label class="label" for="wwr-sill-height-n">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-sill-height-n" min="0" max="10" value="1.0" step="0.05"><span id="wwr-sill-height-n-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                    <div><label class="label" for="win-depth-pos-n">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-n" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-n-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                </div>
                <div id="manual-controls-n" class="hidden space-y-5">
                    <div><label class="label" for="win-width-n">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-width-n" min="0.1" max="20" value="1.5" step="0.1"><span id="win-width-n-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                    <div><label class="label" for="win-height-n">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-height-n" min="0.1" max="10" value="1.2" step="0.1"><span id="win-height-n-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                    <div><label class="label" for="sill-height-n">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="sill-height-n" min="0" max="10" value="1.0" step="0.05"><span id="sill-height-n-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                    <div><label class="label" for="win-depth-pos-n-manual">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-n-manual" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-n-val-manual" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                </div>



                <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-sm uppercase text-gray-700">North Wall Shading</h4>
                    <label class="flex items-center cursor-pointer" for="shading-n-toggle"><input type="checkbox" id="shading-n-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                    <div id="shading-controls-n" class="hidden space-y-5">
                        <div><label class="label" for="shading-type-n">Device Type</label><select id="shading-type-n" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option><option value="generative">Generative (AI)</option><option value="imported_obj">Imported OBJ</option></select></div>
                        <div id="shading-controls-overhang-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label" for="overhang-dist-above-n">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-dist-above-n" min="0" max="1.0" value="0" step="0.05"><span id="overhang-dist-above-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>


                            <div><label class="label" for="overhang-tilt-n">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-tilt-n" min="-90" max="90" value="0" step="1"><span id="overhang-tilt-n-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" for="overhang-depth-n">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-depth-n" min="0" max="2.0" value="0.5" step="0.1"><span id="overhang-depth-n-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                            <div><label class="label" for="overhang-thick-n">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-thick-n" min="0.005" max="0.5" value="0.05" step="0.005"><span id="overhang-thick-n-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                            <div><label class="label" for="overhang-extension-n">Extension From Window (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-extension-n" min="0" max="1.0" value="0.0" step="0.05"><span id="overhang-extension-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        </div>
                        <div id="shading-controls-lightshelf-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="lightshelf-placement-ext-n" class="btn active">Exterior</button><button id="lightshelf-placement-int-n" class="btn">Interior</button><button id="lightshelf-placement-both-n" class="btn">Both</button></div></div>
                            <div id="lightshelf-controls-ext-n" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3><div><label class="label" for="lightshelf-dist-below-ext-n">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-ext-n" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-ext-n-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-ext-n">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-ext-n" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-ext-n-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-ext-n">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-ext-n" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-ext-n-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-ext-n">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-ext-n" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-ext-n-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                            <div id="lightshelf-controls-int-n" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3><div><label class="label" for="lightshelf-dist-below-int-n">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-int-n" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-int-n-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-int-n">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-int-n" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-int-n-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-int-n">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-int-n" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-int-n-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-int-n">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-int-n" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-int-n-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                        </div>
                        <div id="shading-controls-louver-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="louver-placement-ext-n" class="btn active">Exterior</button><button id="louver-placement-int-n" class="btn">Interior</button></div></div>
                            <div><label class="label" for="louver-slat-orientation-n">Slat Orientation</label><select id="louver-slat-orientation-n" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                            <div><label class="label" for="louver-slat-width-n">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-width-n" min="0.01" max="1.0" value="0.1" step="0.01"><span id="louver-slat-width-n-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <div><label class="label" for="louver-slat-sep-n">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-sep-n" min="0.0" max="0.5" value="0.05" step="0.01"><span id="louver-slat-sep-n-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                            <div><label class="label" for="louver-slat-thick-n">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-thick-n" min="0.0" max="0.5" value="0.01" step="0.005"><span id="louver-slat-thick-n-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                            <div><label class="label" for="louver-slat-angle-n">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-angle-n" min="-90" max="90" value="0" step="1"><span id="louver-slat-angle-n-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" for="louver-dist-to-glass-n">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-dist-to-glass-n" min="0.0" max="1.0" value="0.1" step="0.01"><span id="louver-dist-to-glass-n-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        </div>
                        <div id="shading-controls-roller-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <p class="info-box !text-xs !py-2 !px-3">Roller shades are placed internally.</p>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Sizing Offsets</h4>
                            <div><label class="label" for="roller-top-opening-n">Top Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-top-opening-n" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-top-opening-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-bottom-opening-n">Bottom Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-bottom-opening-n" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-bottom-opening-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-left-opening-n">Left Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-left-opening-n" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-left-opening-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-right-opening-n">Right Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-right-opening-n" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-right-opening-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Placement</h4>
                            <div><label class="label" for="roller-dist-to-glass-n">Distance to Glass (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-dist-to-glass-n" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-dist-to-glass-n-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Physical Properties (for simulation)</h4>
                            <div><label class="label" for="roller-solar-trans-n">Solar Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-trans-n" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-solar-trans-n-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                            <div><label class="label" for="roller-solar-refl-n">Solar Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-refl-n" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-solar-refl-n-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                            <div><label class="label" for="roller-vis-trans-n">Visible Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-trans-n" min="0.0" max="1.0" value="0.05" step="0.01"><span id="roller-vis-trans-n-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                            <div><label class="label" for="roller-vis-refl-n">Visible Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-refl-n" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-vis-refl-n-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                            <div><label class="label" for="roller-ir-emis-n">IR Emissivity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-emis-n" min="0.0" max="1.0" value="0.9" step="0.01"><span id="roller-ir-emis-n-val" class="data-value font-mono w-12 text-left">0.90</span></div></div>
                            <div><label class="label" for="roller-ir-trans-n">IR Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-trans-n" min="0.0" max="1.0" value="0.0" step="0.01"><span id="roller-ir-trans-n-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                            <div><label class="label" for="roller-thickness-n">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-thickness-n" min="0.0" max="0.05" value="0.001" step="0.001"><span id="roller-thickness-n-val" class="data-value font-mono w-12 text-left">0.001m</span></div></div>
                            <div><label class="label" for="roller-conductivity-n">Conductivity (W/m-K)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-conductivity-n" min="0.0" max="10.0" value="0.1" step="0.01"><span id="roller-conductivity-n-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                        </div>
                        <div id="shading-controls-imported_obj-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div>
                                <label class="label" for="shading-obj-file-n">OBJ File (.obj)</label>
                                <input type="file" id="shading-obj-file-n" accept=".obj" class="w-full text-sm">
                                <span data-file-display-for-id="shading-obj-file-n" class="text-xs text-[--text-secondary] truncate block mt-1">No file selected.</span>
                            </div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Transform</h4>
                             <div>
                                <label class="label text-xs">Position (X, Y, Z)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-pos-x-n" value="0" step="0.1" class="param-input-num">
                                    <input type="number" id="shading-obj-pos-y-n" value="0" step="0.1" class="param-input-num">
                                    <input type="number" id="shading-obj-pos-z-n" value="0" step="0.1" class="param-input-num">
                                </div>
                            </div>
                             <div>
                                <label class="label text-xs">Rotation (°)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-rot-x-n" value="0" step="1" class="param-input-num">
                                    <input type="number" id="shading-obj-rot-y-n" value="0" step="1" class="param-input-num">
                                    <input type="number" id="shading-obj-rot-z-n" value="0" step="1" class="param-input-num">
                                </div>
                            </div>
                            <div>
                                <label class="label text-xs">Scale</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-scale-x-n" value="1" step="0.05" class="param-input-num">
                                    <input type="number" id="shading-obj-scale-y-n" value="1" step="0.05" class="param-input-num">
                                    <input type="number" id="shading-obj-scale-z-n" value="1" step="0.05" class="param-input-num">
                                </div>
                            </div>
                            <p class="info-box !text-xs !py-2 !px-3">Click the imported object in the 3D view to use the transform gizmo for interactive placement.</p>
                        </div>
                        <div id="shading-controls-generative-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <p class="info-box !text-xs !py-2 !px-3">
                                AI-generated pattern. Adjust common parameters below. New patterns can only be created by the AI assistant.
                            </p>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-depth-n"><span>Depth</span><span id="shading-generative-depth-n-val" class="data-value font-mono">0.5m</span></label>
                                <input type="range" id="shading-generative-depth-n" min="0.1" max="2.0" step="0.05" value="0.5">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-spacing-x-n"><span>Spacing X</span><span id="shading-generative-spacing-x-n-val" class="data-value font-mono">0.3m</span></label>
                                <input type="range" id="shading-generative-spacing-x-n" min="0.1" max="2.0" step="0.05" value="0.3">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-spacing-y-n"><span>Spacing Y</span><span id="shading-generative-spacing-y-n-val" class="data-value font-mono">0.3m</span></label>
                                <input type="range" id="shading-generative-spacing-y-n" min="0.1" max="2.0" step="0.05" value="0.3">
                            </div>






                            <div>
                            <label class="label text-xs flex justify-between" for="shading-generative-element-width-n"><span>Element Width</span><span id="shading-generative-element-width-n-val" class="data-value font-mono">0.05m</span></label>
                            <input type="range" id="shading-generative-element-width-n" min="0.01" max="0.5" step="0.01" value="0.05">
                        </div>
                        <input type="hidden" id="shading-pattern-type-n">

                        <!-- Solar Responsive Parameters -->
                        <div id="solar-params-n" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                            <h4 class="font-semibold text-sm">Solar Responsive Shading</h4>
                            
                            <!-- Analysis Quality -->
                            <div>
                                <label class="text-sm">Analysis Quality</label>
                                <select id="solar-quality-n" class="input w-full">
                                    <option value="quick">Quick (Monthly, Coarse Grid)</option>
                                    <option value="standard" selected>Standard (Hourly, Medium Grid)</option>
                                    <option value="high-fidelity">High-Fidelity (Sub-hourly, Fine Grid)</option>
                                </select>
                            </div>
                            
                            <!-- Radiation Threshold -->
                            <div class="flex items-center justify-between">
                                <label class="text-sm">Radiation Threshold</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="solar-threshold-n" 
                                           min="200" max="1000" step="50" value="500" class="slider flex-1">
                                    <span id="solar-threshold-val-n" class="text-sm w-24 text-right">500 kWh/m²</span>
                                </div>
                            </div>
                            
                            <!-- Weather File -->
                            <div>
                                <label class="text-sm">Weather File</label>
                                <input type="file" id="solar-epw-file-n" accept=".epw" class="input w-full text-sm">
                            </div>
                            
                            <!-- Run Analysis Button -->
                            <button id="solar-analyze-btn-n" class="btn btn-primary w-full">
                                Run Solar Analysis
                            </button>
                            
                            <!-- Progress indicator -->
                            <div id="solar-progress-n" class="hidden">
                                <div class="progress-bar">
                                    <div id="solar-progress-fill-n" class="progress-fill"></div>
                                </div>
                                <p class="text-xs text-center mt-1" id="solar-progress-text-n">Analyzing...</p>
                            </div>
                            
                            <!-- Results Summary (shown after analysis) -->
                            <div id="solar-results-n" class="hidden p-3 bg-gray-800 rounded">
                                <h5 class="font-semibold text-xs mb-2">Analysis Results</h5>
                                <p class="text-xs">High-radiation hours: <span id="solar-high-hours-n">-</span></p>
                                <p class="text-xs">Peak altitude: <span id="solar-peak-alt-n">-</span>°</p>
                                <p class="text-xs">Fins generated: <span id="solar-fin-count-n">-</span></p>
                            </div>
                            
                            <!-- Manual Adjustment -->
                            <button id="solar-edit-btn-n" class="btn btn-secondary w-full hidden">
                                Manually Adjust Pattern
                            </button>
                        </div>
                    </div>

                </div>
                <div class="pt-4 mt-4 border-t border-dashed border-[--grid-color]">









                        <input type="checkbox" id="sun-ray-tracing-toggle-n">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Sun Ray Tracing</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="aperture-controls-s" class="aperture-controls hidden space-y-5 pt-4 border-t border-[--grid-color]">
            <h3 class="font-semibold text-sm uppercase">South Wall Apertures</h3>
            <div><label class="label" for="win-count-s"># of Windows</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-count-s" min="0" max="10" value="0" step="1"><span id="win-count-s-val" class="data-value font-mono w-12 text-left">0</span></div></div>
            <div><label class="label">Mode</label><div class="btn-group mt-1"><button id="mode-wwr-btn-s" class="btn active">WWR</button><button id="mode-manual-btn-s" class="btn">Manual</button></div></div>
                <div id="wwr-controls-s" class="space-y-5">
                    <div><label class="label" for="wwr-s">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-s" min="0" max="0.99" value="0.4" step="0.01"><span id="wwr-s-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                    <div><label class="label" for="wwr-sill-height-s">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-sill-height-s" min="0" max="10" value="1.0" step="0.05"><span id="wwr-sill-height-s-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                    <div><label class="label" for="win-depth-pos-s">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-s" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-s-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                </div>
                <div id="manual-controls-s" class="hidden space-y-5">
                    <div><label class="label" for="win-width-s">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-width-s" min="0.1" max="20" value="1.2" step="0.1"><span id="win-width-s-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                    <div><label class="label" for="win-height-s">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-height-s" min="0.1" max="10" value="1.5" step="0.1"><span id="win-height-s-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                    <div><label class="label" for="sill-height-s">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="sill-height-s" min="0" max="10" value="1.0" step="0.05"><span id="sill-height-s-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                    <div><label class="label" for="win-depth-pos-s-manual">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-s-manual" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-s-val-manual" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                </div>
                <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-sm uppercase text-gray-700">South Wall Shading</h4>
                    <label class="flex items-center cursor-pointer" for="shading-s-toggle"><input type="checkbox" id="shading-s-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                    <div id="shading-controls-s" class="hidden space-y-5">
                        <div><label class="label" for="shading-type-s">Device Type</label><select id="shading-type-s" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option><option value="generative">Generative (AI)</option><option value="imported_obj">Imported OBJ</option></select></div>
                        <div id="shading-controls-overhang-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label" for="overhang-dist-above-s">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-dist-above-s" min="0" max="1.0" value="0" step="0.05"><span id="overhang-dist-above-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="overhang-tilt-s">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-tilt-s" min="-90" max="90" value="0" step="1"><span id="overhang-tilt-s-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" for="overhang-depth-s">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-depth-s" min="0" max="2.0" value="0.5" step="0.1"><span id="overhang-depth-s-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                            <div><label class="label" for="overhang-thick-s">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-thick-s" min="0.005" max="0.5" value="0.05" step="0.005"><span id="overhang-thick-s-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                            <div><label class="label" for="overhang-extension-s">Extension From Window (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-extension-s" min="0" max="1.0" value="0.0" step="0.05"><span id="overhang-extension-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        </div>
                        <div id="shading-controls-lightshelf-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="lightshelf-placement-ext-s" class="btn active">Exterior</button><button id="lightshelf-placement-int-s" class="btn">Interior</button><button id="lightshelf-placement-both-s" class="btn">Both</button></div></div>
                            <div id="lightshelf-controls-ext-s" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3><div><label class="label" for="lightshelf-dist-below-ext-s">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-ext-s" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-ext-s-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-ext-s">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-ext-s" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-ext-s-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-ext-s">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-ext-s" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-ext-s-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-ext-s">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-ext-s" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-ext-s-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                            <div id="lightshelf-controls-int-s" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3><div><label class="label" for="lightshelf-dist-below-int-s">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-int-s" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-int-s-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-int-s">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-int-s" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-int-s-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-int-s">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-int-s" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-int-s-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-int-s">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-int-s" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-int-s-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                        </div>
                        <div id="shading-controls-louver-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="louver-placement-ext-s" class="btn active">Exterior</button><button id="louver-placement-int-s" class="btn">Interior</button></div></div>
                            <div><label class="label" for="louver-slat-orientation-s">Slat Orientation</label><select id="louver-slat-orientation-s" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                            <div><label class="label" for="louver-slat-width-s">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-width-s" min="0.01" max="1.0" value="0.1" step="0.01"><span id="louver-slat-width-s-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <div><label class="label" for="louver-slat-sep-s">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-sep-s" min="0.0" max="0.5" value="0.05" step="0.01"><span id="louver-slat-sep-s-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                            <div><label class="label" for="louver-slat-thick-s">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-thick-s" min="0.0" max="0.5" value="0.01" step="0.005"><span id="louver-slat-thick-s-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                            <div><label class="label" for="louver-slat-angle-s">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-angle-s" min="-90" max="90" value="0" step="1"><span id="louver-slat-angle-s-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" for="louver-dist-to-glass-s">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-dist-to-glass-s" min="0.0" max="1.0" value="0.1" step="0.01"><span id="louver-dist-to-glass-s-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        </div>
                        <div id="shading-controls-roller-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <p class="info-box !text-xs !py-2 !px-3">Roller shades are placed internally.</p>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Sizing Offsets</h4>
                            <div><label class="label" for="roller-top-opening-s">Top Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-top-opening-s" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-top-opening-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-bottom-opening-s">Bottom Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-bottom-opening-s" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-bottom-opening-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-left-opening-s">Left Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-left-opening-s" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-left-opening-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-right-opening-s">Right Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-right-opening-s" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-right-opening-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Placement</h4>
                            <div><label class="label" for="roller-dist-to-glass-s">Distance to Glass (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-dist-to-glass-s" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-dist-to-glass-s-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Physical Properties (for simulation)</h4>
                            <div><label class="label" for="roller-solar-trans-s">Solar Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-trans-s" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-solar-trans-s-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                            <div><label class="label" for="roller-solar-refl-s">Solar Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-refl-s" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-solar-refl-s-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                            <div><label class="label" for="roller-vis-trans-s">Visible Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-trans-s" min="0.0" max="1.0" value="0.05" step="0.01"><span id="roller-vis-trans-s-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                            <div><label class="label" for="roller-vis-refl-s">Visible Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-refl-s" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-vis-refl-s-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                            <div><label class="label" for="roller-ir-emis-s">IR Emissivity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-emis-s" min="0.0" max="1.0" value="0.9" step="0.01"><span id="roller-ir-emis-s-val" class="data-value font-mono w-12 text-left">0.90</span></div></div>
                            <div><label class="label" for="roller-ir-trans-s">IR Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-trans-s" min="0.0" max="1.0" value="0.0" step="0.01"><span id="roller-ir-trans-s-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                            <div><label class="label" for="roller-thickness-s">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-thickness-s" min="0.0" max="0.05" value="0.001" step="0.001"><span id="roller-thickness-s-val" class="data-value font-mono w-12 text-left">0.001m</span></div></div>
                            <div><label class="label" for="roller-conductivity-s">Conductivity (W/m-K)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-conductivity-s" min="0.0" max="10.0" value="0.1" step="0.01"><span id="roller-conductivity-s-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                        </div>
                        <div id="shading-controls-imported_obj-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div>
                                <label class="label" for="shading-obj-file-s">OBJ File (.obj)</label>
                                <input type="file" id="shading-obj-file-s" accept=".obj" class="w-full text-sm">
                                <span data-file-display-for-id="shading-obj-file-s" class="text-xs text-[--text-secondary] truncate block mt-1">No file selected.</span>
                            </div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Transform</h4>
                             <div>
                                <label class="label text-xs">Position (X, Y, Z)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-pos-x-s" value="0" step="0.1" class="param-input-num">
                                    <input type="number" id="shading-obj-pos-y-s" value="0" step="0.1" class="param-input-num">
                                    <input type="number" id="shading-obj-pos-z-s" value="0" step="0.1" class="param-input-num">
                                </div>
                            </div>
                             <div>
                                <label class="label text-xs">Rotation (°)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-rot-x-s" value="0" step="1" class="param-input-num">
                                    <input type="number" id="shading-obj-rot-y-s" value="0" step="1" class="param-input-num">
                                    <input type="number" id="shading-obj-rot-z-s" value="0" step="1" class="param-input-num">
                                </div>
                            </div>
                            <div>
                                <label class="label text-xs">Scale</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-scale-x-s" value="1" step="0.05" class="param-input-num">
                                    <input type="number" id="shading-obj-scale-y-s" value="1" step="0.05" class="param-input-num">
                                    <input type="number" id="shading-obj-scale-z-s" value="1" step="0.05" class="param-input-num">
                                </div>
                            </div>
                            <p class="info-box !text-xs !py-2 !px-3">Click the imported object in the 3D view to use the transform gizmo for interactive placement.</p>
                        </div>
                        <div id="shading-controls-generative-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <p class="info-box !text-xs !py-2 !px-3">
                                AI-generated pattern. Adjust common parameters below. New patterns can only be created by the AI assistant.
                            </p>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-depth-s"><span>Depth</span><span id="shading-generative-depth-s-val" class="data-value font-mono">0.5m</span></label>
                                <input type="range" id="shading-generative-depth-s" min="0.1" max="2.0" step="0.05" value="0.5">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-spacing-x-s"><span>Spacing X</span><span id="shading-generative-spacing-x-s-val" class="data-value font-mono">0.3m</span></label>
                                <input type="range" id="shading-generative-spacing-x-s" min="0.1" max="2.0" step="0.05" value="0.3">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-spacing-y-s"><span>Spacing Y</span><span id="shading-generative-spacing-y-s-val" class="data-value font-mono">0.3m</span></label>
                                <input type="range" id="shading-generative-spacing-y-s" min="0.1" max="2.0" step="0.05" value="0.3">
                            </div>
                                                        <div>
                            <label class="label text-xs flex justify-between" for="shading-generative-element-width-s"><span>Element Width</span><span id="shading-generative-element-width-s-val" class="data-value font-mono">0.05m</span></label>
                            <input type="range" id="shading-generative-element-width-s" min="0.01" max="0.5" step="0.01" value="0.05">
                        </div>
                        <input type="hidden" id="shading-pattern-type-s">

                        <!-- Solar Responsive Parameters -->
                        <div id="solar-params-s" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                            <h4 class="font-semibold text-sm">Solar Responsive Shading</h4>
                            
                            <!-- Analysis Quality -->
                            <div>
                                <label class="text-sm">Analysis Quality</label>
                                <select id="solar-quality-s" class="input w-full">
                                    <option value="quick">Quick (Monthly, Coarse Grid)</option>
                                    <option value="standard" selected>Standard (Hourly, Medium Grid)</option>
                                    <option value="high-fidelity">High-Fidelity (Sub-hourly, Fine Grid)</option>
                                </select>
                            </div>
                            
                            <!-- Radiation Threshold -->
                            <div class="flex items-center justify-between">
                                <label class="text-sm">Radiation Threshold</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="solar-threshold-s" 
                                           min="200" max="1000" step="50" value="500" class="slider flex-1">
                                    <span id="solar-threshold-val-s" class="text-sm w-24 text-right">500 kWh/m²</span>
                                </div>
                            </div>
                            
                            <!-- Weather File -->
                            <div>
                                <label class="text-sm">Weather File</label>
                                <input type="file" id="solar-epw-file-s" accept=".epw" class="input w-full text-sm">
                            </div>
                            
                            <!-- Run Analysis Button -->
                            <button id="solar-analyze-btn-s" class="btn btn-primary w-full">
                                Run Solar Analysis
                            </button>
                            
                            <!-- Progress indicator -->
                            <div id="solar-progress-s" class="hidden">
                                <div class="progress-bar">
                                    <div id="solar-progress-fill-s" class="progress-fill"></div>
                                </div>
                                <p class="text-xs text-center mt-1" id="solar-progress-text-s">Analyzing...</p>
                            </div>
                            
                            <!-- Results Summary (shown after analysis) -->
                            <div id="solar-results-s" class="hidden p-3 bg-gray-800 rounded">
                                <h5 class="font-semibold text-xs mb-2">Analysis Results</h5>
                                <p class="text-xs">High-radiation hours: <span id="solar-high-hours-s">-</span></p>
                                <p class="text-xs">Peak altitude: <span id="solar-peak-alt-s">-</span>°</p>
                                <p class="text-xs">Fins generated: <span id="solar-fin-count-s">-</span></p>
                            </div>
                            
                            <!-- Manual Adjustment -->
                            <button id="solar-edit-btn-s" class="btn btn-secondary w-full hidden">
                                Manually Adjust Pattern
                            </button>
                        </div>
                    </div>
                    
                </div>
                <div class="pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                        <input type="checkbox" id="sun-ray-tracing-toggle-s">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Sun Ray Tracing</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="aperture-controls-e" class="aperture-controls hidden space-y-5 pt-4 border-t border-[--grid-color]">
            <h3 class="font-semibold text-sm uppercase">East Wall Apertures</h3>
            <div><label class="label" for="win-count-e"># of Windows</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-count-e" min="0" max="10" value="0" step="1"><span id="win-count-e-val" class="data-value font-mono w-12 text-left">0</span></div></div>
            <div><label class="label">Mode</label><div class="btn-group mt-1"><button id="mode-wwr-btn-e" class="btn active">WWR</button><button id="mode-manual-btn-e" class="btn">Manual</button></div></div>
                <div id="wwr-controls-e" class="space-y-5">
                    <div><label class="label" for="wwr-e">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-e" min="0" max="0.99" value="0.4" step="0.01"><span id="wwr-e-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                    <div><label class="label" for="wwr-sill-height-e">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-sill-height-e" min="0" max="10" value="1.0" step="0.1"><span id="wwr-sill-height-e-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                    <div><label class="label" for="win-depth-pos-e">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-e" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-e-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                </div>
            <div id="manual-controls-e" class="hidden space-y-5">
                    <div><label class="label" for="win-width-e">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-width-e" min="0.1" max="20" value="1.5" step="0.1"><span id="win-width-e-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                    <div><label class="label" for="win-height-e">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-height-e" min="0.1" max="10" value="1.2" step="0.1"><span id="win-height-e-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                    <div><label class="label" for="sill-height-e">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="sill-height-e" min="0" max="10" value="1.0" step="0.1"><span id="sill-height-e-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                    <div><label class="label" for="win-depth-pos-e-manual">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-e-manual" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-e-val-manual" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                </div>
            <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                <h4 class="font-semibold text-sm uppercase text-gray-700">East Wall Shading</h4>
                    <label class="flex items-center cursor-pointer" for="shading-e-toggle"><input type="checkbox" id="shading-e-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                    <div id="shading-controls-e" class="hidden space-y-5">
                        <div><label class="label" for="shading-type-e">Device Type</label><select id="shading-type-e" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option><option value="generative">Generative (AI)</option><option value="imported_obj">Imported OBJ</option></select></div>
                        <div id="shading-controls-overhang-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label" for="overhang-dist-above-e">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-dist-above-e" min="0" max="1.0" value="0" step="0.05"><span id="overhang-dist-above-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        </div>
                        <div id="shading-controls-lightshelf-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="lightshelf-placement-ext-e" class="btn active">Exterior</button><button id="lightshelf-placement-int-e" class="btn">Interior</button><button id="lightshelf-placement-both-e" class="btn">Both</button></div></div>
                            <div id="lightshelf-controls-ext-e" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3><div><label class="label" for="lightshelf-dist-below-ext-e">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-ext-e" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-ext-e-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-ext-e">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-ext-e" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-ext-e-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-ext-e">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-ext-e" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-ext-e-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-ext-e">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-ext-e" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-ext-e-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                            <div id="lightshelf-controls-int-e" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3><div><label class="label" for="lightshelf-dist-below-int-e">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-int-e" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-int-e-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-int-e">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-int-e" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-int-e-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-int-e">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-int-e" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-int-e-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-int-e">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-int-e" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-int-e-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                        </div>
                        <div id="shading-controls-louver-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="louver-placement-ext-e" class="btn active">Exterior</button><button id="louver-placement-int-e" class="btn">Interior</button></div></div>
                            <div><label class="label" for="louver-slat-orientation-e">Slat Orientation</label><select id="louver-slat-orientation-e" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                            <div><label class="label" for="louver-slat-width-e">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-width-e" min="0.01" max="1.0" value="0.1" step="0.01"><span id="louver-slat-width-e-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <div><label class="label" for="louver-slat-sep-e">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-sep-e" min="0.0" max="0.5" value="0.05" step="0.01"><span id="louver-slat-sep-e-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                            <div><label class="label" for="louver-slat-thick-e">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-thick-e" min="0.0" max="0.5" value="0.01" step="0.005"><span id="louver-slat-thick-e-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                            <div><label class="label" for="louver-slat-angle-e">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-angle-e" min="-90" max="90" value="0" step="1"><span id="louver-slat-angle-e-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" for="louver-dist-to-glass-e">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-dist-to-glass-e" min="0.0" max="1.0" value="0.1" step="0.01"><span id="louver-dist-to-glass-e-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        </div>
                        <div id="shading-controls-roller-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <p class="info-box !text-xs !py-2 !px-3">Roller shades are placed internally.</p>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Sizing Offsets</h4>
                            <div><label class="label" for="roller-top-opening-e">Top Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-top-opening-e" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-top-opening-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-bottom-opening-e">Bottom Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-bottom-opening-e" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-bottom-opening-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-left-opening-e">Left Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-left-opening-e" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-left-opening-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-right-opening-e">Right Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-right-opening-e" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-right-opening-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Placement</h4>
                            <div><label class="label" for="roller-dist-to-glass-e">Distance to Glass (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-dist-to-glass-e" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-dist-to-glass-e-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Physical Properties (for simulation)</h4>
                            <div><label class="label" for="roller-solar-trans-e">Solar Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-trans-e" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-solar-trans-e-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                            <div><label class="label" for="roller-solar-refl-e">Solar Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-refl-e" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-solar-refl-e-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                            <div><label class="label" for="roller-vis-trans-e">Visible Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-trans-e" min="0.0" max="1.0" value="0.05" step="0.01"><span id="roller-vis-trans-e-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                            <div><label class="label" for="roller-vis-refl-e">Visible Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-refl-e" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-vis-refl-e-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                            <div><label class="label" for="roller-ir-emis-e">IR Emissivity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-emis-e" min="0.0" max="1.0" value="0.9" step="0.01"><span id="roller-ir-emis-e-val" class="data-value font-mono w-12 text-left">0.90</span></div></div>
                            <div><label class="label" for="roller-ir-trans-e">IR Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-trans-e" min="0.0" max="1.0" value="0.0" step="0.01"><span id="roller-ir-trans-e-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                            <div><label class="label" for="roller-thickness-e">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-thickness-e" min="0.0" max="0.05" value="0.001" step="0.001"><span id="roller-thickness-e-val" class="data-value font-mono w-12 text-left">0.001m</span></div></div>
                            <div><label class="label" for="roller-conductivity-e">Conductivity (W/m-K)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-conductivity-e" min="0.0" max="10.0" value="0.1" step="0.01"><span id="roller-conductivity-e-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                        </div>
                        <div id="shading-controls-imported_obj-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div>
                                <label class="label" for="shading-obj-file-e">OBJ File (.obj)</label>
                                <input type="file" id="shading-obj-file-e" accept=".obj" class="w-full text-sm">
                                <span data-file-display-for-id="shading-obj-file-e" class="text-xs text-[--text-secondary] truncate block mt-1">No file selected.</span>
                            </div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Transform</h4>
                             <div>
                                <label class="label text-xs">Position (X, Y, Z)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-pos-x-e" value="0" step="0.1" class="param-input-num">
                                    <input type="number" id="shading-obj-pos-y-e" value="0" step="0.1" class="param-input-num">
                                    <input type="number" id="shading-obj-pos-z-e" value="0" step="0.1" class="param-input-num">
                                </div>
                            </div>
                             <div>
                                <label class="label text-xs">Rotation (°)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-rot-x-e" value="0" step="1" class="param-input-num">
                                    <input type="number" id="shading-obj-rot-y-e" value="0" step="1" class="param-input-num">
                                    <input type="number" id="shading-obj-rot-z-e" value="0" step="1" class="param-input-num">
                                </div>
                            </div>
                            <div>
                                <label class="label text-xs">Scale</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-scale-x-e" value="1" step="0.05" class="param-input-num">
                                    <input type="number" id="shading-obj-scale-y-e" value="1" step="0.05" class="param-input-num">
                                    <input type="number" id="shading-obj-scale-z-e" value="1" step="0.05" class="param-input-num">
                                </div>
                            </div>
                            <p class="info-box !text-xs !py-2 !px-3">Click the imported object in the 3D view to use the transform gizmo for interactive placement.</p>
                        </div>
                        <div id="shading-controls-generative-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <p class="info-box !text-xs !py-2 !px-3">
                                AI-generated pattern. Adjust common parameters below. New patterns can only be created by the AI assistant.
                            </p>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-depth-e"><span>Depth</span><span id="shading-generative-depth-e-val" class="data-value font-mono">0.5m</span></label>
                                <input type="range" id="shading-generative-depth-e" min="0.1" max="2.0" step="0.05" value="0.5">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-spacing-x-e"><span>Spacing X</span><span id="shading-generative-spacing-x-e-val" class="data-value font-mono">0.3m</span></label>
                                <input type="range" id="shading-generative-spacing-x-e" min="0.1" max="2.0" step="0.05" value="0.3">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-spacing-y-e"><span>Spacing Y</span><span id="shading-generative-spacing-y-e-val" class="data-value font-mono">0.3m</span></label>
                                <input type="range" id="shading-generative-spacing-y-e" min="0.1" max="2.0" step="0.05" value="0.3">
                            </div>
                            <div>
                            <label class="label text-e-xs flex justify-between" for="shading-generative-element-width-e"><span>Element Width</span><span id="shading-generative-element-width-e-val" class="data-value font-mono">0.05m</span></label>
                            <input type="range" id="shading-generative-element-width-e" min="0.01" max="0.5" step="0.01" value="0.05">
                        </div>
                        <input type="hidden" id="shading-pattern-type-e">

                        <!-- Solar Responsive Parameters -->
                        <div id="solar-params-e" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                            <h4 class="font-semibold text-sm">Solar Responsive Shading</h4>
                            
                            <!-- Analysis Quality -->
                            <div>
                                <label class="text-sm">Analysis Quality</label>
                                <select id="solar-quality-e" class="input w-full">
                                    <option value="quick">Quick (Monthly, Coarse Grid)</option>
                                    <option value="standard" selected>Standard (Hourly, Medium Grid)</option>
                                    <option value="high-fidelity">High-Fidelity (Sub-hourly, Fine Grid)</option>
                                </select>
                            </div>
                            
                            <!-- Radiation Threshold -->
                            <div class="flex items-center justify-between">
                                <label class="text-sm">Radiation Threshold</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="solar-threshold-e" 
                                           min="200" max="1000" step="50" value="500" class="slider flex-1">
                                    <span id="solar-threshold-val-e" class="text-sm w-24 text-right">500 kWh/m²</span>
                                </div>
                            </div>
                            
                            <!-- Weather File -->
                            <div>
                                <label class="text-sm">Weather File</label>
                                <input type="file" id="solar-epw-file-e" accept=".epw" class="input w-full text-sm">
                            </div>
                            
                            <!-- Run Analysis Button -->
                            <button id="solar-analyze-btn-e" class="btn btn-primary w-full">
                                Run Solar Analysis
                            </button>
                            
                            <!-- Progress indicator -->
                            <div id="solar-progress-e" class="hidden">
                                <div class="progress-bar">
                                    <div id="solar-progress-fill-e" class="progress-fill"></div>
                                </div>
                                <p class="text-xs text-center mt-1" id="solar-progress-text-e">Analyzing...</p>
                            </div>
                            
                            <!-- Results Summary (shown after analysis) -->
                            <div id="solar-results-e" class="hidden p-3 bg-gray-800 rounded">
                                <h5 class="font-semibold text-xs mb-2">Analysis Results</h5>
                                <p class="text-xs">High-radiation hours: <span id="solar-high-hours-e">-</span></p>
                                <p class="text-xs">Peak altitude: <span id="solar-peak-alt-e">-</span>°</p>
                                <p class="text-xs">Fins generated: <span id="solar-fin-count-e">-</span></p>
                            </div>
                            
                            <!-- Manual Adjustment -->
                            <button id="solar-edit-btn-e" class="btn btn-secondary w-full hidden">
                                Manually Adjust Pattern
                            </button>
                        </div>
                    </div>
                    
                </div>
                <div class="pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                        <input type="checkbox" id="sun-ray-tracing-toggle-e">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Sun Ray Tracing</span>
                    </label>
                </div>
            </div>
        </div>

            <div id="aperture-controls-w" class="aperture-controls hidden space-y-5 pt-4 border-t border-[--grid-color]">
            <h3 class="font-semibold text-sm uppercase">West Wall Apertures</h3>
            <div><label class="label" for="win-count-w"># of Windows</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-count-w" min="0" max="10" value="0" step="1"><span id="win-count-w-val" class="data-value font-mono w-12 text-left">0</span></div></div>
            <div><label class="label">Mode</label><div class="btn-group mt-1"><button id="mode-wwr-btn-w" class="btn active">WWR</button><button id="mode-manual-btn-w" class="btn">Manual</button></div></div>
                <div id="wwr-controls-w" class="space-y-5">
                    <div><label class="label" for="wwr-w">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-w" min="0" max="0.99" value="0.4" step="0.01"><span id="wwr-w-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                    <div><label class="label" for="wwr-sill-height-w">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-sill-height-w" min="0" max="10" value="1.0" step="0.1"><span id="wwr-sill-height-w-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                    <div><label class="label" for="win-depth-pos-w">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-w" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-w-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                </div>
            <div id="manual-controls-w" class="hidden space-y-5">
                <div><label class="label" for="win-width-w">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-width-w" min="0.1" max="20" value="1.5" step="0.1"><span id="win-width-w-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                <div><label class="label" for="win-height-w">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-height-w" min="0.1" max="10" value="1.2" step="0.1"><span id="win-height-w-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                <div><label class="label" for="sill-height-w">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="sill-height-w" min="0" max="10" value="1.0" step="0.05"><span id="sill-height-w-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                <div><label class="label" for="win-depth-pos-w-manual">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-w-manual" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-w-val-manual" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
            </div>
            <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                <h4 class="font-semibold text-sm uppercase text-gray-700">West Wall Shading</h4>
                    <label class="flex items-center cursor-pointer" for="shading-w-toggle"><input type="checkbox" id="shading-w-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                    <div id="shading-controls-w" class="hidden space-y-5">
                        <div><label class="label" for="shading-type-w">Device Type</label><select id="shading-type-w" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option><option value="generative">Generative (AI)</option><option value="imported_obj">Imported OBJ</option></select></div>
                        <div id="shading-controls-overhang-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label" for="overhang-dist-above-w">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-dist-above-w" min="0" max="1.0" value="0" step="0.05"><span id="overhang-dist-above-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        </div>
                        <div id="shading-controls-lightshelf-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="lightshelf-placement-ext-w" class="btn active">Exterior</button><button id="lightshelf-placement-int-w" class="btn">Interior</button><button id="lightshelf-placement-both-w" class="btn">Both</button></div></div>
                            <div id="lightshelf-controls-ext-w" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3><div><label class="label" for="lightshelf-dist-below-ext-w">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-ext-w" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-ext-w-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-ext-w">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-ext-w" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-ext-w-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-ext-w">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-ext-w" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-ext-w-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-ext-w">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-ext-w" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-ext-w-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                            <div id="lightshelf-controls-int-w" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3><div><label class="label" for="lightshelf-dist-below-int-w">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-int-w" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-int-w-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-int-w">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-int-w" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-int-w-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-int-w">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-int-w" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-int-w-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-int-w">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-int-w" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-int-w-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                        </div>
                        <div id="shading-controls-louver-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="louver-placement-ext-w" class="btn active">Exterior</button><button id="louver-placement-int-w" class="btn">Interior</button></div></div>
                            <div><label class="label" for="louver-slat-orientation-w">Slat Orientation</label><select id="louver-slat-orientation-w" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                            <div><label class="label" for="louver-slat-width-w">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-width-w" min="0.01" max="1.0" value="0.1" step="0.01"><span id="louver-slat-width-w-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <div><label class="label" for="louver-slat-sep-w">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-sep-w" min="0.0" max="0.5" value="0.05" step="0.01"><span id="louver-slat-sep-w-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                            <div><label class="label" for="louver-slat-thick-w">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-thick-w" min="0.0" max="0.5" value="0.01" step="0.005"><span id="louver-slat-thick-w-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                            <div><label class="label" for="louver-slat-angle-w">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-angle-w" min="-90" max="90" value="0" step="1"><span id="louver-slat-angle-w-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" for="louver-dist-to-glass-w">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-dist-to-glass-w" min="0.0" max="1.0" value="0.1" step="0.01"><span id="louver-dist-to-glass-w-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        </div>
                        <div id="shading-controls-roller-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <p class="info-box !text-xs !py-2 !px-3">Roller shades are placed internally.</p>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Sizing Offsets</h4>
                            <div><label class="label" for="roller-top-opening-w">Top Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-top-opening-w" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-top-opening-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-bottom-opening-w">Bottom Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-bottom-opening-w" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-bottom-opening-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-left-opening-w">Left Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-left-opening-w" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-left-opening-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <div><label class="label" for="roller-right-opening-w">Right Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-right-opening-w" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-right-opening-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Placement</h4>
                            <div><label class="label" for="roller-dist-to-glass-w">Distance to Glass (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-dist-to-glass-w" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-dist-to-glass-w-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Physical Properties (for simulation)</h4>
                            <div><label class="label" for="roller-solar-trans-w">Solar Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-trans-w" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-solar-trans-w-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                            <div><label class="label" for="roller-solar-refl-w">Solar Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-refl-w" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-solar-refl-w-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                            <div><label class="label" for="roller-vis-trans-w">Visible Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-trans-w" min="0.0" max="1.0" value="0.05" step="0.01"><span id="roller-vis-trans-w-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                            <div><label class="label" for="roller-vis-refl-w">Visible Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-refl-w" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-vis-refl-w-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                            <div><label class="label" for="roller-ir-emis-w">IR Emissivity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-emis-w" min="0.0" max="1.0" value="0.9" step="0.01"><span id="roller-ir-emis-w-val" class="data-value font-mono w-12 text-left">0.90</span></div></div>
                            <div><label class="label" for="roller-ir-trans-w">IR Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-trans-w" min="0.0" max="1.0" value="0.0" step="0.01"><span id="roller-ir-trans-w-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                            <div><label class="label" for="roller-thickness-w">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-thickness-w" min="0.0" max="0.05" value="0.001" step="0.001"><span id="roller-thickness-w-val" class="data-value font-mono w-12 text-left">0.001m</span></div></div>
                            <div><label class="label" for="roller-conductivity-w">Conductivity (W/m-K)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-conductivity-w" min="0.0" max="10.0" value="0.1" step="0.01"><span id="roller-conductivity-w-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                        </div>
                        <div id="shading-controls-imported_obj-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div>
                                <label class="label" for="shading-obj-file-w">OBJ File (.obj)</label>
                                <input type="file" id="shading-obj-file-w" accept=".obj" class="w-full text-sm">
                                <span data-file-display-for-id="shading-obj-file-w" class="text-xs text-[--text-secondary] truncate block mt-1">No file selected.</span>
                            </div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Transform</h4>
                             <div>
                                <label class="label text-xs">Position (X, Y, Z)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-pos-x-w" value="0" step="0.1" class="param-input-num">
                                    <input type="number" id="shading-obj-pos-y-w" value="0" step="0.1" class="param-input-num">
                                    <input type="number" id="shading-obj-pos-z-w" value="0" step="0.1" class="param-input-num">
                                </div>
                            </div>
                             <div>
                                <label class="label text-xs">Rotation (°)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-rot-x-w" value="0" step="1" class="param-input-num">
                                    <input type="number" id="shading-obj-rot-y-w" value="0" step="1" class="param-input-num">
                                    <input type="number" id="shading-obj-rot-z-w" value="0" step="1" class="param-input-num">
                                </div>
                            </div>
                            <div>
                                <label class="label text-xs">Scale</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" id="shading-obj-scale-x-w" value="1" step="0.05" class="param-input-num">
                                    <input type="number" id="shading-obj-scale-y-w" value="1" step="0.05" class="param-input-num">
                                    <input type="number" id="shading-obj-scale-z-w" value="1" step="0.05" class="param-input-num">
                                </div>
                            </div>
                            <p class="info-box !text-xs !py-2 !px-3">Click the imported object in the 3D view to use the transform gizmo for interactive placement.</p>
                        </div>
                        <div id="shading-controls-generative-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <p class="info-box !text-xs !py-2 !px-3">
                                AI-generated pattern. Adjust common parameters below. New patterns can only be created by the AI assistant.
                            </p>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-depth-w"><span>Depth</span><span id="shading-generative-depth-w-val" class="data-value font-mono">0.5m</span></label>
                                <input type="range" id="shading-generative-depth-w" min="0.1" max="2.0" step="0.05" value="0.5">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-spacing-x-w"><span>Spacing X</span><span id="shading-generative-spacing-x-w-val" class="data-value font-mono">0.3m</span></label>
                                <input type="range" id="shading-generative-spacing-x-w" min="0.1" max="2.0" step="0.05" value="0.3">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="shading-generative-spacing-y-w"><span>Spacing Y</span><span id="shading-generative-spacing-y-w-val" class="data-value font-mono">0.3m</span></label>
                                <input type="range" id="shading-generative-spacing-y-w" min="0.1" max="2.0" step="0.05" value="0.3">
                            </div>
                            <div>
                            <label class="label text-xs flex justify-between" for="shading-generative-element-width-w"><span>Element Width</span><span id="shading-generative-element-width-w-val" class="data-value font-mono">0.05m</span></label>
                            <input type="range" id="shading-generative-element-width-w" min="0.01" max="0.5" step="0.01" value="0.05">
                        </div>
                        <input type="hidden" id="shading-pattern-type-w">

                        <!-- Solar Responsive Parameters -->
                        <div id="solar-params-w" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                            <h4 class="font-semibold text-sm">Solar Responsive Shading</h4>
                            
                            <!-- Analysis Quality -->
                            <div>
                                <label class="text-sm">Analysis Quality</label>
                                <select id="solar-quality-w" class="input w-full">
                                    <option value="quick">Quick (Monthly, Coarse Grid)</option>
                                    <option value="standard" selected>Standard (Hourly, Medium Grid)</option>
                                    <option value="high-fidelity">High-Fidelity (Sub-hourly, Fine Grid)</option>
                                </select>
                            </div>
                            
                            <!-- Radiation Threshold -->
                            <div class="flex items-center justify-between">
                                <label class="text-sm">Radiation Threshold</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="solar-threshold-w" 
                                           min="200" max="1000" step="50" value="500" class="slider flex-1">
                                    <span id="solar-threshold-val-w" class="text-sm w-24 text-right">500 kWh/m²</span>
                                </div>
                            </div>
                            
                            <!-- Weather File -->
                            <div>
                                <label class="text-sm">Weather File</label>
                                <input type="file" id="solar-epw-file-w" accept=".epw" class="input w-full text-sm">
                            </div>
                            
                            <!-- Run Analysis Button -->
                            <button id="solar-analyze-btn-w" class="btn btn-primary w-full">
                                Run Solar Analysis
                            </button>
                            
                            <!-- Progress indicator -->
                            <div id="solar-progress-w" class="hidden">
                                <div class="progress-bar">
                                    <div id="solar-progress-fill-w" class="progress-fill"></div>
                                </div>
                                <p class="text-xs text-center mt-1" id="solar-progress-text-w">Analyzing...</p>
                            </div>
                            
                            <!-- Results Summary (shown after analysis) -->
                            <div id="solar-results-w" class="hidden p-3 bg-gray-800 rounded">
                                <h5 class="font-semibold text-xs mb-2">Analysis Results</h5>
                                <p class="text-xs">High-radiation hours: <span id="solar-high-hours-w">-</span></p>
                                <p class="text-xs">Peak altitude: <span id="solar-peak-alt-w">-</span>°</p>
                                <p class="text-xs">Fins generated: <span id="solar-fin-count-w">-</span></p>
                            </div>
                            
                            <!-- Manual Adjustment -->
                            <button id="solar-edit-btn-w" class="btn btn-secondary w-full hidden">
                                Manually Adjust Pattern
                            </button>
                        </div>
                    </div>
                    
                </div>
                <div class="pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                            <input type="checkbox" id="sun-ray-tracing-toggle-w">
                            <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Sun Ray Tracing</span>
                        </label>
                    </div>
                </div>
            </div>

            

            <div class="pt-4 border-t border-[--grid-color]">
                <label for="frame-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="frame-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Add Frame To All Windows</span></label>
                <div id="frame-controls" class="mt-4">
                <div>
                    <label class="label" for="frame-thick">Frame Thick. (m)</label>
                    <div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-thick" min="0.00" max="1.00" value="0.01" step="0.01"><span id="frame-thick-val" class="data-value font-mono w-12 text-left">0.01m</span></div>
                </div>
                        <div class="mt-2">
                            <label class="label" for="frame-depth">Frame Depth (m)</label>
                            <div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-depth" min="0.00" max="1.00" value="0.05" step="0.01"><span id="frame-depth-val" class="data-value font-mono w-12 text-left">0.05m</span></div>
                        </div>
                    </div>
                </div>
            </div> 
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

    <div id="panel-lighting" class="floating-window ui-panel hidden">

      <div class="window-header">
            <span>Artificial Lighting</span>
            <div class="window-controls">
                <div class="window-icon-max"></div>
                <div class="collapse-icon"></div>
                <div class="window-icon-close"></div>
            </div>
        </div>
        <div class="window-content space-y-5">

            <div class="param-section">
                <label for="lighting-enabled-toggle" class="flex items-center cursor-pointer">
                <input type="checkbox" id="lighting-enabled-toggle">
                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Enable Artificial Lighting</span>
                </label>
            </div>

            <div id="lighting-controls-wrapper" class="hidden space-y-5 border-t border-dashed border-[--grid-color] pt-5">

                <div class="param-section">
                    <label for="light-type-selector" class="label">Light Source Type</label>
                    <select id="light-type-selector" class="w-full">
                        <option value="light">light (Uniform Emitter)</option>
                        <option value="spotlight">spotlight (Directed)</option>
                        <option value="glow">glow (Controlled Luminance)</option>
                        <option value="illum">illum (Secondary Source)</option>
                        <option value="ies">IES Photometric File</option>
                    </select>
                </div>

                <div id="light-geometry-section" class="param-section">
                    <label for="light-geometry-selector" class="label">Light Source Geometry</label>
                    <select id="light-geometry-selector" class="w-full">
                        <option value="polygon" selected>Polygon</option>
                        <option value="sphere">Sphere</option>
                        <option value="cylinder">Cylinder</option>
                        <option value="ring">Ring</option>
                    </select>
                </div>

                  <div id="geometry-params-section" class="param-section space-y-3 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                      <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Geometry Parameters</h4>
                      <div id="geo-params-polygon" class="mt-2"><p class="info-box !text-xs !py-2 !px-3">Default polygon geometry is defined by placement and rotation. Advanced shapes require separate .rad files.</p></div>
                      <div id="geo-params-sphere" class="hidden mt-2"><label class="label !mb-1">Radius</label><input type="number" id="geo-sphere-radius" value="0.1" step="0.01"></div>
                      <div id="geo-params-cylinder" class="hidden grid grid-cols-2 gap-2 mt-2">
                        <div><label class="label !mb-1">Radius</label><input type="number" id="geo-cylinder-radius" value="0.05" step="0.01"></div>
                        <div><label class="label !mb-1">Length</label><input type="number" id="geo-cylinder-length" value="1.2" step="0.1"></div>
                    </div>
                    <div id="geo-params-ring" class="hidden grid grid-cols-2 gap-2">
                        <div><label class="label !mb-1">Inner Radius</label><input type="number" id="geo-ring-radius-in" value="0" step="0.01"></div>
                        <div><label class="label !mb-1">Outer Radius</label><input type="number" id="geo-ring-radius-out" value="0.05" step="0.01"></div>
                    </div>
                </div>

                <div id="params-light" class="light-param-section space-y-3">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Emission (W/sr/m²)</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label for="light-rgb-r" class="label !mb-1">Red</label><input type="number" id="light-rgb-r" value="100"></div>
                        <div><label for="light-rgb-g" class="label !mb-1">Green</label><input type="number" id="light-rgb-g" value="100"></div>
                        <div><label for="light-rgb-b" class="label !mb-1">Blue</label><input type="number" id="light-rgb-b" value="100"></div>
                    </div>
                </div>

                <div id="params-spotlight" class="light-param-section hidden space-y-3">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Emission (W/sr/m²)</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label for="spot-rgb-r" class="label !mb-1">Red</label><input type="number" id="spot-rgb-r" value="1000"></div>
                        <div><label for="spot-rgb-g" class="label !mb-1">Green</label><input type="number" id="spot-rgb-g" value="950"></div>
                        <div><label for="spot-rgb-b" class="label !mb-1">Blue</label><input type="number" id="spot-rgb-b" value="800"></div>
                    </div>
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Directionality</h4>
                    <div><label for="spot-cone-angle" class="label !mb-1">Cone Angle (°)</label><input type="number" id="spot-cone-angle" value="45">
                  </div>
                <div>
                    <label class="label !mb-1">Direction Vector (dx, dy, dz)<span class="info-icon">i<span class="info-popover">The vector's direction aims the light. Its length creates a 'focal length' effect (1/(r+e)² falloff). Use Normalize to disable this for a standard 1/r² falloff.</span></span></label>
                    <div class="grid grid-cols-3 gap-2"><input type="number" id="spot-dir-x" value="0" step="0.1"><input type="number" id="spot-dir-y" value="0" step="0.1"><input type="number" id="spot-dir-z" value="-1" step="0.1"></div>
                    <label for="spot-normalize-toggle" class="flex items-center cursor-pointer mt-3"><input type="checkbox" id="spot-normalize-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Normalize Vector</span></label>
                </div>
            </div>

                <div id="params-glow" class="light-param-section hidden space-y-3">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Emission (W/sr/m²)</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label for="glow-rgb-r" class="label !mb-1">Red</label><input type="number" id="glow-rgb-r" value="10"></div>
                        <div><label for="glow-rgb-g" class="label !mb-1">Green</label><input type="number" id="glow-rgb-g" value="0"></div>
                        <div><label for="glow-rgb-b" class="label !mb-1">Blue</label><input type="number" id="glow-rgb-b" value="0"></div>
                    </div>
                    <div>
                        <label for="glow-behavior" class="label !mb-1">Calculation Behavior<span class="info-icon">i<span class="info-popover">Controls how/if this source contributes to scene lighting, useful for managing performance.</span></span></label>
                        <select id="glow-behavior" class="w-full"><option value="-1" selected>Visible Only (Cosmetic)</option><option value="0">Indirect Light Only</option><option value="positive">Localized Direct Light</option></select>
                    </div>
                    <div id="glow-radius-input-container" class="hidden"><label for="glow-max-radius" class="label !mb-1">Direct Light Radius</label><input type="number" id="glow-max-radius" value="1.0" step="0.1" min="0.01"></div>
                </div>

                <div id="params-illum" class="light-param-section hidden space-y-3">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Emission (W/sr/m²)</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label for="illum-rgb-r" class="label !mb-1">Red</label><input type="number" id="illum-rgb-r" value="15"></div>
                        <div><label for="illum-rgb-g" class="label !mb-1">Green</label><input type="number" id="illum-rgb-g" value="15.5"></div>
                        <div><label for="illum-rgb-b" class="label !mb-1">Blue</label><input type="number" id="illum-rgb-b" value="16"></div>
                    </div>
                    <div><label for="illum-alt-material" class="label !mb-1">Alternate Material (Appearance)</label><select id="illum-alt-material" class="w-full"><option value="" disabled selected>Select an appearance material...</option><option value="diffuser_appearance">diffuser_appearance (example)</option></select></div>
                </div>

                <div id="params-ies" class="light-param-section hidden space-y-3">
                    <div><label for="ies-file-input" class="label">IES File (.ies)</label><input type="file" id="ies-file-input" accept=".ies" class="w-full text-sm"></div>
                    <div id="ies-photometry-viewer" class="hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] mb-2">IES Photometry Viewer</h4>
                        <div id="ies-info-display" class="grid grid-cols-3 gap-2 text-center p-2 rounded bg-[--grid-color] mb-3">
                            <div><span class="block text-xs">Total Lumens</span><span id="ies-lumens-val" class="data-value font-mono">--</span></div>
                            <div><span class="block text-xs">Wattage (W)</span><span id="ies-wattage-val" class="data-value font-mono">--</span></div>
                            <div><span class="block text-xs">Efficacy (lm/W)</span><span id="ies-efficacy-val" class="data-value font-mono">--</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="relative aspect-square bg-[--grid-color] rounded p-1">
                                <h5 class="absolute top-1 left-2 text-xs font-semibold text-[--text-secondary]">2D Polar Plot (C0)</h5>
                                <canvas id="ies-polar-plot-canvas"></canvas>
                            </div>
                            <div id="ies-3d-viewer-container" class="relative aspect-square bg-[--grid-color] rounded cursor-move">
                                <h5 class="absolute top-1 left-2 text-xs font-semibold text-[--text-secondary] z-10">3D Photometric Web</h5>
                            </div>
                        </div>
                    </div>
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">ies2rad Options</h4>
                    <div>
                        <label for="ies-units" class="label !mb-1">Geometry Units (-d)</label>
                        <select id="ies-units" class="w-full"><option value="m" selected>Meters (m)</option><option value="f">Feet (f)</option><option value="i">Inches (i)</option><option value="c">Centimeters (c)</option></select>
                    </div>
                    <div><label for="ies-multiplier" class="label !mb-1">Multiplier (-m)<span class="info-icon">i<span class="info-popover">Applies a scaling factor. Primarily used for a Light Loss Factor (LLF) to account for depreciation (e.g., 0.85 for 15% loss).</span></span></label><input type="number" id="ies-multiplier" value="1.0" step="0.01"></div>
                    <div><label for="ies-lamp-type" class="label !mb-1">Lamp Type (-t)</label><input type="text" id="ies-lamp-type" placeholder="e.g., F32T8/SP35"></div>
                    <label for="ies-force-color-toggle" class="flex items-center cursor-pointer pt-2"><input type="checkbox" id="ies-force-color-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Override with Custom Color (-t default)<span class="info-icon">i<span class="info-popover">Recommended for color consistency. Ignores color from the IES file and uses the RGB values below.</span></span></span></label>
                    <div id="ies-color-override-inputs">
                        <label class="label !mb-1">Color Override (-c)</label>
                        <div class="grid grid-cols-3 gap-2"><input type="number" id="ies-color-r" value="1" step="0.01"><input type="number" id="ies-color-g" value="1" step="0.01"><input type="number" id="ies-color-b" value="1" step="0.01"></div>
                    </div>
                </div>

                <div class="param-section">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Placement<span class="info-icon">i<span class="info-popover">Transformations are applied in a fixed order (rotate, then translate). For predictable results, always set rotation before position.</span></span></h4>
                    <div class="btn-group mt-1"><button id="placement-mode-individual" class="btn active">Individual</button><button id="placement-mode-grid" class="btn">Grid</button></div>
                    <div class="mt-3"><label class="label !mb-1">Position (X, Y, Z)</label><div class="grid grid-cols-3 gap-2"><input type="number" id="light-pos-x" value="1.7" step="0.1"><input type="number" id="light-pos-y" value="2.7" step="0.1"><input type="number" id="light-pos-z" value="2.8" step="0.1"></div></div>
                    <div class="mt-3"><label class="label !mb-1">Rotation (°)</label><div class="grid grid-cols-3 gap-2"><input type="number" id="light-rot-x" value="-90" step="1"><input type="number" id="light-rot-y" value="0" step="1"><input type="number" id="light-rot-z" value="0" step="1"></div></div>
                    <div id="grid-layout-inputs" class="hidden mt-3 space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div><label for="grid-rows" class="label !mb-1">Rows</label><input type="number" id="grid-rows" value="4" min="1"></div>
                            <div><label for="grid-cols" class="label !mb-1">Columns</label><input type="number" id="grid-cols" value="5" min="1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label for="grid-row-spacing" class="label !mb-1">Row Spacing</label><input type="number" id="grid-row-spacing" value="1.5" step="0.1"></div>
                            <div><label for="grid-col-spacing" class="label !mb-1">Col Spacing</label><input type="number" id="grid-col-spacing" value="2.0" step="0.1"></div>
                        </div>
                    </div>
              </div>
          </div>

        <div class="param-section pt-4 mt-4 border-t border-[--grid-color]">
            <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Availability & Controls</h4>
            <div>
                <label for="daylighting-availability-schedule" class="label">Availability Schedule (.csv) (Optional)</label>
                <input type="file" id="daylighting-availability-schedule" accept=".csv" class="w-full text-sm">
            </div>
        </div>

        <div id="lighting-power-section" class="param-section pt-4 mt-4 border-t border-[--grid-color]">
            <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Power & Energy</h4>
            <div class="grid grid-cols-2 gap-4 mt-3">
                    <div>
                        <label for="luminaire-wattage" class="label text-xs">Luminaire Power (Watts)</label>
                        <input type="number" id="luminaire-wattage" value="35" min="0" step="1" class="w-full mt-1">
                    </div>
                    <div>
                        <label class="label text-xs">Lighting Power Density</label>
                        <div id="lpd-display" class="data-value font-mono text-lg mt-1">-- W/m²</div>
                    </div>
              </div>
          </div>

          <div id="lighting-spec-section" class="param-section pt-4 mt-4 border-t border-[--grid-color]">
              <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">EN 12464-1 Specification</h4>
              <p class="info-box !text-xs !py-2 !px-3">Define compliance parameters. These values are used by EN 12464-1 recipes and for documentation.</p>
                  <div class="mt-3">
                      <label class="label text-xs flex justify-between" for="maintenance-factor">
                          <span>Maintenance Factor (MF)</span>
                          <span id="maintenance-factor-val" class="data-value font-mono">0.80</span>
                      </label>
                      <input type="range" id="maintenance-factor" min="0.1" max="1.0" value="0.8" step="0.01">
                  </div>
                  <div class="grid grid-cols-2 gap-4 mt-3">
                      <div><label for="light-source-ra" class="label text-xs">Color Rendering ($R_a$)</label><input type="number" id="light-source-ra" value="80" min="0" step="1"></div>
                      <div><label for="light-source-tcp" class="label text-xs">Color Temperature (TCP)</label><input type="number" id="light-source-tcp" value="4000" min="0" step="100"></div>
                  </div>
              </div>

                <div class="param-section pt-4 mt-4 border-t border-[--grid-color]">
                    <label for="daylighting-enabled-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="daylighting-enabled-toggle">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Enable Daylighting Controls</span>
                    </label>
                </div>

                <div id="daylighting-controls-wrapper" class="hidden space-y-5 border-t border-dashed border-[--grid-color] pt-5">
                <div class="param-section !pt-0 !mt-0 !border-none">
                    <label for="daylighting-visualize-zones-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="daylighting-visualize-zones-toggle">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Visualize Control Zones</span>
                    </label>
                </div>
              <div class="param-section !pt-0 !mt-0 !border-none space-y-4">
                  <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Control Logic</h4>
                  <div>
                      <label for="daylighting-control-type" class="label">Lighting Control Type</label>
                          <select id="daylighting-control-type" class="w-full">
                              <option value="Continuous">Continuous</option>
                              <option value="Stepped">Stepped</option>
                              <option value="ContinuousOff">Continuous/Off</option>
                          </select>
                      </div>
                      <div>
                          <label for="daylighting-setpoint" class="label">Illuminance Setpoint (lux)</label>
                          <input type="number" id="daylighting-setpoint" value="500" min="0" step="10">
                      </div>
                      <div id="daylight-continuous-params" class="space-y-3">
                          <div><label class="label text-xs flex justify-between" for="daylighting-min-power-frac"><span>Min Input Power Fraction</span><span id="daylighting-min-power-frac-val" class="data-value font-mono">0.30</span></label><input type="range" id="daylighting-min-power-frac" min="0" max="1" value="0.3" step="0.01"></div>
                          <div><label class="label text-xs flex justify-between" for="daylighting-min-light-frac"><span>Min Light Output Fraction</span><span id="daylighting-min-light-frac-val" class="data-value font-mono">0.20</span></label><input type="range" id="daylighting-min-light-frac" min="0" max="1" value="0.2" step="0.01"></div>
                      </div>
                      <div id="daylight-stepped-params" class="hidden space-y-3">
                          <div><label for="daylighting-steps" class="label">Number of Steps (Excl. Off)</label><input type="number" id="daylighting-steps" value="3" min="1" step="1"></div>
                      </div>
                      </div>
                  <div class="param-section pt-4 mt-4 border-t border-dashed border-[--grid-color] space-y-4">
                      <h4 id="daylight-sensor-placement-header" class="font-semibold text-xs uppercase text-[--text-secondary]">Control Sensor Placement</h4>
                      <p class="info-box !text-xs !py-2 !px-3">Define the location and properties for the daylighting sensor(s).</p>
                      <div>
                          <label class="label text-xs" for="daylight-sensor-count">Number of Sensors</label>
                          <select id="daylight-sensor-count" class="w-full mt-1">
                              <option value="1" selected>1</option>
                              <option value="2">2</option>
                          </select>
                      </div>

                      <div id="daylight-sensor-controls-container">
                      <div id="daylighting-zoning-strategy-controls" class="hidden pb-3">
                          <label class="label text-xs">Zoning Strategy</label>
                          <div class="btn-group mt-1">
                              <button id="daylighting-zone-strategy-rows" class="btn active">Rows (Front/Back)</button>
                            <button id="daylighting-zone-strategy-cols" class="btn">Columns (Left/Right)</button>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                        <label class="label text-xs">Zone Visualizer</label>
                        <div id="daylighting-zone-visualizer-container" class="relative mt-2 aspect-video bg-[--grid-color] rounded overflow-hidden cursor-pointer">
                            <canvas id="daylighting-zone-canvas"></canvas>
                        </div>
                    </div>
                    <div id="daylight-sensor-1-controls" class="space-y-3 pt-3 border-t border-dashed border-[--grid-color]">
                        <h5 class="font-semibold text-sm">Daylight Sensor 1</h5>
                        <div class="pt-2"><label for="daylight-sensor1-gizmo-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="daylight-sensor1-gizmo-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Show Placement Gizmo</span></label></div>
                              <div><label class="label text-xs" for="daylight-sensor1-x">Position X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-x" min="-10" max="10" value="0.0" step="0.1"><span id="daylight-sensor1-x-val" class="data-value font-mono w-12 text-left">0.0m</span></div></div>
                              <div><label class="label text-xs" for="daylight-sensor1-y">Position Y (Height)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-y" min="0" max="10" value="0.8" step="0.1"><span id="daylight-sensor1-y-val" class="data-value font-mono w-12 text-left">0.8m</span></div></div>
                              <div><label class="label text-xs" for="daylight-sensor1-z">Position Z (Depth)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-z" min="-10" max="10" value="0.0" step="0.1"><span id="daylight-sensor1-z-val" class="data-value font-mono w-12 text-left">0.0m</span></div></div>
                              <div class="pt-2"><label class="label text-xs">Direction Vector (Normal)</label>
                                  <div><label class="label text-xs">Direction X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-dir-x" min="-1" max="1" value="0" step="0.05"><span id="daylight-sensor1-dir-x-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                                  <div><label class="label text-xs">Direction Y</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-dir-y" min="-1" max="1" value="1" step="0.05"><span id="daylight-sensor1-dir-y-val" class="data-value font-mono w-12 text-left">1.00</span></div></div>
                                  <div><label class="label text-xs">Direction Z</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-dir-z" min="-1" max="1" value="0" step="0.05"><span id="daylight-sensor1-dir-z-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                              </div>
                              <div><label class="label text-xs">Fraction of Lights Controlled</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-percent" min="0" max="1" value="1.0" step="0.01" disabled><span id="daylight-sensor1-percent-val" class="data-value font-mono w-12 text-left">1.00</span></div></div>
                          </div>
                          <div id="daylight-sensor-2-controls" class="hidden space-y-3 pt-3 mt-4 border-t border-dashed border-[--grid-color]">
                              <h5 class="font-semibold text-sm">Daylight Sensor 2</h5>
                              <div class="pt-2"><label for="daylight-sensor2-gizmo-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="daylight-sensor2-gizmo-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Show Placement Gizmo</span></label></div>
                              <div><label class="label text-xs" for="daylight-sensor2-x">Position X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-x" min="-10" max="10" value="0.0" step="0.1"><span id="daylight-sensor2-x-val" class="data-value font-mono w-12 text-left">0.0m</span></div></div>
                              <div><label class="label text-xs" for="daylight-sensor2-y">Position Y (Height)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-y" min="0" max="10" value="0.8" step="0.1"><span id="daylight-sensor2-y-val" class="data-value font-mono w-12 text-left">0.8m</span></div></div>
                              <div><label class="label text-xs" for="daylight-sensor2-z">Position Z (Depth)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-z" min="-10" max="10" value="1.8" step="0.1"><span id="daylight-sensor2-z-val" class="data-value font-mono w-12 text-left">1.8m</span></div></div>
                              <div class="pt-2"><label class="label text-xs">Direction Vector (Normal)</label>
                                  <div><label class="label text-xs">Direction X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-dir-x" min="-1" max="1" value="0" step="0.05"><span id="daylight-sensor2-dir-x-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                                  <div><label class="label text-xs">Direction Y</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-dir-y" min="-1" max="1" value="1" step="0.05"><span id="daylight-sensor2-dir-y-val" class="data-value font-mono w-12 text-left">1.00</span></div></div>
                                  <div><label class="label text-xs">Direction Z</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-dir-z" min="-1" max="1" value="0" step="0.05"><span id="daylight-sensor2-dir-z-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                              </div>
                              <div><label class="label text-xs">Fraction of Lights Controlled</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-percent" min="0" max="1" value="0.5" step="0.01"><span id="daylight-sensor2-percent-val" class="data-value font-mono w-12 text-left">0.50</span></div></div>
                          </div>
                      </div>
                  </div>
              </div>
        </div>
          <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
      </div>

      <div id="panel-materials" class="floating-window ui-panel hidden">
          <div class="window-header">
                <span>Material Properties</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
           <div class="window-content space-y-5">
                <div class="space-y-3"><h3 class="font-semibold text-sm uppercase">Walls</h3>
                    <div><label class="label text-xs">Material Type</label><select id="wall-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div>
                    <div>
                        <label class="label text-xs">Reflectance Mode</label>
                        <div class="btn-group mt-1">
                            <button id="wall-mode-refl" class="btn active" data-mode="refl">Simple</button>
                            <button id="wall-mode-srd" class="btn" data-mode="srd">Spectral</button>
                        </div>
                    </div>
                <div id="wall-refl-controls">
                    <label class="label text-xs !mb-0" for="wall-refl">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wall-refl" min="0" max="1" value="0.5" step="0.01"><span id="wall-refl-val" class="data-value font-mono w-12 text-left">0.50</span></div>
                </div>
                <div id="wall-srd-controls" class="hidden">
                    <label for="wall-srd-file" class="label text-xs">Spectral Reflectance File (.dat)</label><input type="file" id="wall-srd-file" accept=".dat,.txt" class="w-full text-sm">
                </div>
                <div><label class="label text-xs" for="wall-spec">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wall-spec" min="0" max="1" value="0.00" step="0.01"><span id="wall-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                <div><label class="label text-xs" for="wall-rough">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wall-rough" min="0" max="1" value="0.00" step="0.01"><span id="wall-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
            </div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]"><h3 class="font-semibold text-sm uppercase">Floor</h3>
                    <div><label class="label text-xs">Material Type</label><select id="floor-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div>
                    <div>
                        <label class="label text-xs">Reflectance Mode</label>
                        <div class="btn-group mt-1">
                            <button id="floor-mode-refl" class="btn active" data-mode="refl">Simple</button>
                            <button id="floor-mode-srd" class="btn" data-mode="srd">Spectral</button>
                        </div>
                    </div>
                    <div id="floor-refl-controls">
                        <label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-refl" min="0" max="1" value="0.2" step="0.01"><span id="floor-refl-val" class="data-value font-mono w-12 text-left">0.20</span></div>
                    </div>
                    <div id="floor-srd-controls" class="hidden">
                        <label for="floor-srd-file" class="label text-xs">Spectral Reflectance File (.dat)</label><input type="file" id="floor-srd-file" accept=".dat,.txt" class="w-full text-sm">
                    </div>
                    <div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-spec" min="0" max="1" value="0.00" step="0.01"><span id="floor-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div><div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-rough" min="0" max="1" value="0.00" step="0.01"><span id="floor-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                </div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]"><h3 class="font-semibold text-sm uppercase">Ceiling</h3>
                    <div><label class="label text-xs">Material Type</label><select id="ceiling-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div>
                    <div>
                        <label class="label text-xs">Reflectance Mode</label>
                        <div class="btn-group mt-1">
                            <button id="ceiling-mode-refl" class="btn active" data-mode="refl">Simple</button>
                            <button id="ceiling-mode-srd" class="btn" data-mode="srd">Spectral</button>
                        </div>
                    </div>
                    <div id="ceiling-refl-controls">
                        <label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="ceiling-refl" min="0" max="1" value="0.8" step="0.01"><span id="ceiling-refl-val" class="data-value font-mono w-12 text-left">0.80</span></div>
                    </div>
                    <div id="ceiling-srd-controls" class="hidden">
                        <label for="ceiling-srd-file" class="label text-xs">Spectral Reflectance File (.dat)</label><input type="file" id="ceiling-srd-file" accept=".dat,.txt" class="w-full text-sm">
                    </div>
                    <div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="ceiling-spec" min="0" max="1" value="0.00" step="0.01"><span id="ceiling-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div><div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="ceiling-rough" min="0" max="1" value="0.00" step="0.01"><span id="ceiling-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                </div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                    <h3 class="font-semibold text-sm uppercase">Frame</h3><div><label class="label text-xs">Material Type</label><select id="frame-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div><label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-refl" min="0" max="1" value="0.1" step="0.01"><span id="frame-refl-val" class="data-value font-mono w-12 text-left">0.10</span></div><div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-spec" min="0" max="1" value="0.00" step="0.01"><span id="frame-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div><div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-rough" min="0" max="1" value="0.00" step="0.01"><span id="frame-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div></div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                    <h3 class="font-semibold text-sm uppercase">Shading</h3><div>
                        <label class="label text-xs">Material Type</label>
                        <select id="shading-mat-type" class="w-full mt-1">
                            <option selected>Plastic</option><option>Glass</option>
                            <option>Metal</option>
                        </select>
                </div>
                <div>
                    <label class="label text-xs !mb-0">Reflectance</label>
                    <div class="flex items-center space-x-3 mt-1"><input type="range" id="shading-refl" min="0" max="1" value="0.5" step="0.01"><span id="shading-refl-val" class="data-value font-mono w-12 text-left">0.50</span></div>
                </div>
                <div>
                    <label class="label text-xs">Specularity</label>
                    <div class="flex items-center space-x-3 mt-1"><input type="range" id="shading-spec" min="0" max="1" value="0.00" step="0.01"><span id="shading-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div>
                </div>
                <div>
                    <label class="label text-xs">Roughness</label>
                    <div class="flex items-center space-x-3 mt-1"><input type="range" id="shading-rough" min="0" max="1" value="0.00" step="0.01"><span id="shading-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div>
                </div>
            </div>
        <div class="space-y-3 pt-4 border-t border-[--grid-color]">
            <h3 class="font-semibold text-sm uppercase">Glazing</h3>
            <div>
                <label class="label text-xs">Transmittance</label>
                    <div class="flex items-center space-x-3 mt-1">
                        <input type="range" id="glazing-trans" min="0" max="1" value="0.7" step="0.01">
                        <span id="glazing-trans-val" class="data-value font-mono w-12 text-left">0.70</span>
                    </div>
                </div>
                <label for="bsdf-toggle" class="flex items-center cursor-pointer pt-2">
                    <input type="checkbox" id="bsdf-toggle">
                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Add BSDF</span>
                </label>
                <div id="bsdf-controls" class="hidden mt-2">
                    <label for="bsdf-file" class="label text-xs">BSDF XML File</label>
                    <input type="file" id="bsdf-file" accept=".xml" class="w-full text-sm mt-1">
                    <button id="view-bsdf-btn" class="btn btn-secondary w-full mt-2 hidden">View BSDF</button>
                </div>
            </div>
            <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                <h3 class="font-semibold text-sm uppercase">Furniture</h3>
                <div><label class="label text-xs">Material Type</label><select id="furniture-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Metal</option></select></div>
                <label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="furniture-refl" min="0" max="1" value="0.3" step="0.01"><span id="furniture-refl-val" class="data-value font-mono w-12 text-left">0.30</span></div>
                <div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="furniture-spec" min="0" max="1" value="0.05" step="0.01"><span id="furniture-spec-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                <div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="furniture-rough" min="0" max="1" value="0.1" step="0.01"><span id="furniture-rough-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
            </div>
        </div> <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
</div>

<div id="panel-sensor" class="floating-window ui-panel hidden">
            <div class="window-header">
                <span>Sensor Grid</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content space-y-5">
                <div class="space-y-3">
                    <label for="illuminance-grid-toggle" class="flex items-center cursor-pointer w-full">
                        <input type="checkbox" id="illuminance-grid-toggle" checked>
                        <span class="ml-3 font-semibold text-sm uppercase">Illuminance Grid</span>
                    </label>
                    <div id="illuminance-grid-controls" class="space-y-5 pt-4 border-t border-[--grid-color]">
                        <div class="space-y-3">
                            <h3 class="font-semibold text-sm uppercase">Surface Selection</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <label for="grid-floor-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-floor-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Floor</span></label>
                                <label for="grid-ceiling-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-ceiling-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Ceiling</span></label>
                                <label for="grid-north-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-north-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">North Wall</span></label>
                                <label for="grid-south-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-south-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">South Wall</span></label>
                                <label for="grid-east-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-east-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">East Wall</span></label>
                                <label for="grid-west-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-west-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">West Wall</span></label>
                            </div>
                        </div>
                        <div id="floor-grid-controls" class="space-y-3 pt-4 border-t border-[--grid-color]">
                            <h3 class="font-semibold text-sm uppercase">Floor Grid</h3>
                            <div class="pt-2">
                                <label for="show-floor-grid-3d-toggle" class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="show-floor-grid-3d-toggle">
                                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Show in 3D View</span>
                                </label>
                            </div>
                            <div><label class="label" for="floor-grid-spacing">Spacing (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-grid-spacing" min="0.05" max="2.0" value="0.50" step="0.05"><span id="floor-grid-spacing-val" class="data-value font-mono w-12 text-left">0.50m</span></div></div>
                            <div><label class="label" for="floor-grid-offset">Height Offset (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-grid-offset" min="0" max="10" value="0.8" step="0.05"><span id="floor-grid-offset-val" class="data-value font-mono w-12 text-left">0.8m</span></div></div>
                            <div class="pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">EN 12464-1 Specification</h4>
                                <p class="info-box !text-xs !py-2 !px-3">Define Task Area parameters. These values are used by EN 12464-1 recipes and for documentation.</p>
                            </div>
                            <div class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <label for="task-area-toggle" class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="task-area-toggle">
                                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Define Specific Task Area</span>
                                </label>
                                <div id="task-area-controls" class="hidden space-y-3 pl-4">
                                    <div><label class="label text-xs" for="task-area-start-x">Start X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="task-area-start-x" min="0" max="20" value="0.5" step="0.1"><span id="task-area-start-x-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                                    <div><label class="label text-xs" for="task-area-start-z">Start Z</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="task-area-start-z" min="0" max="20" value="0.5" step="0.1"><span id="task-area-start-z-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                                    <div><label class="label text-xs" for="task-area-width">Width</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="task-area-width" min="0.5" max="20" value="2.0" step="0.1"><span id="task-area-width-val" class="data-value font-mono w-12 text-left">2.0m</span></div></div>
                                    <div><label class="label text-xs" for="task-area-depth">Depth</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="task-area-depth" min="0.5" max="20" value="1.0" step="0.1"><span id="task-area-depth-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                                    <div class="mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                        <label class="label text-xs">Task Area Visualizer</label>
                                        <div id="task-area-visualizer-container" class="relative mt-2 aspect-video bg-[--grid-color] rounded overflow-hidden cursor-move">
                                            <canvas id="task-area-canvas"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <label for="surrounding-area-toggle" class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="surrounding-area-toggle" disabled>
                                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Include Surrounding Area</span>
                                </label>
                                <div id="surrounding-area-controls" class="hidden space-y-3 pl-4">
                                    <div><label class="label text-xs">Band Width</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="surrounding-area-width" min="0.1" max="2.0" value="0.5" step="0.1"><span id="surrounding-area-width-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                                </div>
                            </div>
                        </div>
                        <div id="ceiling-grid-controls" class="hidden space-y-3 pt-4 border-t border-[--grid-color]">
                            <h3 class="font-semibold text-sm uppercase">Ceiling Grid</h3>
                            <div>
                                <label class="label" for="ceiling-grid-spacing">Spacing (m)</label>
                                <div class="flex items-center space-x-3 mt-1">
                                    <input type="range" id="ceiling-grid-spacing" min="0.05" max="2.0" value="0.50" step="0.05">
                                    <span id="ceiling-grid-spacing-val" class="data-value font-mono w-12 text-left">0.50m</span>
                                </div>
                            </div>
                            <div>
                                <label class="label" for="ceiling-grid-offset">Offset from Ceiling (m)</label>
                                <div class="flex items-center space-x-3 mt-1">
                                    <input type="range" id="ceiling-grid-offset" min="-1.0" max="0" value="-0.2" step="0.05">
                                    <span id="ceiling-grid-offset-val" class="data-value font-mono w-12 text-left">-0.2m</span>
                                </div>
                            </div>
                        </div>
                        <div id="wall-grid-controls" class="hidden space-y-3 pt-4 border-t border-[--grid-color]">
                            <h3 class="font-semibold text-sm uppercase">Wall Grids</h3>
                            <div>
                                <label class="label" for="wall-grid-spacing">Spacing (m)</label>
                                <div class="flex items-center space-x-3 mt-1">
                                    <input type="range" id="wall-grid-spacing" min="0.05" max="2.0" value="0.50" step="0.05">
                                    <span id="wall-grid-spacing-val" class="data-value font-mono w-12 text-left">0.50m</span>
                                </div>
                            </div>
                            <div>
                                <label class="label" for="wall-grid-offset">Wall Offset (m)</label>
                                <div class="flex items-center space-x-3 mt-1">
                                    <input type="range" id="wall-grid-offset" min="0.05" max="1.0" value="0.1" step="0.05">
                                    <span id="wall-grid-offset-val" class="data-value font-mono w-12 text-left">0.1m</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                    <label for="view-grid-toggle" class="flex items-center cursor-pointer w-full">
                        <input type="checkbox" id="view-grid-toggle">
                        <span class="ml-3 font-semibold text-sm uppercase">View Grid (for Glare)</span>
                    </label>
                    <div id="view-grid-controls" class="hidden space-y-5 pt-4 border-t border-[--grid-color]">
                        <p class="info-box !text-xs !py-2 !px-3">Generates a .ray file for imageless glare analysis with points on a horizontal plane.</p>
                        <div class="pt-2">
                            <label for="show-view-grid-3d-toggle" class="flex items-center cursor-pointer">
                                <input type="checkbox" id="show-view-grid-3d-toggle">
                                <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Show in 3D View</span>
                            </label>
                        </div>
                        <div><label class="label" for="view-grid-spacing">Spacing (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="view-grid-spacing" min="0.05" max="2.0" value="0.75" step="0.05"><span id="view-grid-spacing-val" class="data-value font-mono w-12 text-left">0.75m</span></div></div>
                        <div><label class="label" for="view-grid-offset">Height Offset (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="view-grid-offset" min="0" max="10" value="1.2" step="0.1"><span id="view-grid-offset-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                        <div class="pt-4 border-t border-dashed border-[--grid-color] space-y-3">
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">View Directions</h4>
                            <div><label class="label" for="view-grid-directions">Number of Directions</label><input type="number" id="view-grid-directions" min="1" value="6" step="1" class="w-full mt-1"></div>
                            <div>
                                <label class="label !mb-1">Starting Vector (X, Y, Z)</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <input type="number" id="view-grid-start-vec-x" value="1" step="0.1">
                                    <input type="number" id="view-grid-start-vec-y" value="0" step="0.1">
                                    <input type="number" id="view-grid-start-vec-z" value="0" step="0.1">
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

    <div id="panel-viewpoint" class="floating-window ui-panel hidden">
        <div class="window-header">
            <span>Viewpoint</span>
            <div class="window-controls">
                <div class="window-icon-max"></div>
                <div class="collapse-icon"></div>
                <div class="window-icon-close"></div>
            </div>
        </div>
        <div class="window-content space-y-5">
            <div>
                <label class="label" for="view-type">View Type</label>
                <select id="view-type" class="w-full mt-1">
                    <option value="v" selected>Perspective</option>
                    <option value="h">Fisheye</option>
                    <option value="c">Cylindrical</option>
                    <option value="l">Parallel</option>
                    <option value="a">Angular Fisheye</option>
                </select>
            </div>
            <div class="pt-2">
                <button id="fpv-toggle-btn" class="btn btn-primary w-full">
                    <span>Enter Viewpoint</span>
                </button>
            </div>
            <div class="pt-2">
            <label for="gizmo-toggle" class="flex items-center cursor-pointer">
                <input type="checkbox" id="gizmo-toggle">
                <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Show Viewpoint Camera</span>
            </label>
        </div>
        <div class="space-y-3 pt-4 border-t border-[--grid-color]">
        <h3 class="font-semibold text-sm uppercase">Saved Views</h3>
            <button id="save-view-btn" class="btn btn-secondary w-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Save Current View</span>
            </button>
                <div id="saved-views-list" class="mt-4 space-y-2 max-h-48 overflow-y-auto">
                </div>
            </div>
        <div class="border-t border-[--grid-color] pt-4 space-y-4">
            <h3 class="font-bold text-xs uppercase text-[--text-secondary]">Position (vp)</h3>
                <div>
                    <label class="label text-xs">X</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="view-pos-x" min="0" max="20" value="1.1" step="0.1">
                        <span id="view-pos-x-val" class="data-value font-mono w-12 text-left">1.1m</span>
                    </div>
                </div>
                <div>
                    <label class="label text-xs">Y (Height)</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="view-pos-y" min="0" max="10" value="1.2" step="0.1">
                        <span id="view-pos-y-val" class="data-value font-mono w-12 text-left">1.2m</span>
                    </div>
                </div>
                <div>
                    <label class="label text-xs">Z</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="view-pos-z" min="0" max="20" value="1.4" step="0.1">
                        <span id="view-pos-z-val" class="data-value font-mono w-12 text-left">1.4m</span>
                    </div>
                </div>
        </div>
        <div class="border-t border-[--grid-color] pt-4 space-y-4">
            <h3 class="font-bold text-xs uppercase text-[--text-secondary]">Direction (vd)</h3>
            <div>
                <label class="label text-xs">X</label>
                <div class="flex items-center space-x-4 mt-1">
                    <input type="range" id="view-dir-x" min="-1" max="1" value="0.5" step="0.01">
                    <span id="view-dir-x-val" class="data-value font-mono w-12 text-left">0.50</span>
                </div>
            </div>
            <div>
                <label class="label text-xs">Y (Height)</label>
                <div class="flex items-center space-x-4 mt-1">
                    <input type="range" id="view-dir-y" min="-1" max="1" value="0" step="0.01">
                    <span id="view-dir-y-val" class="data-value font-mono w-12 text-left">0.00</span>
                </div>
            </div>
            <div>
                <label class="label text-xs">Z</label>
                <div class="flex items-center space-x-4 mt-1">
                    <input type="range" id="view-dir-z" min="-1" max="1" value="0.5" step="0.01">
                    <span id="view-dir-z-val" class="data-value font-mono w-12 text-left">0.50</span>
                </div>
            </div>
        </div>

        <div class="border-t border-[--grid-color] pt-4 space-y-4">
            <div>
                <div>
                    <label class="label mt-2">Field of View</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="view-fov" min="10" max="180" value="60" step="1">
                        <span id="view-fov-val" class="data-value font-mono w-12 text-center">30°</span>
                    </div>
                </div>
                <div>
                    <label class="label mt-2">View Distance</label>
                    <div class="flex items-center space-x-4 mt-1">
                                  <input type="range" id="view-dist" min="1" max="50" value="5" step="0.1">
                                  <span id="view-dist-val" class="data-value font-mono w-12 text-left">5.0m</span>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="border-t border-[--grid-color] pt-4 space-y-4">
                    <h3 class="font-bold text-xs uppercase text-[--text-secondary]">Section Views</h3>
                    <div>
                        <label for="h-section-toggle" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="h-section-toggle">
                            <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Horizontal Section</span>
                        </label>
                        <div id="h-section-controls" class="hidden">
                            <label class="label text-xs">Section Height</label>
                            <div class="flex items-center space-x-3 mt-1">
                                <input type="range" id="h-section-dist" min="0" max="3" value="1.5" step="0.1">
                                <span id="h-section-dist-val" class="data-value font-mono w-12 text-left">1.5m</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-dashed border-[--grid-color]">
                        <label for="v-section-toggle" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="v-section-toggle">
                            <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Vertical Section</span>
                        </label>
                        <div id="v-section-controls" class="hidden">
                            <label class="label text-xs">Section Position (from West)</label>
                            <div class="flex items-center space-x-3 mt-1">
                                <input type="range" id="v-section-dist" min="0" max="4" value="2.0" step="0.1">
                                <span id="v-section-dist-val" class="data-value font-mono w-12 text-left">2.0m</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

        <div id="panel-scene-elements" class="floating-window ui-panel hidden">
            <div class="window-header">
                <span>Scene Elements</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content space-y-5">
                <div class="param-section">
                    <h3 class="font-semibold text-sm uppercase">Interior Furniture & Partitions</h3>
                    <p class="info-box !text-xs !py-2 !px-3">Drag assets into the 3D scene. Select an object to transform it.</p>
                    <div id="asset-library" class="grid grid-cols-4 gap-2 mt-4">
            <div class="asset-item" draggable="true" data-asset-type="desk" title="Desk">
                <div class="asset-icon"><svg viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M320.547 139.676c-17.421-.673-16.786-.83-38.428-.531-43.37.6-84.987 1.594-129.012 1.594-18.369 0-58.946-1.467-74.107 0m23.662 7.956c-1.422 37.694-5.228 75.327-5.228 112.622M295.43 148.695c1.21 37.146 5.331 74.947 3.178 112.622" stroke="currentColor" stroke-opacity=".9" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <span class="asset-name">Desk</span>
            </div>
                <div class="asset-item" draggable="true" data-asset-type="chair" title="Chair">
            <div class="asset-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.334 279.334" fill="currentColor"><path d="M232.423 101.03h-20.497a6 6 0 0 0 0 12h4.429v31.517l-13.396 7.135c-3.289-4.313-8.479-7.053-14.139-7.053h-32.76v-16.088h20.107c5.563 0 10.744-2.214 14.59-6.233s5.828-9.294 5.582-14.851L192.44 19.3A20.156 20.156 0 0 0 172.267 0h-63.08a20.155 20.155 0 0 0-20.173 19.3l-3.899 88.156c-.246 5.557 1.736 10.832 5.582 14.851s9.027 6.233 14.59 6.233h20.107v16.088H90.595a17.76 17.76 0 0 0-14.366 7.325l-1.478-.787-11.771-6.269v-31.516h4.429a6 6 0 0 0 0-12H46.911a6 6 0 0 0 0 12h4.068V148.5a6 6 0 0 0 3.18 5.296l18.172 9.678-.839 4.529c-.965 5.205.422 10.523 3.807 14.593S83.66 189 88.954 189h33.159v11.667a6 6 0 0 0 6 6h6.712a6 6 0 0 0-.099 1.056v14.823c-23.277.46-46.396 3.589-68.808 9.333a6.005 6.005 0 0 0-4.511 5.816v12.942c-5.265 2.317-8.954 7.576-8.954 13.688 0 8.246 6.708 14.954 14.954 14.954 8.245 0 14.953-6.708 14.953-14.954 0-6.111-3.689-11.37-8.953-13.687v-8.251c20.025-4.786 40.604-7.411 61.318-7.837v16.171c-5.234 2.33-8.897 7.571-8.897 13.66 0 8.246 6.708 14.954 14.953 14.954 8.246 0 14.954-6.708 14.954-14.954 0-6.133-3.715-11.41-9.01-13.714V234.55c20.713.426 41.29 3.051 61.317 7.837v8.251c-5.264 2.317-8.953 7.576-8.953 13.687 0 8.246 6.708 14.954 14.954 14.954 8.245 0 14.953-6.708 14.953-14.954 0-6.112-3.689-11.371-8.954-13.688v-12.791a6 6 0 0 0-4.51-5.967c-22.414-5.744-45.532-8.872-68.808-9.332v-14.823a6 6 0 0 0-.099-1.056h6.711a6 6 0 0 0 6-6V189h31.395a17.68 17.68 0 0 0 13.821-6.607 17.68 17.68 0 0 0 3.537-14.906l-.959-4.433 18.042-9.609a6 6 0 0 0 3.18-5.296V113.03h4.068a6 6 0 0 0 .003-12M64.454 264.324a2.96 2.96 0 0 1 2.954-2.954c1.628 0 2.953 1.325 2.953 2.954s-1.325 2.954-2.953 2.954a2.957 2.957 0 0 1-2.954-2.954m146.637 0a2.96 2.96 0 0 1 2.954-2.954c1.628 0 2.953 1.325 2.953 2.954s-1.325 2.954-2.953 2.954a2.957 2.957 0 0 1-2.954-2.954m-70.309 3.01c-1.628 0-2.953-1.325-2.953-2.954s1.325-2.954 2.953-2.954c1.629 0 2.954 1.325 2.954 2.954s-1.325 2.954-2.954 2.954m6.557-72.667h-13.226V189h13.226zM88.954 177c-2.351 0-3.783-1.301-4.429-2.077-.645-.775-1.663-2.421-1.234-4.732l1.641-8.852a5.76 5.76 0 0 1 5.663-4.71h98.225a5.79 5.79 0 0 1 5.63 4.542l1.914 8.852c.369 1.71-.049 3.473-1.147 4.834S192.483 177 190.733 177zm10.413-62.988a8.12 8.12 0 0 1-2.265-6.025l3.899-88.156A8.177 8.177 0 0 1 109.186 12h63.08a8.177 8.177 0 0 1 8.185 7.83l3.899 88.156c.1 2.255-.704 4.395-2.265 6.025s-3.662 2.529-5.919 2.529h-70.881a8.12 8.12 0 0 1-5.918-2.528m44.693 14.529v16.088h-6.666v-16.088z"/></svg></div>
            <span class="asset-name">Chair</span>
        </div>
            <div class="asset-item" draggable="true" data-asset-type="partition" title="Partition">
            <div class="asset-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 320" xml:space="preserve" fill="currentColor"><path d="M273.507 0H46.495C21.896 0 1.882 20.21 1.882 45.051v229.897C1.882 299.79 21.896 320 46.495 320h227.012c24.599 0 44.611-20.21 44.611-45.052V45.051C318.118 20.21 298.105 0 273.507 0M95.943 224.689v-55.31H224.06v55.31zm138.755-75.309c-.212-.013-.423-.032-.638-.032s-.426.019-.638.032h-63.42V94.069h128.117v55.311zM95.943 74.069V20H224.06v54.069zm54.058 20v55.311H86.582c-.212-.013-.423-.032-.638-.032s-.426.019-.638.032H21.882V94.069zM21.882 169.38h54.062v55.31H21.882zm222.178 0h54.059v55.31H244.06zm54.058-124.329V74.07H244.06V20h29.447c13.57 0 24.611 11.237 24.611 25.051M46.495 20h29.448v54.069H21.882V45.051C21.882 31.237 32.923 20 46.495 20M21.882 274.948v-30.259h128.119V300H46.495c-13.572 0-24.613-11.238-24.613-25.052M273.507 300H170.001v-55.311h128.117v30.259c0 13.814-11.041 25.052-24.611 25.052"/></svg></div>
            <span class="asset-name">Partition</span>
        </div>
        <div class="asset-item" draggable="true" data-asset-type="custom-obj-furniture" title="Import Custom OBJ">
            <div class="asset-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 417.164 417.164" fill="currentColor"><path d="M409.664 279.579H351.95l7.013-69.75a7.5 7.5 0 0 0-7.462-8.251H339v-39h12.5a7.5 7.5 0 0 0 7.5-7.5v-26a7.5 7.5 0 0 0-15 0v18.5h-5v-29.5c0-12.407-10.093-22.5-22.5-22.5s-22.5 10.093-22.5 22.5v83.5h-12.5a7.5 7.5 0 0 0-7.462 8.251l7.013 69.75H225.7l9.505-4.482a7.5 7.5 0 0 0 3.585-9.982l-62.708-132.989a7.5 7.5 0 0 0-9.982-3.585l-29.1 13.72v-2.214a7.5 7.5 0 0 0-7.5-7.5H93v-5.969a7.5 7.5 0 0 0-7.5-7.5h-44a7.5 7.5 0 0 0-7.5 7.5v153.001H7.5a7.5 7.5 0 0 0-7.5 7.5v27.006a7.5 7.5 0 0 0 7.5 7.5h402.164a7.5 7.5 0 0 0 7.5-7.5v-27.006a7.5 7.5 0 0 0-7.5-7.5M309 118.079c0-4.136 3.365-7.5 7.5-7.5s7.5 3.364 7.5 7.5v83.5h-15zm-19.208 98.5h53.416l-6.334 63h-40.748zm-124.079-71.272 56.311 119.422-26.23 12.368-56.311-119.422zm14.667 134.272H137V187.58zM122 147.547v132.032H93V147.547zm-73-13.469h29v145.501H49zm353.164 172.507H15v-12.006h387.164z"/></svg></div>
            <span class="asset-name">Import OBJ</span>
        </div>
            </div>
                </div>
                <div class="param-section pt-4 border-t border-dashed border-[--grid-color]">
                <h3 class="font-semibold text-sm uppercase">Vegetation & Tree Modeling</h3>
                <p class="info-box !text-xs !py-2 !px-3">Drag vegetation assets onto your site. The canopy uses a 'trans' material in Radiance to simulate light filtering.</p>
                <div id="asset-library-vegetation" class="grid grid-cols-4 gap-2 mt-4">
                    <div class="asset-item" draggable="true" data-asset-type="tree-deciduous" title="Deciduous Tree">
                <div class="asset-icon"><svg viewBox="0 0 24 24" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg"><defs><style>.cls-1{fill:none;stroke:currentColor;stroke-miterlimit:10;stroke-width:1.91px}.cls-2{fill:currentColor;stroke:currentColor;stroke-miterlimit:10;stroke-width:1.91px}</style></defs><path class="cls-1" d="M12 5.32V22.5m3.82 0H8.18m.96-12.41L12 12"/><circle class="cls-2" cx="12" cy="8.18" r="6.68"/><path class="cls-1" d="M14.86 7.23 12 10.09"/></svg></div>
                <span class="asset-name">Tree</span>
            </div>
            <div class="asset-item" draggable="true" data-asset-type="tree-coniferous" title="Coniferous Tree">
                    <div class="asset-icon"><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 370 370" xml:space="preserve" fill="currentColor"><path d="M221.216 31.777C209.472 10.68 197.278 0 184.973 0h-.006c-12.191 0-24.309 10.722-36.013 31.747-31.026 55.734-50.181 166.609-27.263 203.571 13.299 21.447 34.021 28.994 49.278 31.507V342h-29.127c-4.415 0-7.873 3.454-7.873 7.863v12.295c0 4.397 3.458 7.842 7.873 7.842h87.092c4.506 0 8.036-3.444 8.036-7.842v-12.295c0-4.336-3.605-7.863-8.036-7.863H199.97v-75.26c20.734-3.578 37.881-14.645 48.278-31.413 22.965-37.035 3.934-147.923-27.032-203.55"/></svg></div>
                    <span class="asset-name">Pine</span>
                </div>
                <div class="asset-item" draggable="true" data-asset-type="bush" title="Bush">
        <div class="asset-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" xml:space="preserve" fill="currentColor"><path d="M331.824 368.38a20.44 20.44 0 0 0-15.463-7.073h-39.922v-94.944c-6.638 1.195-13.46 1.854-20.438 1.854s-13.8-.659-20.438-1.854v94.944h-39.922a20.436 20.436 0 0 0-20.222 23.396l16.067 109.819c1.469 10.038 10.077 17.48 20.222 17.48h88.585c10.144 0 18.754-7.441 20.222-17.48l16.067-109.819a20.43 20.43 0 0 0-4.758-16.323M256.001 0c-69.439 0-125.935 56.493-125.935 125.933 0 22.383 5.878 43.418 16.159 61.654 21.616 38.333 62.719 64.279 109.775 64.279s88.159-25.946 109.774-64.281c10.282-18.235 16.159-39.269 16.159-61.654C381.935 56.493 325.441 0 256.001 0"/></svg></div>
        <span class="asset-name">Bush</span>
    </div>
    <div class="asset-item" draggable="true" data-asset-type="custom-obj-vegetation" title="Import Custom OBJ">
        <div class="asset-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 225 225" xml:space="preserve" fill="currentColor"><path d="M225 210.508c0 4.143-3.357 7.5-7.5 7.5H7.5c-4.143 0-7.5-3.357-7.5-7.5s3.357-7.5 7.5-7.5h58.834v-16.874H41.247a7.502 7.502 0 0 1-7.293-9.252L73.385 12.74a7.501 7.501 0 0 1 14.586 0l18.337 76.336c-12.521 11.297-20.407 27.64-20.407 45.792a61.3 61.3 0 0 0 7.608 29.644c.385.511.71 1.07.955 1.671a62.2 62.2 0 0 0 18.865 19.951H95.021v16.874h37.947v-23.816c-18.602-6.149-32.067-23.688-32.067-44.325 0-25.74 20.941-46.682 46.682-46.682s46.681 20.941 46.681 46.682c0 20.636-13.465 38.176-32.066 44.325v23.816H217.5a7.5 7.5 0 0 1 7.5 7.5"/></svg></div>
        <span class="asset-name">Import OBJ</span>
    </div>
        </div>
            </div>
            <div id="transform-controls-section" class="hidden param-section pt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Selected Object Transform</h4>
                    <div class="flex items-center justify-between mt-2">
                    <div class="btn-group">
                        <button id="gizmo-mode-translate" class="btn active" data-mode="translate">Move</button>
                        <button id="gizmo-mode-rotate" class="btn" data-mode="rotate">Rotate</button>
                        <button id="gizmo-mode-scale" class="btn" data-mode="scale">Scale</button>
                    </div>
                    <button id="remove-selected-object-btn" class="btn btn-danger btn-sm">Remove</button>
                </div>
                <div class="space-y-4 pt-4 border-t border-[--grid-color] mt-4">
                    <div>
                        <label class="label text-xs" for="obj-pos-x">Position (X)</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="obj-pos-x" min="-25" max="25" value="0" step="0.1">
                            <span id="obj-pos-x-val" class="data-value font-mono w-16 text-left">0.0m</span>
                        </div>
                    </div>
                    <div>
                        <label class="label text-xs" for="obj-pos-y">Position (Y)</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="obj-pos-y" min="0" max="10" value="0" step="0.1">
                            <span id="obj-pos-y-val" class="data-value font-mono w-16 text-left">0.0m</span>
                        </div>
                    </div>
                    <div>
                        <label class="label text-xs" for="obj-pos-z">Position (Z)</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="obj-pos-z" min="-25" max="25" value="0" step="0.1">
                            <span id="obj-pos-z-val" class="data-value font-mono w-16 text-left">0.0m</span>
                        </div>
                    </div>
                    <div class="pt-2 border-t border-dashed border-[--grid-color]">
                        <label class="label text-xs" for="obj-rot-y">Rotation (°)</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="obj-rot-y" min="-180" max="180" value="0" step="1">
                            <span id="obj-rot-y-val" class="data-value font-mono w-16 text-left">0°</span>
                        </div>
                    </div>
                    <div class="pt-2 border-t border-dashed border-[--grid-color]">
                        <label class="label text-xs" for="obj-scale-uniform">Scale (Uniform)</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="obj-scale-uniform" min="0.1" max="5" value="1" step="0.05">
                            <span id="obj-scale-uniform-val" class="data-value font-mono w-16 text-left">1.00</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="param-section pt-4 border-t border-dashed border-[--grid-color]">
                <h3 class="font-semibold text-sm uppercase">Context & Site Modeling</h3>
                <p class="info-box !text-xs !py-2 !px-3">Model surrounding buildings and topography to improve simulation accuracy.</p>
                        <div>
                            <label class="label">Context Source</label>
                            <div class="btn-group mt-1">
                                <button id="context-mode-none" class="btn active">None</button>
                                <button id="context-mode-osm" class="btn">OSM</button>
                                <button id="context-mode-massing" class="btn">Massing</button>
                                <button id="context-mode-topo" class="btn">Topography</button>
                            </div>
                        </div>

                        <div id="osm-controls" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                            <p class="text-xs text-[--text-secondary]">Automatically fetch building data around the project's latitude and longitude.</p>
                            <div>
                                <label for="osm-radius" class="label text-xs">Fetch Radius (meters)</label>
                                <div class="flex items-center space-x-3 mt-1">
                                    <input type="range" id="osm-radius" min="10" max="1000" value="100" step="10">
                                    <span id="osm-radius-val" class="data-value font-mono w-16 text-left">100m</span>
                                </div>
                            </div>
                            <button id="fetch-osm-data-btn" class="btn btn-secondary w-full">Fetch Building Data</button>
                            <div class="pt-2">
                                <label for="context-visibility-toggle" class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="context-visibility-toggle" checked>
                                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Show Context in 3D View</span>
                                </label>
                            </div>
                        </div>

                        <div id="massing-controls" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Simple Massing Tools</h4>
                            <p class="info-box !text-xs !py-2 !px-3">Create and place simple 3D shapes to represent surrounding buildings or site obstructions. Material for all context objects can be set at the bottom of this panel.</p>

                            <div class="space-y-4">
                                <div>
                                    <label class="label text-xs">Shape Type</label>
                                    <div class="grid grid-cols-4 gap-2 mt-1">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="massing-shape" value="box" checked class="mr-1">
                                            <span class="text-xs">Box</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="massing-shape" value="cylinder" class="mr-1">
                                            <span class="text-xs">Cylinder</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="massing-shape" value="pyramid" class="mr-1">
                                            <span class="text-xs">Pyramid</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="massing-shape" value="sphere" class="mr-1">
                                            <span class="text-xs">Sphere</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="massing-dimensions" class="space-y-3">
                                    <h5 class="font-semibold text-xs text-[--text-secondary]">Dimensions</h5>
                                    <div id="box-dimensions">
                                        <div><label class="label text-xs" for="massing-width">Width (X)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-width" min="1" max="100" value="10" step="0.1"><span id="massing-width-val" class="data-value font-mono w-12 text-left">10m</span></div></div>
                                        <div><label class="label text-xs" for="massing-depth">Depth (Z)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-depth" min="1" max="100" value="10" step="0.1"><span id="massing-depth-val" class="data-value font-mono w-12 text-left">10m</span></div></div>
                                        <div><label class="label text-xs" for="massing-height">Height (Y)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-height" min="1" max="100" value="15" step="0.1"><span id="massing-height-val" class="data-value font-mono w-12 text-left">15m</span></div></div>
                                    </div>
                                    <div id="radius-dimension" class="hidden">
                                        <div><label class="label text-xs" for="massing-radius">Radius</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-radius" min="1" max="50" value="5" step="1"><span id="massing-radius-val" class="data-value font-mono w-12 text-left">5m</span></div></div>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <h5 class="font-semibold text-xs text-[--text-secondary]">Positioning</h5>
                                    <div><label class="label text-xs" for="massing-pos-x">Position X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-pos-x" min="-100" max="100" value="20" step="1"><span id="massing-pos-x-val" class="data-value font-mono w-12 text-left">20m</span></div></div>
                                    <div><label class="label text-xs" for="massing-pos-y">Position Y (Height)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-pos-y" min="0" max="50" value="7.5" step="1"><span id="massing-pos-y-val" class="data-value font-mono w-12 text-left">7.5m</span></div></div>
                                    <div><label class="label text-xs" for="massing-pos-z">Position Z</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-pos-z" min="-100" max="100" value="0" step="1"><span id="massing-pos-z-val" class="data-value font-mono w-12 text-left">0m</span></div></div>
                                </div>

                                <div class="space-y-3">
                                    <h5 class="font-semibold text-xs text-[--text-secondary]">Block Creation</h5>
                                    <div><label class="label text-xs" for="massing-count">Number of Blocks</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-count" min="1" max="10" value="1" step="0.1"><span id="massing-count-val" class="data-value font-mono w-12 text-left">1</span></div></div>
                                    <div><label class="label text-xs" for="massing-spacing">Spacing Between</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="massing-spacing" min="0" max="20" value="5" step="0.1"><span id="massing-spacing-val" class="data-value font-mono w-12 text-left">5m</span></div></div>
                                    <div>
                                        <label class="label text-xs">Arrangement Pattern</label>
                                        <div class="grid grid-cols-3 gap-2 mt-1">
                                            <label class="flex items-center cursor-pointer">
                                                <input type="radio" name="massing-pattern" value="linear" checked class="mr-1">
                                                <span class="text-xs">Linear</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer">
                                                <input type="radio" name="massing-pattern" value="grid" class="mr-1">
                                                <span class="text-xs">Grid</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer">
                                                <input type="radio" name="massing-pattern" value="random" class="mr-1">
                                                <span class="text-xs">Random</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="pt-3 border-t border-dashed border-[--grid-color]">
                                    <button id="create-massing-blocks-btn" class="btn btn-primary w-full">Create Massing Blocks</button>
                                    <button id="clear-massing-blocks-btn" class="btn btn-secondary w-full mt-2">Clear All Blocks</button>
                                </div>

                                <div id="massing-info" class="text-xs text-[--text-secondary] pt-2 border-t border-dashed border-[--grid-color]">
                                    <p>Current blocks: <span id="massing-count-display">0</span></p>
                                    <p>Total volume: <span id="massing-volume-display">0m³</span></p>
                                </div>
                            </div>
        
                            <!-- Context Object Management Panel -->
                            <div id="context-object-management" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Context Object Manager</h4>
                                <p class="info-box !text-xs !py-2 !px-3">Manage all context objects in your scene. Select objects to view properties and perform bulk operations.</p>
        
                                <!-- Search and Filter -->
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <input type="text" id="context-object-search" placeholder="Search objects..." class="flex-grow text-sm">
                                        <select id="context-object-filter" class="text-sm">
                                            <option value="all">All Objects</option>
                                            <option value="mass">Massing Blocks</option>
                                            <option value="building">Buildings</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="select-all-objects" class="btn btn-xs btn-secondary">Select All</button>
                                        <button id="clear-selection" class="btn btn-xs btn-secondary">Clear</button>
                                        <button id="invert-selection" class="btn btn-xs btn-secondary">Invert</button>
                                    </div>
                                </div>
        
                                <!-- Object List -->
                                <div id="context-object-list" class="max-h-48 overflow-y-auto space-y-2 border border-[--grid-color] rounded p-2">
                                    <p class="text-xs text-[--text-secondary] text-center py-4">No context objects found.</p>
                                </div>
        
                                <!-- Bulk Operations -->
                                <div class="space-y-2 pt-2 border-t border-dashed border-[--grid-color]">
                                    <h5 class="font-semibold text-xs text-[--text-secondary]">Bulk Operations</h5>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="bulk-delete" class="btn btn-xs btn-danger">Delete Selected</button>
                                        <button id="bulk-copy" class="btn btn-xs btn-secondary">Copy Selected</button>
                                        <button id="bulk-change-material" class="btn btn-xs btn-secondary">Change Material</button>
                                        <button id="bulk-select-by-type" class="btn btn-xs btn-secondary">Select by Type</button>
                                    </div>
                                </div>
        
                                <!-- Object Properties Panel -->
                                <div id="context-object-properties" class="hidden space-y-2 pt-2 border-t border-dashed border-[--grid-color]">
                                    <h5 class="font-semibold text-xs text-[--text-secondary]">Selected Object Properties</h5>
                                    <div id="object-info-display" class="text-xs space-y-1">
                                        <div class="flex justify-between">
                                            <span class="text-[--text-secondary]">Name:</span>
                                            <span id="obj-name" class="font-mono">--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-[--text-secondary]">Type:</span>
                                            <span id="obj-type" class="font-mono">--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-[--text-secondary]">Position:</span>
                                            <span id="obj-position" class="font-mono">--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-[--text-secondary]">Dimensions:</span>
                                            <span id="obj-dimensions" class="font-mono">--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-[--text-secondary]">Volume:</span>
                                            <span id="obj-volume" class="font-mono">--</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 pt-2">
                                        <button id="delete-single-object" class="btn btn-xs btn-danger">Delete</button>
                                        <button id="copy-single-object" class="btn btn-xs btn-secondary">Copy</button>
                                        <button id="focus-object" class="btn btn-xs btn-secondary">Focus Camera</button>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>

                        <div id="topo-controls" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                            <p class="text-xs text-[--text-secondary]">Use a grayscale image as a heightmap to generate topography. White is high, black is low.</p>
                            <div>
                                <label class="label" for="topo-heightmap-file">Heightmap Image (.png, .jpg)</label>
                                <input type="file" id="topo-heightmap-file" accept="image/png, image/jpeg" class="w-full text-sm">
                                <span data-file-display-for="topo-heightmap-file" class="text-xs text-[--text-secondary] truncate block mt-1">No file selected.</span>
                            </div>
                            <div>
                                <label class="label" for="topo-plane-size">Plane Size (m)</label>
                                <div class="flex items-center space-x-3 mt-1"><input type="range" id="topo-plane-size" min="50" max="1000" value="200" step="10"><span id="topo-plane-size-val" class="data-value font-mono w-16 text-left">200m</span></div>
                            </div>
                            <div>
                                <label class="label" for="topo-vertical-scale">Vertical Scale (m)</label>
                                <div class="flex items-center space-x-3 mt-1"><input type="range" id="topo-vertical-scale" min="0" max="100" value="10" step="1"><span id="topo-vertical-scale-val" class="data-value font-mono w-16 text-left">10m</span></div>
                            </div>
                        </div>

                        <div id="context-material-controls" class="hidden space-y-3 pt-4 border-t border-dashed border-[--grid-color]">
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Context Material</h4>
                            <div>
                                <label class="label text-xs" for="context-mat-type">Material Type</label>
                                <select id="context-mat-type" class="w-full mt-1">
                                    <option selected>Plastic</option>
                                    <option>Metal</option>
                                </select>
                            </div>
                            <div>
                                <label class="label text-xs !mb-0" for="context-refl">Reflectance</label>
                                <div class="flex items-center space-x-3 mt-1">
                                    <input type="range" id="context-refl" min="0" max="1" value="0.2" step="0.01">
                                    <span id="context-refl-val" class="data-value font-mono w-12 text-left">0.20</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
            </div>
    <div id="project-access-prompt" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] ui-panel !p-3 flex items-center gap-4 hidden">
    <p class="text-sm">Please select a project folder to enable direct saving and file access.</p>
            <button id="select-folder-btn" class="btn btn-primary btn-sm">Select Folder</button>
            <button id="dismiss-prompt-btn" class="text-gray-400 hover:text-gray-200" aria-label="Dismiss">&times;</button>
        </div>

            <div id="hdr-viewer-panel" class="floating-window ui-panel hidden" style="width: 550px; height: 640px;">
                <div class="window-header">
                    <span>HDR Image Viewer</span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content !p-0 flex flex-col">
                    <div id="hdr-canvas-container" class="flex-grow bg-black relative cursor-crosshair">
                        </div>
                    <div id="hdr-controls" class="p-4 border-t border-[--grid-color] space-y-4">
                        <div>
                            <label class="label text-xs flex justify-between" for="hdr-exposure">
                                <span>Exposure (EV)</span>
                                <span id="hdr-exposure-val" class="data-value font-mono">0.0</span>
                            </label>
                            <input type="range" id="hdr-exposure" min="-10" max="10" value="0" step="0.1">
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="hdr-false-color-toggle" class="flex items-center cursor-pointer">
                                <input type="checkbox" id="hdr-false-color-toggle">
                                <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">False Color (Luminance)</span>
                            </label>
                            <div id="hdr-luminance-probe" class="text-sm font-mono bg-[--grid-color] px-2 py-1 rounded hidden">
                                <span id="hdr-luminance-value">--</span> cd/m²
                            </div>
                        </div>
                </div>
                </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

    <div id="temporal-map-panel" class="floating-window ui-panel hidden" style="width: 800px; height: 400px;">
              <div class="window-header">
                    <span>Temporal Map - Sensor Point #<span id="temporal-map-point-id">--</span></span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content !p-4 flex flex-col items-center justify-center">
                <canvas id="temporal-map-canvas" class="w-full h-full"></canvas>
          </div>
      <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
  </div>

      <div id="glare-rose-panel" class="floating-window ui-panel hidden" style="width: 450px; height: 550px;">
                <div class="window-header">
                    <span>Annual Glare Rose</span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content !p-4 flex flex-col">
                    <div class="param-section">
                        <label class="label text-xs flex justify-between" for="glare-rose-threshold">
                            <span>DGP Threshold for Glare Event</span>
                            <span id="glare-rose-threshold-val" class="data-value font-mono">0.40</span>
                        </label>
                        <input type="range" id="glare-rose-threshold" min="0.2" max="0.6" value="0.4" step="0.01">
                        <p class="info-box !text-xs !py-2 !px-3">The diagram shows the number of occupied hours where DGP exceeds the threshold, binned by sun direction.</p>
                    </div>
                    <canvas id="glare-rose-canvas"></canvas>
                  </div>
                </div>
                    <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
                </div>

                <div id="combined-analysis-panel" class="floating-window ui-panel hidden" style="width: 600px; height: 650px;">
                <div class="window-header">
                    <span>Combined Daylight & Glare Analysis</span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content !p-4 flex flex-col">
                    <div class="param-section">
                        <label class="label text-xs flex justify-between" for="combined-glare-threshold">
                            <span>DGP Threshold for "Glare Hour"</span>
                            <span id="combined-glare-threshold-val" class="data-value font-mono">0.40</span>
                        </label>
                        <input type="range" id="combined-glare-threshold" min="0.2" max="0.6" value="0.4" step="0.01">
                        <p class="info-box !text-xs !py-2 !px-3">Each point on the scatter plot represents one sensor in the grid. The plot helps identify trade-offs between having useful daylight and experiencing uncomfortable glare.</p>
                    </div>
                    <div id="combined-analysis-canvas-container" class="w-full h-full relative flex-grow mt-4">
                        <canvas id="combined-analysis-canvas"></canvas>
                  </div>
              </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

        <div id="panel-info" class="floating-window ui-panel hidden" style="width: 600px; height: 70vh;">
          <div class="window-header">
                  <span>Application Information & Help</span>
                  <div class="window-controls">
                      <div class="window-icon-max"></div>
                      <div class="collapse-icon"></div>
                      <div class="window-icon-close"></div>
                  </div>
              </div>
              <div class="window-content">
                <p class="mb-4">
                    Ray Modeler is a web-based graphical user interface for the Radiance Lighting Simulation Suite, with an integrated AI Assistant to automate workflows and provide expert guidance. It streamlines the entire daylighting and electric lighting analysis workflow, from parametric 3D modeling to simulation script generation and advanced results visualization.
                </p>
                <p class="mb-4">
                    Ray Modeler provides an intuitive, interactive environment to model, simulate, and analyze lighting performance in single-zone spaces without needing to write Radiance code manually.
                </p>
                <img src="./Pictures/welcome_screen.png" alt="Ray Modeler Welcome Screen" class="w-full rounded-md my-4 border border-[--grid-color]">

                <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v.01h-.001a6 6 0 01-5.84-7.38L6.75 8.25a.75.75 0 01.75-.75h7.5a.75.75 0 01.75.75l2.84 6.12zM12 12l.001.001M12 12l-.001.001M12 12l.001-.001M12 12l-.001-.001M12 6a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008A.75.75 0 0112 6zM12 3.75a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008a.75.75 0 01-.75-.75V3.75zM12 15a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008A.75.75 0 0112 15z" /></svg>Getting Started</h2>
                <p>To use Ray Modeler, you will need a modern web browser and a local installation of the Radiance Lighting Simulation Suite. The desktop version provides the most seamless experience.</p>
                <ol class="list-decimal list-inside space-y-2 my-4">
                    <li><strong>Install Radiance</strong>:
                        Download and install <a href="https://www.radiance-online.org/" target="_blank" class="text-[--text-secondary] underline">Radiance</a> from the official website or the <a href="https://github.com/NREL/Radiance" target="_blank" class="text-[--text-secondary] underline">NREL GitHub repository</a>. Ensure the Radiance <code>bin</code> directory is in your system's PATH.
                    </li>
                    <li><strong>Download Ray Modeler</strong>:
                        Download the latest release for your operating system (macOS or Windows) from the project's Releases page.
                    </li>
                    <li><strong>Run the Application</strong>:
                        <ul class="list-disc list-inside ml-4">
                            <li><em>Windows</em>: Run the <code>Ray Modeler Setup X.X.X.exe</code> installer.</li>
                            <li><em>macOS</em>: Open the <code>Ray Modeler-X.X.X.dmg</code> and drag the application to your Applications folder.</li>
                        </ul>
                    </li>
                </ol>
                <h4 class="font-semibold text-sm uppercase text-[--text-secondary] mt-4">Security Warnings on First Launch</h4>
                <p>Because the application is not yet code-signed, your operating system will likely show a security warning. When a user on a Mac downloads and tries to open the unsigned app, they will be stopped by Gatekeeper, which will show a message like "Ray Modeler cannot be opened because the developer cannot be verified."</p>
                <ul class="list-disc list-inside ml-4 mt-2">
                    <li><strong>On Windows (SmartScreen)</strong>: Click "<strong>More info</strong>", then click "<strong>Run anyway</strong>".</li>
                    <li><strong>On macOS (Gatekeeper)</strong>: <strong>Right-click</strong> (or Control-click) the app icon, select "<strong>Open</strong>" from the menu. A new dialog box will appear that is similar to the first one, but this time it will include an "<strong>Open</strong>" button. Clicking this will run the app. You only need to do this once. After the first successful launch, the app can be opened normally by double-clicking it.</li>
                </ul>

                <h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Core Capabilities</h2>
                <p>Ray Modeler is packed with features that automate and enhance the Radiance workflow:</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>Parametric Scene Modeling</strong>: Visually define room dimensions, orientation, window-to-wall ratios (WWR), and complex shading devices like overhangs, light shelves, louvers, and roller shades.</li>
                    <li><strong>Geometry Importer</strong>: Import complex models from <code>.obj</code> files, with an interactive UI to tag surfaces (walls, floors, glazing) for accurate simulation setup.</li>
                    <li><strong>Context & Site Modeling</strong>: Improve simulation accuracy by adding surrounding context, either through simple massing tools, topography from heightmaps, or by automatically fetching building data from OpenStreetMaps.</li>
                    <li><strong>Interior Furniture Library</strong>: Place simple furniture and partition objects from a pre-built library via drag-and-drop to create more realistic interior scenes.</li>
                    <li><strong>Radiance Material Editor</strong>: Configure standard Radiance materials (<code>plastic</code>, <code>metal</code>, <code>glass</code>) by adjusting properties like reflectance, specularity, and roughness. It also supports spectral data (<code>.dat</code>) files for advanced material definitions.</li>
                    <li><strong>Advanced Glazing Systems</strong>: Model glazing using simple transmittance values or incorporate complex fenestration data via Bidirectional Scattering Distribution Function (BSDF) <code>.xml</code> files. The application correctly converts intuitive transmittance to physically-based transmissivity for simulations.</li>
                    <li><strong>Interactive BSDF Viewer</strong>: Demystify complex glazing by providing immediate visual feedback. When a BSDF <code>.xml</code> file is loaded, the application can parse the Klems matrix and render an interactive 2D polar plot showing the angular distribution of transmitted light for any incident angle.</li>
                    <li><strong>Electric Lighting Design</strong>: Place and configure multiple Radiance light source types (light, spotlight, glow, illum) or import real-world luminaire data using IES photometric files in individual or grid-based layouts.</li>
                    <li><strong>Advanced IES Photometry Viewer</strong>: In addition to a 2D polar plot, visualize luminaire distributions with an interactive 3D photometric web and view key metadata like lumens and wattage directly from the <code>.ies</code> file.</li>
                    <li><strong>Daylighting Controls</strong>: Simulate energy savings by implementing photosensor-controlled lighting systems with continuous, stepped, or off modes.</li>
                    <li><strong>Daylighting Control Zone Visualization</strong>: Instantly visualize which luminaires are controlled by which photosensors with color-coded 3D gizmos, providing immediate feedback on the daylighting strategy.</li>
                    <li><strong>Automated Radiance Workflow</strong>: Generates a complete, organized project folder structure (e.g., 01_geometry, 04_skies, 07_scripts) and populates it with geometry files, material definitions, sensor points, and executable run scripts for both Windows (<code>.bat</code>) and macOS/Linux (<code>.sh</code>).</li>
                    <li><strong>First-Person View (FPV) Mode</strong>: Enter the Radiance viewpoint camera directly to preview the exact perspective, fisheye, or parallel view that will be rendered for analysis.</li>
                    <li><strong>Saved Camera Views ("Snapshots")</strong>: Save and load specific camera positions and angles, complete with thumbnails, to quickly return to key perspectives during analysis.</li>
                    <li><strong>Advanced Annual Analysis</strong>: Generate and view temporal heatmaps, glare rose diagrams, and combined daylight/glare scatter plots to deeply understand annual performance.</li>
                    <li><strong>Recipe-Based Simulation Engine</strong>: Automate complex Radiance workflows with pre-configured "recipes." The application generates all necessary geometry files, material definitions, and executable run scripts (<code>.sh</code>, <code>.bat</code>) in a standardized project folder.</li>
                    <li><strong>Advanced Annual Methods</strong>: Support for industry-standard annual simulation methods, including 3-Phase and 5-Phase Daylight Analysis.</li>
                    <li><strong>Spectral Lighting Analysis</strong>: A full implementation of the Lark methodology to run multi-channel simulations and calculate non-visual lighting metrics like melanopic and neuropic illuminance.</li>
                    <li><strong>Automated Compliance Workflows</strong>: Specialized recipes for checking compliance with major industry standards, including <code>IES LM-83 (sDA/ASE)</code>, <code>EN 17037 (Daylight in Buildings)</code>, and <code>EN 12464-1 (Light and lighting of work places)</code>.</li>
                    <li><strong>Interactive HDR Image Analysis</strong>: View High-Dynamic Range (HDR) renderings with exposure controls, toggle false-color luminance mode, and use a mouse-over probe to get exact cd/m² values. Detected glare sources can be overlaid directly onto the image for verification.</li>
                    <li><strong>Live Sun Ray Tracing</strong>: Visualize direct sun penetration in real-time. Trace a grid of rays from the sun's current position (calculated from the EPW file for any date/time) through glazing surfaces and see how they bounce around the interior, helping to quickly identify potential glare spots or assess daylight distribution.</li>
                    <li><strong>File System Integration</strong>: Using the File System Access API (or Electron's APIs), Ray Modeler can directly read from and save to a local project folder, enabling a seamless desktop-like experience.</li>
                    <li><strong>AI Assistant</strong>: An integrated, context-aware AI chat powered by generative AI (Google Gemini or models via OpenRouter) that can answer questions and directly manipulate the scene, run simulations, and control the UI using natural language commands.</li>
                    <li><strong>Automated Report Generation</strong>: Generate comprehensive HTML reports with a single click. The report includes project details, a 3D scene snapshot, key performance metrics (sDA, ASE, DGP), and all generated dashboard charts (UDI, Glare Rose), ready for printing or saving as a PDF.</li>
                    <li><strong>Interactive Data Table</strong>: Inspect raw simulation data in a sortable, filterable table. Click on any row to instantly highlight the corresponding sensor point in the 3D model, linking numerical data directly to its spatial context.</li>
                    <li><strong>Daylight Autonomy Heatmaps</strong>: Visualize annual performance not just as point-in-time illuminance, but also as Daylight Autonomy (DA), showing the percentage of occupied hours that each sensor point meets a specific illuminance threshold.</li>
                    <li><strong>Climate Data Analysis</strong>: Generate an interactive dashboard from the loaded EPW file, including a wind rose, solar radiation charts, and temperature profiles to better understand the site context.</li>
                    <li><strong>Advanced Circadian Health Dashboard</strong>: Analyze results from spectral simulations to calculate and visualize key circadian lighting metrics like Circadian Stimulus (CS), Equivalent Melanopic Lux (EML), and check for compliance with WELL building standards.</li>
                    <li><strong>Advanced IES Photometry Viewer</strong>: In addition to a 2D polar plot, visualize luminaire distributions with an interactive 3D photometric web and view key metadata like lumens and wattage directly from the <code>.ies</code> file.</li>
                    <li><strong>Interactive 3D Room Resizing</strong>: A "Resize Mode" that allows you to directly manipulate the room's dimensions in the 3D viewport by dragging its exterior faces, providing immediate tactile feedback.</li>
                    <li><strong>Keyboard Shortcuts</strong>: Accelerate your workflow with keyboard shortcuts for common actions, such as <code>T</code> for Top View, <code>P</code> for Perspective, and <code>Ctrl+S</code> to save the project. A help modal (<code>?</code>) displays all available shortcuts.</li>
                    <li><strong>Multi-View Layout (Quad View)</strong>: Split the main viewport into four synchronized cameras (Perspective, Top, Front, Side) for comprehensive spatial awareness and precise object placement, a standard in professional 3D software.</li>
                    <li><strong>Vegetation & Tree Modeling</strong>: Add simple procedural trees and bushes from the Scene Elements library to your site. The vegetation canopy uses a Radiance <code>trans</code> material to accurately simulate its light-filtering effects, improving the realism of site-specific analyses.</li>
                </ul>

                <h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.311a15.045 15.045 0 01-7.5 0C4.508 17.311 2.25 15.122 2.25 12c0-3.122 2.258-5.311 4.75-5.965M12 18a2.25 2.25 0 01-2.25-2.25V6.75A2.25 2.25 0 0112 4.5h.75a2.25 2.25 0 012.25 2.25v5.25a2.25 2.25 0 01-2.25 2.25h-.75z" /></svg>AI Assistant</h2>
                <p>The AI Assistant panel provides a chat interface to help you with your workflow. It understands the application's current state and can perform actions on your behalf using natural language commands.</p>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>AI-Powered Actions (Tool Use)</h3>
                <p>Beyond answering questions, the assistant can directly manipulate the UI and query project data. This allows for a powerful natural language workflow. Its capabilities include:</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>Project Validation</strong>: Ask it to <code>"validate my project for an annual glare simulation"</code> and it will check for common setup errors, such as a missing weather file or an incorrect viewpoint type, and report back any issues.</li>
                    <li><strong>Advanced Scene Manipulation</strong>:
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>Shading</strong>: <code>"Add a 0.5 meter deep overhang to the south wall."</code></li>
                            <li><strong>Sensor Grids</strong>: <code>"Enable a sensor grid on the floor with 0.75m spacing."</code></li>
                            <li><strong>Daylighting</strong>: <code>"Enable continuous daylighting controls with a setpoint of 500 lux."</code></li>
                        </ul>
                    </li>
                    <li><strong>Simulation & Recipe Control</strong>:
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>Global Parameters</strong>: <code>"Set the global ambient bounces to 5."</code></li>
                            <li><strong>Recipe Configuration</strong>: <code>"In the open illuminance recipe, change the time to 9:00 AM."</code></li>
                        </ul>
                    </li>
                    <li><strong>Conversational Data Exploration & Comparison</strong>:
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>Data Query</strong>: <code>"What is the average illuminance for the current results?"</code> or <code>"How many points are above 500 lux?"</code></li>
                            <li><strong>Time Scrubbing</strong>: <code>"Show me the results for the winter solstice at noon."</code></li>
                            <li><strong>Dashboard Control</strong>: <code>"Open the glare rose diagram."</code></li>
                            <li><strong>Comparative Analysis</strong>: <code>"Which of my two designs has better daylight uniformity?"</code> or <code>"Compare the sDA for both designs."</code></li>
                        </ul>
                    </li>
                    <li><strong>File Management</strong>:
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>Load Results</strong>: <code>"Load a results file into dataset A."</code></li>
                            <li><strong>Clear Results</strong>: <code>"Clear all loaded results data."</code></li>
                        </ul>
                    </li>
                </ul>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Design Inspector</h3>
                <p>The AI analyzes the entire project state to identify conflicting or suboptimal combinations of settings, explains the potential consequences, and offers a one-click fix.</p>
                <div class="info-box my-4">
                    <strong>AI Analysis:</strong> "I've reviewed your project. Your wall reflectance is quite low (0.2), and you're only using 2 ambient bounces. This combination will likely result in an unrealistically dark rendering with noticeable splotches. I recommend increasing ambient bounces to 4 and wall reflectance to 0.5."
                    <br>
                    <button class="btn btn-xs btn-secondary mt-2">[Apply Fixes]</button>
                </div>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Results Critique</h3>
                <p>After a simulation completes, the AI can analyze the results, identify problems, and suggest specific, actionable design changes.</p>
                <div class="info-box my-4">
                    <strong>AI Analysis:</strong> "The Daylight Glare Probability (DGP) is 0.47, which is considered 'Intolerable'. This is caused by low-angle sun from the west-facing window. To fix this, I suggest adding vertical louvers."
                    <br>
                    <button class="btn btn-xs btn-secondary mt-2">[Add Vertical Louvers]</button>
                </div>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Interactive Tutor</h3>
                <p>The AI can act as a tutor to guide new users through complex simulation workflows step-by-step, teaching them the process as they go.</p>
                <div class="info-box my-4">
                    <p><strong>User</strong>: "How do I run a glare simulation?"</p>
                    <p><strong>AI</strong>: "Of course! To calculate DGP, we need a 180° fisheye view. Your current viewpoint is set to Perspective. Would you like me to change it for you?"</p>
                    <p><strong>User</strong>: "Yes"</p>
                    <p><strong>AI</strong>: <em>(Changes viewpoint)</em> "Great. Next, I'll open the DGP recipe panel for you." <em>(Opens recipe)</em> "Now you just need to click 'Generate Package' and run the simulation."</p>
                </div>
                <h4 class="font-semibold text-sm uppercase text-[--text-secondary] mt-4">Proactive Suggestions</h4>
                <p>The AI Assistant monitors user actions and provides contextual, non-intrusive suggestions to guide the workflow and prevent common errors. These suggestions appear as dismissible chips in the UI. For example:</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li>After loading an <strong>EPW weather file</strong>, it will suggest opening an annual simulation recipe.</li>
                    <li>If a material's <strong>reflectance is set to an unusually high or low value</strong>, it will warn that this may be physically unrealistic.</li>
                    <li>If the user enables a <strong>View Grid</strong>, it will suggest opening the Imageless Annual Glare recipe.</li>
                    <li>If the <strong>DGP recipe is open but the viewpoint is not set to fisheye</strong>, it will offer to correct the setting.</li>
                </ul>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Generative Design</h3>
                <p>Leverage the AI to perform automated, multi-step design tasks.</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>Scene Creation from Natural Language</strong>: Instead of manually adjusting sliders, describe the space you want to build in plain English.
                        <div class="info-box !text-sm my-2">
                            "Create a long office, 12 meters deep by 5 meters wide, with a 3-meter high ceiling. Put a large, continuous window across the entire south wall with a sill height of 0.8 meters. Add a 1-meter deep overhang above it and place two desks in the middle of the room."
                        </div>
                    </li>
                    <li><strong>Design Optimization</strong>: Define a goal, constraints, and a design variable, and the assistant will orchestrate the entire workflow to find the best solution. For example:
                        <div class="info-box !text-sm my-2">
                            "Find an overhang depth for the south wall between 0.5m and 2.0m that maximizes sDA while keeping ASE below 10%."
                        </div>
                    </li>
                </ul>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>API Key Configuration</h3>
                <p>The integrated AI Assistant requires an API key to function. It supports multiple providers for greater flexibility.</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>Expanded Provider Support</strong>: Select between <strong>OpenRouter</strong>, <strong>OpenAI</strong>, <strong>Google Gemini</strong>, and <strong>Anthropic</strong>.</li>
                    <li><strong>Provider-Specific Keys</strong>: The application saves a separate API key for each provider, so you can switch between models without re-entering credentials.</li>
                    <li><strong>AI Configuration</strong>: A settings modal (⚙️ icon) allows you to select your preferred provider, choose from a list of popular models (e.g., Gemini 1.5 Pro, GPT-4o, Claude 3.5 Sonnet), and enter your API key.</li>
                </ul>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Getting Your API Key</h3>
                <h4 class="font-semibold text-sm uppercase text-[--text-secondary] mt-4">Google Gemini API Key 🔑</h4>
                <p>You can get a free API key for the Gemini family of models from <a href="https://aistudio.google.com/prompts/new_chat" target="_blank" class="text-[--text-secondary] underline">Google AI Studio</a>.</p>
                <ol class="list-decimal list-inside space-y-1 my-2 ml-4">
                    <li>Go to the Google AI Studio website.</li>
                    <li>Sign in with your Google account.</li>
                    <li>Click the "<code>Get API key</code>" button, usually located in the top-left or top-right corner of the page.</li>
                    <li>A dialog will appear. Click "<code>Create API key</code>".</li>
                    <li>Your new API key will be generated and displayed.</li>
                    <li>Copy this key and paste it into the API Key field in the Ray Modeler AI settings.</li>
                </ol>
                <p class="text-xs text-[--text-secondary]"><em>Note: The Gemini API has a free tier with usage limits. Be sure to review Google's current pricing and terms of service.</em></p>

                <h4 class="font-semibold text-sm uppercase text-[--text-secondary] mt-4">OpenRouter API Key 🔑</h4>
                <p>OpenRouter provides access to a wide variety of models from different providers through a single API.</p>
                <ol class="list-decimal list-inside space-y-1 my-2 ml-4">
                    <li>Go to the <a href="https://openrouter.ai/" target="_blank" class="text-[--text-secondary] underline">OpenRouter.ai</a> website and log in.</li>
                    <li>Click on your account icon in the top-right corner and select "<code>Keys</code>" from the dropdown menu.</li>
                    <li>Click the "<code>+ Create Key</code>" button. Give your key a name (e.g., "RayModeler") and click "<code>Create</code>".Your new API key will be generated.</li>
                    <li>Copy this key and paste it into the API Key field in the Ray Modeler AI settings.</li>
                </ol>
                <p class="text-xs text-[--text-secondary]"><em>Note: OpenRouter is a paid service. You will need to add credits to your account to use most models. To use some of the free models, you may need to adjust your privacy settings to allow your data to be used for model improvement.</em></p>

                <h4 class="font-semibold text-sm uppercase text-[--text-secondary] mt-4">OpenAI API Key 🔑</h4>
                <ol class="list-decimal list-inside space-y-1 my-2 ml-4">
                    <li>Go to the <a href="https://platform.openai.com/api-keys" target="_blank" class="text-[--text-secondary] underline">OpenAI API keys</a> page and log in.</li>
                    <li>Click the "<code>+ Create new secret key</code>" button.</li>
                    <li>Give your key a name (e.g., "RayModeler") and click "<code>Create secret key</code>".</li>
                    <li>Copy the generated key immediately and paste it into the API Key field in the Ray Modeler AI settings. You will not be able to view it again.</li>
                </ol>

                <h4 class="font-semibold text-sm uppercase text-[--text-secondary] mt-4">Anthropic API Key 🔑</h4>
                <ol class="list-decimal list-inside space-y-1 my-2 ml-4">
                    <li>Go to the <a href="https://console.anthropic.com/" target="_blank" class="text-[--text-secondary] underline">Anthropic Console</a> and log in.</li>
                    <li>Navigate to the "API Keys" section in your account settings.</li>
                    <li>Click the "<code>Create Key</code>" button.</li>
                    <li>Give the key a name and click "<code>Create Key</code>".</li>
                    <li>Copy the key and paste it into the API Key field in the Ray Modeler AI settings.</li>
                </ol>
                <p class="info-box my-4"><strong>Important</strong>: Treat your API keys like passwords. Do not share them publicly or commit them to version control.</p>

                <h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75C6.75 5.64543 7.64543 4.75 8.75 4.75H15.25C16.3546 4.75 17.25 5.64543 17.25 6.75V19.25L12 14.75L6.75 19.25V6.75Z" /></svg>UI Walkthrough 💻</h2>
                <p>The interface is designed around a logical workflow, guiding the user from setup to analysis.</p>
                <img src="./Pictures/main_ui.png" alt="Ray Modeler Main UI" class="w-full rounded-md my-4 border border-[--grid-color]">
                <img src="./Pictures/main_ui_quad.png" alt="Ray Modeler Main UI in Quad View" class="w-full rounded-md my-4 border border-[--grid-color]">
                <img src="./Pictures/panels_ui.png" alt="Ray Modeler Panels" class="w-full rounded-md my-4 border border-[--grid-color]">
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>3D Viewport (Center)</strong>: This is the main interactive area where your 3D scene is displayed. You can navigate using standard orbit controls (mouse drag, scroll). The viewport can also be split into a <strong>Quad View</strong> layout, showing synchronized Perspective, Top, Front, and Side cameras for comprehensive spatial awareness.</li>
                    <li><strong>Left Toolbar</strong>: This is the primary command center for building your scene. It contains buttons to open floating panels for defining all aspects of the physical model, from <strong>Project Setup</strong> and <strong>Dimensions</strong> to <strong>Simulation</strong> and <strong>Analysis</strong> modules.</li>
                    <li><strong>Top View Controls</strong>: A quick-access toolbar to instantly switch between standard orthographic (Top, Front, etc.) and perspective camera views. It also includes the button to toggle the <strong>Quad View</strong> layout.</li>
                    <li><strong>Bottom Toolbar (Bottom-Left)</strong>: Provides quick access to global actions like saving/loading project files, viewing application information and keyboard shortcuts, and launching the AI Assistant.</li>
                    <li><strong>Floating Panels</strong>: All scene definition, simulation, and analysis tools open as independent floating windows. These panels can be dragged, resized, collapsed, and arranged anywhere on the screen, allowing you to create a workspace tailored to your needs.</li>
                    <li><strong>AI Assistant Sidebar (Right)</strong>: A dedicated, resizable sidebar that houses the conversational AI Assistant. This keeps the AI's powerful capabilities accessible without cluttering your modeling and analysis workflow.</li>
                </ul>

                <h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>In-Depth Feature Guide</h2>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Scene Definition Panels</h3>
                <p>The panels on the left toolbar are used to define the scene.</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>Project Setup</strong>: This is the starting point. Define project metadata, set the building's geographic location using an interactive map, or by uploading an <code>.epw</code> weather file which auto-populates location data. This panel also contains controls for the 3D Sun Path visualization and a tool for generating annual occupancy schedules.</li>
                    <li><strong>Dimensions</strong>: Set the foundational geometry: <strong>width (X-axis)</strong>, <strong>length (Z-axis)</strong>, and <strong>height (Y-axis)</strong>. The <strong>Orientation</strong> slider rotates the entire room, affecting its solar exposure.</li>
                    <li><strong>Apertures & Shading</strong>: Control openings on each wall. Work parametrically using <strong>Window-to-Wall Ratio (WWR)</strong> or switch to <strong>Manual</strong> mode for precise control. Each wall can have its own complex shading system, including <code>Overhangs</code>, <code>Light Shelves</code>, <code>Louvers</code>, and <code>Roller Shades</code>.</li>
                    <li><strong>Artificial Lighting</strong>: Add electric lighting. Choose from Radiance primitives like <code>light</code>, <code>spotlight</code>, and <code>glow</code>, or upload an <code>.ies</code> file for a specific luminaire. Lights can be placed individually or arranged in a grid.</li>
                    <li><strong>Material Properties</strong>: Define surface characteristics. For each element, select a Radiance material and adjust its <strong>reflectance</strong>, <strong>specularity</strong>, and <strong>roughness</strong>. The app correctly converts the intuitive 'Transmittance' value for glazing into the physically-based 'Transmissivity' required by the Radiance <code>glass</code> material. Advanced optics can be modeled via BSDF <code>.xml</code> files.</li>
                    <li><strong>Sensor Grid</strong>: Create measurement points for simulations. The <strong>Illuminance Grid</strong> generates a <code>.pts</code> file for `rtrace` and is visualized as spheres. The <strong>View Grid</strong> generates a <code>.ray</code> file for imageless glare analysis (`rcontrib`) and is visualized as arrows indicating view directions.</li>
                    <li><strong>Viewpoint</strong>: This panel controls the specific camera view used by Radiance for generating renderings (<code>rpict</code>) or glare images (<code>evalglare</code>). It defines the camera's position (<code>-vp</code>), direction (<code>-vd</code>), and view type. You can manipulate this camera with a 3D gizmo or enter a <strong>First-Person View (FPV)</strong> to see exactly what Radiance will render.</li>
                    <li><strong>Scene Elements</strong>: Add and manage non-architectural objects in the scene. Includes an <strong>Interior Furniture Library</strong> (drag-and-drop), <strong>Context & Site Modeling</strong> tools (Simple Massing, Topography Import, OpenStreetMaps Integration).</li>
                </ul>

                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Simulation Modules (Recipes)</h3>
                <p>Each recipe automates a specific Radiance workflow by generating scripts that call core commands. Global simulation parameters (<code>-ab</code>, <code>-ad</code>) can be set once and overridden per recipe.</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>Global Simulation Parameters</strong>: Sets default Radiance parameters inherited by all recipes.</li>
                    <li><strong>Illuminance Map</strong>: A point-in-time calculation for sensor grid illuminance.</li>
                    <li><strong>Photorealistic Rendering</strong>: Creates an HDR image from the Viewpoint.</li>
                    <li><strong>Daylight Glare Probability (DGP)</strong>: Renders a 180° fisheye image and analyzes it for glare.</li>
                    <li><strong>Daylight Factor (DF)</strong>: Calculates internal/external illuminance ratio under a CIE overcast sky.</li>
                    <li><strong>Annual Daylight (3-Phase & 5-Phase)</strong>: Generates scripts for advanced matrix-based annual simulations.</li>
                    <li><strong>Imageless Annual Glare</strong>: Uses <code>rcontrib</code> and <code>dcglare</code> for an 8760-hour DGP profile.</li>
                    <li><strong>Spectral Analysis (Lark)</strong>: Implements the Lark methodology for multi-channel spectral simulations.</li>
                    <li><strong>Compliance Recipes</strong>: Specialized recipes for <code>IES LM-83 (sDA/ASE)</code>, <code>EN 17037</code>, and <code>EN 12464-1</code>.</li>
                    <li><strong>Lighting Energy Analysis</strong>: Runs an annual simulation with daylighting controls to estimate energy use.</li>
                    <li><strong>Façade Irradiation Analysis</strong>: Calculates total annual solar irradiation on an exterior façade.</li>
                    <li><strong>Annual Solar Radiation Maps</strong>: Calculates cumulative solar radiation on interior surfaces.</li>
                </ul>

                <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>Analysis 📊</h2>
                <p>The Analysis Sidebar uses a background Web Worker to parse various Radiance result files without freezing the interface. The application automatically detects the file type and enables the relevant visualization tools.</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>3D Visualization</strong>: Illuminance data is mapped as a false-color grid onto the 3D model, with a customizable color scale and support for comparing two datasets.</li>
                    <li><strong>Annual Metrics Dashboard</strong>: For annual <code>.ill</code> files, this dashboard visualizes key metrics like sDA, ASE, and UDI.</li>
                    <li><strong>Climate Analysis Dashboard</strong>: When an EPW file is loaded, this dashboard provides interactive visualizations of the climate data.</li>
                    <li><strong>Temporal Map</strong>: After loading annual results, clicking on any sensor point generates a 24x365 heatmap for that specific point.</li>
                    <li><strong>Glare Rose Diagram</strong>: For annual <code>.dgp</code> files, this generates a polar chart showing glare frequency by sun position.</li>
                    <li><strong>Combined Daylight vs. Glare Plot</strong>: A scatter plot showing the trade-off between useful daylight and glare hours for each sensor.</li>
                    <li><strong>HDR Viewer</strong>: Loads <code>.hdr</code> images with exposure controls, false-color mode, and a luminance probe.</li>
                    <li><strong>Advanced Circadian Health Dashboard</strong>: Visualizes metrics like CS, EML, and checks for WELL compliance.</li>
                    <li><strong>Automated Report Generation</strong>: Compiles all project information, metrics, and charts into a single HTML report.</li>
                </ul>
                <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Desktop Integration (Electron)</h3>
                <p>Ray Modeler operates as an Electron-based desktop application, enabling direct interaction with your file system.</p>
                <ul class="list-disc list-inside space-y-1 my-4">
                    <li><strong>Standardized Project Folder</strong>: When you save a project, the application creates a complete, organized folder structure on your local machine.</li>
                    <li><strong>Simulation Console</strong>: A built-in console window appears when you run a simulation, showing the live output from the Radiance processes and reporting the final exit code (success or failure).</li>
                </ul>
            </div> 
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
            </div> <div id="simulation-console-panel" class="floating-window ui-panel hidden" style="width: 700px; height: 450px;">
              <div class="window-header">
              <span>Simulation Console</span>
              <div class="window-controls">
                  <div class="window-icon-max"></div>
                  <div class="collapse-icon"></div>
                  <div class="window-icon-close"></div>
              </div>
          </div>
          <div class="window-content !p-0 flex flex-col">
          <div id="simulation-output" class="flex-grow p-3 font-mono text-xs bg-[--grid-color] overflow-y-auto whitespace-pre-wrap"></div>
          <div class="p-2 border-t border-[--grid-color]">
              <span id="simulation-status" class="text-sm">Status: Idle</span>
          </div>
        </div> <div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
    
        </div> <div id="proactive-suggestion-container" class="fixed bottom-24 right-8 z-[10001] flex flex-col items-end gap-2 w-full max-w-sm pointer-events-none"></div>

    <div id="climate-analysis-panel" class="floating-window ui-panel hidden" style="width: 950px; height: 820px;">
        <div class="window-header">
            <span>Climate Analysis</span>
            <div class="window-controls">
                <div class="window-icon-max"></div>
                <div class="collapse-icon"></div>
                <div class="window-icon-close"></div>
            </div>
        </div>
        <div class="window-content !p-4 grid grid-cols-6 grid-rows-2 gap-6 h-full">
            <div class="flex flex-col items-center h-full col-span-2">
                <h4 class="font-semibold text-xs uppercase text-[--text-secondary] mb-2">Wind Rose</h4>
                <div class="w-full relative flex-grow"><canvas id="wind-rose-canvas"></canvas></div>
            </div>
            <div class="flex flex-col items-center h-full col-span-2">
                <h4 class="font-semibold text-xs uppercase text-[--text-secondary] mb-2">Monthly Solar Radiation (kWh/m²)</h4>
                <div class="w-full relative flex-grow"><canvas id="solar-radiation-canvas"></canvas></div>
            </div>
            <div class="flex flex-col items-center h-full col-span-2">
                <h4 class="font-semibold text-xs uppercase text-[--text-secondary] mb-2">Annual Temperature Range (°C)</h4>
                <div class="w-full relative flex-grow"><canvas id="temperature-chart-canvas"></canvas></div>
            </div>
            <div class="flex flex-col items-center h-full col-span-3">
                <h4 class="font-semibold text-xs uppercase text-[--text-secondary] mb-2">Humidity & Comfort Profile</h4>
                <div class="w-full relative flex-grow"><canvas id="humidity-chart-canvas"></canvas></div>
            </div>
            <div class="flex flex-col items-center h-full col-span-3">
                <h4 class="font-semibold text-xs uppercase text-[--text-secondary] mb-2">Sun Path Diagram</h4>
                <div class="w-full relative flex-grow"><canvas id="sun-path-canvas"></canvas></div>
            </div>
        </div>
        <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div>
        
        
        
        
        
        
        <div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
</div>

 <div id="panel-simulation-modules" class="floating-window ui-panel hidden">
          <div class="window-header">
              <span>Simulation</span>
              <div class="window-controls">
                  <div class="window-icon-max"></div>
                  <div class="collapse-icon"></div>
                  <div class="window-icon-close"></div>
              </div>
          </div>
         <div class="window-content">
      <div class="space-y-3">
          <label for="globals-toggle" class="flex items-center cursor-pointer w-full">
              <input type="checkbox" id="globals-toggle">
              <span class="ml-3 font-semibold text-sm uppercase">Global Simulation Parameters</span>
          </label>
          <div id="globals-controls" class="hidden space-y-5 pt-4 border-t border-[--grid-color]">
              <p class="info-box !text-xs !py-2 !px-3 !mt-0">These are the default Radiance parameters inherited by all recipes. They can be overridden in specific recipes by setting the quality to "Custom".</p>
              <div class="param-section !pt-0 !mt-0 !border-none">
                    <h4>Ambient Calculation Settings</h4>
                      <div class="param-grid-sim">
                                  <div class="param-item">
                                      <div class="param-item-row"><label for="ab" class="label">Ambient Bounces (-ab) <span class="info-icon">i<span class="info-popover">Max number of diffuse inter-reflections. 0 disables indirect calculation. 2-4 is standard, 5-8 for high accuracy or complex scenes.</span></span></label><input type="number" class="param-input-num" id="ab-num" data-param-name="ab-num" step="1" min="0" max="16" autocomplete="off"></div>
                                      <input type="range" id="ab" data-param-name="ab" min="0" max="16" value="4" step="1">
                                  </div>
                                      <div class="param-item">
                                      <div class="param-item-row"><label for="ad" class="label">Ambient Divisions (-ad) <span class="info-icon">i<span class="info-popover">Number of samples for indirect illuminance. Primary control for "splotchy" artifacts.</span></span></label><input type="number" class="param-input-num" id="ad-num" data-param-name="ad-num" step="64" min="0" max="8192" autocomplete="off"></div>
                                      <input type="range" id="ad" data-param-name="ad" min="0" max="8192" value="1024" step="64">
                                  </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="as" class="label">Ambient Super-samples (-as) <span class="info-icon">i<span class="info-popover">Additional samples to refine areas with high variance. Use to clean up noise after setting -ad.</span></span></label><input type="number" class="param-input-num" id="as-num" data-param-name="as-num" step="64" min="0" max="8192" autocomplete="off"></div>
                                <input type="range" id="as" data-param-name="as" min="0" max="8192" value="256" step="64">
                            </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="aa" class="label">Ambient Accuracy (-aa) <span class="info-icon">i<span class="info-popover">Error tolerance for irradiance cache interpolation. Lower values are more accurate but slower. Does not fix splotches.</span></span></label><input type="number" class="param-input-num" id="aa-num" data-param-name="aa-num" step="0.01" min="0" max="1" autocomplete="off"></div>
                                <input type="range" id="aa" data-param-name="aa" min="0" max="1" value="0.15" step="0.01">
                            </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="ar" class="label">Ambient Resolution (-ar) <span class="info-icon">i<span class="info-popover">Sets the density of the irradiance cache relative to scene size. Works with -aa.</span></span></label><input type="number" class="param-input-num" id="ar-num" data-param-name="ar-num" step="32" min="0" max="4096" autocomplete="off"></div>
                                <input type="range" id="ar" data-param-name="ar" min="0" max="4096" value="128" step="32">
                            </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="lw" class="label">Limit Weight (-lw) <span class="info-icon">i<span class="info-popover">Minimum contribution for a ray to be traced. Crucial for simulations with high -ab values.</span></span></label><input type="number" class="param-input-num" id="lw-num" data-param-name="lw-num" step="0.0001" min="0" max="0.01" autocomplete="off"></div>
                                <input type="range" id="lw" data-param-name="lw" min="0" max="0.01" value="0.002" step="0.0001">
                            </div>
                            </div>
                        </div>
                        <div class="param-section">
                            <h4>Direct & Specular Calculation Settings</h4>
                            <div class="param-grid-sim">
                                <div class="param-item">
                                <div class="param-item-row"><label for="dc" class="label">Direct Certainty (-dc) <span class="info-icon">i<span class="info-popover">A value of 1 guarantees shadow accuracy. 0.5 is a good balance.</span></span></label><input type="number" class="param-input-num" id="dc-num" data-param-name="dc-num" step="0.05" min="0" max="1" autocomplete="off"></div>
                                <input type="range" id="dc" data-param-name="dc" min="0" max="1" value="0.5" step="0.05">
                            </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="dt" class="label">Direct Thresholding (-dt) <span class="info-icon">i<span class="info-popover">Optimization to ignore insignificant light sources. For max accuracy, set to 0.</span></span></label><input type="number" class="param-input-num" id="dt-num" data-param-name="dt-num" step="0.05" min="0" max="1" autocomplete="off"></div>
                                <input type="range" id="dt" data-param-name="dt" min="0" max="1" value="0.05" step="0.05">
                            </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="dr" class="label">Direct Relays (-dr) <span class="info-icon">i<span class="info-popover">Number of relays for secondary sources (e.g., reflections in mirrors).</span></span></label><input type="number" class="param-input-num" id="dr-num" data-param-name="dr-num" step="1" min="0" max="6" autocomplete="off"></div>
                                <input type="range" id="dr" data-param-name="dr" min="0" max="6" value="1" step="1">
                            </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="dp" class="label">Direct Pre-test Density (-dp) <span class="info-icon">i<span class="info-popover">Number of samples/steradian for pre-testing secondary sources.</span></span></label><input type="number" class="param-input-num" id="dp-num" data-param-name="dp-num" step="32" min="32" max="512"></div>
                                <input type="range" id="dp" data-param-name="dp" min="32" max="512" value="64" step="32">
                            </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="ss" class="label">Specular Sampling (-ss) <span class="info-icon">i<span class="info-popover">Sampling for rough specular materials. >1 sends multiple rays to reduce noise.</span></span></label><input type="number" class="param-input-num" id="ss-num" data-param-name="ss-num" step="0.1" min="0" max="2" autocomplete="off"></div>
                                <input type="range" id="ss" data-param-name="ss" min="0" max="2" value="0.7" step="0.1">
                            </div>
                                <div class="param-item">
                                <div class="param-item-row"><label for="lr" class="label">Limit Reflection (-lr) <span class="info-icon">i<span class="info-popover">Maximum number of specular reflections. 0 uses Russian Roulette for ray termination.</span></span></label><input type="number" class="param-input-num" id="lr-num" data-param-name="lr-num" step="1" min="0" max="16" autocomplete="off"></div>
                                <input type="range" id="lr" data-param-name="lr" min="0" max="16" value="8" step="1">
                            </div>
                            </div>
                      </div>
              </div>
      </div>
      <div id="simulation-recipes-container" class="space-y-4 pt-4 mt-4 border-t-2 border-[--grid-color]">
          <h3 class="font-semibold text-sm uppercase">Simulation Recipes</h3>
            <div class="param-section">
                <label for="recipe-selector" class="label">Select Recipe</label>
                  <select id="recipe-selector" class="w-full mt-1" autocomplete="off">
                          <option value="" selected>-- Select a simulation recipe --</option>
                      </select>
                      </div>
                      <div id="recipe-parameters-container" class="mt-4">
                          <p class="text-sm text-center text-[--text-secondary] p-4">Select a recipe from the dropdown above to configure a simulation.</p>
                      </div>
                       <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                          <h4 class="text-base font-semibold mb-3">Execution</h4>
                          <div class="space-y-3">
                              <button data-action="generate" class="btn btn-primary w-full">Generate Package</button>
                              <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation</button>
                          </div>
                          <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                              <div class="flex justify-between items-center mb-2">
                                  <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                  <button class="btn btn-xs btn-secondary" title="Copy to clipboard" data-action="copy-script">Copy</button>
                              </div>
                              <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                          </div>
                      </div>
                  </div>
          </div>
          <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
      </div>

      <div id="panel-analysis-modules" class="floating-window ui-panel hidden">
          <div class="window-header">
                <span>Analysis</span>
                <div class="window-controls">
            <div class="window-icon-max"></div>
            <div class="collapse-icon"></div>
            <div class="window-icon-close"></div>
        </div>
    </div>
    <div class="window-content">
        <p class="text-sm text-gray-500 mb-6">Load a simulation results file to visualize data on the 3D model.</p>
        <div class="param-section">
            <label for="results-file-input-a" class="btn btn-secondary w-full cursor-pointer text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span>Load Results File (A)</span>
                        </label>
                        <input type="file" id="results-file-input-a" class="hidden" accept=".txt,.res,.ill,.hdr,.dgp,.ga,.epw">
                        <p id="results-file-name-a" class="text-sm text-gray-500 mt-2 text-center truncate"></p>
                    </div>
                    <div id="climate-analysis-controls" class="param-section hidden pt-4 border-t border-dashed border-[--grid-color]">
                        <button id="climate-dashboard-btn" class="btn btn-secondary w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"></path></svg>
                            <span>Climate Analysis</span>
                        </button>
                    </div>
                    <div class="param-section pt-4 border-t border-dashed border-[--grid-color]">
                        <label for="compare-mode-toggle" class="flex items-center cursor-pointer w-full">
                            <input type="checkbox" id="compare-mode-toggle">
                            <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">
                                Enable Comparative Analysis
                            </span>
                        </label>
                    </div>
                    <div id="comparison-file-loader" class="param-section hidden">
                        <label for="results-file-input-b" class="btn btn-secondary w-full cursor-pointer text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span>Load Comparison File (B)</span>
                        </label>
                        <input type="file" id="results-file-input-b" class="hidden" accept=".txt,.res,.ill,.hdr,.dgp,.ga">
                        <p id="results-file-name-b" class="text-sm text-gray-500 mt-2 text-center truncate"></p>
                    </div>
                    <div class="param-section">
                        <button id="view-hdr-btn" class="btn btn-secondary w-full hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <span>View HDR Image</span>
                        </button>
                    </div>
                    <div id="results-dashboard" class="hidden space-y-5">
                        <div class="param-section">
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">3D Visualization Mode</h4>
                            <div id="view-mode-selector" class="btn-group mt-1">
                                <button id="view-mode-a-btn" class="btn active">Dataset A</button>
                                <button id="view-mode-b-btn" class="btn hidden">Dataset B</button>
                                <button id="view-mode-diff-btn" class="btn hidden">Difference (A-B)</button>
                            </div>
                        </div>
                        <div id="summary-stats-container" class="param-section">
                            <div id="summary-a">
                                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Summary: Dataset A (lux)</h4>
                                <div class="grid grid-cols-3 gap-2 text-center mt-2">
                                    <div><span class="block text-xs">Min</span><span id="results-min-val-a" class="data-value font-mono">--</span></div>
                                    <div><span class="block text-xs">Avg</span><span id="results-avg-val-a" class="data-value font-mono">--</span></div>
                                    <div><span class="block text-xs">Max</span><span id="results-max-val-a" class="data-value font-mono">--</span></div>
                                </div>
                            </div>
                            <div id="summary-b" class="hidden mt-3">
                                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Summary: Dataset B (lux)</h4>
                                <div class="grid grid-cols-3 gap-2 text-center mt-2">
                                    <div><span class="block text-xs">Min</span><span id="results-min-val-b" class="data-value font-mono">--</span></div>
                                    <div><span class="block text-xs">Avg</span><span id="results-avg-val-b" class="data-value font-mono">--</span></div>
                                    <div><span class="block text-xs">Max</span><span id="results-max-val-b" class="data-value font-mono">--</span></div>
                                </div>
                            </div>
                        </div>
                        <div id="metric-selector-container" class="param-section hidden">
                            <label for="metric-selector" class="label">3D View Metric</label>
                            <select id="metric-selector" class="w-full mt-1">
                            </select>
                        </div>
                        <div id="color-scale-section" class="param-section">
                            <div id="standard-color-scale">
                                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Color Scale (lux)</h4>
                                <canvas id="results-legend" height="20" class="w-full mt-2 rounded border border-[--grid-color]"></canvas>
                            </div>
                            <div id="difference-color-scale" class="hidden">
                                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Difference Scale (lux)</h4>
                                <canvas id="difference-legend" height="20" class="w-full mt-2 rounded border border-[--grid-color]"></canvas>
                                <div class="flex justify-between text-xs font-mono mt-1">
                                    <span id="diff-legend-min-label">--</span>
                                    <span>0</span>
                                    <span id="diff-legend-max-label">--</span>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs font-mono mt-1">
                                <span id="legend-min-label">0</span>
                                <span id="legend-max-label">1000</span>
                            </div>
                        </div>
                        <div class="space-y-3 mt-3">
                            <div>
                                <label class="label text-xs flex justify-between" for="results-scale-min">
                                    <span>Scale Min</span>
                                    <input type="number" id="results-scale-min-num" class="param-input-num-sm">
                                </label>
                                <input type="range" id="results-scale-min" min="0" max="5000" value="0" step="10">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="results-scale-max">
                                    <span>Scale Max</span>
                                    <input type="number" id="results-scale-max-num" class="param-input-num-sm">
                                </label>
                                <input type="range" id="results-scale-max" min="0" max="5000" value="1000" step="10">
                            </div>
                        </div>
                        <div>
                            <label for="results-palette" class="label text-xs">Color Palette</label>
                            <select id="results-palette" class="w-full mt-1">
                                <option value="viridis" selected>Viridis</option>
                                <option value="plasma">Plasma</option>
                                <option value="inferno">Inferno</option>
                                <option value="magma">Magma</option>
                                <option value="cividis">Cividis</option>
                            </select>
                        </div>
                    </div>
                    <div id="glare-analysis-dashboard" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                        <div class="param-section">
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Glare Analysis (evalglare)</h4>
                            <div class="grid grid-cols-2 gap-2 text-center mt-2">
                                <div><span id="glare-metric-label" class="block text-xs">DGP</span><span id="glare-val" class="data-value font-mono text-lg">--</span></div>
                                <div><span class="block text-xs">Source Count</span><span id="glare-source-count" class="data-value font-mono text-lg">--</span></div>
                            </div>
                        </div>
                        <div class="param-section">
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Detected Glare Sources</h4>
                                <button id="clear-glare-highlight-btn" class="btn btn-xs btn-secondary">Clear</button>
                            </div>
                            <p class="info-box !text-xs !py-2 !px-3">Click on a source to highlight it in the 3D view.</p>
                            <ul id="glare-source-list" class="space-y-1.5 mt-2 text-sm max-h-60 overflow-y-auto">
                            </ul>
                        </div>
                    </div>
                    <div id="annual-glare-controls" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Annual Glare Analysis</h4>
                        <button id="glare-rose-btn" class="btn btn-secondary w-full">Generate Glare Rose Diagram</button>
                        <button id="combined-analysis-btn" class="btn btn-secondary w-full mt-2" style="display: none;">Daylight vs. Glare Plot</button>
                    </div>
                    <div class="param-section">
                        <button id="results-dashboard-btn" class="btn btn-primary w-full mt-4">Results Dashboard</button>
                        <button id="data-table-btn" class="btn btn-secondary w-full mt-2 hidden">Show Data Table</button>
                        <button id="generate-report-btn" class="btn btn-secondary w-full mt-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Generate Report</span>
                </button>
            </div>
            </div>
                <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
            </div>
        </div>

        <div id="panel-recipe-guides" class="floating-window ui-panel hidden" style="width: 600px; height: 70vh;">
            <div class="window-header">
            <span>Recipe Guides</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content space-y-4">
                <div>
                    <label for="guide-selector" class="label">Select a Recipe Guide</label>
                    <select id="guide-selector" class="w-full mt-1">
                        <option value="" disabled selected>-- Choose a guide to display --</option>
                    </select>
                </div>
                <div id="guide-content" class="prose max-w-none h-full overflow-y-auto border border-[--grid-color] p-4 rounded-md bg-[--grid-color]">
                    <p class="text-[--text-secondary]">Please select a recipe from the dropdown above to see its guide.</p>
                </div>
            </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
    </main>

    <div id="sidebar-wrapper">
    <div id="ai-assistant-toggle-container" class="action-button-container">
        <button id="ai-assistant-button" class="bottom-action-button" aria-label="Open AI Assistant">
            <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 14 14" width="28px" fill="currentColor">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M11.958 10.945a1.786 1.786 0 1 1-3.573 0 1.786 1.786 0 0 1 3.573 0Zm-.298-3.84a1.489 1.489 0 1 1-2.978 0 1.489 1.489 0 0 1 2.978 0ZM13 5.287a.744.744 0 1 1-1.489 0 .744.744 0 0 1 1.489 0ZM8.325 4.93a3.663 3.663 0 0 1-3.662 3.662A3.663 3.663 0 0 1 1 4.931a3.663 3.663 0 0 1 3.663-3.663 3.663 3.663 0 0 1 3.662 3.663Z"/>
            </svg>
        </button>
        <span class="tooltip" role="tooltip">AI Assistant</span>
        </div>
         </aside>
        <aside id="right-sidebar" class="ui-panel closed flex flex-col">
            <div class="resize-handle-edge left" style="cursor: ew-resize;"></div>
            <div class="window-header">
            <span>AI Assistant</span>
            <div class="window-controls">
                    <button id="ai-settings-btn" class="window-icon-settings" aria-label="AI Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="sidebar-content !p-0 flex flex-col">
            <div class="p-3 border-b border-[--grid-color] space-y-3">
                <div class="ai-mode-selector">
                    <label for="ai-mode-select" class="label !mb-0 flex-shrink-0">Action:</label>
                    <select id="ai-mode-select" class="flex-grow">
                        <option value="" disabled selected>Start a new chat...</option>
                        <option value="chat">Chat Assistant</option>
                        <option value="generate">Generative Design</option>
                        <option value="inspector">Design Inspector</option>
                        <option value="critique">Results Critique</option>
                        <option value="explorer">Data Explorer</option>
                        <option value="tutor">Interactive Tutor</option>
                    </select>
                </div>
                <div id="ai-mode-description-box" class="info-box !py-2 !px-3">
                    <p id="ai-mode-description-text" class="leading-relaxed"></p>
                </div>
            </div>
            <div id="ai-chat-tabs" class="ai-chat-tabs"></div>
            <div id="ai-chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto">
            </div>
            <div id="ai-inspector-results" class="flex-grow p-4 space-y-3 overflow-y-auto hidden">
                <div class="text-center text-sm text-[--text-secondary] p-4">
                    <p>Click "Run Inspector" to analyze your current project setup for potential issues and design suggestions.</p>
                </div>
            </div>
            <div id="ai-critique-results" class="flex-grow p-4 space-y-3 overflow-y-auto hidden">
            <div class="text-center text-sm text-[--text-secondary] p-4">
                <p>Load a simulation result file, then click "Analyze Results" for an AI-powered critique and design suggestions.</p>
            </div>
        </div>
        <div id="ai-chat-input-container" class="p-4 border-t border-[--grid-color] relative">
            <div id="chat-resize-handle"></div>
                    <form id="ai-chat-form" class="flex gap-2 items-end">
                        <textarea id="ai-chat-input" placeholder="Ask about Radiance or this app..." class="flex-grow" autocomplete="off" rows="1"></textarea>
                        <button type="submit" id="ai-chat-send" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
            </aside>
        </div>

            <div id="results-analysis-panel" class="floating-window ui-panel hidden">
                <div class="window-header">
                    <span>Results Analysis</span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content space-y-5">
                    <div class="param-section">
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Summary Statistics</h4>
                        <div id="results-summary-stats" class="grid grid-cols-4 gap-2 text-center mt-2">
                            <div><span class="block text-xs">Min</span><span id="stats-min-val" class="data-value font-mono">--</span></div>
                            <div><span class="block text-xs">Max</span><span id="stats-max-val" class="data-value font-mono">--</span></div>
                            <div><span class="block text-xs">Average</span><span id="stats-avg-val" class="data-value font-mono">--</span></div>
                            <div><span class="block text-xs">Uniformity</span><span id="stats-uniformity-val" class="data-value font-mono">--</span></div>
                        </div>
                    </div>
                    <div class="param-section">
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Analysis Tools</h4>
                        <div class="btn-group mt-2">
                            <button id="highlight-min-btn" class="btn btn-secondary">Highlight Min</button>
                            <button id="highlight-max-btn" class="btn btn-secondary">Highlight Max</button>
                            <button id="clear-highlights-btn" class="btn btn-secondary">Clear</button>
                        </div>
                    </div>
                    <div class="param-section">
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Illuminance Distribution</h4>
                        <div class="mt-2"><canvas id="illuminance-histogram"></canvas></div>
                    </div>
                    <div class="param-section">
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">False-Color Scale</h4>
                        <canvas id="interactive-legend" height="20" class="w-full mt-2 rounded border border-[--grid-color]"></canvas>
                        <div class="flex justify-between text-xs font-mono mt-1">
                            <span id="legend-min-val">0</span>
                            <span id="legend-max-val">1000</span>
                        </div>
                        <div class="space-y-3 mt-3">
                            <div>
                                <label class="label text-xs flex justify-between" for="scale-min-input">
                                    <span>Scale Min</span>
                                    <input type="number" id="scale-min-input-num" class="param-input-num-sm">
                                </label>
                                <input type="range" id="scale-min-input" min="0" max="5000" value="0" step="10">
                            </div>
                            <div>
                                <label class="label text-xs flex justify-between" for="scale-max-input">
                                    <span>Scale Max</span>
                                    <input type="number" id="scale-max-input-num" class="param-input-num-sm">
                                </label>
                                <input type="range" id="scale-max-input" min="0" max="5000" value="1000" step="10">
                            </div>
                        </div>
                    </div>
                    <div class="param-section">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">2D Floor Plan Heatmap</h4>
                    <div id="heatmap-controls-container" class="hidden mt-2 space-y-3">
                        <div>
                            <label for="heatmap-mode-selector" class="label text-xs">Display Mode</label>
                            <select id="heatmap-mode-selector" class="w-full mt-1">
                                <option value="illuminance">Illuminance</option>
                                <option value="da">Daylight Autonomy</option>
                            </select>
                        </div>
                        <div id="da-threshold-controls" class="hidden">
                            <label class="label text-xs flex justify-between" for="da-threshold-slider">
                                <span>DA Threshold (lux)</span>
                                <span id="da-threshold-val" class="data-value font-mono">300 lux</span>
                            </label>
                            <input type="range" id="da-threshold-slider" min="50" max="1000" value="300" step="10">
                        </div>
                    </div>
                    <div class="mt-2 aspect-square bg-[--grid-color] rounded overflow-hidden">
                        <canvas id="heatmap-canvas" class="w-full h-full"></canvas>
                    </div>
                </div>
                </div>

                <div id="annual-time-series-explorer" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Time-Series Explorer</h4>
                    <div class="pt-2">
                        <h5 class="font-semibold text-sm text-center">Space-Averaged Illuminance</h5>
                        <p class="text-xs text-center text-[--text-secondary] mt-1">Full Year (8760 hours)</p>
                        <div class="mt-2 h-40 relative"><canvas id="time-series-chart"></canvas></div>
                    </div>
                    <div class="pt-4">
                        <label class="label text-xs flex justify-between" for="time-scrubber">
                            <span>3D Scrubber (Hour of Year)</span>
                            <span id="time-scrubber-display" class="data-value font-mono">Jul 2, 12:00</span>
                        </label>
                        <div class="flex items-center space-x-3 mt-1">
                            <input type="range" id="time-scrubber" min="0" max="8759" value="4380" step="1">
                        </div>
                    </div>
              </div>
              <div id="spectral-metrics-dashboard" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Spectral Lighting Metrics</h4>
                <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <h5 class="font-semibold text-sm">Photopic</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="metric-photopic-val">--</span> lux</p>
                        </div>
                        <div>
                            <h5 class="font-semibold text-sm">Melanopic</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="metric-melanopic-val">--</span> m-EDI lux</p>
                        </div>
                        <div>
                            <h5 class="font-semibold text-sm">Neuropic</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="metric-neuropic-val">--</span> W/m²</p>
                        </div>
                    </div>
                <p class="info-box !text-xs !py-2 !px-3">These are space-averaged values from the sensor grid. Load the respective text file (e.g., photopic_illuminance.txt) to see the 3D visualization.</p>
            </div>
          </div>
          <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
      </div>
  </div>
  </div>

  <div id="sensor-context-menu" class="hidden absolute z-[1000] ui-panel !p-1">
     <button id="set-viewpoint-here-btn" class="btn btn-secondary !py-2 !px-4 !text-sm">Set Viewpoint Here</button>
  </div>

  <div id="data-table-panel" class="floating-window ui-panel hidden" style="width: 400px; height: 500px;">
      <div class="window-header">
          <span>Interactive Data Table</span>
          <div class="window-controls">
              <div class="window-icon-max"></div>
              <div class="collapse-icon"></div>
              <div class="window-icon-close"></div>
          </div>
      </div>
      <div class="window-content !p-0 flex flex-col">
          <div class="p-3 border-b border-[--grid-color]">
              <input type="text" id="data-table-filter-input" placeholder="Filter data (e.g., > 500, <= 100)" class="w-full">
          </div>
          <div class="flex-grow overflow-auto">
              <table id="results-data-table" class="w-full text-sm text-left">
                  <thead id="data-table-head" class="sticky top-0 bg-[--panel-bg] z-10">
                      </thead>
                  <tbody id="data-table-body">
                      </tbody>
              </table>
          </div>
      </div>
      <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
  </div>

  <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
      <div class="ui-panel p-6 w-full max-w-sm mx-auto bg-[--bg-main]"><h3 id="custom-alert-title" class="text-lg font-bold mb-4">Notification</h3><p id="custom-alert-message" class="text-sm mb-6"></p><button id="custom-alert-close" class="btn btn-primary w-full">Close</button></div>
  </div>
    
    <div id="epw-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="ui-panel p-6 w-full max-w-lg mx-auto bg-[--bg-main] relative">
            <button id="epw-modal-close" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800" aria-label="Close EPW Upload Modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="text-lg font-bold mb-4">Upload Climate Data File</h3>
            <div id="modal-file-drop-area" class="file-drop-area">
                <svg width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h.586a1 1 0 01.707.293l2 2a1 1 0 00.707.293H12.5A2.5 2.5 0 0115 11v.5a2.5 2.5 0 01-2.5 2.5h-1a1 1 0 00-.707.293l-2 2A1 1 0 017.586 16H7z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11h4.5a2.5 2.5 0 012.5 2.5V17a4 4 0 01-4 4h-1.5a1 1 0 01-.707-.293l-2-2A1 1 0 009.586 18H9"></path>
                </svg>
                <p>Upload EPW file or drag and drop</p>
            </div>
        </div>
    </div>
    <div id="ai-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10002] hidden items-center justify-center">
        <div class="ui-panel p-6 w-full max-w-md mx-auto bg-[--bg-main] relative">
            <button id="ai-settings-close-btn" class="absolute top-3 right-3 text-[--text-secondary] hover:text-[--text-primary]" aria-label="Close AI Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="text-lg font-bold mb-4">AI Assistant Settings</h3>
            <form id="ai-settings-form" class="space-y-4">
        <div>
        <label for="ai-provider-select" class="label">AI Provider</label>
    <select id="ai-provider-select" class="w-full">
        <option value="openrouter">OpenRouter</option>
        <option value="openai">OpenAI</option>
        <option value="gemini">Google Gemini</option>
        <option value="anthropic">Anthropic</option>
    </select>
</div>
        <div>
                <label for="ai-model-select" class="label">Model</label>
                <select id="ai-model-select" class="w-full"></select>
            </div>
            <div>
                <label for="ai-custom-model-input" class="label">Custom Model ID (Optional)</label>
                <input type="text" id="ai-custom-model-input" placeholder="e.g., gpt-4, claude-3-sonnet" class="w-full">
                <p class="text-xs text-[--text-secondary] mt-1">Enter a custom model ID if your preferred model isn't in the list above.</p>
            </div>
            <div>
                <label for="ai-model-access-token" class="label">API Key</label>
                <input type="password" id="ai-model-access-token" placeholder="Enter your API key" class="w-full" autocomplete="off">
            </div>
            <div id="openrouter-info-box" class="info-box !text-xs hidden">
                <b>Note:</b> To use free models on OpenRouter, you may need to adjust your
                <a href="https://openrouter.ai/settings/privacy" target="_blank" class="text-[--text-secondary] underline">privacy settings</a>
                to allow your data to be used for model improvement.
            </div>
            <button type="submit" class="btn btn-primary w-full mt-4">Save Settings</button>
            </form>
        </div>
    </div>

    <div id="shortcut-help-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10002] hidden items-center justify-center">
        <div class="ui-panel p-6 w-full max-w-2xl mx-auto bg-[--bg-main] relative">
            <button id="shortcut-modal-close-btn" class="absolute top-3 right-3 text-[--text-secondary] hover:text-[--text-primary]" aria-label="Close Shortcuts">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="text-lg font-bold mb-4">Keyboard Shortcuts</h3>
            <div class="grid grid-cols-2 gap-x-8 gap-y-4 text-sm">
                <div>
                    <h4 class="font-semibold uppercase text-xs text-[--text-secondary] mb-2">File</h4>
                    <div class="space-y-1">
                        <div class="flex justify-between"><span>Save Project</span><div class="flex gap-1"><kbd class="kbd">Ctrl</kbd><kbd class="kbd">S</kbd></div></div>
                        <div class="flex justify-between"><span>Load Project</span><div class="flex gap-1"><kbd class="kbd">Ctrl</kbd><kbd class="kbd">O</kbd></div></div>
                        <div class="flex justify-between"><span>Save Current View</span><div class="flex gap-1"><kbd class="kbd">Shift</kbd><kbd class="kbd">S</kbd></div></div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold uppercase text-xs text-[--text-secondary] mb-2">Views</h4>
                    <div class="space-y-1">
                        <div class="flex justify-between"><span>Perspective</span><kbd class="kbd">P</kbd></div>
                        <div class="flex justify-between"><span>Orthographic</span><kbd class="kbd">O</kbd></div>
                        <div class="flex justify-between"><span>Top</span><kbd class="kbd">T</kbd></div>
                        <div class="flex justify-between"><span>Front</span><kbd class="kbd">F</kbd></div>
                        <div class="flex justify-between"><span>Back</span><kbd class="kbd">B</kbd></div>
                        <div class="flex justify-between"><span>Left</span><kbd class="kbd">L</kbd></div>
                        <div class="flex justify-between"><span>Right</span><kbd class="kbd">R</kbd></div>
                        <div class="flex justify-between"><span>Toggle Quad View</span><kbd class="kbd">Q</kbd></div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold uppercase text-xs text-[--text-secondary] mb-2">Panels</h4>
                    <div class="space-y-1">
                        <div class="flex justify-between"><span>Project Setup</span><kbd class="kbd">1</kbd></div>
                        <div class="flex justify-between"><span>Dimensions</span><kbd class="kbd">2</kbd></div>
                        <div class="flex justify-between"><span>Apertures</span><kbd class="kbd">3</kbd></div>
                        <div class="flex justify-between"><span>Lighting</span><kbd class="kbd">4</kbd></div>
                        <div class="flex justify-between"><span>Materials</span><kbd class="kbd">5</kbd></div>
                        <div class="flex justify-between"><span>Sensor Grid</span><kbd class="kbd">6</kbd></div>
                        <div class="flex justify-between"><span>Viewpoint</span><kbd class="kbd">7</kbd></div>
                        <div class="flex justify-between"><span>Scene Elements</span><kbd class="kbd">8</kbd></div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold uppercase text-xs text-[--text-secondary] mb-2">Tools</h4>
                    <div class="space-y-1">
                        <div class="flex justify-between"><span>Info Panel</span><kbd class="kbd">I</kbd></div>
                        <div class="flex justify-between"><span>AI Assistant</span><kbd class="kbd">A</kbd></div>
                        <div class="flex justify-between"><span>Toggle FPV Mode</span><kbd class="kbd">V</kbd></div>
                        <div class="flex justify-between"><span>Toggle Gizmo</span><kbd class="kbd">G</kbd></div>
                        <div class="flex justify-between"><span>Toggle Resize Mode</span><kbd class="kbd">M</kbd></div>
                        <div class="flex justify-between"><span>Move Gizmo</span><kbd class="kbd">W</kbd></div>
                        <div class="flex justify-between"><span>Rotate Gizmo</span><kbd class="kbd">E</kbd></div>
                        <div class="flex justify-between"><span>Scale Gizmo</span><kbd class="kbd">R</kbd></div>
                    </div>
                </div>
            </div>
            <p class="text-xs text-[--text-secondary] mt-4 text-center">Shortcuts are disabled when typing in input fields.</p>
        </div>
    </div>
    <div id="bottom-left-controls" class="fixed bottom-6 left-6 z-50 flex gap-4 items-center">
        <div class="action-button-container">
            <button id="save-project-button" class="bottom-action-button" aria-label="Save Project File">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM6 6h9v4H6z"/></svg>
            </button>
            <span class="tooltip" role="tooltip">Save Project</span>
        </div>
        <div class="action-button-container">
            <button id="load-project-button" class="bottom-action-button" aria-label="Load Project File">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
            </button>
            <span class="tooltip" role="tooltip">Load Project</span>
        </div>
        <div class="action-button-container">
            <button id="info-button" class="bottom-action-button" aria-label="Show App Info">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
            </button>
            <span class="tooltip" role="tooltip">App Information</span>
            </div>
        <div class="action-button-container">
          <button id="recipe-guides-btn" class="bottom-action-button" aria-label="Show Recipe Guides">
              <svg xmlns="http://www.w3.org/2000/svg" height="28px" width="28px" viewBox="0 0 32 32">
                  <path d="M8 4h22v28H8z" style="fill:var(--btn-secondary-bg)"></path>
                  <path d="M8 4v28l16-4V0z" style="fill:var(--grid-color)"></path>
                  <path d="M2 0h22v28H2z" style="fill:var(--bg-main)"></path>
                  <path d="M26 19h2v2h-2zm3 0h1v2h-1zm-5 0h1v2h-1z" style="fill:var(--text-primary)"></path>
                  <path d="M4 7h2v2H4zm3 0h2v2H7zm6 0h2v2h-2zm3 0h2v2h-2zm0 3h2v2h-2zm0 3h2v2h-2zm0 3h2v2h-2zm3 0h2v2h-2zm3 0h2v2h-2zM2 7h1v2H2zm8 0h2v2h-2z" style="fill:var(--text-secondary)"></path>
              </svg>
          </button>
          <span class="tooltip" role="tooltip">Recipe Guides</span>
      </div>
          <div class="action-button-container">
                <button id="shortcut-help-btn" class="bottom-action-button" aria-label="Show Keyboard Shortcuts">
                    <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm-1-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg>
                </button>
                <span class="tooltip" role="tooltip">Shortcuts (?)</span>
            </div>
        </div>

        <div id="templates" class="hidden">
    <template id="template-view-target-item">
    <div class="view-target-item border border-[--grid-color] rounded p-2 space-y-2">
        <div class="flex items-center justify-between">
            <input type="text" placeholder="Description (e.g., Garden view)" 
                   class="view-target-desc input text-xs flex-1 mr-2">
            <button class="view-target-remove btn btn-xs btn-danger" aria-label="Remove view target">×</button>
        </div>
        
        <div class="grid grid-cols-3 gap-2">
            <div>
                <label class="text-xs text-[--text-secondary]">Dir X</label>
                <input type="number" step="0.1" value="0" class="view-target-dir-x input text-xs w-full">
            </div>
            <div>
                <label class="text-xs text-[--text-secondary]">Dir Y</label>
                <input type="number" step="0.1" value="0" class="view-target-dir-y input text-xs w-full">
            </div>
            <div>
                <label class="text-xs text-[--text-secondary]">Dir Z</label>
                <input type="number" step="0.1" value="1" class="view-target-dir-z input text-xs w-full">
            </div>
        </div>
        
        <div>
            <label class="label text-xs flex justify-between">
                <span>Angular Width</span>
                <span class="view-target-angle-val data-value font-mono">30°</span>
            </label>
            <input type="range" min="5" max="90" value="30" step="5" class="view-target-angle w-full">
        </div>
    </div>
</template>
            <template id="template-material-tagger">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Surface Tagger</span>
                        <div class="window-controls">
                            <div class="window-icon-max"></div>
                            <div class="collapse-icon"></div>
                            <div class="window-icon-close"></div>
                        </div>
                    </div>
                    <div class="window-content space-y-4">
                        <p class="info-box">Assign a surface type to each material from your imported model. This is critical for Radiance simulations.</p>
                        <div id="material-tag-list" class="space-y-3 max-h-60 overflow-y-auto">
                            </div>
                        <button id="finalize-import-btn" class="btn btn-primary w-full">Finalize Import</button>
                    </div>
                    <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
                </div>
            </template>
            <template id="template-material-tag-item">
                <div class="material-tag-item grid grid-cols-2 gap-4 items-center">
                    <div class="flex items-center gap-2">
                        <div class="material-swatch w-4 h-4 rounded border border-gray-400"></div>
                        <span class="material-name font-mono text-sm">material_name</span>
                    </div>
                    <select class="surface-type-selector w-full">
                        <option value="INTERIOR_WALL" selected>Wall (Interior)</option>
                        <option value="INTERIOR_FLOOR">Floor (Interior)</option>
                        <option value="INTERIOR_CEILING">Ceiling (Interior)</option>
                        <option value="GLAZING">Glazing</option>
                        <option value="FRAME">Frame</option>
                        <option value="SHADING_DEVICE">Shading Device</option>
                        <option value="IGNORE">Ignore</option>
                    </select>
                </div>
            </template>
            <template id="aperture-wall-template">
                <div class="aperture-controls space-y-5 pt-4 border-t border-[--grid-color]">
                <h3 class="font-semibold text-sm uppercase" data-template-text="heading">WALL_DIRECTION Wall Apertures</h3>
            <div>
                <label class="label" data-template-for="win-count"># of Windows</label>
                <div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="win-count" min="0" max="10" value="0" step="1"><span data-template-id="win-count-val" class="data-value font-mono w-12 text-left">0</span></div>
            </div>
            <div>
                <label class="label">Mode</label>
                    <div class="btn-group mt-1"><button data-template-id="mode-wwr-btn" class="btn active">WWR</button><button data-template-id="mode-manual-btn" class="btn">Manual</button></div>
                </div>
                <div data-template-id="wwr-controls" class="space-y-5">
                    <div><label class="label" data-template-for="wwr">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="wwr" min="0" max="0.99" value="0.4" step="0.01"><span data-template-id="wwr-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                    <div><label class="label" data-template-for="wwr-sill-height">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="wwr-sill-height" min="0" max="10" value="1.0" step="0.05"><span data-template-id="wwr-sill-height-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                </div>
                <div data-template-id="manual-controls" class="hidden space-y-5">
                    <div><label class="label" data-template-for="win-width">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="win-width" min="0.1" max="20" value="1.5" step="0.1"><span data-template-id="win-width-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                    <div><label class="label" data-template-for="win-height">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="win-height" min="0.1" max="10" value="1.2" step="0.1"><span data-template-id="win-height-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                    <div><label class="label" data-template-for="sill-height">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="sill-height" min="0" max="10" value="1.0" step="0.05"><span data-template-id="sill-height-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                </div>
                <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-sm uppercase text-gray-700" data-template-text="shading-heading">WALL_DIRECTION Wall Shading</h4>
                    <label class="flex items-center cursor-pointer" data-template-for="shading-toggle"><input type="checkbox" data-template-id="shading-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                    
                    
                <div data-template-id="shading-controls" class="hidden space-y-5">
                        <div><label class="label" data-template-for="shading-type">Device Type</label><select data-template-id="shading-type" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option><option value="imported_obj">Imported OBJ</option></select></div>
                        <div data-template-id="shading-controls-overhang" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label" data-template-for="overhang-dist-above">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-dist-above" min="0" max="1.0" value="0" step="0.05"><span data-template-id="overhang-dist-above-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>



                            <div><label class="label" data-template-for="overhang-tilt">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-tilt" min="-90" max="90" value="0" step="1"><span data-template-id="overhang-tilt-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" data-template-for="overhang-depth">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-depth" min="0" max="2.0" value="0.5" step="0.1"><span data-template-id="overhang-depth-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                            <div><label class="label" data-template-for="overhang-thick">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-thick" min="0.005" max="0.5" value="0.05" step="0.005"><span data-template-id="overhang-thick-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                            <div><label class="label" data-template-for="overhang-extension">Extension From Window (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-extension" min="0" max="1.0" value="0.0" step="0.05"><span data-template-id="overhang-extension-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        </div>
                        <div data-template-id="shading-controls-lightshelf" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button data-template-id="lightshelf-placement-ext" class="btn active">Exterior</button><button data-template-id="lightshelf-placement-int" class="btn">Interior</button><button data-template-id="lightshelf-placement-both" class="btn">Both</button></div></div>
                            <div data-template-id="lightshelf-controls-ext" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3>
                                <div><label class="label" data-template-for="lightshelf-dist-below-ext">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-dist-below-ext" min="0" max="3.0" value="0.2" step="0.05"><span data-template-id="lightshelf-dist-below-ext-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-tilt-ext">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-tilt-ext" min="-90" max="90" value="0" step="1"><span data-template-id="lightshelf-tilt-ext-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-depth-ext">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-depth-ext" min="0" max="2.0" value="0.5" step="0.1"><span data-template-id="lightshelf-depth-ext-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-thick-ext">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-thick-ext" min="0.005" max="0.5" value="0.05" step="0.005"><span data-template-id="lightshelf-thick-ext-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                            </div>
                            <div data-template-id="lightshelf-controls-int" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3>
                                <div><label class="label" data-template-for="lightshelf-dist-below-int">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-dist-below-int" min="0" max="3.0" value="0.2" step="0.05"><span data-template-id="lightshelf-dist-below-int-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-tilt-int">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-tilt-int" min="-90" max="90" value="0" step="1"><span data-template-id="lightshelf-tilt-int-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-depth-int">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-depth-int" min="0" max="2.0" value="0.5" step="0.1"><span data-template-id="lightshelf-depth-int-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-thick-int">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-thick-int" min="0.005" max="0.5" value="0.05" step="0.005"><span data-template-id="lightshelf-thick-int-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                            </div>
                        </div>
                        <div data-template-id="shading-controls-louver" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button data-template-id="louver-placement-ext" class="btn active">Exterior</button><button data-template-id="louver-placement-int" class="btn">Interior</button></div></div>
                            <div><label class="label" data-template-for="louver-slat-orientation">Slat Orientation</label><select data-template-id="louver-slat-orientation" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                            <div><label class="label" data-template-for="louver-slat-width">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-slat-width" min="0.01" max="1.0" value="0.1" step="0.01"><span data-template-id="louver-slat-width-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <div><label class="label" data-template-for="louver-slat-sep">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-slat-sep" min="0.0" max="0.5" value="0.05" step="0.01"><span data-template-id="louver-slat-sep-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                            <div><label class="label" data-template-for="louver-slat-thick">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-slat-thick" min="0.0" max="0.5" value="0.01" step="0.005"><span data-template-id="louver-slat-thick-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                            <div><label class="label" data-template-for="louver-slat-angle">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-slat-angle" min="-90" max="90" value="0" step="1"><span data-template-id="louver-slat-angle-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <<div><label class="label" data-template-for="louver-dist-to-glass">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-dist-to-glass" min="0.0" max="1.0" value="0.1" step="0.01"><span data-template-id="louver-dist-to-glass-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        </div>
                        <div data-template-id="shading-controls-imported_obj" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div>
                                <label class="label" data-template-for="shading-obj-file">OBJ File (.obj)</label>
                                <input type="file" data-template-id="shading-obj-file" accept=".obj" class="w-full text-sm">
                                <span data-file-display-for-id="shading-obj-file" class="text-xs text-[--text-secondary] truncate block mt-1">No file selected.</span>
                            </div>
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Transform</h4>
                             <div>
                                <label class="label text-xs">Position (X, Y, Z)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" data-template-id="shading-obj-pos-x" value="0" step="0.1" class="param-input-num">
                                    <input type="number" data-template-id="shading-obj-pos-y" value="0" step="0.1" class="param-input-num">
                                    <input type="number" data-template-id="shading-obj-pos-z" value="0" step="0.1" class="param-input-num">
                                </div>
                            </div>
                             <div>
                                <label class="label text-xs">Rotation (°)</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" data-template-id="shading-obj-rot-x" value="0" step="1" class="param-input-num">
                                    <input type="number" data-template-id="shading-obj-rot-y" value="0" step="1" class="param-input-num">
                                    <input type="number" data-template-id="shading-obj-rot-z" value="0" step="1" class="param-input-num">
                                </div>
                            </div>
                            <div>
                                <label class="label text-xs">Scale</label>
                                <div class="grid grid-cols-3 gap-2 mt-1">
                                    <input type="number" data-template-id="shading-obj-scale-x" value="1" step="0.05" class="param-input-num">
                                    <input type="number" data-template-id="shading-obj-scale-y" value="1" step="0.05" class="param-input-num">
                                    <input type="number" data-template-id="shading-obj-scale-z" value="1" step="0.05" class="param-input-num">
                                </div>
                            </div>
                            <p class="info-box !text-xs !py-2 !px-3">Click the imported object in the 3D view to use the transform gizmo for interactive placement.</p>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <input type="file" id="custom-asset-importer" class="hidden" accept=".obj,.mtl" multiple>

        <div id="panel-templates">
            <template id="template-recipe-illuminance">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Illuminance Map</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <h4>Sky Definition (gensky)</h4>
                                <p class="info-box !mb-4">Define the sky for a specific moment. Location is taken from the Project Setup panel.</p>
                                <div class="grid grid-cols-3 gap-4">
                                <div><label for="pit-month" class="label">Month</label><input type="number" id="pit-month" min="1" max="12" value="6" autocomplete="off"></div>
                                <div><label for="pit-day" class="label">Day</label><input type="number" id="pit-day" min="1" max="31" value="21" autocomplete="off"></div>
                                <div><label for="pit-time" class="label">Time (HH:MM)</label><input type="time" id="pit-time" value="14:30" autocomplete="off"></div>
                            </div>
                            </div>
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Grid-Based Illuminance (rtrace)</h4>
                                <p class="info-box">Calculates illuminance or irradiance values on a sensor grid. Uses global simulation parameters for the calculation.</p>
                                <div class="param-section">
                                    <h5>Calculation Mode &amp; Switches</h5>
                                    <div class="param-grid-sim mt-2">
                                        <div>
                                            <label class="label">Calculation Mode
                                                <span class="info-icon">i<span class="info-popover"><b>-I (Irradiance):</b> Computes irradiance directly. Input is measurement point and surface normal.<br><br><b>-i (Illuminance):</b> Computes radiance first, then converts to illuminance. Input is a ray origin and direction.</span></span>
                                            </label>
                                            <div class="btn-group"><button id="rtrace-mode-I" class="btn active" title="-I">Irradiance (-I)</button><button id="rtrace-mode-i" class="btn" title="-i">Illuminance (-i)</button></div>
                                        </div>
                                        <div>
                                            <label class="label">General Switches</label>
                                            <div class="space-y-2">
                                                <label class="flex items-center cursor-pointer"><input type="checkbox" id="rtrace-h"><span class="ml-2 text-sm">Suppress Header (-h)</span></label>
                                                <label class="flex items-center cursor-pointer"><input type="checkbox" id="rtrace-w" checked><span class="ml-2 text-sm">Suppress Warnings (-w)</span></label>
                                                <label class="flex items-center cursor-pointer"><input type="checkbox" id="rtrace-u"><span class="ml-2 text-sm">Uncorrelated Sampling (-u)</span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            
                        </div>
                </template>

                <template id="template-recipe-rendering">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Photorealistic Rendering</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <h4>Sky Definition (gensky)</h4>
                                <p class="info-box !mb-4">Define the sky for a specific moment. Location is taken from the Project Setup panel.</p>
                                <div class="grid grid-cols-3 gap-4">
                                    <div><label for="pit-month" class="label">Month</label><input type="number" id="pit-month" min="1" max="12" value="6" autocomplete="off"></div>
                                    <div><label for="pit-day" class="label">Day</label><input type="number" id="pit-day" min="1" max="31" value="21" autocomplete="off"></div>
                                    <div><label for="pit-time" class="label">Time (HH:MM)</label><input type="time" id="pit-time" value="14:30" autocomplete="off"></div>
                                </div>
                            </div>
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Image-Based Rendering (rpict)</h4>
                                <p class="info-box">Creates a physically-based image. Uses the view from the 'Viewpoint' panel and quality settings from 'Global Simulation Parameters'. Add or override specific settings below.</p>
                                <div class="accordion-item open">
                                    <div class="accordion-header">Image Size &amp; Resolution <div class="accordion-chevron">▶</div></div>
                                    <div>
                                        <div class="param-grid-sim">
                                            <div><label class="label" for="rpict-x">X Resolution (-x)</label><input type="number" id="rpict-x" min="1" value="512" autocomplete="off"></div>
                                            <div><label class="label" for="rpict-y">Y Resolution (-y)</label><input type="number" id="rpict-y" min="1" value="512" autocomplete="off"></div>
                                            <div><label class="label" for="rpict-pa">Pixel Aspect Ratio (-pa)</label><input type="number" id="rpict-pa" min="0" value="1.0" step="0.1" autocomplete="off"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <div class="accordion-header">Image Sampling &amp; Filtering <div class="accordion-chevron">▶</div></div>
                                    <div style="display:none;">
                                        <div class="param-grid-sim">
                                            <div class="param-item">
                                                <div class="param-item-row"><label for="rpict-ps" class="label">Pixel Sampling (-ps)</label><input type="number" class="param-input-num" id="rpict-ps-num" step="1" min="0" max="48"></div>
                                                <input type="range" id="rpict-ps" min="0" max="48" value="8" step="1">
                                            </div>
                                            <div class="param-item">
                                                <div class="param-item-row"><label for="rpict-pt" class="label">Sampling Threshold (-pt)</label><input type="number" class="param-input-num" id="rpict-pt-num" step="0.01" min="0" max="1" autocomplete="off"></div>
                                                <input type="range" id="rpict-pt" min="0" max="1" value="0.05" step="0.01" autocomplete="off">
                                            </div>
                                            <div class="param-item">
                                                <div class="param-item-row"><label for="rpict-pj" class="label">Pixel Jitter (-pj)</label><input type="number" class="param-input-num" id="rpict-pj-num" step="0.1" min="0" max="1" autocomplete="off"></div>
                                                <input type="range" id="rpict-pj" min="0" max="1" value="0.9" step="0.1" autocomplete="off">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <div class="accordion-header">General Switches<div class="accordion-chevron">▶</div></div>
                                    <div style="display:none;">
                                        <div class="grid grid-cols-2 gap-2 mt-2">
                                            <label class="flex items-center cursor-pointer"><input type="checkbox" id="rpict-i"><span class="ml-2 text-sm">Compute Irradiance (-i)</span></label>
                                            <label class="flex items-center cursor-pointer"><input type="checkbox" id="rpict-dv" checked><span class="ml-2 text-sm">Source Visible (-dv)</span></label>
                                            <label class="flex items-center cursor-pointer"><input type="checkbox" id="rpict-bv"><span class="ml-2 text-sm">Backface Visible (-bv)</span></label>
                                            <label class="flex items-center cursor-pointer"><input type="checkbox" id="rpict-w" checked><span class="ml-2 text-sm">Suppress Warnings (-w)</span></label>
                                        </div>
                                    </div>
                                </div>
        
                    </div>
                </template>

                <div id="lighting-energy-dashboard" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                </div>

                <div id="circadian-metrics-dashboard" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Circadian Health Metrics</h4>
                    <p class="info-box !text-xs !py-2 !px-3">Average metrics from the sensor grid based on the spectral simulation. Calculated from <code>circadian_summary.json</code>.</p>
                    <div class="grid grid-cols-2 gap-4 text-center items-center">
                        <div>
                            <h5 class="font-semibold text-sm">Circadian Stimulus (CS)</h5>
                            <div class="relative w-32 h-16 mx-auto mt-2">
                                <canvas id="cs-gauge"></canvas>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="cs-value" class="data-value font-mono text-2xl">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 text-left">
                            <div>
                                <h5 class="font-semibold text-sm">EML</h5>
                                <p class="data-value font-mono text-lg"><span id="eml-value">--</span> lux</p>
                            </div>
                            <div>
                                <h5 class="font-semibold text-sm">CCT</h5>
                                <p class="data-value font-mono text-lg"><span id="cct-value">--</span> K</p>
                            </div>
                        </div>
                    </div>
                    <div class="param-section">
                        <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">WELL v2 L03 Compliance</h5>
                        <ul id="well-compliance-checklist" class="mt-2 space-y-1 text-sm">
                        </ul>
                    </div>
                </div>

                <template id="template-recipe-dgp">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Daylight Glare Probability (DGP)</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <h4>Sky Definition (gensky)</h4>
                                <p class="info-box !mb-4">Define the sky for a specific moment. Location is taken from the Project Setup panel.</p>
                                <div class="grid grid-cols-3 gap-4">
                                    <div><label for="pit-month" class="label">Month</label><input type="number" id="pit-month" min="1" max="12" value="6" autocomplete="off"></div>
                                    <div><label for="pit-day" class="label">Day</label><input type="number" id="pit-day" min="1" max="31" value="21" autocomplete="off"></div>
                                    <div><label for="pit-time" class="label">Time (HH:MM)</label><input type="time" id="pit-time" value="14:30" autocomplete="off"></div>
                                </div>
                            </div>
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Daylight Glare Probability (evalglare)</h4>
                                <p class="info-box">Calculates glare from a 180° fisheye image. For accurate results, use high-quality rendering parameters. Viewpoint must be set to fisheye.</p>
                                <div class="param-section">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="evalglare-t">
                                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Define Task Area (-t)<span class="info-icon">i<span class="info-popover">Defines a task area on the image to automatically determine the glare threshold based on the average luminance within that area. This is the recommended method.</span></span></span>
                                    </label>
                                </div>
                                <div class="param-section">
                                    <h5>Verification &amp; Output</h5>
                                    <div class="space-y-3 mt-2">
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" id="evalglare-c" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Create Check File (-c)<span class="info-icon">i<span class="info-popover">Generates a visual check image (e.g., check.hdr) with detected glare sources highlighted. Invaluable for verification.</span></span></span></label>
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" id="evalglare-d" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Detailed Output (-d)<span class="info-icon">i<span class="info-popover">Produces detailed output, listing the properties of each individual glare source found.</span></span></span></label>
                                    </div>
                                </div>
                            </div>

                        </div>
                </template>

                <template id="template-recipe-df">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Daylight Factor</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Daylight Factor</h4>
                                <p class="info-box">Calculates Daylight Factor. A standard calculation uses a CIE Overcast Sky, but other types are available for non-standard analysis.</p>
                                <div class="param-section">
                                    <h5>gensky Parameters for DF</h5>
                                    <div class="param-grid-sim mt-2">
                                        <div>
                                            <label class="label" for="df-sky-type">Sky Type</label>
                                            <select id="df-sky-type" class="w-full mt-1">
                                                <option value="-c" selected>Overcast (-c)</option>
                                                <option value="+s">Sunny w/ Sun (+s)</option>
                                                <option value="-s">Sunny w/o Sun (-s)</option>
                                                <option value="+i">Intermediate w/ Sun (+i)</option>
                                                <option value="-i">Intermediate w/o Sun (-i)</option>
                                                <option value="-u">Uniform (-u)</option>
                                            </select>
                                        </div>
                                        <div class="param-item">
                                            <div class="param-item-row">
                                                <label for="df-ground-refl" class="label">Ground Reflectance (-g)</label>
                                                <input type="number" class="param-input-num" id="df-ground-refl-num" step="0.01" min="0" max="1" autocomplete="off">
                                            </div>
                                            <input type="range" id="df-ground-refl" min="0" max="1" value="0.2" step="0.01" autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="param-grid-sim mt-4">
                                        <div class="param-item">
                                            <div class="param-item-row">
                                                <label for="df-irrad" class="label">Diffuse Horizontal Irradiance (-B)
                                                    <span class="info-icon">i<span class="info-popover">To achieve a standard outdoor illuminance of 10,000 lux for DF calculations, a horizontal irradiance of <b>55.866 W/m²</b> is used with a CIE Overcast Sky. This may not apply to other sky types.</span></span>
                                                </label>
                                                <input type="number" class="param-input-num" id="df-irrad-num" step="0.001" min="0" max="200" autocomplete="off">
                                            </div>
                                            <input type="range" id="df-irrad" min="0" max="200" value="55.866" step="0.001" autocomplete="off">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                </template>

                <template id="template-recipe-annual-3ph">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Annual Daylight (3-Phase)</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="param-section">
                                <h4 class="text-base font-semibold">Three-Phase Method Parameters (V T D S)</h4>
                                <p class="info-box">Decouples the light path into View (V), Transmission (T), Daylight (D) and Sky (S) matrices. </p>
                                <div class="param-section mt-4">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Phase 1: Sky Matrix (S) - gendaymtx</h5>
                                    <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                                </div>
                                <div class="param-section mt-4">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Phase 2: Transmission (T) - genBSDF</h5>
                                    <div><label class="label" for="bsdf-file">BSDF File (.xml)</label><input type="file" id="bsdf-file" accept=".xml" class="w-full text-sm"></div>
                                </div>
                                <div class="param-section mt-4">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Phase 3: V & D Matrices - rcontrib</h5>
                                    <p class="info-box !text-xs !py-2 !px-3">These are computationally intensive steps. Ambient parameters from the Advanced section will be used.</p>
                                </div>
                            </div>

                    </div>
                </template>

                <template id="template-recipe-annual-5ph">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Annual Daylight (5-Phase)</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="param-section">
                                <h4 class="text-base font-semibold">Five-Phase Method Parameters</h4>
                                <p class="info-box">Extends the 3-Phase method for higher accuracy with complex fenestration by precisely modeling direct sun. Provide the core weather and BSDF files below.</p>
                                <div class="param-section mt-4">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Required User Inputs</h5>
                                    <p class="info-box !text-xs !py-2 !px-3 !mb-3">Specify the paths to the core input files. All other matrices will be generated by the script.</p>
                                    <div class="space-y-3">
                                        <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                                        <div><label class="label" for="bsdf-klems">Klems BSDF (T)</label><input type="file" id="bsdf-klems" accept=".xml" class="w-full text-sm"></div>
                                        <div><label class="label" for="bsdf-tensor">Tensor Tree BSDF (for Cds)</label><input type="file" id="bsdf-tensor" accept=".xml" class="w-full text-sm"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                <template id="template-recipe-imageless-glare">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Imageless Annual Glare</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <p class="info-box">This recipe requires a "View Grid" to be defined in the Sensor Grid panel.</p>
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="param-section space-y-3">
                                <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                                <div><label class="label" for="occupancy-schedule">Occupancy Schedule (.csv) (Optional)</label><input type="file" id="occupancy-schedule" accept=".csv" class="w-full text-sm"></div>
                                <div class="param-item">
                                    <div class="param-item-row"><label for="glare-threshold" class="label">Glare Threshold (DGP)</label><input type="number" class="param-input-num" id="glare-threshold-num" step="0.01" min="0" max="1" autocomplete="off"></div>
                                    <input type="range" id="glare-threshold" min="0" max="1" value="0.4" step="0.01" autocomplete="off">
                                </div>
                                <div class="param-item">
                                    <label for="glare-autonomy-target" class="label">Spatial Glare Autonomy Target (%)</label>
                                    <input type="number" id="glare-autonomy-target" class="w-full mt-1" min="0" max="100" value="95" autocomplete="off">
                                </div>
                            </div>
                        </div>
                    </template>
                  <template id="template-recipe-spectral-lark">
                  <div class="floating-window ui-panel">
                      <div class="window-header">
                          <span>Recipe: Spectral Analysis (Lark)</span>
                          <div class="window-controls">
                              <div class="window-icon-max"></div>
                              <div class="collapse-icon"></div>
                              <div class="window-icon-close"></div>
                          </div>
                      </div>
                      <div class="window-content">
                          <div class="param-section">
                              <h4 class="text-base font-semibold">Multi-Channel Spectral Simulation</h4>
                              <p class="info-box">Generates spectral irradiance and HDR images using the Lark methodology. Requires spectral data files for materials and light sources, which can be set in the Materials and Lighting panels.</p>
                          </div>

                          <div class="param-section">
                              <h4>Simulation Methods</h4>
                              <div class="space-y-2">
                                  <label class="flex items-center cursor-pointer"><input type="checkbox" id="lark-run-9ch-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Run 9-Channel Spectral Simulation (High Accuracy)</span></label>
                                  <label class="flex items-center cursor-pointer"><input type="checkbox" id="lark-run-3ch-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Run 3-Channel Spectral Simulation (Faster)</span></label>
                              </div>
                          </div>

                          <div class="param-section">
                              <h4>Sky & Sun Definition (Common Inputs)</h4>
                              <div class="grid grid-cols-3 gap-4">
                                  <div><label for="lark-month" class="label">Month</label><input type="number" id="lark-month" min="1" max="12" value="6" autocomplete="off"></div>
                                  <div><label for="lark-day" class="label">Day</label><input type="number" id="lark-day" min="1" max="31" value="21" autocomplete="off"></div>
                                  <div><label for="lark-time" class="label">Time (HH:MM)</label><input type="time" id="lark-time" value="14:30" autocomplete="off"></div>
                              </div>
                              <div class="grid grid-cols-2 gap-4 mt-4">
                                  <div><label for="lark-dni" class="label">Direct Normal Irradiance (W/m²)</label><input type="number" id="lark-dni" min="0" value="750" autocomplete="off"></div>
                                  <div><label for="lark-dhi" class="label">Diffuse Horizontal Irradiance (W/m²)</label><input type="number" id="lark-dhi" min="0" value="150" autocomplete="off"></div>
                              </div>
                          </div>

                          <div class="param-section">
                              <h4>Spectral Data Files (Common Inputs)</h4>
                              <div class="space-y-3">
                                  <div><label for="lark-sun-spd" class="label">Sun Spectral Power Distribution (.spd)</label><input type="file" id="lark-sun-spd" accept=".spd,.txt" class="w-full text-sm"></div>
                                  <div><label for="lark-sky-spd" class="label">Sky Spectral Power Distribution (.spd)</label><input type="file" id="lark-sky-spd" accept=".spd,.txt" class="w-full text-sm"></div>
                              </div>
                          </div>

                          <div class="param-section">
                              <label for="quality-preset" class="label">Quality Preset</label>
                              <select id="quality-preset" class="w-full mt-1">
                                  <option value="draft">Draft (Fast)</option>
                                  <option value="medium" selected>Medium (Balanced)</option>
                                  <option value="high">High (Accurate)</option>
                                  <option value="custom">Custom</option>
                              </select>
                          </div>

                          <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                  </div>
            </template>
            
            <template id="template-recipe-sda-ase">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: sDA & ASE (LM-83)</span>
                        <div class="window-controls">
                            <div class="window-icon-max"></div>
                            <div class="collapse-icon"></div>
                            <div class="window-icon-close"></div>
                        </div>
                    </div>
                    <div class="window-content">
                        <div class="param-section">
                            <h4 class="text-base font-semibold">LM-83 Simulation Inputs</h4>
                            <p class="info-box">This recipe runs the full sDA/ASE workflow, including dynamic blind simulation. It generates two key results files: one for ASE (direct-only) and one for sDA (with shades operated).</p>
                            <div class="space-y-3 mt-4">
                                <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                                <div><label class="label" for="bsdf-open-file">BSDF - Blinds Open (.xml)</label><input type="file" id="bsdf-open-file" accept=".xml" class="w-full text-sm"></div>
                                <div><label class="label" for="bsdf-closed-file">BSDF - Blinds Closed (.xml)</label><input type="file" id="bsdf-closed-file" accept=".xml" class="w-full text-sm"></div>
                            </div>
                        </div>
                    <div class="param-section">
                            <h4 class="text-base font-semibold">Blind Operation Parameters</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="label" for="blinds-threshold-lux">Illuminance Threshold (lux)</label><input type="number" id="blinds-threshold-lux" value="1000" min="0" step="50" class="w-full mt-1"></div>
                                <div><label class="label" for="blinds-trigger-percent">Area Trigger (%)</label><input type="number" id="blinds-trigger-percent" value="2" min="0" max="100" step="1" class="w-full mt-1" autocomplete="off"></div>
                            </div>
                        </div>
                  </div>
                  <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
            </template>

            <template id="template-recipe-en17037">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: EN 17037 Compliance Check</span>
                        <div class="window-controls">
                            <div class="window-icon-max"></div>
                            <div class="collapse-icon"></div>
                            <div class="window-icon-close"></div>
                        </div>
                    </div>
                    <div class="window-content">
                        <p class="info-box">This recipe runs the necessary simulations to check for compliance with the four pillars of the EN 17037 daylighting standard.</p>

                        <div class="param-section">
                            <label for="en17037-provision-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="en17037-provision-toggle" checked>
                                <h4 class="ml-3 font-semibold text-sm uppercase">1. Daylight Provision</h4>
                            </label>
                            <div id="en17037-provision-controls" class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <p class="text-xs text-gray-400">Uses Climate-Based Method 2. Requires an annual simulation.</p>
                                <div>
                                    <label for="en17037-provision-level" class="label">Target Performance Level</label>
                                    <select id="en17037-provision-level" class="w-full mt-1">
                                        <option value="minimum" selected>Minimum</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="param-section">
                            <label for="en17037-sunlight-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="en17037-sunlight-toggle" checked>
                                <h4 class="ml-3 font-semibold text-sm uppercase">2. Exposure to Sunlight</h4>
                            </label>
                            <div id="en17037-sunlight-controls" class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <p class="text-xs text-gray-400">Checks for direct sun access on a specific day.</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="en17037-sunlight-date" class="label text-xs">Reference Day</label>
                                        <input type="text" id="en17037-sunlight-date" class="w-full mt-1 flatpickr-input" placeholder="Select date...">
                                    </div>
                                    <div>
                                        <label for="en17037-sunlight-level" class="label text-xs">Target Duration</label>
                                        <select id="en17037-sunlight-level" class="w-full mt-1">
                                            <option value="minimum" selected>Minimum (1.5 hours)</option>
                                            <option value="medium">Medium (3.0 hours)</option>
                                            <option value="high">High (4.0 hours)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="param-section">
                            <label for="en17037-view-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="en17037-view-toggle" checked>
                                <h4 class="ml-3 font-semibold text-sm uppercase">3. View Out</h4>
                            </label>
                            <div id="en17037-view-controls" class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <p class="text-xs text-gray-400">Generates a fisheye image for manual verification of view quality (Horizontal Sight Angle, Layers, etc.).</p>
                                <label for="en17037-view-factor-toggle" class="flex items-center cursor-pointer w-full !text-xs !text-gray-400 mt-2">
                                    <input type="checkbox" id="en17037-view-factor-toggle">
                                    <span class="ml-3 label !text-gray-400 !uppercase-none !font-normal">Also run quantitative View Factor calculation</span>
                                </label>
                                <div class="pt-2">
                                    <label for="en17037-view-level" class="label">Target Performance Level</label>
                                    <select id="en17037-view-level" class="w-full mt-1">
                                        <option value="minimum" selected>Minimum</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="param-section">
                            <label for="en17037-glare-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="en17037-glare-toggle" checked>
                                <h4 class="ml-3 font-semibold text-sm uppercase">4. Protection from Glare</h4>
                            </label>
                            <div id="en17037-glare-controls" class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <p class="text-xs text-gray-400">Uses imageless annual DGP. Requires a 'View Grid' to be defined.</p>
                                 <div>
                                    <label for="en17037-glare-level" class="label">Target Performance Level</label>
                                    <select id="en17037-glare-level" class="w-full mt-1">
                                        <option value="minimum" selected>Minimum (DGP ≤ 0.45)</option>
                                        <option value="medium">Medium (DGP ≤ 0.40)</option>
                                        <option value="high">High (DGP ≤ 0.35)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                </div>
            </template>

            <template id="template-recipe-en-illuminance">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: EN 12464-1 Illuminance</span>
                        <div class="window-controls"><div class="window-icon-max"></div><div class="collapse-icon"></div><div class="window-icon-close"></div></div>
                    </div>
                    <div class="window-content">
                        <p class="info-box">Verifies maintained illuminance ($E_m$) and uniformity ($U_0$) on the Task and Surrounding grids defined in the Sensor Grid panel.</p>
                        <div class="param-section">
                            <label for="quality-preset" class="label">Calculation Quality</label>
                            <select id="quality-preset" class="w-full mt-1">
                                <option value="draft">Draft (Fast)</option>
                                <option value="medium">Medium (Balanced)</option>
                                <option value="high" selected>Compliance (High Quality)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                            <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                            <div class="accordion-content" style="display: none;"></div>
                        </div>
                        <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                          <button data-action="generate" class="btn btn-primary w-full">Generate Illuminance Check Package</button>
                      </div>
                  </div>
                  <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
              </div>
          </template>

        <template id="template-recipe-lighting-energy">
            <div class="floating-window ui-panel">
                <div class="window-header">
                    <span>Recipe: Lighting Energy Analysis</span>
                    <div class="window-controls"><div class="window-icon-max"></div><div class="collapse-icon"></div><div class="window-icon-close"></div></div>
                </div>
                <div class="window-content">
                    <p class="info-box">Runs an annual simulation using daylighting controls to estimate electric lighting energy usage and savings. This requires the same inputs as the sDA/ASE recipe.</p>
                    <div class="param-section">
                        <h4 class="text-base font-semibold">Simulation Inputs</h4>
                        <div class="space-y-3 mt-4">
                            <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                            <div><label class="label" for="bsdf-open-file">BSDF - Blinds Open (.xml)</label><input type="file" id="bsdf-open-file" accept=".xml" class="w-full text-sm"></div>
                            <div><label class="label" for="bsdf-closed-file">BSDF - Blinds Closed (.xml)</label><input type="file" id="bsdf-closed-file" accept=".xml" class="w-full text-sm"></div>
                        </div>
                    </div>
                    <div class="param-section">
                        <h4 class="text-base font-semibold">Blind Operation Parameters</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label" for="blinds-threshold-lux">Illuminance Threshold (lux)</label><input type="number" id="blinds-threshold-lux" value="1000" min="0" step="50" class="w-full mt-1" autocomplete="off"></div>
                            <div><label class="label" for="blinds-trigger-percent">Area Trigger (%)</label><input type="number" id="blinds-trigger-percent" value="2" min="0" max="100" step="1" class="w-full mt-1" autocomplete="off"></div>
                        </div>
                    </div>
                    <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                        <h4 class="text-base font-semibold mb-3">Execution</h4>
                      <button data-action="generate" class="btn btn-primary w-full">Generate Energy Analysis Package</button>
                  </div>
              </div>
              <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
          </div>
            </template>

            <template id="template-recipe-facade-irradiation">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: Façade Irradiation Analysis</span>
                        <div class="window-controls">
                            <div class="window-icon-max"></div>
                            <div class="collapse-icon"></div>
                            <div class="window-icon-close"></div>
                        </div>
                    </div>
                    <div class="window-content">
                        <p class="info-box">Calculates the total annual solar irradiation (kWh/m²/year) on a vertical surface placed in front of a selected façade, accounting for shading from the building itself and any attached shading devices.</p>
                        
                        <div class="param-section">
                            <h4 class="text-base font-semibold">Analysis Plane & Grid</h4>
                            <div class="space-y-3 mt-4">
                                <div>
                                    <label for="facade-selection" class="label">Target Façade</label>
                                    <select id="facade-selection" class="w-full mt-1">
                                        <option value="S" selected>South</option>
                                        <option value="N">North</option>
                                        <option value="E">East</option>
                                        <option value="W">West</option>
                                    </select>
                                </div>
                                <div class="param-item">
                                    <div class="param-item-row">
                                        <label for="facade-offset" class="label">Offset from Façade (m)</label>
                                        <input type="number" class="param-input-num" id="facade-offset-num" step="0.05" min="0" max="5" autocomplete="off">
                                    </div>
                                    <input type="range" id="facade-offset" min="0" max="5" value="0.05" step="0.05" autocomplete="off">
                                </div>
                                <div class="param-item">
                                    <div class="param-item-row">
                                        <label for="facade-grid-spacing" class="label">Grid Spacing (m)</label>
                                        <input type="number" class="param-input-num" id="facade-grid-spacing-num" step="0.1" min="0.1" max="5" autocomplete="off">
                                    </div>
                                    <input type="range" id="facade-grid-spacing" min="0.1" max="5" value="0.5" step="0.1" autocomplete="off">
                                </div>
                            </div>
                        </div>

                        <div class="param-section">
                            <h4 class="text-base font-semibold">Required Inputs</h4>
                            <div class="space-y-3 mt-4">
                                <div>
                                    <label class="label" for="weather-file">Weather File (.epw)</label>
                                    <input type="file" id="weather-file" accept=".epw" class="w-full text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                        <button data-action="generate" class="btn btn-primary w-full">Generate Irradiation Analysis Package</button>
                    </div>
                </div>
            </template>

            <template id="template-recipe-en-ugr">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: EN 12464-1 UGR</span>
                        <div class="window-controls"><div class="window-icon-max"></div><div class="collapse-icon"></div><div class="window-icon-close"></div></div>
                    </div>
                    <div class="window-content">
                        <p class="info-box">Calculates the Unified Glare Rating (UGR) from the observer position defined in the Viewpoint panel.</p>
                        <div class="param-section">
                            <div><label for="ugr-limit" class="label">UGR Limit ($UGR_L$)</label><input type="number" id="ugr-limit" value="19" min="0" step="1" class="w-full mt-1" autocomplete="off"></div>
                        </div>
                        <div class="param-section">
                            <label for="quality-preset" class="label">Calculation Quality</label>
                            <select id="quality-preset" class="w-full mt-1">
                                <option value="draft">Draft (Fast)</option>
                                <option value="medium">Medium (Balanced)</option>
                                <option value="high" selected>Compliance (High Quality)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
            </template>

            <template id="template-recipe-facade-irradiation">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Façade Irradiation Analysis</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <p class="info-box">Calculates the total annual solar irradiation (kWh/m²/year) on a vertical surface placed in front of a selected façade, accounting for shading from the building itself and any attached shading devices.</p>
                            
                            <div class="param-section">
                                <h4 class="text-base font-semibold">Analysis Plane & Grid</h4>
                                <div class="space-y-3 mt-4">
                                    <div>
                                        <label for="facade-selection" class="label">Target Façade</label>
                                        <select id="facade-selection" class="w-full mt-1">
                                            <option value="S" selected>South</option>
                                            <option value="N">North</option>
                                            <option value="E">East</option>
                                            <option value="W">West</option>
                                        </select>
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row">
                                            <label for="facade-offset" class="label">Offset from Façade (m)</label>
                                            <input type="number" class="param-input-num" id="facade-offset-num" step="0.05" min="0" max="5" autocomplete="off">
                                        </div>
                                        <input type="range" id="facade-offset" min="0" max="5" value="0.05" step="0.05" autocomplete="off">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row">
                                            <label for="facade-grid-spacing" class="label">Grid Spacing (m)</label>
                                            <input type="number" class="param-input-num" id="facade-grid-spacing-num" step="0.1" min="0.1" max="5" autocomplete="off">
                                        </div>
                                        <input type="range" id="facade-grid-spacing" min="0.1" max="5" value="0.5" step="0.1" autocomplete="off">
                                    </div>
                                </div>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Required Inputs</h4>
                                <div class="space-y-3 mt-4">
                                    <div>
                                        <label class="label" for="weather-file">Weather File (.epw)</label>
                                        <input type="file" id="weather-file" accept=".epw" class="w-full text-sm">
                                    </div>
                                </div>
                            </div>
                    </div>
            </template>

        <template id="template-recipe-annual-radiation">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: Annual Solar Radiation</span>
                        <div class="window-controls">
                            <div class="window-icon-max"></div>
                            <div class="collapse-icon"></div>
                            <div class="window-icon-close"></div>
                        </div>
                    </div>
                    <div class="window-content">
                        <p class="info-box">Calculates the total annual solar radiation (kWh/m²/year) on interior surfaces, including the effect of shading devices. Ensure you have enabled sensor grids on the desired surfaces (e.g., floor, walls) in the Sensor Grid panel.</p>
                        <div class="param-section">
                            <label for="quality-preset" class="label">Calculation Quality</label>
                            <select id="quality-preset" class="w-full mt-1">
                                <option value="draft">Draft (Fast)</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="high">High (Accurate)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="param-section space-y-3">
                            <div>
                                <label class="label" for="weather-file">Weather File (.epw)</label>
                                <input type="file" id="weather-file" accept=".epw" class="w-full text-sm">
                            </div>
                        </div>
                </div>
            </template>

        </div>

        <div id="bsdf-viewer-panel" class="floating-window ui-panel hidden" style="width: 500px; height: 650px;">
        <div class="window-header">
            <span>BSDF Viewer</span>
            <div class="window-controls">
                <div class="window-icon-max"></div>
                <div class="collapse-icon"></div>
                <div class="window-icon-close"></div>
            </div>
        </div>
        <div class="window-content !p-4 flex flex-col">
            <div class="param-section">
                <div id="bsdf-info-display" class="info-box !text-xs !py-2 !px-3 mb-4">Loading BSDF data...</div>
                <label for="bsdf-incident-angle-select" class="label">Incident Angle (Theta, Phi)</label>
                <select id="bsdf-incident-angle-select" class="w-full mt-1"></select>
            </div>
            <div class="relative aspect-square bg-[--grid-color] rounded p-2 mt-4 flex-grow">
                <canvas id="bsdf-polar-plot-canvas"></canvas>
            </div>
        </div>
        <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "d3-delaunay": "https://unpkg.com/d3-delaunay?module",
            "lsystem": "https://esm.sh/lsystem"
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script type="module" src="scripts/resultsManager.js"></script>
    <script type="module" src="scripts/annualDashboard.js"></script>
    <script type="module" src="scripts/hdrViewer.js"></script>
    <script type="module" src="scripts/lighting.js"></script>
    <script type="module" src="scripts/sunTracer.js"></script>
    <script type="module" src="scripts/main.js"></script>
    <script type="module" src="scripts/ai-assistant.js"></script>

</body>
</html>
