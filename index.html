<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ray Modeler</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 511.987 511.987'><rect x='66.717' y='204.027' transform='matrix(-0.2411 -0.9705 0.9705 -0.2411 -177.6681 420.4137)' fill='%23B6F2FC' width='17.648' height='151.29'/><polygon fill='%238ED7E0' points='235.67,98.502 417.524,413.484 53.815,413.484'/><polygon fill='%23F4BD64' points='511.987,268.44 511.987,315.737 368.184,337.491 344.872,329.255 296.635,235.133'/><polygon fill='%234EB79B' points='511.987,315.737 511.987,363.022 384.886,356.939 384.874,356.939 344.872,329.255 356.814,308.325'/><polygon fill='%23E88158' points='511.987,221.156 511.987,268.44 328.73,259.687 276.634,248.075 300.658,211.061'/><polygon fill='%23B6F2FC' points='384.874,356.939 385.874,358.669 113.88,263.558 300.658,211.061 328.73,259.687 356.802,308.325 356.814,308.325'/></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    
    <link rel="stylesheet" href="styles.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>

<body>
    <div id="welcome-screen">
    <div id="glow-portal"></div>
    <canvas id="glow-canvas"></canvas>
    <div class="welcome-content">
        <div id="welcome-logo-container">
            <svg id="welcome-logo-light" class="welcome-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.987 511.987" xml:space="preserve">
                <path transform="rotate(-103.951 75.54 279.672)" style="fill:#cccccc" d="M66.717 204.027h17.648v151.29H66.717z"/>
                <path style="fill:#858585" d="m235.67 98.502 181.854 314.982H53.815z"/>
                <path style="fill:#ffbf00" d="M511.987 268.44v47.297l-143.803 21.754-23.312-8.236-48.237-94.122z"/>
                <path style="fill:#3b82f6" d="M511.987 315.737v47.285l-127.101-6.083h-.012l-40.002-27.684 11.942-20.93z"/>
                <path style="fill:#fa2c15" d="M511.987 221.156v47.284l-183.257-8.753-52.096-11.612 24.024-37.014z"/>
                <path style="fill:#cccccc" d="m384.874 356.939 1 1.73-271.994-95.111 186.778-52.497 28.072 48.626 28.072 48.638h.012z"/>
            </svg>
            <svg id="welcome-logo-dark" class="welcome-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.987 511.987" xml:space="preserve">
                <path transform="rotate(-103.951 75.54 279.672)" style="fill:#616161" d="M66.717 204.027h17.648v151.29H66.717z"/>
                <path style="fill:#bdbdbd" d="m235.67 98.502 181.854 314.982H53.815z"/>
                <path style="fill:#ffff00" d="M511.987 268.44v47.297l-143.803 21.754-23.312-8.236-48.237-94.122z"/>
                <path style="fill:#3b82f6" d="M511.987 315.737v47.285l-127.101-6.083h-.012l-40.002-27.684 11.942-20.93z"/>
                <path style="fill:#fa2c15" d="M511.987 221.156v47.284l-183.257-8.753-52.096-11.612 24.024-37.014z"/>
                <path style="fill:#616161" d="m384.874 356.939 1 1.73-271.994-95.111 186.778-52.497 28.072 48.626 28.072 48.638h.012z"/>
            </svg>
            <svg id="welcome-logo-cyber" class="welcome-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.987 511.987" xml:space="preserve">
                <path transform="rotate(-103.951 75.54 279.672)" style="fill:#4d8bee" d="M66.717 204.027h17.648v151.29H66.717z"/>
                <path style="fill:#11215e" d="m235.67 98.502 181.854 314.982H53.815z"/>
                <path style="fill:#ffd400" d="M511.987 268.44v47.297l-143.803 21.754-23.312-8.236-48.237-94.122z"/>
                <path style="fill:#00f6ff" d="M511.987 315.737v47.285l-127.101-6.083h-.012l-40.002-27.684 11.942-20.93z"/>
                <path style="fill:#ff2e97" d="M511.987 221.156v47.284l-183.257-8.753-52.096-11.612 24.024-37.014z"/>
                <path style="fill:#4d8bee" d="m384.874 356.939 1 1.73-271.994-95.111 186.778-52.497 28.072 48.626 28.072 48.638h.012z"/>
            </svg>
        </div>
        <div class="welcome-text-container">
            <h1 class="welcome-title">Ray Modeler</h1>
            <p class="welcome-subtitle">Click anywhere to start</p>
        </div>
    </div>
    </div>

    <div id="theme-switcher-container" class="fixed top-4 left-4 z-[10001] pointer-events-auto">
    <button id="theme-btn-cyber" class="theme-btn" style="display: none;" aria-label="Switch to Cyber Theme">
        <svg width="800" height="800" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8m0 15c-3.9 0-7-3.1-7-7 0-2.4 1.2-4.6 3.2-5.9C4.1 2.7 4 3.4 4 4c0 4.9 4 8.9 8.9 9-1.3 1.3-3 2-4.9 2"/>
        </svg>
    </button>
    <button id="theme-btn-light" class="theme-btn" aria-label="Switch to Light Theme">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        </button>
        <button id="theme-btn-dark" class="theme-btn" style="display: none;" aria-label="Switch to Dark Theme">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
    </div>

    <div id="render-container"></div>
    
    <div id="left-controls-container" class="fixed top-1/2 -translate-y-1/2 left-4 z-50 pointer-events-auto flex flex-col gap-4">
        <div id="left-toolbar" class="ui-panel p-1">
            <div class="btn-group flex-col">
                <div class="action-button-container">
                    <button id="toggle-panel-project-btn" class="btn" aria-label="Project Setup">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7l8-4v18"/><path d="M19 21V11l-6-4"/></svg>
                    </button>
                    <span class="tooltip" role="tooltip">Project Setup</span>
                </div>
                <div class="action-button-container">
                    <button id="toggle-panel-dimensions-btn" class="btn" aria-label="Dimensions">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" /><path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12" /></svg>
                    </button>
                    <span class="tooltip" role="tooltip">Dimensions</span>
                </div>
                 <div class="action-button-container">
                    <button id="toggle-panel-aperture-btn" class="btn" aria-label="Apertures & Shading">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/><path d="M3 9h18"/></svg>
                    </button>
                    <span class="tooltip" role="tooltip">Apertures & Shading</span>
                </div>
                 <div class="action-button-container">
                    <button id="toggle-panel-lighting-btn" class="btn" aria-label="Artificial Lighting">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M9 16a5 5 0 1 0 6 0a5 5 0 0 0 -6 0"></path><path d="M12 16v6"></path><path d="M8 16h8"></path><path d="M12 2v4"></path><path d="M3.5 5.5l1.5 1.5"></path><path d="M19 7l-1.5 -1.5"></path><path d="M5 13l-2 0"></path><path d="M19 13l2 0"></path></svg>
                    </button>
                    <span class="tooltip" role="tooltip">Artificial Lighting</span>
                </div>
                <div class="action-button-container">
                    <button id="toggle-panel-materials-btn" class="btn" aria-label="Material Properties">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="12,2 2,7 12,12 22,7 12,2"/><polyline points="2,17 12,22 22,17"/><polyline points="2,12 12,17 22,12"/></svg>                  
                    </button>
                    <span class="tooltip" role="tooltip">Material Properties</span>
                </div>
                <div class="action-button-container">
                    <button id="toggle-panel-sensor-btn" class="btn" aria-label="Sensor Grid">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="5" cy="5" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="19" cy="5" r="1"/><circle cx="5" cy="12" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="19" r="1"/><circle cx="12" cy="19" r="1"/><circle cx="19" cy="19" r="1"/></svg>                    
                    </button>
                    <span class="tooltip" role="tooltip">Sensor Grid</span>
                </div>
                 <div class="action-button-container">
                    <button id="toggle-panel-viewpoint-btn" class="btn" aria-label="Viewpoint">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>                    
                    </button>
                    <span class="tooltip" role="tooltip">Viewpoint</span>
                </div>
                 <div class="action-button-container">
                    <button id="toggle-panel-view-options-btn" class="btn" aria-label="View Options">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>                    
                </button>
                    <span class="tooltip" role="tooltip">View Options</span>
                </div>
            </div>
        </div>
    </div>

    <div id="view-controls" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 pointer-events-auto">
        <div class="ui-panel p-1">
            <div class="btn-group">
                <div class="action-button-container"><button id="view-btn-persp" class="btn active" aria-label="Perspective View"><svg viewBox="0 0 24 24"><path d="M3 8l8-4 8 4-8 4-8-4z" /><path d="M11 8v8M19 12l-8 4" /><path d="M3 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Perspective View</span></div>
                <div class="action-button-container"><button id="view-btn-ortho" class="btn" aria-label="Orthographic View"><svg viewBox="0 0 24 24"><path d="M4,8 L12,4 L20,8 L12,12 L4,8 Z" /><path d="M4,8 L4,16 L12,20 L12,12 Z" /><path d="M12,12 L12,20 L20,16 L20,8 Z" /></svg></button><span class="tooltip" role="tooltip">Orthographic View</span></div>
                <div class="action-button-container"><button id="view-btn-top" class="btn" aria-label="Top View"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="4,8 12,4 20,8 12,12" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Top View</span></div>
                <div class="action-button-container"><button id="view-btn-front" class="btn" aria-label="Front View (South)"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="4,16 12,20 12,12 4,8" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Front View (South)</span></div>
                <div class="action-button-container"><button id="view-btn-back" class="btn" aria-label="Back View (North)"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="12,4 20,8 20,16 12,12" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Back View (North)</span></div>
                <div class="action-button-container"><button id="view-btn-left" class="btn" aria-label="Left View (West)"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="4,8 12,4 12,12 4,16" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Left View (West)</span></div>
                <div class="action-button-container"><button id="view-btn-right" class="btn" aria-label="Right View (East)"><svg viewBox="0 0 24 24"><polygon class="face-fill" points="12,4 20,8 20,16 12,20" /><path d="M4 8l8 4 8-4" /><path d="M12 12v8M20 8l-8 4" /><path d="M4 8v8l8 4" /></svg></button><span class="tooltip" role="tooltip">Right View (East)</span></div>
            </div>
        </div>
    </div>

    <main id="window-container" class="relative">
        
        <div id="panel-project" class="floating-window ui-panel hidden">
            <div class="window-header">
                <span>Project Setup</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content">
                <div class="form-grid">
                    <div class="form-column">
                        <div><label for="project-name" class="label">Project Name</label><input type="text" id="project-name" placeholder="e.g., Simple Office Room"></div>
                        <div><label for="project-desc" class="label">Project Description (Optional)</label><textarea id="project-desc" rows="3" placeholder="Enter your project description"></textarea></div>
                        <div><label for="building-type" class="label">Building Type</label><select id="building-type"><option value="" disabled selected>Select Building Type</option><option>Office</option><option>Classroom</option><option>Laboratory</option><option>Libraries</option><option>Lobbies</option><option>Residential</option><option>Creative Arts</option></select></div>
                        <div><label for="radiance-path" class="label">Radiance Installation Path</label><input type="text" id="radiance-path" placeholder="Path is OS-dependent..."></div>
                    </div>
                    <div class="form-column">
                        <div style="flex-grow: 1; display: flex; flex-direction: column;">
                            <label class="label">Climate Data Source</label>
                            <div class="flex items-center">
                                <button id="upload-epw-btn" class="btn btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span>Upload EPW File</span></button>
                                <p id="epw-file-name" class="text-sm text-gray-500 ml-4 truncate max-w-[150px]"></p>
                            </div>
                            <input type="file" id="epw-file-input" class="hidden" accept=".epw" style="display: none;">
                        </div>
                        <div id="location-inputs-container" style="display: none;">
                            <label class="label">Location</label>
                            <div class="location-grid">
                                <input type="text" id="latitude" placeholder="Latitude e.g., 40.71">
                                <input type="text" id="longitude" placeholder="Longitude e.g., -74.00">
                            </div>
                        </div>
                        <div style="flex-grow: 1; display: flex; flex-direction: column;">
                            <label class="label">Map</label>
                            <div id="map"></div>
                        </div>

                        <div class="space-y-3 pt-4 mt-4 border-t border-[--grid-color]">
                            <label for="occupancy-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="occupancy-toggle">
                                <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">
                                    Generate Occupancy Schedule
                                </span>
                            </label>
                            <div id="occupancy-controls" class="hidden pt-2 space-y-4">
                                <div>
                                    <label class="label text-xs" for="occupancy-schedule-filename">Schedule Filename</label>
                                    <input type="text" id="occupancy-schedule-filename" class="w-full mt-1" value="occupancy.csv">
                                </div>
                                <div>
                                    <label class="label text-xs">Occupied Days</label>
                                    <div class="grid grid-cols-4 gap-2 text-sm mt-1">
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="0"> Sun</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="1" checked> Mon</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="2" checked> Tue</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="3" checked> Wed</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="4" checked> Thu</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="5" checked> Fri</label>
                                        <label class="flex items-center"><input type="checkbox" class="occupancy-day" value="6"> Sat</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="label text-xs flex justify-between">
                                        <span>Occupancy Time Range</span>
                                        <span id="occupancy-time-range-display" class="data-value font-mono">08:00 - 18:00</span>
                                    </label>
                                    <div id="occupancy-time-slider-container" class="relative h-5 mt-2 time-range-slider-container">
                                        <input type="range" id="occupancy-time-range-start" min="0" max="23.75" value="8" step="0.25">
                                        <input type="range" id="occupancy-time-range-end" min="0" max="23.75" value="18" step="0.25">
                                    </div>
                                </div>
                                <div class="mb-4"></div>
                                <button id="generate-occupancy-btn" class="btn btn-secondary w-full mt-6">Generate & Save Schedule</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
            </div>
        <div id="panel-dimensions" class="floating-window ui-panel hidden">
            <div class="window-header">
                <span>Dimensions</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content space-y-4">
                <div><label class="label" for="width">Width (X)</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="width" min="1" max="20" value="3.4" step="0.1"><span id="width-val" class="data-value font-mono w-12 text-left">3.4m</span></div></div>
                <div><label class="label" for="length">Length (Z)</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="length" min="1" max="20" value="5.4" step="0.1"><span id="length-val" class="data-value font-mono w-12 text-left">5.4m</span></div></div>
                <div><label class="label" for="height">Height (Y)</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="height" min="1" max="10" value="2.8" step="0.1"><span id="height-val" class="data-value font-mono w-12 text-left">2.8m</span></div></div>
                <div><label class="label" for="room-orientation">Orientation</label><div class="flex items-center space-x-4 mt-1"><input type="range" id="room-orientation" min="0" max="359" value="0" step="1"><span id="room-orientation-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                <div class="pt-4 mt-4 border-t border-[--grid-color]">
                <div>
                    <label class="label" for="surface-thickness">Surface Thickness</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="surface-thickness" min="0.00" max="1.0" value="0.15" step="0.01">
                        <span id="surface-thickness-val" class="data-value font-mono w-12 text-left">0.20m</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

<div id="panel-aperture" class="floating-window ui-panel hidden">
    <div class="window-header">
        <span>Apertures & Shading</span>
        <div class="window-controls">
            <div class="window-icon-max"></div>
            <div class="collapse-icon"></div>
            <div class="window-icon-close"></div>
        </div>
    </div>
    <div class="window-content space-y-5">
        <div class="space-y-2 pb-3">
            <h3 class="font-semibold text-sm uppercase">Wall Selection</h3>
            <p class="info-box !text-xs !py-2 !px-3">Click a wall in the 3D view to select it.</p>
            <div class="flex justify-between items-center pt-2">
            <span class="label">Selected Wall:</span>
            <div id="wall-selection-status" class="flex items-center gap-3">
                <span id="selected-wall-display" class="data-value font-mono">None</span>
                <button id="wall-select-lock-btn" class="hidden" aria-label="Lock wall selection">
                    <svg id="lock-icon-unlocked" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
                    <svg id="lock-icon-locked" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                </button>
            </div>
        </div>
        </div>

        <div id="aperture-controls-n" class="aperture-controls hidden space-y-5 pt-4 border-t border-[--grid-color]">
            <h3 class="font-semibold text-sm uppercase">North Wall Apertures</h3>
            <div><label class="label" for="win-count-n"># of Windows</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-count-n" min="0" max="10" value="0" step="1"><span id="win-count-n-val" class="data-value font-mono w-12 text-left">0</span></div></div>
            <div><label class="label">Mode</label><div class="btn-group mt-1"><button id="mode-wwr-btn-n" class="btn active">WWR</button><button id="mode-manual-btn-n" class="btn">Manual</button></div></div>
            <div id="wwr-controls-n" class="space-y-5">
                <div><label class="label" for="wwr-n">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-n" min="0" max="0.99" value="0.4" step="0.01"><span id="wwr-n-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                <div><label class="label" for="wwr-sill-height-n">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-sill-height-n" min="0" max="10" value="1.0" step="0.05"><span id="wwr-sill-height-n-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                <div><label class="label" for="win-depth-pos-n">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-n" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-n-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
            </div>
            <div id="manual-controls-n" class="hidden space-y-5">
                <div><label class="label" for="win-width-n">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-width-n" min="0.1" max="20" value="1.5" step="0.1"><span id="win-width-n-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                <div><label class="label" for="win-height-n">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-height-n" min="0.1" max="10" value="1.2" step="0.1"><span id="win-height-n-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                <div><label class="label" for="sill-height-n">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="sill-height-n" min="0" max="10" value="1.0" step="0.05"><span id="sill-height-n-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                <div><label class="label" for="win-depth-pos-n-manual">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-n-manual" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-n-val-manual" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
            </div>
            <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                <h4 class="font-semibold text-sm uppercase text-gray-700">North Wall Shading</h4>
                <label class="flex items-center cursor-pointer" for="shading-n-toggle"><input type="checkbox" id="shading-n-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                <div id="shading-controls-n" class="hidden space-y-5">
                    <div><label class="label" for="shading-type-n">Device Type</label><select id="shading-type-n" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option></select></div>
                    <div id="shading-controls-overhang-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label" for="overhang-dist-above-n">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-dist-above-n" min="0" max="1.0" value="0" step="0.05"><span id="overhang-dist-above-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="overhang-tilt-n">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-tilt-n" min="-90" max="90" value="0" step="1"><span id="overhang-tilt-n-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                        <div><label class="label" for="overhang-depth-n">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-depth-n" min="0" max="2.0" value="0.5" step="0.1"><span id="overhang-depth-n-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                        <div><label class="label" for="overhang-thick-n">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-thick-n" min="0.005" max="0.5" value="0.05" step="0.005"><span id="overhang-thick-n-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                        <div><label class="label" for="overhang-extension-n">Extension From Window (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-extension-n" min="0" max="1.0" value="0.0" step="0.05"><span id="overhang-extension-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                    </div>
                    <div id="shading-controls-lightshelf-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="lightshelf-placement-ext-n" class="btn active">Exterior</button><button id="lightshelf-placement-int-n" class="btn">Interior</button><button id="lightshelf-placement-both-n" class="btn">Both</button></div></div>
                        <div id="lightshelf-controls-ext-n" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3><div><label class="label" for="lightshelf-dist-below-ext-n">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-ext-n" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-ext-n-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-ext-n">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-ext-n" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-ext-n-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-ext-n">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-ext-n" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-ext-n-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-ext-n">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-ext-n" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-ext-n-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                        <div id="lightshelf-controls-int-n" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3><div><label class="label" for="lightshelf-dist-below-int-n">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-int-n" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-int-n-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-int-n">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-int-n" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-int-n-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-int-n">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-int-n" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-int-n-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-int-n">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-int-n" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-int-n-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                    </div>
                    <div id="shading-controls-louver-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="louver-placement-ext-n" class="btn active">Exterior</button><button id="louver-placement-int-n" class="btn">Interior</button></div></div>
                        <div><label class="label" for="louver-slat-orientation-n">Slat Orientation</label><select id="louver-slat-orientation-n" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                        <div><label class="label" for="louver-slat-width-n">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-width-n" min="0.01" max="1.0" value="0.1" step="0.01"><span id="louver-slat-width-n-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        <div><label class="label" for="louver-slat-sep-n">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-sep-n" min="0.0" max="0.5" value="0.05" step="0.01"><span id="louver-slat-sep-n-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                        <div><label class="label" for="louver-slat-thick-n">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-thick-n" min="0.0" max="0.5" value="0.01" step="0.005"><span id="louver-slat-thick-n-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                        <div><label class="label" for="louver-slat-angle-n">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-angle-n" min="-90" max="90" value="0" step="1"><span id="louver-slat-angle-n-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                        <div><label class="label" for="louver-dist-to-glass-n">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-dist-to-glass-n" min="0.0" max="1.0" value="0.1" step="0.01"><span id="louver-dist-to-glass-n-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                    </div>
                    <div id="shading-controls-roller-n" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <p class="info-box !text-xs !py-2 !px-3">Roller shades are placed internally.</p>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Sizing Offsets</h4>
                        <div><label class="label" for="roller-top-opening-n">Top Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-top-opening-n" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-top-opening-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-bottom-opening-n">Bottom Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-bottom-opening-n" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-bottom-opening-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-left-opening-n">Left Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-left-opening-n" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-left-opening-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-right-opening-n">Right Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-right-opening-n" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-right-opening-n-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Placement</h4>
                        <div><label class="label" for="roller-dist-to-glass-n">Distance to Glass (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-dist-to-glass-n" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-dist-to-glass-n-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Physical Properties (for simulation)</h4>
                        <div><label class="label" for="roller-solar-trans-n">Solar Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-trans-n" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-solar-trans-n-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                        <div><label class="label" for="roller-solar-refl-n">Solar Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-refl-n" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-solar-refl-n-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                        <div><label class="label" for="roller-vis-trans-n">Visible Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-trans-n" min="0.0" max="1.0" value="0.05" step="0.01"><span id="roller-vis-trans-n-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                        <div><label class="label" for="roller-vis-refl-n">Visible Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-refl-n" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-vis-refl-n-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                        <div><label class="label" for="roller-ir-emis-n">IR Emissivity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-emis-n" min="0.0" max="1.0" value="0.9" step="0.01"><span id="roller-ir-emis-n-val" class="data-value font-mono w-12 text-left">0.90</span></div></div>
                        <div><label class="label" for="roller-ir-trans-n">IR Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-trans-n" min="0.0" max="1.0" value="0.0" step="0.01"><span id="roller-ir-trans-n-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                        <div><label class="label" for="roller-thickness-n">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-thickness-n" min="0.0" max="0.05" value="0.001" step="0.001"><span id="roller-thickness-n-val" class="data-value font-mono w-12 text-left">0.001m</span></div></div>
                        <div><label class="label" for="roller-conductivity-n">Conductivity (W/m-K)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-conductivity-n" min="0.0" max="10.0" value="0.1" step="0.01"><span id="roller-conductivity-n-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="aperture-controls-s" class="aperture-controls hidden space-y-5 pt-4 border-t border-[--grid-color]">
        <h3 class="font-semibold text-sm uppercase">South Wall Apertures</h3>
        <div><label class="label" for="win-count-s"># of Windows</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-count-s" min="0" max="10" value="0" step="1"><span id="win-count-s-val" class="data-value font-mono w-12 text-left">0</span></div></div>
        <div><label class="label">Mode</label><div class="btn-group mt-1"><button id="mode-wwr-btn-s" class="btn active">WWR</button><button id="mode-manual-btn-s" class="btn">Manual</button></div></div>
            <div id="wwr-controls-s" class="space-y-5">
                <div><label class="label" for="wwr-s">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-s" min="0" max="0.99" value="0.4" step="0.01"><span id="wwr-s-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                <div><label class="label" for="wwr-sill-height-s">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-sill-height-s" min="0" max="10" value="1.0" step="0.05"><span id="wwr-sill-height-s-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                <div><label class="label" for="win-depth-pos-s">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-s" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-s-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
            </div>
            <div id="manual-controls-s" class="hidden space-y-5">
                <div><label class="label" for="win-width-s">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-width-s" min="0.1" max="20" value="1.2" step="0.1"><span id="win-width-s-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                <div><label class="label" for="win-height-s">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-height-s" min="0.1" max="10" value="1.5" step="0.1"><span id="win-height-s-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                <div><label class="label" for="sill-height-s">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="sill-height-s" min="0" max="10" value="1.0" step="0.05"><span id="sill-height-s-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                <div><label class="label" for="win-depth-pos-s-manual">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-s-manual" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-s-val-manual" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
            </div>
            <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                <h4 class="font-semibold text-sm uppercase text-gray-700">South Wall Shading</h4>
                <label class="flex items-center cursor-pointer" for="shading-s-toggle"><input type="checkbox" id="shading-s-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                <div id="shading-controls-s" class="hidden space-y-5">
                    <div><label class="label" for="shading-type-s">Device Type</label><select id="shading-type-s" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option></select></div>
                    <div id="shading-controls-overhang-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label" for="overhang-dist-above-s">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-dist-above-s" min="0" max="1.0" value="0" step="0.05"><span id="overhang-dist-above-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="overhang-tilt-s">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-tilt-s" min="-90" max="90" value="0" step="1"><span id="overhang-tilt-s-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                        <div><label class="label" for="overhang-depth-s">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-depth-s" min="0" max="2.0" value="0.5" step="0.1"><span id="overhang-depth-s-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                        <div><label class="label" for="overhang-thick-s">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-thick-s" min="0.005" max="0.5" value="0.05" step="0.005"><span id="overhang-thick-s-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                        <div><label class="label" for="overhang-extension-s">Extension From Window (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-extension-s" min="0" max="1.0" value="0.0" step="0.05"><span id="overhang-extension-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                    </div>
                    <div id="shading-controls-lightshelf-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="lightshelf-placement-ext-s" class="btn active">Exterior</button><button id="lightshelf-placement-int-s" class="btn">Interior</button><button id="lightshelf-placement-both-s" class="btn">Both</button></div></div>
                        <div id="lightshelf-controls-ext-s" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3><div><label class="label" for="lightshelf-dist-below-ext-s">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-ext-s" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-ext-s-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-ext-s">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-ext-s" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-ext-s-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-ext-s">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-ext-s" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-ext-s-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-ext-s">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-ext-s" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-ext-s-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                        <div id="lightshelf-controls-int-s" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3><div><label class="label" for="lightshelf-dist-below-int-s">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-int-s" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-int-s-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-int-s">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-int-s" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-int-s-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-int-s">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-int-s" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-int-s-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-int-s">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-int-s" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-int-s-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                    </div>
                    <div id="shading-controls-louver-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="louver-placement-ext-s" class="btn active">Exterior</button><button id="louver-placement-int-s" class="btn">Interior</button></div></div>
                        <div><label class="label" for="louver-slat-orientation-s">Slat Orientation</label><select id="louver-slat-orientation-s" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                        <div><label class="label" for="louver-slat-width-s">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-width-s" min="0.01" max="1.0" value="0.1" step="0.01"><span id="louver-slat-width-s-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        <div><label class="label" for="louver-slat-sep-s">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-sep-s" min="0.0" max="0.5" value="0.05" step="0.01"><span id="louver-slat-sep-s-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                        <div><label class="label" for="louver-slat-thick-s">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-thick-s" min="0.0" max="0.5" value="0.01" step="0.005"><span id="louver-slat-thick-s-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                        <div><label class="label" for="louver-slat-angle-s">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-angle-s" min="-90" max="90" value="0" step="1"><span id="louver-slat-angle-s-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                        <div><label class="label" for="louver-dist-to-glass-s">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-dist-to-glass-s" min="0.0" max="1.0" value="0.1" step="0.01"><span id="louver-dist-to-glass-s-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                    </div>
                    <div id="shading-controls-roller-s" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <p class="info-box !text-xs !py-2 !px-3">Roller shades are placed internally.</p>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Sizing Offsets</h4>
                        <div><label class="label" for="roller-top-opening-s">Top Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-top-opening-s" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-top-opening-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-bottom-opening-s">Bottom Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-bottom-opening-s" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-bottom-opening-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-left-opening-s">Left Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-left-opening-s" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-left-opening-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-right-opening-s">Right Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-right-opening-s" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-right-opening-s-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Placement</h4>
                        <div><label class="label" for="roller-dist-to-glass-s">Distance to Glass (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-dist-to-glass-s" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-dist-to-glass-s-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Physical Properties (for simulation)</h4>
                        <div><label class="label" for="roller-solar-trans-s">Solar Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-trans-s" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-solar-trans-s-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                        <div><label class="label" for="roller-solar-refl-s">Solar Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-refl-s" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-solar-refl-s-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                        <div><label class="label" for="roller-vis-trans-s">Visible Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-trans-s" min="0.0" max="1.0" value="0.05" step="0.01"><span id="roller-vis-trans-s-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                        <div><label class="label" for="roller-vis-refl-s">Visible Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-refl-s" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-vis-refl-s-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                        <div><label class="label" for="roller-ir-emis-s">IR Emissivity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-emis-s" min="0.0" max="1.0" value="0.9" step="0.01"><span id="roller-ir-emis-s-val" class="data-value font-mono w-12 text-left">0.90</span></div></div>
                        <div><label class="label" for="roller-ir-trans-s">IR Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-trans-s" min="0.0" max="1.0" value="0.0" step="0.01"><span id="roller-ir-trans-s-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                        <div><label class="label" for="roller-thickness-s">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-thickness-s" min="0.0" max="0.05" value="0.001" step="0.001"><span id="roller-thickness-s-val" class="data-value font-mono w-12 text-left">0.001m</span></div></div>
                        <div><label class="label" for="roller-conductivity-s">Conductivity (W/m-K)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-conductivity-s" min="0.0" max="10.0" value="0.1" step="0.01"><span id="roller-conductivity-s-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                    </div>
                </div>
            </div>
        </div>
        
       <div id="aperture-controls-e" class="aperture-controls hidden space-y-5 pt-4 border-t border-[--grid-color]">
        <h3 class="font-semibold text-sm uppercase">East Wall Apertures</h3>
        <div><label class="label" for="win-count-e"># of Windows</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-count-e" min="0" max="10" value="0" step="1"><span id="win-count-e-val" class="data-value font-mono w-12 text-left">0</span></div></div>
        <div><label class="label">Mode</label><div class="btn-group mt-1"><button id="mode-wwr-btn-e" class="btn active">WWR</button><button id="mode-manual-btn-e" class="btn">Manual</button></div></div>
            <div id="wwr-controls-e" class="space-y-5">
                <div><label class="label" for="wwr-e">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-e" min="0" max="0.99" value="0.4" step="0.01"><span id="wwr-e-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                <div><label class="label" for="wwr-sill-height-e">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-sill-height-e" min="0" max="10" value="1.0" step="0.1"><span id="wwr-sill-height-e-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                <div><label class="label" for="win-depth-pos-e">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-e" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-e-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
            </div>
           <div id="manual-controls-e" class="hidden space-y-5">
            <div><label class="label" for="win-width-e">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-width-e" min="0.1" max="20" value="1.5" step="0.1"><span id="win-width-e-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
            <div><label class="label" for="win-height-e">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-height-e" min="0.1" max="10" value="1.2" step="0.1"><span id="win-height-e-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
            <div><label class="label" for="sill-height-e">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="sill-height-e" min="0" max="10" value="0.05" step="0.1"><span id="sill-height-e-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
            <div><label class="label" for="win-depth-pos-e-manual">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-e-manual" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-e-val-manual" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
        </div>
        <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
            <h4 class="font-semibold text-sm uppercase text-gray-700">East Wall Shading</h4>
                <label class="flex items-center cursor-pointer" for="shading-e-toggle"><input type="checkbox" id="shading-e-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                <div id="shading-controls-e" class="hidden space-y-5">
                    <div><label class="label" for="shading-type-e">Device Type</label><select id="shading-type-e" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option></select></div>
                    <div id="shading-controls-overhang-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label" for="overhang-dist-above-e">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-dist-above-e" min="0" max="1.0" value="0" step="0.05"><span id="overhang-dist-above-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="overhang-tilt-e">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-tilt-e" min="-90" max="90" value="0" step="1"><span id="overhang-tilt-e-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                        <div><label class="label" for="overhang-depth-e">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-depth-e" min="0" max="2.0" value="0.5" step="0.1"><span id="overhang-depth-e-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                        <div><label class="label" for="overhang-thick-e">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-thick-e" min="0.005" max="0.5" value="0.05" step="0.005"><span id="overhang-thick-e-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                        <div><label class="label" for="overhang-extension-e">Extension From Window (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-extension-e" min="0" max="1.0" value="0.0" step="0.05"><span id="overhang-extension-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                    </div>
                    <div id="shading-controls-lightshelf-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="lightshelf-placement-ext-e" class="btn active">Exterior</button><button id="lightshelf-placement-int-e" class="btn">Interior</button><button id="lightshelf-placement-both-e" class="btn">Both</button></div></div>
                        <div id="lightshelf-controls-ext-e" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3><div><label class="label" for="lightshelf-dist-below-ext-e">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-ext-e" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-ext-e-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-ext-e">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-ext-e" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-ext-e-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-ext-e">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-ext-e" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-ext-e-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-ext-e">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-ext-e" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-ext-e-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                        <div id="lightshelf-controls-int-e" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3><div><label class="label" for="lightshelf-dist-below-int-e">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-int-e" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-int-e-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-int-e">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-int-e" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-int-e-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-int-e">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-int-e" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-int-e-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-int-e">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-int-e" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-int-e-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                    </div>
                    <div id="shading-controls-louver-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="louver-placement-ext-e" class="btn active">Exterior</button><button id="louver-placement-int-e" class="btn">Interior</button></div></div>
                        <div><label class="label" for="louver-slat-orientation-e">Slat Orientation</label><select id="louver-slat-orientation-e" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                        <div><label class="label" for="louver-slat-width-e">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-width-e" min="0.01" max="1.0" value="0.1" step="0.01"><span id="louver-slat-width-e-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        <div><label class="label" for="louver-slat-sep-e">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-sep-e" min="0.0" max="0.5" value="0.05" step="0.01"><span id="louver-slat-sep-e-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                        <div><label class="label" for="louver-slat-thick-e">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-thick-e" min="0.0" max="0.5" value="0.01" step="0.005"><span id="louver-slat-thick-e-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                        <div><label class="label" for="louver-slat-angle-e">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-angle-e" min="-90" max="90" value="0" step="1"><span id="louver-slat-angle-e-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                        <div><label class="label" for="louver-dist-to-glass-e">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-dist-to-glass-e" min="0.0" max="1.0" value="0.1" step="0.01"><span id="louver-dist-to-glass-e-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                    </div>
                    <div id="shading-controls-roller-e" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <p class="info-box !text-xs !py-2 !px-3">Roller shades are placed internally.</p>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Sizing Offsets</h4>
                        <div><label class="label" for="roller-top-opening-e">Top Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-top-opening-e" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-top-opening-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-bottom-opening-e">Bottom Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-bottom-opening-e" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-bottom-opening-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-left-opening-e">Left Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-left-opening-e" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-left-opening-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-right-opening-e">Right Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-right-opening-e" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-right-opening-e-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Placement</h4>
                        <div><label class="label" for="roller-dist-to-glass-e">Distance to Glass (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-dist-to-glass-e" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-dist-to-glass-e-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Physical Properties (for simulation)</h4>
                        <div><label class="label" for="roller-solar-trans-e">Solar Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-trans-e" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-solar-trans-e-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                        <div><label class="label" for="roller-solar-refl-e">Solar Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-refl-e" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-solar-refl-e-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                        <div><label class="label" for="roller-vis-trans-e">Visible Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-trans-e" min="0.0" max="1.0" value="0.05" step="0.01"><span id="roller-vis-trans-e-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                        <div><label class="label" for="roller-vis-refl-e">Visible Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-refl-e" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-vis-refl-e-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                        <div><label class="label" for="roller-ir-emis-e">IR Emissivity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-emis-e" min="0.0" max="1.0" value="0.9" step="0.01"><span id="roller-ir-emis-e-val" class="data-value font-mono w-12 text-left">0.90</span></div></div>
                        <div><label class="label" for="roller-ir-trans-e">IR Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-trans-e" min="0.0" max="1.0" value="0.0" step="0.01"><span id="roller-ir-trans-e-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                        <div><label class="label" for="roller-thickness-e">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-thickness-e" min="0.0" max="0.05" value="0.001" step="0.001"><span id="roller-thickness-e-val" class="data-value font-mono w-12 text-left">0.001m</span></div></div>
                        <div><label class="label" for="roller-conductivity-e">Conductivity (W/m-K)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-conductivity-e" min="0.0" max="10.0" value="0.1" step="0.01"><span id="roller-conductivity-e-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="aperture-controls-w" class="aperture-controls hidden space-y-5 pt-4 border-t border-[--grid-color]">
        <h3 class="font-semibold text-sm uppercase">West Wall Apertures</h3>
        <div><label class="label" for="win-count-w"># of Windows</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-count-w" min="0" max="10" value="0" step="1"><span id="win-count-w-val" class="data-value font-mono w-12 text-left">0</span></div></div>
        <div><label class="label">Mode</label><div class="btn-group mt-1"><button id="mode-wwr-btn-w" class="btn active">WWR</button><button id="mode-manual-btn-w" class="btn">Manual</button></div></div>
            <div id="wwr-controls-w" class="space-y-5">
                <div><label class="label" for="wwr-w">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-w" min="0" max="0.99" value="0.4" step="0.01"><span id="wwr-w-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                <div><label class="label" for="wwr-sill-height-w">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wwr-sill-height-w" min="0" max="10" value="1.0" step="0.1"><span id="wwr-sill-height-w-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                <div><label class="label" for="win-depth-pos-w">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-w" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-w-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
            </div>
         <div id="manual-controls-w" class="hidden space-y-5">
            <div><label class="label" for="win-width-w">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-width-w" min="0.1" max="20" value="1.5" step="0.1"><span id="win-width-w-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
            <div><label class="label" for="win-height-w">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-height-w" min="0.1" max="10" value="1.2" step="0.1"><span id="win-height-w-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
            <div><label class="label" for="sill-height-w">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="sill-height-w" min="0" max="10" value="1.0" step="0.05"><span id="sill-height-w-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
            <div><label class="label" for="win-depth-pos-w-manual">Window Depth Position (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="win-depth-pos-w-manual" min="0" max="0.2" value="0.1" step="0.01"><span id="win-depth-pos-w-val-manual" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
        </div>
        <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
            <h4 class="font-semibold text-sm uppercase text-gray-700">West Wall Shading</h4>
                <label class="flex items-center cursor-pointer" for="shading-w-toggle"><input type="checkbox" id="shading-w-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                <div id="shading-controls-w" class="hidden space-y-5">
                    <div><label class="label" for="shading-type-w">Device Type</label><select id="shading-type-w" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option></select></div>
                    <div id="shading-controls-overhang-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label" for="overhang-dist-above-w">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-dist-above-w" min="0" max="1.0" value="0" step="0.05"><span id="overhang-dist-above-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="overhang-tilt-w">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-tilt-w" min="-90" max="90" value="0" step="1"><span id="overhang-tilt-w-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                        <div><label class="label" for="overhang-depth-w">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-depth-w" min="0" max="2.0" value="0.5" step="0.1"><span id="overhang-depth-w-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                        <div><label class="label" for="overhang-thick-w">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-thick-w" min="0.005" max="0.5" value="0.05" step="0.005"><span id="overhang-thick-w-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                        <div><label class="label" for="overhang-extension-w">Extension From Window (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="overhang-extension-w" min="0" max="1.0" value="0.0" step="0.05"><span id="overhang-extension-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                    </div>
                    <div id="shading-controls-lightshelf-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="lightshelf-placement-ext-w" class="btn active">Exterior</button><button id="lightshelf-placement-int-w" class="btn">Interior</button><button id="lightshelf-placement-both-w" class="btn">Both</button></div></div>
                        <div id="lightshelf-controls-ext-w" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3><div><label class="label" for="lightshelf-dist-below-ext-w">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-ext-w" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-ext-w-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-ext-w">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-ext-w" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-ext-w-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-ext-w">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-ext-w" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-ext-w-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-ext-w">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-ext-w" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-ext-w-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                        <div id="lightshelf-controls-int-w" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3><div><label class="label" for="lightshelf-dist-below-int-w">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-dist-below-int-w" min="0" max="3.0" value="0.2" step="0.05"><span id="lightshelf-dist-below-int-w-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div><div><label class="label" for="lightshelf-tilt-int-w">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-tilt-int-w" min="-90" max="90" value="0" step="1"><span id="lightshelf-tilt-int-w-val" class="data-value font-mono w-12 text-left">0°</span></div></div><div><label class="label" for="lightshelf-depth-int-w">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-depth-int-w" min="0" max="2.0" value="0.5" step="0.1"><span id="lightshelf-depth-int-w-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div><div><label class="label" for="lightshelf-thick-int-w">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="lightshelf-thick-int-w" min="0.005" max="0.5" value="0.05" step="0.005"><span id="lightshelf-thick-int-w-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div></div>
                    </div>
                    <div id="shading-controls-louver-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <div><label class="label">Placement</label><div class="btn-group mt-1"><button id="louver-placement-ext-w" class="btn active">Exterior</button><button id="louver-placement-int-w" class="btn">Interior</button></div></div>
                        <div><label class="label" for="louver-slat-orientation-w">Slat Orientation</label><select id="louver-slat-orientation-w" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                        <div><label class="label" for="louver-slat-width-w">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-width-w" min="0.01" max="1.0" value="0.1" step="0.01"><span id="louver-slat-width-w-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        <div><label class="label" for="louver-slat-sep-w">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-sep-w" min="0.0" max="0.5" value="0.05" step="0.01"><span id="louver-slat-sep-w-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                        <div><label class="label" for="louver-slat-thick-w">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-thick-w" min="0.0" max="0.5" value="0.01" step="0.005"><span id="louver-slat-thick-w-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                        <div><label class="label" for="louver-slat-angle-w">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-slat-angle-w" min="-90" max="90" value="0" step="1"><span id="louver-slat-angle-w-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                        <div><label class="label" for="louver-dist-to-glass-w">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="louver-dist-to-glass-w" min="0.0" max="1.0" value="0.1" step="0.01"><span id="louver-dist-to-glass-w-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                    </div>
                    <div id="shading-controls-roller-w" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                        <p class="info-box !text-xs !py-2 !px-3">Roller shades are placed internally.</p>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Sizing Offsets</h4>
                        <div><label class="label" for="roller-top-opening-w">Top Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-top-opening-w" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-top-opening-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-bottom-opening-w">Bottom Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-bottom-opening-w" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-bottom-opening-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-left-opening-w">Left Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-left-opening-w" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-left-opening-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <div><label class="label" for="roller-right-opening-w">Right Opening (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-right-opening-w" min="-1.0" max="1.0" value="0.0" step="0.01"><span id="roller-right-opening-w-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Placement</h4>
                        <div><label class="label" for="roller-dist-to-glass-w">Distance to Glass (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-dist-to-glass-w" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-dist-to-glass-w-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Physical Properties (for simulation)</h4>
                        <div><label class="label" for="roller-solar-trans-w">Solar Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-trans-w" min="0.0" max="1.0" value="0.1" step="0.01"><span id="roller-solar-trans-w-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                        <div><label class="label" for="roller-solar-refl-w">Solar Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-solar-refl-w" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-solar-refl-w-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                        <div><label class="label" for="roller-vis-trans-w">Visible Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-trans-w" min="0.0" max="1.0" value="0.05" step="0.01"><span id="roller-vis-trans-w-val" class="data-value font-mono w-12 text-left">0.05</span></div></div>
                        <div><label class="label" for="roller-vis-refl-w">Visible Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-vis-refl-w" min="0.0" max="1.0" value="0.7" step="0.01"><span id="roller-vis-refl-w-val" class="data-value font-mono w-12 text-left">0.70</span></div></div>
                        <div><label class="label" for="roller-ir-emis-w">IR Emissivity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-emis-w" min="0.0" max="1.0" value="0.9" step="0.01"><span id="roller-ir-emis-w-val" class="data-value font-mono w-12 text-left">0.90</span></div></div>
                        <div><label class="label" for="roller-ir-trans-w">IR Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-ir-trans-w" min="0.0" max="1.0" value="0.0" step="0.01"><span id="roller-ir-trans-w-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                        <div><label class="label" for="roller-thickness-w">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-thickness-w" min="0.0" max="0.05" value="0.001" step="0.001"><span id="roller-thickness-w-val" class="data-value font-mono w-12 text-left">0.001m</span></div></div>
                        <div><label class="label" for="roller-conductivity-w">Conductivity (W/m-K)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="roller-conductivity-w" min="0.0" max="10.0" value="0.1" step="0.01"><span id="roller-conductivity-w-val" class="data-value font-mono w-12 text-left">0.10</span></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pt-4 border-t border-[--grid-color]">
            <label for="frame-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="frame-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Add Frame To All Windows</span></label>
            <div id="frame-controls" class="mt-4">
            <div>
                <label class="label" for="frame-thick">Frame Thick. (m)</label>
                <div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-thick" min="0.00" max="1.00" value="0.01" step="0.01"><span id="frame-thick-val" class="data-value font-mono w-12 text-left">0.01m</span></div>
            </div>
                    <div class="mt-2">
                        <label class="label" for="frame-depth">Frame Depth (m)</label>
                        <div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-depth" min="0.00" max="1.00" value="0.05" step="0.01"><span id="frame-depth-val" class="data-value font-mono w-12 text-left">0.01m</span></div>
                    </div>
                </div>
            </div>
        </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

        <div id="panel-lighting" class="floating-window ui-panel hidden">
          <div class="window-header">
              <span>Artificial Lighting</span>
              <div class="window-controls">
                  <div class="window-icon-max"></div>
                  <div class="collapse-icon"></div>
                  <div class="window-icon-close"></div>
              </div>
          </div>
          <div class="window-content space-y-5">

              <div class="param-section">
                  <label for="lighting-enabled-toggle" class="flex items-center cursor-pointer">
                  <input type="checkbox" id="lighting-enabled-toggle">
                      <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Enable Artificial Lighting</span>
                  </label>
              </div>

              <div id="lighting-controls-wrapper" class="hidden space-y-5 border-t border-dashed border-[--grid-color] pt-5">

                  <div class="param-section">
                      <label for="light-type-selector" class="label">Light Source Type</label>
                      <select id="light-type-selector" class="w-full">
                          <option value="light">light (Uniform Emitter)</option>
                          <option value="spotlight">spotlight (Directed)</option>
                          <option value="glow">glow (Controlled Luminance)</option>
                          <option value="illum">illum (Secondary Source)</option>
                          <option value="ies">IES Photometric File</option>
                      </select>
                  </div>

                  <div id="light-geometry-section" class="param-section">
                      <label for="light-geometry-selector" class="label">Light Source Geometry</label>
                      <select id="light-geometry-selector" class="w-full">
                          <option value="polygon" selected>Polygon</option>
                          <option value="sphere">Sphere</option>
                          <option value="cylinder">Cylinder</option>
                          <option value="ring">Ring</option>
                      </select>
                  </div>

                  <div id="geometry-params-section" class="param-section space-y-3">
                      <div id="geo-params-polygon"><p class="info-box !text-xs !py-2 !px-3">Default polygon geometry is defined by placement and rotation. Advanced shapes require separate .rad files.</p></div>
                      <div id="geo-params-sphere" class="hidden"><label class="label !mb-1">Radius</label><input type="number" id="geo-sphere-radius" value="0.1" step="0.01"></div>
                      <div id="geo-params-cylinder" class="hidden grid grid-cols-2 gap-2">
                          <div><label class="label !mb-1">Radius</label><input type="number" id="geo-cylinder-radius" value="0.05" step="0.01"></div>
                          <div><label class="label !mb-1">Length</label><input type="number" id="geo-cylinder-length" value="1.2" step="0.1"></div>
                      </div>
                      <div id="geo-params-ring" class="hidden grid grid-cols-2 gap-2">
                          <div><label class="label !mb-1">Inner Radius</label><input type="number" id="geo-ring-radius-in" value="0" step="0.01"></div>
                          <div><label class="label !mb-1">Outer Radius</label><input type="number" id="geo-ring-radius-out" value="0.05" step="0.01"></div>
                      </div>
                  </div>

                  <div id="params-light" class="light-param-section space-y-3">
                      <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Emission (W/sr/m²)</h4>
                      <div class="grid grid-cols-3 gap-2">
                          <div><label for="light-rgb-r" class="label !mb-1">Red</label><input type="number" id="light-rgb-r" value="100"></div>
                          <div><label for="light-rgb-g" class="label !mb-1">Green</label><input type="number" id="light-rgb-g" value="100"></div>
                          <div><label for="light-rgb-b" class="label !mb-1">Blue</label><input type="number" id="light-rgb-b" value="100"></div>
                      </div>
                  </div>

                  <div id="params-spotlight" class="light-param-section hidden space-y-3">
                      <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Emission (W/sr/m²)</h4>
                      <div class="grid grid-cols-3 gap-2">
                          <div><label for="spot-rgb-r" class="label !mb-1">Red</label><input type="number" id="spot-rgb-r" value="1000"></div>
                          <div><label for="spot-rgb-g" class="label !mb-1">Green</label><input type="number" id="spot-rgb-g" value="950"></div>
                          <div><label for="spot-rgb-b" class="label !mb-1">Blue</label><input type="number" id="spot-rgb-b" value="800"></div>
                      </div>
                      <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">Directionality</h4>
                      <div><label for="spot-cone-angle" class="label !mb-1">Cone Angle (°)</label><input type="number" id="spot-cone-angle" value="45"></div>
                      <div>
                          <label class="label !mb-1">Direction Vector (dx, dy, dz)<span class="info-icon">i<span class="info-popover">The vector's direction aims the light. Its length creates a 'focal length' effect (1/(r+e)² falloff). Use Normalize to disable this for a standard 1/r² falloff.</span></span></label>
                          <div class="grid grid-cols-3 gap-2"><input type="number" id="spot-dir-x" value="0" step="0.1"><input type="number" id="spot-dir-y" value="0" step="0.1"><input type="number" id="spot-dir-z" value="-1" step="0.1"></div>
                          <label for="spot-normalize-toggle" class="flex items-center cursor-pointer mt-3"><input type="checkbox" id="spot-normalize-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Normalize Vector</span></label>
                      </div>
                  </div>

                  <div id="params-glow" class="light-param-section hidden space-y-3">
                      <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Emission (W/sr/m²)</h4>
                      <div class="grid grid-cols-3 gap-2">
                          <div><label for="glow-rgb-r" class="label !mb-1">Red</label><input type="number" id="glow-rgb-r" value="10"></div>
                          <div><label for="glow-rgb-g" class="label !mb-1">Green</label><input type="number" id="glow-rgb-g" value="0"></div>
                          <div><label for="glow-rgb-b" class="label !mb-1">Blue</label><input type="number" id="glow-rgb-b" value="0"></div>
                      </div>
                      <div>
                          <label for="glow-behavior" class="label !mb-1">Calculation Behavior<span class="info-icon">i<span class="info-popover">Controls how/if this source contributes to scene lighting, useful for managing performance.</span></span></label>
                          <select id="glow-behavior" class="w-full"><option value="-1" selected>Visible Only (Cosmetic)</option><option value="0">Indirect Light Only</option><option value="positive">Localized Direct Light</option></select>
                      </div>
                      <div id="glow-radius-input-container" class="hidden"><label for="glow-max-radius" class="label !mb-1">Direct Light Radius</label><input type="number" id="glow-max-radius" value="1.0" step="0.1" min="0.01"></div>
                  </div>

                  <div id="params-illum" class="light-param-section hidden space-y-3">
                      <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Emission (W/sr/m²)</h4>
                      <div class="grid grid-cols-3 gap-2">
                          <div><label for="illum-rgb-r" class="label !mb-1">Red</label><input type="number" id="illum-rgb-r" value="15"></div>
                          <div><label for="illum-rgb-g" class="label !mb-1">Green</label><input type="number" id="illum-rgb-g" value="15.5"></div>
                          <div><label for="illum-rgb-b" class="label !mb-1">Blue</label><input type="number" id="illum-rgb-b" value="16"></div>
                      </div>
                      <div><label for="illum-alt-material" class="label !mb-1">Alternate Material (Appearance)</label><select id="illum-alt-material" class="w-full"><option value="" disabled selected>Select an appearance material...</option><option value="diffuser_appearance">diffuser_appearance (example)</option></select></div>
                  </div>

                  <div id="params-ies" class="light-param-section hidden space-y-3">
                      <div><label for="ies-file-input" class="label">IES File (.ies)</label><input type="file" id="ies-file-input" accept=".ies" class="w-full text-sm"></div>
                      <div id="ies-photometry-viewer" class="hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                          <h4 class="font-semibold text-xs uppercase text-[--text-secondary] mb-2">Photometric Distribution</h4>
                          <div class="relative aspect-square bg-[--grid-color] rounded p-2"><canvas id="ies-polar-plot-canvas"></canvas><div id="ies-info-display" class="absolute top-2 left-2 text-xs font-mono bg-black/30 p-1 rounded backdrop-blur-sm"></div></div>
                      </div>
                      <h4 class="font-semibold text-xs uppercase text-[--text-secondary] pt-2">ies2rad Options</h4>
                      <div>
                          <label for="ies-units" class="label !mb-1">Geometry Units (-d)</label>
                          <select id="ies-units" class="w-full"><option value="m" selected>Meters (m)</option><option value="f">Feet (f)</option><option value="i">Inches (i)</option><option value="c">Centimeters (c)</option></select>
                      </div>
                      <div><label for="ies-multiplier" class="label !mb-1">Multiplier (-m)<span class="info-icon">i<span class="info-popover">Applies a scaling factor. Primarily used for a Light Loss Factor (LLF) to account for depreciation (e.g., 0.85 for 15% loss).</span></span></label><input type="number" id="ies-multiplier" value="1.0" step="0.01"></div>
                      <div><label for="ies-lamp-type" class="label !mb-1">Lamp Type (-t)</label><input type="text" id="ies-lamp-type" placeholder="e.g., F32T8/SP35"></div>
                      <label for="ies-force-color-toggle" class="flex items-center cursor-pointer pt-2"><input type="checkbox" id="ies-force-color-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Override with Custom Color (-t default)<span class="info-icon">i<span class="info-popover">Recommended for color consistency. Ignores color from the IES file and uses the RGB values below.</span></span></span></label>
                      <div id="ies-color-override-inputs">
                          <label class="label !mb-1">Color Override (-c)</label>
                          <div class="grid grid-cols-3 gap-2"><input type="number" id="ies-color-r" value="1" step="0.01"><input type="number" id="ies-color-g" value="1" step="0.01"><input type="number" id="ies-color-b" value="1" step="0.01"></div>
                      </div>
                  </div>

                  <div class="param-section">
                      <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Placement<span class="info-icon">i<span class="info-popover">Transformations are applied in a fixed order (rotate, then translate). For predictable results, always set rotation before position.</span></span></h4>
                      <div class="btn-group mt-1"><button id="placement-mode-individual" class="btn active">Individual</button><button id="placement-mode-grid" class="btn">Grid</button></div>
                      <div class="mt-3"><label class="label !mb-1">Position (X, Y, Z)</label><div class="grid grid-cols-3 gap-2"><input type="number" id="light-pos-x" value="1.7" step="0.1"><input type="number" id="light-pos-y" value="2.7" step="0.1"><input type="number" id="light-pos-z" value="2.8" step="0.1"></div></div>
                      <div class="mt-3"><label class="label !mb-1">Rotation (°)</label><div class="grid grid-cols-3 gap-2"><input type="number" id="light-rot-x" value="-90" step="1"><input type="number" id="light-rot-y" value="0" step="1"><input type="number" id="light-rot-z" value="0" step="1"></div></div>
                      <div id="grid-layout-inputs" class="hidden mt-3 space-y-3">
                          <div class="grid grid-cols-2 gap-2">
                              <div><label for="grid-rows" class="label !mb-1">Rows</label><input type="number" id="grid-rows" value="4" min="1"></div>
                              <div><label for="grid-cols" class="label !mb-1">Columns</label><input type="number" id="grid-cols" value="5" min="1"></div>
                          </div>
                          <div class="grid grid-cols-2 gap-2">
                              <div><label for="grid-row-spacing" class="label !mb-1">Row Spacing</label><input type="number" id="grid-row-spacing" value="1.5" step="0.1"></div>
                              <div><label for="grid-col-spacing" class="label !mb-1">Col Spacing</label><input type="number" id="grid-col-spacing" value="2.0" step="0.1"></div>
                          </div>
                      </div>
                    </div>
              </div>

              <div class="param-section pt-4 mt-4 border-t border-[--grid-color]">
                  <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Power & Energy</h4>
                  <div class="grid grid-cols-2 gap-4 mt-3">
                      <div>
                          <label for="luminaire-wattage" class="label text-xs">Luminaire Power (Watts)</label>
                          <input type="number" id="luminaire-wattage" value="35" min="0" step="1" class="w-full mt-1">
                      </div>
                      <div>
                          <label class="label text-xs">Lighting Power Density</label>
                          <div id="lpd-display" class="data-value font-mono text-lg mt-1">-- W/m²</div>
                      </div>
                  </div>
              </div>

              <div class="param-section pt-4 mt-4 border-t border-[--grid-color]">
                  <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">EN 12464-1 Specification</h4>
                  <p class="info-box !text-xs !py-2 !px-3">Define compliance parameters. These values are used by EN 12464-1 recipes and for documentation.</p>
                    <div class="mt-3">
                        <label class="label text-xs flex justify-between" for="maintenance-factor">
                            <span>Maintenance Factor (MF)</span>
                            <span id="maintenance-factor-val" class="data-value font-mono">0.80</span>
                        </label>
                        <input type="range" id="maintenance-factor" min="0.1" max="1.0" value="0.8" step="0.01">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label for="light-source-ra" class="label text-xs">Color Rendering ($R_a$)</label><input type="number" id="light-source-ra" value="80" min="0" step="1"></div>
                        <div><label for="light-source-tcp" class="label text-xs">Color Temperature (TCP)</label><input type="number" id="light-source-tcp" value="4000" min="0" step="100"></div>
                    </div>
                </div>

                  <div class="param-section pt-4 mt-4 border-t border-[--grid-color]">
                      <label for="daylighting-enabled-toggle" class="flex items-center cursor-pointer">
                          <input type="checkbox" id="daylighting-enabled-toggle">
                          <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Enable Daylighting Controls</span>
                      </label>
                  </div>

                  <div id="daylighting-controls-wrapper" class="hidden space-y-5 border-t border-dashed border-[--grid-color] pt-5">
                      <div class="param-section !pt-0 !mt-0 !border-none space-y-4">
                      <h4 id="daylight-sensor-placement-header" class="font-semibold text-xs uppercase text-[--text-secondary]">Control Sensor Placement</h4>
                      <p class="info-box !text-xs !py-2 !px-3">Define the location for the daylighting sensor(s).</p>
                      <div class="mt-3">
                        <label class="label text-xs" for="daylight-sensor-count">Number of Sensors</label>
                        <select id="daylight-sensor-count" class="w-full mt-1">
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                        </select>
                      </div>
                      <div class="pt-2"><label for="daylight-sensor-gizmo-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="daylight-sensor-gizmo-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Show Placement Gizmo</span></label></div>

                      <div id="daylight-sensor-controls-container">
                          <div id="daylight-sensor-1-controls" class="space-y-3 pt-3 border-t border-dashed border-[--grid-color]">
                            <h5 class="font-semibold text-sm">Daylight Sensor 1</h5>
                            <div><label class="label text-xs">Position X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-x" min="0" max="20" value="1.0" step="0.1"><span id="daylight-sensor1-x-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                            <div><label class="label text-xs">Position Y (Height)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-y" min="0" max="10" value="0.8" step="0.1"><span id="daylight-sensor1-y-val" class="data-value font-mono w-12 text-left">0.8m</span></div></div>
                            <div><label class="label text-xs">Position Z (Depth)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-z" min="0" max="20" value="1.5" step="0.1"><span id="daylight-sensor1-z-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                            <div class="pt-2">
                                <label class="label text-xs">Direction Vector (Normal)</label>
                                <div><label class="label text-xs">Direction X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-dir-x" min="-1" max="1" value="0" step="0.05"><span id="daylight-sensor1-dir-x-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                                <div><label class="label text-xs">Direction Y</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-dir-y" min="-1" max="1" value="1" step="0.05"><span id="daylight-sensor1-dir-y-val" class="data-value font-mono w-12 text-left">1.00</span></div></div>
                                <div><label class="label text-xs">Direction Z</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-dir-z" min="-1" max="1" value="0" step="0.05"><span id="daylight-sensor1-dir-z-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                            </div>
                            <div>
                                <label class="label text-xs">Fraction of Lights Controlled</label>
                                <div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor1-percent" min="0" max="1" value="1.0" step="0.01" disabled><span id="daylight-sensor1-percent-val" class="data-value font-mono w-12 text-left">1.00</span></div>
                            </div>
                          </div>
                          <div id="daylight-sensor-2-controls" class="hidden space-y-3 pt-3 mt-4 border-t border-dashed border-[--grid-color]">
                            <h5 class="font-semibold text-sm">Daylight Sensor 2</h5>
                            <div><label class="label text-xs">Position X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-x" min="0" max="20" value="3.0" step="0.1"><span id="daylight-sensor2-x-val" class="data-value font-mono w-12 text-left">3.0m</span></div></div>
                            <div><label class="label text-xs">Position Y (Height)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-y" min="0" max="10" value="0.8" step="0.1"><span id="daylight-sensor2-y-val" class="data-value font-mono w-12 text-left">0.8m</span></div></div>
                            <div><label class="label text-xs">Position Z (Depth)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-z" min="0" max="20" value="4.5" step="0.1"><span id="daylight-sensor2-z-val" class="data-value font-mono w-12 text-left">4.5m</span></div></div>
                            <div class="pt-2">
                                <label class="label text-xs">Direction Vector (Normal)</label>
                                <div><label class="label text-xs">Direction X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-dir-x" min="-1" max="1" value="0" step="0.05"><span id="daylight-sensor2-dir-x-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                                <div><label class="label text-xs">Direction Y</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-dir-y" min="-1" max="1" value="1" step="0.05"><span id="daylight-sensor2-dir-y-val" class="data-value font-mono w-12 text-left">1.00</span></div></div>
                                <div><label class="label text-xs">Direction Z</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-dir-z" min="-1" max="1" value="0" step="0.05"><span id="daylight-sensor2-dir-z-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                            </div>
                            <div>
                                <label class="label text-xs">Fraction of Lights Controlled</label>
                                <div class="flex items-center space-x-3 mt-1"><input type="range" id="daylight-sensor2-percent" min="0" max="1" value="0.5" step="0.01"><span id="daylight-sensor2-percent-val" class="data-value font-mono w-12 text-left">0.50</span></div>
                            </div>
                          </div>
                      </div>
                  </div>

                      <div class="param-section"><label for="daylighting-control-type" class="label">Lighting Control Type</label><select id="daylighting-control-type" class="w-full"><option value="Continuous">Continuous</option><option value="Stepped">Stepped</option><option value="ContinuousOff">Continuous/Off</option></select></div>
                      <div class="param-section"><label for="daylighting-setpoint" class="label">Illuminance Setpoint (lux)</label><input type="number" id="daylighting-setpoint" value="500" min="0" step="10"></div>

                      <div id="daylight-continuous-params" class="space-y-3">
                          <div><label class="label text-xs flex justify-between" for="daylighting-min-power-frac"><span>Min Input Power Fraction</span><span id="daylighting-min-power-frac-val" class="data-value font-mono">0.30</span></label><input type="range" id="daylighting-min-power-frac" min="0" max="1" value="0.3" step="0.01"></div>
                          <div><label class="label text-xs flex justify-between" for="daylighting-min-light-frac"><span>Min Light Output Fraction</span><span id="daylighting-min-light-frac-val" class="data-value font-mono">0.20</span></label><input type="range" id="daylighting-min-light-frac" min="0" max="1" value="0.2" step="0.01"></div>
                      </div>
                      <div id="daylight-stepped-params" class="hidden space-y-3">
                          <div><label for="daylighting-steps" class="label">Number of Steps (Excl. Off)</label><input type="number" id="daylighting-steps" value="3" min="1" step="1"></div>
                      </div>
                      <div class="param-section"><label for="daylighting-availability-schedule" class="label">Availability Schedule (.csv) (Optional)</label><input type="file" id="daylighting-availability-schedule" accept=".csv" class="w-full text-sm"></div>
                    </div>
            </div>
                <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
            </div>
            <div id="panel-materials" class="floating-window ui-panel hidden">
            <div class="window-header">
                <span>Material Properties</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
           <div class="window-content space-y-5">
                <div class="space-y-3"><h3 class="font-semibold text-sm uppercase">Walls</h3>
                    <div><label class="label text-xs">Material Type</label><select id="wall-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div>
                    <div>
                        <label class="label text-xs">Reflectance Mode</label>
                        <div class="btn-group mt-1">
                            <button id="wall-mode-refl" class="btn active" data-mode="refl">Simple</button>
                            <button id="wall-mode-srd" class="btn" data-mode="srd">Spectral</button>
                        </div>
                    </div>
                    <div id="wall-refl-controls">
                        <label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wall-refl" min="0" max="1" value="0.5" step="0.01"><span id="wall-refl-val" class="data-value font-mono w-12 text-left">0.50</span></div>
                    </div>
                    <div id="wall-srd-controls" class="hidden">
                        <label for="wall-srd-file" class="label text-xs">Spectral Reflectance File (.dat)</label><input type="file" id="wall-srd-file" accept=".dat,.txt" class="w-full text-sm">
                    </div>
                    <div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wall-spec" min="0" max="1" value="0.00" step="0.01"><span id="wall-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                    <div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="wall-rough" min="0" max="1" value="0.00" step="0.01"><span id="wall-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                </div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]"><h3 class="font-semibold text-sm uppercase">Floor</h3>
                    <div><label class="label text-xs">Material Type</label><select id="floor-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div>
                    <div>
                        <label class="label text-xs">Reflectance Mode</label>
                        <div class="btn-group mt-1">
                            <button id="floor-mode-refl" class="btn active" data-mode="refl">Simple</button>
                            <button id="floor-mode-srd" class="btn" data-mode="srd">Spectral</button>
                        </div>
                    </div>
                    <div id="floor-refl-controls">
                        <label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-refl" min="0" max="1" value="0.2" step="0.01"><span id="floor-refl-val" class="data-value font-mono w-12 text-left">0.20</span></div>
                    </div>
                    <div id="floor-srd-controls" class="hidden">
                        <label for="floor-srd-file" class="label text-xs">Spectral Reflectance File (.dat)</label><input type="file" id="floor-srd-file" accept=".dat,.txt" class="w-full text-sm">
                    </div>
                    <div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-spec" min="0" max="1" value="0.00" step="0.01"><span id="floor-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div><div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-rough" min="0" max="1" value="0.00" step="0.01"><span id="floor-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                </div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]"><h3 class="font-semibold text-sm uppercase">Ceiling</h3>
                    <div><label class="label text-xs">Material Type</label><select id="ceiling-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div>
                    <div>
                        <label class="label text-xs">Reflectance Mode</label>
                        <div class="btn-group mt-1">
                            <button id="ceiling-mode-refl" class="btn active" data-mode="refl">Simple</button>
                            <button id="ceiling-mode-srd" class="btn" data-mode="srd">Spectral</button>
                        </div>
                    </div>
                    <div id="ceiling-refl-controls">
                        <label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="ceiling-refl" min="0" max="1" value="0.8" step="0.01"><span id="ceiling-refl-val" class="data-value font-mono w-12 text-left">0.80</span></div>
                    </div>
                    <div id="ceiling-srd-controls" class="hidden">
                        <label for="ceiling-srd-file" class="label text-xs">Spectral Reflectance File (.dat)</label><input type="file" id="ceiling-srd-file" accept=".dat,.txt" class="w-full text-sm">
                    </div>
                    <div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="ceiling-spec" min="0" max="1" value="0.00" step="0.01"><span id="ceiling-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div><div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="ceiling-rough" min="0" max="1" value="0.00" step="0.01"><span id="ceiling-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div>
                </div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]"><h3 class="font-semibold text-sm uppercase">Frame</h3><div><label class="label text-xs">Material Type</label><select id="frame-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div><label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-refl" min="0" max="1" value="0.1" step="0.01"><span id="frame-refl-val" class="data-value font-mono w-12 text-left">0.10</span></div><div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-spec" min="0" max="1" value="0.00" step="0.01"><span id="frame-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div><div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="frame-rough" min="0" max="1" value="0.00" step="0.01"><span id="frame-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div></div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]"><h3 class="font-semibold text-sm uppercase">Shading</h3><div><label class="label text-xs">Material Type</label><select id="shading-mat-type" class="w-full mt-1"><option selected>Plastic</option><option>Glass</option><option>Metal</option></select></div><label class="label text-xs !mb-0">Reflectance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="shading-refl" min="0" max="1" value="0.1" step="0.01"><span id="shading-refl-val" class="data-value font-mono w-12 text-left">0.10</span></div><div><label class="label text-xs">Specularity</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="shading-spec" min="0" max="1" value="0.00" step="0.01"><span id="shading-spec-val" class="data-value font-mono w-12 text-left">0.00</span></div></div><div><label class="label text-xs">Roughness</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="shading-rough" min="0" max="1" value="0.00" step="0.01"><span id="shading-rough-val" class="data-value font-mono w-12 text-left">0.00</span></div></div></div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]"><h3 class="font-semibold text-sm uppercase">Glazing</h3><div><label class="label text-xs">Transmittance</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="glazing-trans" min="0" max="1" value="0.7" step="0.01"><span id="glazing-trans-val" class="data-value font-mono w-12 text-left">0.70</span></div></div><label for="bsdf-toggle" class="flex items-center cursor-pointer pt-2"><input type="checkbox" id="bsdf-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Add BSDF</span></label><div id="bsdf-controls" class="hidden mt-2"><label for="bsdf-file" class="label text-xs">BSDF XML File</label><input type="file" id="bsdf-file" accept=".xml" class="w-full text-sm mt-1"></div></div>
            </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

    <div id="panel-sensor" class="floating-window ui-panel hidden">
        <div class="window-header">
            <span>Sensor Grid</span>
            <div class="window-controls">
                <div class="window-icon-max"></div>
                <div class="collapse-icon"></div>
                <div class="window-icon-close"></div>
            </div>
        </div>
        <div class="window-content space-y-5">
        <div class="space-y-3">
            <label for="illuminance-grid-toggle" class="flex items-center cursor-pointer w-full">
                <input type="checkbox" id="illuminance-grid-toggle" checked>
                <span class="ml-3 font-semibold text-sm uppercase">Illuminance Grid</span>
            </label>
            <div id="illuminance-grid-controls" class="space-y-5 pt-4 border-t border-[--grid-color]">
                <div class="space-y-3">
                    <h3 class="font-semibold text-sm uppercase">Surface Selection</h3>
                    <div class="grid grid-cols-2 gap-3">
                    <label for="grid-floor-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-floor-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Floor</span></label>
                    <label for="grid-ceiling-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-ceiling-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Ceiling</span></label>
                    <label for="grid-north-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-north-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">North Wall</span></label>
                    <label for="grid-south-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-south-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">South Wall</span></label>
                    <label for="grid-east-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-east-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">East Wall</span></label>
                    <label for="grid-west-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="grid-west-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">West Wall</span></label>
                </div>
            </div>
            <div id="floor-grid-controls" class="space-y-3 pt-4 border-t border-[--grid-color]">
                <h3 class="font-semibold text-sm uppercase">Floor Grid</h3>
                <div class="pt-2">
                    <label for="show-floor-grid-3d-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="show-floor-grid-3d-toggle">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Show in 3D View</span>
                    </label>
                </div>
                <div><label class="label" for="floor-grid-spacing">Spacing (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-grid-spacing" min="0.05" max="2.0" value="0.50" step="0.05"><span id="floor-grid-spacing-val" class="data-value font-mono w-12 text-left">0.50m</span></div></div>
                <div><label class="label" for="floor-grid-offset">Height Offset (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="floor-grid-offset" min="0" max="10" value="0.8" step="0.05"><span id="floor-grid-offset-val" class="data-value font-mono w-12 text-left">0.8m</span></div></div>
                <div class="pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">EN 12464-1 Specification</h4>
                    <p class="info-box !text-xs !py-2 !px-3">Define Task Area parameters. These values are used by EN 12464-1 recipes and for documentation.</p>
                </div>
                <div class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                    <label for="task-area-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="task-area-toggle">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Define Specific Task Area</span>
                    </label>
                    <div id="task-area-controls" class="hidden space-y-3 pl-4">
                        <div><label class="label text-xs" for="task-area-start-x">Start X</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="task-area-start-x" min="0" max="20" value="0.5" step="0.1"><span id="task-area-start-x-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                        <div><label class="label text-xs" for="task-area-start-z">Start Z</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="task-area-start-z" min="0" max="20" value="0.5" step="0.1"><span id="task-area-start-z-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                        <div><label class="label text-xs" for="task-area-width">Width</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="task-area-width" min="0.5" max="20" value="2.0" step="0.1"><span id="task-area-width-val" class="data-value font-mono w-12 text-left">2.0m</span></div></div>
                        <div><label class="label text-xs" for="task-area-depth">Depth</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="task-area-depth" min="0.5" max="20" value="1.0" step="0.1"><span id="task-area-depth-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                        <div class="mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                            <label class="label text-xs">Task Area Visualizer</label>
                            <div id="task-area-visualizer-container" class="relative mt-2 aspect-video bg-[--grid-color] rounded overflow-hidden cursor-move">
                                <canvas id="task-area-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                    <label for="surrounding-area-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="surrounding-area-toggle" disabled>
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Include Surrounding Area</span>
                    </label>
                    <div id="surrounding-area-controls" class="hidden space-y-3 pl-4">
                    <div><label class="label text-xs">Band Width</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="surrounding-area-width" min="0.1" max="2.0" value="0.5" step="0.1"><span id="surrounding-area-width-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                </div>
            </div>
        </div>
        <div id="ceiling-grid-controls" class="hidden space-y-3 pt-4 border-t border-[--grid-color]">
            <h3 class="font-semibold text-sm uppercase">Ceiling Grid</h3>
            <div>
                <label class="label" for="ceiling-grid-spacing">Spacing (m)</label>
                <div class="flex items-center space-x-3 mt-1">
                    <input type="range" id="ceiling-grid-spacing" min="0.05" max="2.0" value="0.50" step="0.05">
                    <span id="ceiling-grid-spacing-val" class="data-value font-mono w-12 text-left">0.50m</span>
                </div>
            </div>
            <div>
                <label class="label" for="ceiling-grid-offset">Offset from Ceiling (m)</label>
                <div class="flex items-center space-x-3 mt-1">
                    <input type="range" id="ceiling-grid-offset" min="-1.0" max="0" value="-0.2" step="0.05">
                    <span id="ceiling-grid-offset-val" class="data-value font-mono w-12 text-left">-0.2m</span>
                </div>
            </div>
        </div>
        <div id="wall-grid-controls" class="hidden space-y-3 pt-4 border-t border-[--grid-color]">
            <h3 class="font-semibold text-sm uppercase">Wall Grids</h3>
            <div>
                <label class="label" for="wall-grid-spacing">Spacing (m)</label>
                <div class="flex items-center space-x-3 mt-1">
                    <input type="range" id="wall-grid-spacing" min="0.05" max="2.0" value="0.50" step="0.05">
                    <span id="wall-grid-spacing-val" class="data-value font-mono w-12 text-left">0.50m</span>
                </div>
            </div>
            <div>
                <label class="label" for="wall-grid-offset">Wall Offset (m)</label>
                <div class="flex items-center space-x-3 mt-1">
                    <input type="range" id="wall-grid-offset" min="0.05" max="1.0" value="0.1" step="0.05">
                    <span id="wall-grid-offset-val" class="data-value font-mono w-12 text-left">0.1m</span>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div class="space-y-3 pt-4 border-t border-[--grid-color]">
            <label for="view-grid-toggle" class="flex items-center cursor-pointer w-full">
                <input type="checkbox" id="view-grid-toggle">
            <span class="ml-3 font-semibold text-sm uppercase">View Grid (for Glare)</span>
                    </label>
                    <div id="view-grid-controls" class="hidden space-y-5 pt-4 border-t border-[--grid-color]">
                        <p class="info-box !text-xs !py-2 !px-3">Generates a .ray file for imageless glare analysis with points on a horizontal plane.</p>
                    <div class="pt-2">
                        <label for="show-view-grid-3d-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="show-view-grid-3d-toggle">
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Show in 3D View</span>                        </label>
                    </div>
                    <div><label class="label" for="view-grid-spacing">Spacing (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="view-grid-spacing" min="0.05" max="2.0" value="0.75" step="0.05"><span id="view-grid-spacing-val" class="data-value font-mono w-12 text-left">0.75m</span></div></div>
                    <div><label class="label" for="view-grid-offset">Height Offset (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="view-grid-offset" min="0" max="10" value="1.2" step="0.1"><span id="view-grid-offset-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                        <div class="pt-4 border-t border-dashed border-[--grid-color] space-y-3">
                            <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">View Directions</h4>
                            <div><label class="label" for="view-grid-directions">Number of Directions</label><input type="number" id="view-grid-directions" min="1" value="6" step="1" class="w-full mt-1"></div>
                            <div>
                                <label class="label !mb-1">Starting Vector (X, Y, Z)</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <input type="number" id="view-grid-start-vec-x" value="1" step="0.1">
                                    <input type="number" id="view-grid-start-vec-y" value="0" step="0.1">
                                    <input type="number" id="view-grid-start-vec-z" value="0" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

    <div id="panel-viewpoint" class="floating-window ui-panel hidden">
        <div class="window-header">
            <span>Viewpoint</span>
            <div class="window-controls">
                <div class="window-icon-max"></div>
                <div class="collapse-icon"></div>
                <div class="window-icon-close"></div>
            </div>
        </div>
        <div class="window-content space-y-5">
            <div>
                <label class="label" for="view-type">View Type</label>
                <select id="view-type" class="w-full mt-1">
                    <option value="v" selected>Perspective</option>
                    <option value="h">Fisheye</option>
                    <option value="c">Cylindrical</option>
                    <option value="l">Parallel</option>
                    <option value="a">Angular Fisheye</option>
                </select>
            </div>
            <div class="pt-2">
                <button id="fpv-toggle-btn" class="btn btn-primary w-full">
                    <span>Enter Viewpoint</span>
                </button>
            </div>
            <div class="pt-2">
                <label for="gizmo-toggle" class="flex items-center cursor-pointer">
                    <input type="checkbox" id="gizmo-toggle">
                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Show Viewpoint Gizmo</span>
                </label>
            </div>
            <div>
                <label class="label">Gizmo Control</label>
                <div class="btn-group mt-1">
                    <button id="mode-translate-btn" class="btn active">Move</button>
                    <button id="mode-rotate-btn" class="btn">Rotate</button>
                </div>
            </div>

            <div class="border-t border-[--grid-color] pt-4 space-y-4">
                <h3 class="font-bold text-xs uppercase text-[--text-secondary]">Position (vp)</h3>
                <div>
                    <label class="label text-xs">X</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="view-pos-x" min="0" max="20" value="1.1" step="0.1">
                        <span id="view-pos-x-val" class="data-value font-mono w-12 text-left">1.1m</span>
                    </div>
                </div>
                <div>
                    <label class="label text-xs">Y (Height)</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="view-pos-y" min="0" max="10" value="1.2" step="0.1">
                        <span id="view-pos-y-val" class="data-value font-mono w-12 text-left">1.2m</span>
                    </div>
                </div>
                <div>
                    <label class="label text-xs">Z</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="view-pos-z" min="0" max="20" value="1.4" step="0.1">
                        <span id="view-pos-z-val" class="data-value font-mono w-12 text-left">1.4m</span>
                    </div>
                </div>
        </div>
        <div class="border-t border-[--grid-color] pt-4 space-y-4">
            <h3 class="font-bold text-xs uppercase text-[--text-secondary]">Direction (vd)</h3>
            <div>
                <label class="label text-xs">X</label>
                <div class="flex items-center space-x-4 mt-1">
                    <input type="range" id="view-dir-x" min="-1" max="1" value="0.5" step="0.01">
                    <span id="view-dir-x-val" class="data-value font-mono w-12 text-left">0.50</span>
                </div>
            </div>
            <div>
                <label class="label text-xs">Y (Height)</label>
                <div class="flex items-center space-x-4 mt-1">
                    <input type="range" id="view-dir-y" min="-1" max="1" value="0" step="0.01">
                    <span id="view-dir-y-val" class="data-value font-mono w-12 text-left">0.00</span>
                </div>
            </div>
            <div>
                <label class="label text-xs">Z</label>
                <div class="flex items-center space-x-4 mt-1">
                    <input type="range" id="view-dir-z" min="-1" max="1" value="0.5" step="0.01">
                    <span id="view-dir-z-val" class="data-value font-mono w-12 text-left">0.50</span>
                </div>
            </div>
        </div>

        <div class="border-t border-[--grid-color] pt-4 space-y-4">
            <div>
                <div>
                    <label class="label mt-2">Field of View</label>
                    <div class="flex items-center space-x-4 mt-1">
                        <input type="range" id="view-fov" min="10" max="180" value="60" step="1">
                        <span id="view-fov-val" class="data-value font-mono w-12 text-center">30°</span>
                    </div>
                </div>
                <div>
                    <label class="label mt-2">View Distance</label>
                    <div class="flex items-center space-x-4 mt-1">
                                  <input type="range" id="view-dist" min="1" max="50" value="5" step="0.1">
                                  <span id="view-dist-val" class="data-value font-mono w-12 text-left">5.0m</span>
                              </div>
                          </div>
                      </div>
                  </div>
                  </div>
                  <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
              </div>
                      <div id="panel-view-options" class="floating-window ui-panel hidden">
                          <div class="window-header">
                              <span>View Options</span><span>View Options</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content space-y-5">
                <div><label class="label">3D Projection</label><div class="btn-group"><button id="proj-btn-persp" class="btn active">Perspective</button><button id="proj-btn-ortho" class="btn">Orthographic</button></div></div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                    <label for="transparent-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="transparent-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Transparent Surfaces</span></label>
                    <div id="transparency-controls" class="mt-4 pl-4">
                        <label class="label text-xs" for="surface-opacity">Surface Opacity</label>
                        <div class="flex items-center space-x-3 mt-1">
                            <input type="range" id="surface-opacity" min="0.05" max="1.0" value="0.30" step="0.01">
                            <span id="surface-opacity-val" class="data-value font-mono w-12 text-left">0.5</span>
                        </div>
                    </div>
                </div>
                <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                    <label for="ground-plane-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="ground-plane-toggle" checked>
                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Show Ground Plane</span>
                </label>
            </div>
            <div class="space-y-3 pt-4 border-t border-[--grid-color]">
                <label for="world-axes-toggle" class="flex items-center cursor-pointer">
                    <input type="checkbox" id="world-axes-toggle" checked>
                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Show World Axes</span>
                </label>
                <div id="world-axes-controls" class="mt-2">
                    <label class="label text-xs" for="world-axes-size">Axes Size</label>
                    <div class="flex items-center space-x-3 mt-1">
                        <input type="range" id="world-axes-size" min="0.5" max="10" value="1.5" step="0.1">
                        <span id="world-axes-size-val" class="data-value font-mono w-12 text-left">1.5x</span>
                    </div>
                </div>
            </div>
            <div class="space-y-3 pt-4 border-t border-[--grid-color]"><label for="h-section-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="h-section-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Horizontal Section</span></label><div id="h-section-controls" class="hidden"><label class="label text-xs" for="h-section-dist">Section Height</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="h-section-dist" min="0" max="3" value="1.5" step="0.1"><span id="h-section-dist-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div></div>
            <div class="space-y-3 pt-4 border-t border-[--grid-color]"><label for="v-section-toggle" class="flex items-center cursor-pointer"><input type="checkbox" id="v-section-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal !mb-0">Vertical Section</span></label><div id="v-section-controls" class="hidden"><label class="label text-xs" for="v-section-dist">Section Position (from West)</label><div class="flex items-center space-x-3 mt-1"><input type="range" id="v-section-dist" min="0" max="4" value="2.0" step="0.1"><span id="v-section-dist-val" class="data-value font-mono w-12 text-left">2.0m</span></div></div></div>

                <div id="live-preview-section" class="hidden space-y-3 pt-4 mt-4 border-t-2 border-[--grid-color]">
                    <h3 class="font-semibold text-sm uppercase">Live Section Preview</h3>
                    <p class="info-box !text-xs !py-2 !px-3">Render a preview from the current camera view using the loaded EPW weather data.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="preview-date" class="label text-xs">Date</label>
                            <input type="text" id="preview-date" class="w-full mt-1 flatpickr-input" placeholder="Select date...">
                        </div>
                        <div>
                            <label for="preview-time" class="label text-xs">Time</label>
                            <input type="time" id="preview-time" value="14:30" class="w-full mt-1">
                        </div>
                    </div>
                    <button id="render-section-preview-btn" class="btn btn-primary w-full mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        <span>Render Preview</span>
                    </button>
                </div>
            </div>
        <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
        
            <div id="project-access-prompt" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] ui-panel !p-3 flex items-center gap-4 hidden">
                <p class="text-sm">Please select a project folder to enable direct saving and file access.</p>
                <button id="select-folder-btn" class="btn btn-primary btn-sm">Select Folder</button>
                <button id="dismiss-prompt-btn" class="text-gray-400 hover:text-gray-200" aria-label="Dismiss">&times;</button>
            </div>

            <div id="hdr-viewer-panel" class="floating-window ui-panel hidden" style="width: 550px; height: 640px;">
                <div class="window-header">
                    <span>HDR Image Viewer</span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content !p-0 flex flex-col">
                    <div id="hdr-canvas-container" class="flex-grow bg-black relative cursor-crosshair">
                        </div>
                    <div id="hdr-controls" class="p-4 border-t border-[--grid-color] space-y-4">
                        <div>
                            <label class="label text-xs flex justify-between" for="hdr-exposure">
                                <span>Exposure (EV)</span>
                                <span id="hdr-exposure-val" class="data-value font-mono">0.0</span>
                            </label>
                            <input type="range" id="hdr-exposure" min="-10" max="10" value="0" step="0.1">
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="hdr-false-color-toggle" class="flex items-center cursor-pointer">
                                <input type="checkbox" id="hdr-false-color-toggle">
                                <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">False Color (Luminance)</span>
                            </label>
                            <div id="hdr-luminance-probe" class="text-sm font-mono bg-[--grid-color] px-2 py-1 rounded hidden">
                                <span id="hdr-luminance-value">--</span> cd/m²
                            </div>
                        </div>
                    </div>
                </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

            <div id="temporal-map-panel" class="floating-window ui-panel hidden" style="width: 800px; height: 400px;">
                <div class="window-header">
                    <span>Temporal Map - Sensor Point #<span id="temporal-map-point-id">--</span></span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content !p-4 flex flex-col items-center justify-center">
                    <div id="temporal-map-canvas-container" class="w-full h-full relative">
                        <canvas id="temporal-map-canvas" class="w-full h-full"></canvas>
                    </div>
                </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

            <div id="glare-rose-panel" class="floating-window ui-panel hidden" style="width: 450px; height: 550px;">
                <div class="window-header">
                    <span>Annual Glare Rose</span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content !p-4 flex flex-col">
                    <div class="param-section">
                        <label class="label text-xs flex justify-between" for="glare-rose-threshold">
                            <span>DGP Threshold for Glare Event</span>
                            <span id="glare-rose-threshold-val" class="data-value font-mono">0.40</span>
                        </label>
                        <input type="range" id="glare-rose-threshold" min="0.2" max="0.6" value="0.4" step="0.01">
                        <p class="info-box !text-xs !py-2 !px-3">The diagram shows the number of occupied hours where DGP exceeds the threshold, binned by sun direction.</p>
                    </div>
                    <div id="glare-rose-canvas-container" class="w-full h-full relative flex-grow mt-4">
                        <canvas id="glare-rose-canvas"></canvas>
                    </div>
                </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

            <div id="combined-analysis-panel" class="floating-window ui-panel hidden" style="width: 600px; height: 650px;">
                <div class="window-header">
                    <span>Combined Daylight & Glare Analysis</span>
                    <div class="window-controls">
                        <div class="window-icon-max"></div>
                        <div class="collapse-icon"></div>
                        <div class="window-icon-close"></div>
                    </div>
                </div>
                <div class="window-content !p-4 flex flex-col">
                    <div class="param-section">
                        <label class="label text-xs flex justify-between" for="combined-glare-threshold">
                            <span>DGP Threshold for "Glare Hour"</span>
                            <span id="combined-glare-threshold-val" class="data-value font-mono">0.40</span>
                        </label>
                        <input type="range" id="combined-glare-threshold" min="0.2" max="0.6" value="0.4" step="0.01">
                        <p class="info-box !text-xs !py-2 !px-3">Each point on the scatter plot represents one sensor in the grid. The plot helps identify trade-offs between having useful daylight and experiencing uncomfortable glare.</p>
                    </div>
                    <div id="combined-analysis-canvas-container" class="w-full h-full relative flex-grow mt-4">
                        <canvas id="combined-analysis-canvas"></canvas>
                    </div>
                </div>
            <div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>

      <div id="panel-info" class="floating-window ui-panel hidden" style="width: 600px; height: 70vh;">
          <div class="window-header">
                  <span>Application Information & Help</span>
                  <div class="window-controls">
                      <div class="window-icon-max"></div>
                      <div class="collapse-icon"></div>
                      <div class="window-icon-close"></div>
                  </div>
              </div>
              <div class="window-content">
                    <h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.311a15.045 15.045 0 01-7.5 0C4.508 17.311 2.25 15.122 2.25 12c0-3.122 2.258-5.311 4.75-5.965M12 18a2.25 2.25 0 01-2.25-2.25V6.75A2.25 2.25 0 0112 4.5h.75a2.25 2.25 0 012.25 2.25v5.25a2.25 2.25 0 01-2.25 2.25h-.75z" /></svg>About Ray Modeler</h2>
                    <p>This application is a web-based graphical user interface for the <a href="https://www.radiance-online.org/" target="_blank" class="text-[--text-secondary] underline">Radiance Lighting Simulation Suite</a>. It simplifies the process of creating, simulating, and analyzing daylighting and electric lighting in simple, single-zone spaces by providing a visual, parametric modeling environment and automating the script generation process.</p>

                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>Core Capabilities</h3>
                    <ul>
                        <li><strong>Parametric Scene Modeling:</strong> Visually define room dimensions, orientation, window-to-wall ratios, and complex shading devices like overhangs, light shelves, louvers, and roller shades.</li>
                        <li><strong>Radiance Material Editor:</strong> Configure standard Radiance materials (<code>plastic</code>, <code>metal</code>, <code>glass</code>) by adjusting properties like reflectance, specularity, and roughness.</li>
                        <li><strong>Advanced Glazing:</strong> Model glazing using simple transmittance values or by incorporating complex fenestration data via BSDF <code>.xml</code> files.</li>
                        <li><strong>Electric Lighting Design:</strong> Place and configure multiple Radiance light source types (<code>light</code>, <code>spotlight</code>, <code>glow</code>, <code>illum</code>) or import real-world luminaire data using IES photometric files in individual or grid-based layouts.</li>
                        <li><strong>Solar Analysis:</strong> Visualize annual sun paths and analemmas, intelligently centered on the primary window or room center. The 3D diagram is integrated with a 2D stereographic compass for top-down views.</li>
                        <li><strong>Automated Radiance Workflow:</strong> Generates a complete, organized project folder structure (e.g., <code>01_geometry</code>, <code>04_skies</code>, <code>07_scripts</code>) and populates it with geometry files, material definitions, and executable run scripts.</li>
                        <li><strong>First-Person View (FPV) Mode:</strong> Enter the Radiance viewpoint camera directly to preview the exact perspective or fisheye view that will be rendered for analysis.</li>
                        <li><strong>Advanced Annual Analysis:</strong> Generate and view temporal heatmaps, glare rose diagrams, and combined daylight/glare scatter plots to deeply understand annual performance.</li>
                        <li><strong>Interactive HDR Image Analysis:</strong> View renderings with exposure controls, toggle false-color luminance mode, and use a mouse-over probe to get exact cd/m² values.</li>
                    </ul>

                    <h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>Workflow Overview</h2>
                    <p>The application is designed around a clear, linear workflow from scene definition to results analysis. The UI panels are arranged to guide you through this process.</p>
                    <div class="workflow-container">
                        <div class="workflow-step" id="wf-step-1">
                            <div class="workflow-title">Step 1: Scene Setup</div>
                            <div class="workflow-subtitle">Left Toolbar Panels</div>
                            <div class="workflow-items">
                                <span>Project & Location</span>
                                <span>Dimensions & Orientation</span>
                                <span>Apertures & Shading</span>
                                <span>Materials & Lighting</span>
                                <span>Sensor Grids</span>
                            </div>
                        </div>
                        <div class="workflow-arrow">&rarr;</div>
                        <div class="workflow-step" id="wf-step-2">
                            <div class="workflow-title">Step 2: Simulation Setup</div>
                            <div class="workflow-subtitle">Right Simulation Sidebar</div>
                            <div class="workflow-items">
                                <span>Select a Recipe</span>
                                <span>Configure Parameters</span>
                                <span>Generate Package</span>
                            </div>
                        </div>
                        <div class="workflow-arrow">&rarr;</div>
                        <div class="workflow-step" id="wf-step-3">
                            <div class="workflow-title">Step 3: Run Simulation</div>
                            <div class="workflow-subtitle">(External)</div>
                        </div>
                        <div class="workflow-arrow">&rarr;</div>
                        <div class="workflow-step" id="wf-step-4">
                            <div class="workflow-title">Step 4: Analyze Results</div>
                            <div class="workflow-subtitle">Right Analysis Sidebar</div>
                            <div class="workflow-items">
                                <span>Load Results File</span>
                                <span>Visualize Data in 3D</span>
                                <span>View Dashboards</span>
                            </div>
                        </div>
                    </div>

                    <h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>Panel Reference</h2>
                    <h3><code>Project Setup</code></h3>
                    <p>This is the starting point. Define project metadata, set the building's geographic location using an interactive map, or by uploading an <code>.epw</code> weather file which auto-populates location data. This panel also contains controls for the 3D Sun Path visualization and a tool for generating annual occupancy schedules.</p>
                    <h3><code>Dimensions</code></h3>
                    <p>Set the foundational geometry: <strong>width (X-axis)</strong>, <strong>length (Z-axis)</strong>, and <strong>height (Y-axis)</strong>. The <strong>Orientation</strong> slider rotates the entire room, affecting its solar exposure.</p>
                    <h3><code>Apertures & Shading</code></h3>
                    <p>Control openings on each wall. Work parametrically using <strong>Window-to-Wall Ratio (WWR)</strong> or switch to <strong>Manual</strong> mode for precise control. Each wall can have its own complex shading system, including <code>Overhangs</code>, <code>Light Shelves</code>, <code>Louvers</code>, and <code>Roller Shades</code>.</p>
                    <h3><code>Artificial Lighting</code></h3>
                    <p>Add electric lighting. Choose from Radiance primitives like <code>light</code>, <code>spotlight</code>, and <code>glow</code>, or upload an <code>.ies</code> file for a specific luminaire. Lights can be placed individually or arranged in a grid.</p>
                    <h3><code>Material Properties</code></h3>
                    <p>Define surface characteristics. For each element, select a Radiance material and adjust its <strong>reflectance</strong>, <strong>specularity</strong>, and <strong>roughness</strong>. The app correctly converts the intuitive 'Transmittance' value for glazing into the physically-based 'Transmissivity' required by the Radiance <code>glass</code> material. Advanced optics can be modeled via BSDF <code>.xml</code> files.</p>
                    <h3><code>Sensor Grid</code></h3>
                    <p>Create measurement points for simulations. The <strong>Illuminance Grid</strong> generates a <code>.pts</code> file for `rtrace` and is visualized as spheres. The <strong>View Grid</strong> generates a <code>.ray</code> file for imageless glare analysis (`rcontrib`) and is visualized as arrows indicating view directions.</p>
                    <h3><code>Viewpoint</code></h3>
                    <p>This panel controls the specific camera view used by Radiance for generating renderings (<code>rpict</code>) or glare images (<code>evalglare</code>). It defines the camera's position (<code>-vp</code>), direction (<code>-vd</code>), and view type. You can manipulate this camera with a 3D gizmo or enter a <strong>First-Person View (FPV)</strong> to see exactly what Radiance will render.</p>
                    <h3><code>View Options</code></h3>
                    <p>Adjust the live 3D preview. You can make surfaces transparent to see inside the model or enable <strong>section cuts</strong> (horizontal or vertical clipping planes) to inspect the interior.</p>

                    <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>Simulation Modules (Recipes)</h2>
                    <p>Each recipe automates a specific Radiance workflow by generating scripts that call core commands like <code>oconv</code>, <code>rpict</code>, and <code>rtrace</code>. For annual simulations, a Python script (<code>post_process_annual.py</code>) is also generated to calculate metrics from the binary results.</p>
                    <ul>
                        <li><strong>Global Simulation Parameters:</strong> A panel to set default Radiance parameters (e.g., <code>-ab</code>, <code>-ad</code>) that are inherited by all other recipes.</li>
                        <li><strong>Illuminance Map:</strong> A point-in-time calculation that produces illuminance (lux) values for each point in your sensor grid.</li>
                        <li><strong>Photorealistic Rendering:</strong> Creates a high-dynamic-range (HDR) image from the specified Viewpoint.</li>
                        <li><strong>Daylight Glare Probability (DGP):</strong> Renders a 180° fisheye image and analyzes it for glare, producing a DGP value and a report on glare sources.</li>
                        <li><strong>Daylight Factor (DF):</strong> Calculates the ratio of internal to external illuminance under a standard CIE overcast sky.</li>
                        <li><strong>Annual Daylight (3/5-Phase):</strong> Generates scripts to run <code>rcontrib</code> to create the necessary matrices (View, Daylight, etc.) and then uses <code>dctimestep</code> to perform the final annual calculation.</li>
                        <li><strong>Imageless Annual Glare:</strong> This advanced recipe uses <code>rcontrib</code> to generate Daylight Coefficients and then runs <code>dcglare</code> to efficiently calculate an 8760-hour DGP profile.</li>
                    </ul>

                    <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>Analysis Modules</h2>
                    <p>This sidebar uses a background Web Worker to parse various Radiance result files (binary <code>.ill</code>, text-based <code>.dgp</code>, <code>.ga</code> reports, and <code>.hdr</code> images) without freezing the interface. The application will automatically detect the file type and enable the relevant visualization tools.</p>
                    <ul>
                        <li><strong>3D Visualization:</strong> Illuminance data is mapped as a false-color grid onto the 3D model, with a customizable color scale and support for comparing two datasets.</li>
                        <li><strong>Annual Metrics Dashboard:</strong> For annual <code>.ill</code> files, this dashboard visualizes key climate-based metrics. It includes gauge charts for <strong>Spatial Daylight Autonomy (sDA)</strong> and <strong>Annual Sunlight Exposure (ASE)</strong>, and a stacked bar chart detailing the percentages of <strong>Useful Daylight Illuminance (UDI)</strong>.</li>
                        <li><strong>Temporal Map:</strong> When clicking on a sensor point after loading annual results, a 24x365 heatmap is generated, showing the hour-by-hour illuminance profile for that specific point throughout the year.</li>
                        <li><strong>Glare Rose Diagram:</strong> For annual <code>.dgp</code> files, this generates a polar chart showing the number of occupied hours that exceed a DGP threshold, organized by the sun's position in the sky.</li>
                        <li><strong>Combined Daylight vs. Glare Plot:</strong> When both annual illuminance and glare files are loaded, this scatter plot is available. Each point represents a sensor, plotting its percentage of useful daylight hours against its percentage of glare hours.</li>
                        <li><strong>HDR Viewer:</strong> Loads and displays rendered <code>.hdr</code> images. Features include exposure controls, a false-color mode based on luminance, and a mouse-over probe to get exact cd/m² values. It can also overlay detected glare sources from a report.</li>
                    </ul>
                
        <div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
      </div>

      <div id="simulation-console-panel" class="floating-window ui-panel hidden" style="width: 700px; height: 450px;">
          <div class="window-header">
              <span>Simulation Console</span>
              <div class="window-controls">
                  <div class="window-icon-max"></div>
                  <div class="collapse-icon"></div>
                  <div class="window-icon-close"></div>
              </div>
          </div>
          <div class="window-content !p-0 flex flex-col">
              <div id="simulation-output" class="flex-grow p-3 font-mono text-xs bg-[--grid-color] overflow-y-auto whitespace-pre-wrap"></div>
              <div class="p-2 border-t border-[--grid-color]">
                  <span id="simulation-status" class="text-sm">Status: Idle</span>
              </div>
          </div>
          <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
      </div>

        <div id="panel-ai-assistant" class="floating-window ui-panel hidden">
            <div class="window-header">
                <span>AI Assistant</span>
                <div class="window-controls">
                    <button id="ai-settings-btn" class="window-icon-settings" aria-label="AI Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content !p-0 flex flex-col">
                <div id="ai-chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto">
                    </div>
                <div class="p-4 border-t border-[--grid-color]">
                    <form id="ai-chat-form" class="flex gap-2">
                        <input type="text" id="ai-chat-input" placeholder="Ask about Radiance or this app..." class="flex-grow" autocomplete="off">
                        <button type="submit" id="ai-chat-send" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
            </div>

            <div id="proactive-suggestion-container" class="fixed bottom-24 right-8 z-[10001] flex flex-col items-end gap-2 w-full max-w-sm pointer-events-none"></div>
            </main>

        <div id="sidebar-wrapper">
            <aside id="right-sidebar" class="ui-panel closed">
            <button id="toggle-modules-btn" title="Toggle Modules Sidebar" class="sidebar-toggle-btn ui-panel" aria-label="Toggle Modules Sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
            </button>
            <div class="sidebar-content">
                <h2 class="text-lg font-bold mb-4">Simulation Modules</h2>
                <p class="text-sm text-gray-500 mb-6">Click '+' to open a parameter panel. Click '−' to close it.</p>
                <ul id="simulation-module-list" class="module-list mt-6"></ul>
            </div>
        </aside>
        <aside id="analysis-sidebar" class="ui-panel closed">
            <button id="toggle-analysis-btn" title="Toggle Analysis Sidebar" class="sidebar-toggle-btn ui-panel" aria-label="Toggle Analysis Sidebar">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
            </button>
             <div class="sidebar-content">
                        <h2 class="text-lg font-bold">Analysis Modules</h2>
                        <p class="text-sm text-gray-500 mb-6">Load a simulation results file to visualize data on the 3D model.</p>

                        <div id="results-module-content" class="space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                            <div class="param-section">
                                <label for="results-file-input-a" class="btn btn-secondary w-full cursor-pointer text-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <span>Load Results File (A)</span>
                                </label>
                                <input type="file" id="results-file-input-a" class="hidden" accept=".txt,.res,.ill,.hdr,.dgp,.ga">
                                <p id="results-file-name-a" class="text-sm text-gray-500 mt-2 text-center truncate"></p>
                            </div>

                            <div class="param-section pt-4 border-t border-dashed border-[--grid-color]">
                                <label for="compare-mode-toggle" class="flex items-center cursor-pointer w-full">
                                    <input type="checkbox" id="compare-mode-toggle">
                                    <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">
                                        Enable Comparative Analysis
                                    </span>
                                </label>
                            </div>

                            <div id="comparison-file-loader" class="param-section hidden">
                                <label for="results-file-input-b" class="btn btn-secondary w-full cursor-pointer text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <span>Load Comparison File (B)</span>
                                </label>
                                <input type="file" id="results-file-input-b" class="hidden" accept=".txt,.res,.ill,.hdr,.dgp,.ga">
                                <p id="results-file-name-b" class="text-sm text-gray-500 mt-2 text-center truncate"></p>
                            </div>

                            <div class="param-section">
                                <button id="view-hdr-btn" class="btn btn-secondary w-full hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    <span>View HDR Image</span>
                                </button>
                            </div>

                            <div id="results-dashboard" class="hidden space-y-5">
                                <div class="param-section">
                                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">3D Visualization Mode</h4>
                                    <div id="view-mode-selector" class="btn-group mt-1">
                                        <button id="view-mode-a-btn" class="btn active">Dataset A</button>
                                        <button id="view-mode-b-btn" class="btn hidden">Dataset B</button>
                                        <button id="view-mode-diff-btn" class="btn hidden">Difference (A-B)</button>
                                    </div>
                                </div>

                                <div id="summary-stats-container" class="param-section">
                                    <div id="summary-a">
                                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Summary: Dataset A (lux)</h4>
                                        <div class="grid grid-cols-3 gap-2 text-center mt-2">
                                            <div><span class="block text-xs">Min</span><span id="results-min-val-a" class="data-value font-mono">--</span></div>
                                            <div><span class="block text-xs">Avg</span><span id="results-avg-val-a" class="data-value font-mono">--</span></div>
                                            <div><span class="block text-xs">Max</span><span id="results-max-val-a" class="data-value font-mono">--</span></div>
                                        </div>
                                    </div>
                                    <div id="summary-b" class="hidden mt-3">
                                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Summary: Dataset B (lux)</h4>
                                        <div class="grid grid-cols-3 gap-2 text-center mt-2">
                                            <div><span class="block text-xs">Min</span><span id="results-min-val-b" class="data-value font-mono">--</span></div>
                                            <div><span class="block text-xs">Avg</span><span id="results-avg-val-b" class="data-value font-mono">--</span></div>
                                            <div><span class="block text-xs">Max</span><span id="results-max-val-b" class="data-value font-mono">--</span></div>
                                        </div>
                                    </div>
                                </div>

                                <div id="color-scale-section" class="param-section">
                                    <div id="standard-color-scale">
                                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Color Scale (lux)</h4>
                                        <canvas id="results-legend" height="20" class="w-full mt-2 rounded border border-[--grid-color]"></canvas>
                                    </div>
                                    <div id="difference-color-scale" class="hidden">
                                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Difference Scale (lux)</h4>
                                        <canvas id="difference-legend" height="20" class="w-full mt-2 rounded border border-[--grid-color]"></canvas>
                                        <div class="flex justify-between text-xs font-mono mt-1">
                                            <span id="diff-legend-min-label">--</span>
                                            <span>0</span>
                                            <span id="diff-legend-max-label">--</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs font-mono mt-1">
                                        <span id="legend-min-label">0</span>
                                        <span id="legend-max-label">1000</span>
                                    </div>
                                    </div>
                                    <div class="space-y-3 mt-3">
                                        <div>
                                            <label class="label text-xs flex justify-between" for="results-scale-min">
                                                <span>Scale Min</span>
                                                <input type="number" id="results-scale-min-num" class="param-input-num-sm">
                                            </label>
                                            <input type="range" id="results-scale-min" min="0" max="5000" value="0" step="10">
                                        </div>
                                        <div>
                                            <label class="label text-xs flex justify-between" for="results-scale-max">
                                                <span>Scale Max</span>
                                                <input type="number" id="results-scale-max-num" class="param-input-num-sm">
                                            </label>
                                            <input type="range" id="results-scale-max" min="0" max="5000" value="1000" step="10">
                                        </div>
                                        </div>
                                        <div>
                                            <label for="results-palette" class="label text-xs">Color Palette</label>
                                            <select id="results-palette" class="w-full mt-1">
                                                <option value="viridis" selected>Viridis</option>
                                                <option value="plasma">Plasma</option>
                                                <option value="inferno">Inferno</option>
                                                <option value="magma">Magma</option>
                                                <option value="cividis">Cividis</option>
                                            </select>
                                        </div>
                                </div>
                            </div>
                            <div id="glare-analysis-dashboard" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                                <div class="param-section">
                                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Glare Analysis (evalglare)</h4>
                                    <div class="grid grid-cols-2 gap-2 text-center mt-2">
                                        <div><span id="glare-metric-label" class="block text-xs">DGP</span><span id="glare-val" class="data-value font-mono text-lg">--</span></div>
                                        <div><span class="block text-xs">Source Count</span><span id="glare-source-count" class="data-value font-mono text-lg">--</span></div>
                                    </div>
                                </div>
                                <div class="param-section">
                                    <div class="flex justify-between items-center">
                                        <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Detected Glare Sources</h4>
                                        <button id="clear-glare-highlight-btn" class="btn btn-xs btn-secondary">Clear</button>
                                    </div>
                                    <p class="info-box !text-xs !py-2 !px-3">Click on a source to highlight it in the 3D view.</p>
                                    <ul id="glare-source-list" class="space-y-1.5 mt-2 text-sm max-h-60 overflow-y-auto">
                                        </ul>
                                </div>
                            </div>

                            <div id="annual-glare-controls" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                                <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Annual Glare Analysis</h4>
                                <button id="glare-rose-btn" class="btn btn-secondary w-full">Generate Glare Rose Diagram</button>
                                <button id="combined-analysis-btn" class="btn btn-secondary w-full mt-2" style="display: none;">Daylight vs. Glare Plot</button>
                            </div>

                            <div class="param-section">
                                <button id="results-dashboard-btn" class="btn btn-primary w-full mt-4">Results Dashboard</button>
                            </div>
                        </div>
                </div>
        </aside>
        <div id="results-analysis-panel" class="floating-window ui-panel hidden">
            <div class="window-header">
                <span>Results Analysis</span>
                <div class="window-controls">
                    <div class="window-icon-max"></div>
                    <div class="collapse-icon"></div>
                    <div class="window-icon-close"></div>
                </div>
            </div>
            <div class="window-content space-y-5">
                <div class="param-section">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Summary Statistics</h4>
                    <div id="results-summary-stats" class="grid grid-cols-4 gap-2 text-center mt-2">
                        <div><span class="block text-xs">Min</span><span id="stats-min-val" class="data-value font-mono">--</span></div>
                        <div><span class="block text-xs">Max</span><span id="stats-max-val" class="data-value font-mono">--</span></div>
                        <div><span class="block text-xs">Average</span><span id="stats-avg-val" class="data-value font-mono">--</span></div>
                        <div><span class="block text-xs">Uniformity</span><span id="stats-uniformity-val" class="data-value font-mono">--</span></div>
                    </div>
                </div>
                <div class="param-section">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Analysis Tools</h4>
                    <div class="btn-group mt-2">
                        <button id="highlight-min-btn" class="btn btn-secondary">Highlight Min</button>
                        <button id="highlight-max-btn" class="btn btn-secondary">Highlight Max</button>
                        <button id="clear-highlights-btn" class="btn btn-secondary">Clear</button>
                    </div>
                </div>
                <div class="param-section">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Illuminance Distribution</h4>
                    <div class="mt-2"><canvas id="illuminance-histogram"></canvas></div>
                </div>
                <div class="param-section">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">False-Color Scale</h4>
                    <canvas id="interactive-legend" height="20" class="w-full mt-2 rounded border border-[--grid-color]"></canvas>
                    <div class="flex justify-between text-xs font-mono mt-1">
                        <span id="legend-min-val">0</span>
                        <span id="legend-max-val">1000</span>
                    </div>
                    <div class="space-y-3 mt-3">
                        <div>
                            <label class="label text-xs flex justify-between" for="scale-min-input">
                                <span>Scale Min</span>
                                <input type="number" id="scale-min-input-num" class="param-input-num-sm">
                            </label>
                            <input type="range" id="scale-min-input" min="0" max="5000" value="0" step="10">
                        </div>
                        <div>
                            <label class="label text-xs flex justify-between" for="scale-max-input">
                                <span>Scale Max</span>
                                <input type="number" id="scale-max-input-num" class="param-input-num-sm">
                            </label>
                            <input type="range" id="scale-max-input" min="0" max="5000" value="1000" step="10">
                        </div>
                    </div>
                </div>
                <div class="param-section">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">2D Floor Plan Heatmap</h4>
                    <div class="mt-2 aspect-square bg-[--grid-color] rounded overflow-hidden">
                        <canvas id="heatmap-canvas" class="w-full h-full"></canvas>
                </div>
            </div>
            
                </div>

                <div id="annual-time-series-explorer" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Time-Series Explorer</h4>
                    <div class="pt-2">
                        <h5 class="font-semibold text-sm text-center">Space-Averaged Illuminance</h5>
                        <p class="text-xs text-center text-[--text-secondary] mt-1">Full Year (8760 hours)</p>
                        <div class="mt-2 h-40 relative"><canvas id="time-series-chart"></canvas></div>
                    </div>
                    <div class="pt-4">
                        <label class="label text-xs flex justify-between" for="time-scrubber">
                            <span>3D Scrubber (Hour of Year)</span>
                            <span id="time-scrubber-display" class="data-value font-mono">Jul 2, 12:00</span>
                        </label>
                        <div class="flex items-center space-x-3 mt-1">
                            <input type="range" id="time-scrubber" min="0" max="8759" value="4380" step="1">
                        </div>
                    </div>
                </div>
            <div id="spectral-metrics-dashboard" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
              <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Spectral Lighting Metrics</h4>
              <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <h5 class="font-semibold text-sm">Photopic</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="metric-photopic-val">--</span> lux</p>
                        </div>
                        <div>
                            <h5 class="font-semibold text-sm">Melanopic</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="metric-melanopic-val">--</span> m-EDI lux</p>
                        </div>
                        <div>
                            <h5 class="font-semibold text-sm">Neuropic</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="metric-neuropic-val">--</span> W/m²</p>
                        </div>
                    </div>
                <p class="info-box !text-xs !py-2 !px-3">These are space-averaged values from the sensor grid. Load the respective text file (e.g., photopic_illuminance.txt) to see the 3D visualization.</p>
            </div>
        </div>
            </div>
        </aside>
    </div>

    <div id="sensor-context-menu" class="hidden absolute z-[1000] ui-panel !p-1">
        <button id="set-viewpoint-here-btn" class="btn btn-secondary !py-2 !px-4 !text-sm">Set Viewpoint Here</button>
    </div>
    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="ui-panel p-6 w-full max-w-sm mx-auto bg-[--bg-main]"><h3 id="custom-alert-title" class="text-lg font-bold mb-4">Notification</h3><p id="custom-alert-message" class="text-sm mb-6"></p><button id="custom-alert-close" class="btn btn-primary w-full">Close</button></div>
    </div>
    
    <div id="epw-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="ui-panel p-6 w-full max-w-lg mx-auto bg-[--bg-main] relative">
            <button id="epw-modal-close" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800" aria-label="Close EPW Upload Modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="text-lg font-bold mb-4">Upload Climate Data File</h3>
            <div id="modal-file-drop-area" class="file-drop-area">
                <svg width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h.586a1 1 0 01.707.293l2 2a1 1 0 00.707.293H12.5A2.5 2.5 0 0115 11v.5a2.5 2.5 0 01-2.5 2.5h-1a1 1 0 00-.707.293l-2 2A1 1 0 017.586 16H7z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11h4.5a2.5 2.5 0 012.5 2.5V17a4 4 0 01-4 4h-1.5a1 1 0 01-.707-.293l-2-2A1 1 0 009.586 18H9"></path>
                </svg>
                <p>Upload EPW file or drag and drop</p>
            </div>
        </div>
    </div>
    <div id="ai-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10002] hidden items-center justify-center">
        <div class="ui-panel p-6 w-full max-w-md mx-auto bg-[--bg-main] relative">
            <button id="ai-settings-close-btn" class="absolute top-3 right-3 text-[--text-secondary] hover:text-[--text-primary]" aria-label="Close AI Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="text-lg font-bold mb-4">AI Assistant Settings</h3>
            <form id="ai-settings-form" class="space-y-4">
            <div>
                <label for="ai-provider-select" class="label">AI Provider</label>
                <select id="ai-provider-select" class="w-full">
                    <option value="gemini">Google Gemini</option>
                    <option value="openrouter">OpenRouter</option>
                </select>
            </div>
            <div>
                <label for="ai-model-select" class="label">Model</label>
                <select id="ai-model-select" class="w-full"></select>
            </div>
            <div>
                <label for="ai-api-key-input" class="label">API Key</label>
                <input type="password" id="ai-api-key-input" placeholder="Enter your API key" class="w-full">
            </div>
            <div id="openrouter-info-box" class="info-box !text-xs hidden">
                <b>Note:</b> To use free models on OpenRouter, you may need to adjust your
                <a href="https://openrouter.ai/settings/privacy" target="_blank" class="text-[--text-secondary] underline">privacy settings</a>
                to allow your data to be used for model improvement.
            </div>
            <button type="submit" class="btn btn-primary w-full mt-4">Save Settings</button>
            </form>
        </div>
    </div>
    <div id="bottom-left-controls" class="fixed bottom-6 left-6 z-50 flex gap-4 items-center">
        <div class="action-button-container">
            <button id="save-project-button" class="bottom-action-button" aria-label="Save Project File">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM6 6h9v4H6z"/></svg>
            </button>
            <span class="tooltip" role="tooltip">Save Project</span>
        </div>
        <div class="action-button-container">
            <button id="load-project-button" class="bottom-action-button" aria-label="Load Project File">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
            </button>
            <span class="tooltip" role="tooltip">Load Project</span>
        </div>
        <div class="action-button-container">
            <button id="info-button" class="bottom-action-button" aria-label="Show App Info">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
            </button>
            <span class="tooltip" role="tooltip">App Information</span>
            </div>
            <div class="action-button-container">
                <button id="ai-assistant-button" class="bottom-action-button" aria-label="Open AI Assistant">
                    <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 14 14" width="28px" fill="currentColor">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M11.958 10.945a1.786 1.786 0 1 1-3.573 0 1.786 1.786 0 0 1 3.573 0Zm-.298-3.84a1.489 1.489 0 1 1-2.978 0 1.489 1.489 0 0 1 2.978 0ZM13 5.287a.744.744 0 1 1-1.489 0 .744.744 0 0 1 1.489 0ZM8.325 4.93a3.663 3.663 0 0 1-3.662 3.662A3.663 3.663 0 0 1 1 4.931a3.663 3.663 0 0 1 3.663-3.663 3.663 3.663 0 0 1 3.662 3.663Z"/>
                    </svg>
                </button>
                <span class="tooltip" role="tooltip">AI Assistant</span>
            </div>
            </div>

        <div id="templates" style="display: none;">

        <template id="aperture-wall-template">
            <div class="aperture-controls space-y-5 pt-4 border-t border-[--grid-color]">
                <h3 class="font-semibold text-sm uppercase" data-template-text="heading">WALL_DIRECTION Wall Apertures</h3>
                <div>
                    <label class="label" data-template-for="win-count"># of Windows</label>
                    <div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="win-count" min="1" max="10" value="1" step="1"><span data-template-id="win-count-val" class="data-value font-mono w-12 text-left">1</span></div>
                </div>
                <div>
                    <label class="label">Mode</label>
                    <div class="btn-group mt-1"><button data-template-id="mode-wwr-btn" class="btn active">WWR</button><button data-template-id="mode-manual-btn" class="btn">Manual</button></div>
                </div>
                <div data-template-id="wwr-controls" class="space-y-5">
                    <div><label class="label" data-template-for="wwr">WWR (%)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="wwr" min="0" max="0.99" value="0.4" step="0.01"><span data-template-id="wwr-val" class="data-value font-mono w-12 text-left">40%</span></div></div>
                    <div><label class="label" data-template-for="wwr-sill-height">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="wwr-sill-height" min="0" max="10" value="1.0" step="0.05"><span data-template-id="wwr-sill-height-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                </div>
                <div data-template-id="manual-controls" class="hidden space-y-5">
                    <div><label class="label" data-template-for="win-width">Win. Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="win-width" min="0.1" max="20" value="1.5" step="0.1"><span data-template-id="win-width-val" class="data-value font-mono w-12 text-left">1.5m</span></div></div>
                    <div><label class="label" data-template-for="win-height">Win. Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="win-height" min="0.1" max="10" value="1.2" step="0.1"><span data-template-id="win-height-val" class="data-value font-mono w-12 text-left">1.2m</span></div></div>
                    <div><label class="label" data-template-for="sill-height">Sill Height (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="sill-height" min="0" max="10" value="1.0" step="0.05"><span data-template-id="sill-height-val" class="data-value font-mono w-12 text-left">1.0m</span></div></div>
                </div>
                <div class="shading-section-container space-y-4 pt-4 mt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-sm uppercase text-gray-700" data-template-text="shading-heading">WALL_DIRECTION Wall Shading</h4>
                    <label class="flex items-center cursor-pointer" data-template-for="shading-toggle"><input type="checkbox" data-template-id="shading-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Enable Shading on this Wall</span></label>
                    
                    
                <div data-template-id="shading-controls" class="hidden space-y-5">
                    <div><label class="label" data-template-for="shading-type">Device Type</label><select data-template-id="shading-type" class="w-full mt-1"><option value="none" selected>None</option><option value="overhang">Overhang</option><option value="lightshelf">Light Shelf</option><option value="louver">Louver</option><option value="roller">Roller</option></select></div>
                    <div data-template-id="shading-controls-overhang" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                    <div><label class="label" data-template-for="overhang-dist-above">Distance Above Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-dist-above" min="0" max="1.0" value="0" step="0.05"><span data-template-id="overhang-dist-above-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>



                            <div><label class="label" data-template-for="overhang-tilt">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-tilt" min="-90" max="90" value="0" step="1"><span data-template-id="overhang-tilt-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" data-template-for="overhang-depth">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-depth" min="0" max="2.0" value="0.5" step="0.1"><span data-template-id="overhang-depth-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                            <div><label class="label" data-template-for="overhang-thick">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-thick" min="0.005" max="0.5" value="0.05" step="0.005"><span data-template-id="overhang-thick-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                            <div><label class="label" data-template-for="overhang-extension">Extension From Window (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="overhang-extension" min="0" max="1.0" value="0.0" step="0.05"><span data-template-id="overhang-extension-val" class="data-value font-mono w-12 text-left">0.00m</span></div></div>
                        </div>
                        <div data-template-id="shading-controls-lightshelf" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button data-template-id="lightshelf-placement-ext" class="btn active">Exterior</button><button data-template-id="lightshelf-placement-int" class="btn">Interior</button><button data-template-id="lightshelf-placement-both" class="btn">Both</button></div></div>
                            <div data-template-id="lightshelf-controls-ext" class="space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Exterior Shelf</h3>
                                <div><label class="label" data-template-for="lightshelf-dist-below-ext">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-dist-below-ext" min="0" max="3.0" value="0.2" step="0.05"><span data-template-id="lightshelf-dist-below-ext-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-tilt-ext">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-tilt-ext" min="-90" max="90" value="0" step="1"><span data-template-id="lightshelf-tilt-ext-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-depth-ext">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-depth-ext" min="0" max="2.0" value="0.5" step="0.1"><span data-template-id="lightshelf-depth-ext-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-thick-ext">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-thick-ext" min="0.005" max="0.5" value="0.05" step="0.005"><span data-template-id="lightshelf-thick-ext-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                            </div>
                            <div data-template-id="lightshelf-controls-int" class="hidden space-y-4 pt-4 border-t border-dashed border-[--grid-color]"><h3 class="font-semibold text-xs uppercase text-[--text-secondary]">Interior Shelf</h3>
                                <div><label class="label" data-template-for="lightshelf-dist-below-int">Distance Below Top (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-dist-below-int" min="0" max="3.0" value="0.2" step="0.05"><span data-template-id="lightshelf-dist-below-int-val" class="data-value font-mono w-12 text-left">0.20m</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-tilt-int">Tilt Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-tilt-int" min="-90" max="90" value="0" step="1"><span data-template-id="lightshelf-tilt-int-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-depth-int">Depth (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-depth-int" min="0" max="2.0" value="0.5" step="0.1"><span data-template-id="lightshelf-depth-int-val" class="data-value font-mono w-12 text-left">0.5m</span></div></div>
                                <div><label class="label" data-template-for="lightshelf-thick-int">Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="lightshelf-thick-int" min="0.005" max="0.5" value="0.05" step="0.005"><span data-template-id="lightshelf-thick-int-val" class="data-value font-mono w-12 text-left">0.050m</span></div></div>
                            </div>
                        </div>
                        <div data-template-id="shading-controls-louver" class="hidden space-y-4 pt-4 border-t border-[--grid-color]">
                            <div><label class="label">Placement</label><div class="btn-group mt-1"><button data-template-id="louver-placement-ext" class="btn active">Exterior</button><button data-template-id="louver-placement-int" class="btn">Interior</button></div></div>
                            <div><label class="label" data-template-for="louver-slat-orientation">Slat Orientation</label><select data-template-id="louver-slat-orientation" class="w-full mt-1"><option value="horizontal" selected>Horizontal</option><option value="vertical">Vertical</option></select></div>
                            <div><label class="label" data-template-for="louver-slat-width">Slat Width (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-slat-width" min="0.01" max="1.0" value="0.1" step="0.01"><span data-template-id="louver-slat-width-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                            <div><label class="label" data-template-for="louver-slat-sep">Slat Separation (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-slat-sep" min="0.0" max="0.5" value="0.05" step="0.01"><span data-template-id="louver-slat-sep-val" class="data-value font-mono w-12 text-left">0.05m</span></div></div>
                            <div><label class="label" data-template-for="louver-slat-thick">Slat Thickness (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-slat-thick" min="0.0" max="0.5" value="0.01" step="0.005"><span data-template-id="louver-slat-thick-val" class="data-value font-mono w-12 text-left">0.01m</span></div></div>
                            <div><label class="label" data-template-for="louver-slat-angle">Slat Angle (°)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-slat-angle" min="-90" max="90" value="0" step="1"><span data-template-id="louver-slat-angle-val" class="data-value font-mono w-12 text-left">0°</span></div></div>
                            <div><label class="label" data-template-for="louver-dist-to-glass">Blind to Glass Distance (m)</label><div class="flex items-center space-x-3 mt-1"><input type="range" data-template-id="louver-dist-to-glass" min="0.0" max="1.0" value="0.1" step="0.01"><span data-template-id="louver-dist-to-glass-val" class="data-value font-mono w-12 text-left">0.10m</span></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <div id="panel-templates">
                <template id="template-global-sim-params">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Global Simulation Parameters</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <h4>Ambient Calculation Settings</h4>
                                <div class="param-grid-sim">
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="ab" class="label">Ambient Bounces (-ab) <span class="info-icon">i<span class="info-popover">Max number of diffuse inter-reflections. 0 disables indirect calculation. 2-4 is standard, 5-8 for high accuracy or complex scenes.</span></span></label><input type="number" class="param-input-num" id="ab-num" step="1" min="0" max="16"></div>
                                        <input type="range" id="ab" min="0" max="16" value="4" step="1">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="ad" class="label">Ambient Divisions (-ad) <span class="info-icon">i<span class="info-popover">Number of samples for indirect illuminance. Primary control for "splotchy" artifacts.</span></span></label><input type="number" class="param-input-num" id="ad-num" step="64" min="0" max="8192"></div>
                                        <input type="range" id="ad" min="0" max="8192" value="1024" step="64">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="as" class="label">Ambient Super-samples (-as) <span class="info-icon">i<span class="info-popover">Additional samples to refine areas with high variance. Use to clean up noise after setting -ad.</span></span></label><input type="number" class="param-input-num" id="as-num" step="64" min="0" max="8192"></div>
                                        <input type="range" id="as" min="0" max="8192" value="256" step="64">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="aa" class="label">Ambient Accuracy (-aa) <span class="info-icon">i<span class="info-popover">Error tolerance for irradiance cache interpolation. Lower values are more accurate but slower. Does not fix splotches.</span></span></label><input type="number" class="param-input-num" id="aa-num" step="0.01" min="0" max="1"></div>
                                        <input type="range" id="aa" min="0" max="1" value="0.15" step="0.01">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="ar" class="label">Ambient Resolution (-ar) <span class="info-icon">i<span class="info-popover">Sets the density of the irradiance cache relative to scene size. Works with -aa.</span></span></label><input type="number" class="param-input-num" id="ar-num" step="32" min="0" max="4096"></div>
                                        <input type="range" id="ar" min="0" max="4096" value="128" step="32">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="lw" class="label">Limit Weight (-lw) <span class="info-icon">i<span class="info-popover">Minimum contribution for a ray to be traced. Crucial for simulations with high -ab values.</span></span></label><input type="number" class="param-input-num" id="lw-num" step="0.0001" min="0" max="0.01"></div>
                                        <input type="range" id="lw" min="0" max="0.01" value="0.002" step="0.0001">
                                    </div>
                                </div>
                            </div>
                            <div class="param-section">
                                <h4>Direct & Specular Calculation Settings</h4>
                                <div class="param-grid-sim">
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="dc" class="label">Direct Certainty (-dc) <span class="info-icon">i<span class="info-popover">A value of 1 guarantees shadow accuracy. 0.5 is a good balance.</span></span></label><input type="number" class="param-input-num" id="dc-num" step="0.05" min="0" max="1"></div>
                                        <input type="range" id="dc" min="0" max="1" value="0.5" step="0.05">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="dt" class="label">Direct Thresholding (-dt) <span class="info-icon">i<span class="info-popover">Optimization to ignore insignificant light sources. For max accuracy, set to 0.</span></span></label><input type="number" class="param-input-num" id="dt-num" step="0.05" min="0" max="1"></div>
                                        <input type="range" id="dt" min="0" max="1" value="0.05" step="0.05">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="dr" class="label">Direct Relays (-dr) <span class="info-icon">i<span class="info-popover">Number of relays for secondary sources (e.g., reflections in mirrors).</span></span></label><input type="number" class="param-input-num" id="dr-num" step="1" min="0" max="6"></div>
                                        <input type="range" id="dr" min="0" max="6" value="1" step="1">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="dp" class="label">Direct Pre-test Density (-dp) <span class="info-icon">i<span class="info-popover">Number of samples/steradian for pre-testing secondary sources.</span></span></label><input type="number" class="param-input-num" id="dp-num" step="32" min="32" max="512"></div>
                                        <input type="range" id="dp" min="32" max="512" value="64" step="32">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="ss" class="label">Specular Sampling (-ss) <span class="info-icon">i<span class="info-popover">Sampling for rough specular materials. >1 sends multiple rays to reduce noise.</span></span></label><input type="number" class="param-input-num" id="ss-num" step="0.1" min="0" max="2"></div>
                                        <input type="range" id="ss" min="0" max="2" value="0.7" step="0.1">
                                    </div>
                                    <div class="param-item">
                                        <div class="param-item-row"><label for="lr" class="label">Limit Reflection (-lr) <span class="info-icon">i<span class="info-popover">Maximum number of specular reflections. 0 uses Russian Roulette for ray termination.</span></span></label><input type="number" class="param-input-num" id="lr-num" step="1" min="0" max="16"></div>
                                        <input type="range" id="lr" min="0" max="16" value="8" step="1">
                                    </div>
                                </div>
                            </div>
                        </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
                </template>

                <template id="template-recipe-illuminance">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Illuminance Map</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <h4>Sky Definition (gensky)</h4>
                                <p class="info-box !mb-4">Define the sky for a specific moment. Location is taken from the Project Setup panel.</p>
                                <div class="grid grid-cols-3 gap-4">
                                    <div><label for="pit-month" class="label">Month</label><input type="number" id="pit-month" min="1" max="12" value="6"></div>
                                    <div><label for="pit-day" class="label">Day</label><input type="number" id="pit-day" min="1" max="31" value="21"></div>
                                    <div><label for="pit-time" class="label">Time (HH:MM)</label><input type="time" id="pit-time" value="14:30"></div>
                                </div>
                            </div>
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Grid-Based Illuminance (rtrace)</h4>
                                <p class="info-box">Calculates illuminance or irradiance values on a sensor grid. Uses global simulation parameters for the calculation.</p>
                                <div class="param-section">
                                    <h5>Calculation Mode &amp; Switches</h5>
                                    <div class="param-grid-sim mt-2">
                                        <div>
                                            <label class="label">Calculation Mode
                                                <span class="info-icon">i<span class="info-popover"><b>-I (Irradiance):</b> Computes irradiance directly. Input is measurement point and surface normal.<br><br><b>-i (Illuminance):</b> Computes radiance first, then converts to illuminance. Input is a ray origin and direction.</span></span>
                                            </label>
                                            <div class="btn-group"><button id="rtrace-mode-I" class="btn active" title="-I">Irradiance (-I)</button><button id="rtrace-mode-i" class="btn" title="-i">Illuminance (-i)</button></div>
                                        </div>
                                        <div>
                                            <label class="label">General Switches</label>
                                            <div class="space-y-2">
                                                <label class="flex items-center cursor-pointer"><input type="checkbox" id="rtrace-h"><span class="ml-2 text-sm">Suppress Header (-h)</span></label>
                                                <label class="flex items-center cursor-pointer"><input type="checkbox" id="rtrace-w" checked><span class="ml-2 text-sm">Suppress Warnings (-w)</span></label>
                                                <label class="flex items-center cursor-pointer"><input type="checkbox" id="rtrace-u"><span class="ml-2 text-sm">Uncorrelated Sampling (-u)</span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                                <div class="accordion-content" style="display: none;">
                                    </div>
                            </div>

                            <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                                <h4 class="text-base font-semibold mb-3">Execution</h4>
                                <div class="space-y-3">
                                    <button data-action="generate" class="btn btn-primary w-full">Generate Illuminance Package</button>
                                    <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-center">Generates a .zip with scene geometry and run scripts.</p>
                                <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                    <div class="flex justify-between items-center mb-2">
                                        <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                        <button class="btn btn-xs btn-secondary" title="Copy to clipboard">Copy</button>
                                    </div>
                                    <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                                </div>
                            </div>
                        </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
                </template>

                <template id="template-recipe-rendering">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Photorealistic Rendering</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <h4>Sky Definition (gensky)</h4>
                                <p class="info-box !mb-4">Define the sky for a specific moment. Location is taken from the Project Setup panel.</p>
                                <div class="grid grid-cols-3 gap-4">
                                    <div><label for="pit-month" class="label">Month</label><input type="number" id="pit-month" min="1" max="12" value="6"></div>
                                    <div><label for="pit-day" class="label">Day</label><input type="number" id="pit-day" min="1" max="31" value="21"></div>
                                    <div><label for="pit-time" class="label">Time (HH:MM)</label><input type="time" id="pit-time" value="14:30"></div>
                                </div>
                            </div>
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Image-Based Rendering (rpict)</h4>
                                <p class="info-box">Creates a physically-based image. Uses the view from the 'Viewpoint' panel and quality settings from 'Global Simulation Parameters'. Add or override specific settings below.</p>
                                <div class="accordion-item open">
                                    <div class="accordion-header">Image Size &amp; Resolution <div class="accordion-chevron">▶</div></div>
                                    <div>
                                        <div class="param-grid-sim">
                                            <div><label class="label" for="rpict-x">X Resolution (-x)</label><input type="number" id="rpict-x" min="1" value="512"></div>
                                            <div><label class="label" for="rpict-y">Y Resolution (-y)</label><input type="number" id="rpict-y" min="1" value="512"></div>
                                            <div><label class="label" for="rpict-pa">Pixel Aspect Ratio (-pa)</label><input type="number" id="rpict-pa" min="0" value="1.0" step="0.1"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <div class="accordion-header">Image Sampling &amp; Filtering <div class="accordion-chevron">▶</div></div>
                                    <div style="display:none;">
                                        <div class="param-grid-sim">
                                            <div class="param-item">
                                                <div class="param-item-row"><label for="rpict-ps" class="label">Pixel Sampling (-ps)</label><input type="number" class="param-input-num" id="rpict-ps-num" step="1" min="0" max="48"></div>
                                                <input type="range" id="rpict-ps" min="0" max="48" value="8" step="1">
                                            </div>
                                            <div class="param-item">
                                                <div class="param-item-row"><label for="rpict-pt" class="label">Sampling Threshold (-pt)</label><input type="number" class="param-input-num" id="rpict-pt-num" step="0.01" min="0" max="1"></div>
                                                <input type="range" id="rpict-pt" min="0" max="1" value="0.05" step="0.01">
                                            </div>
                                            <div class="param-item">
                                                <div class="param-item-row"><label for="rpict-pj" class="label">Pixel Jitter (-pj)</label><input type="number" class="param-input-num" id="rpict-pj-num" step="0.1" min="0" max="1"></div>
                                                <input type="range" id="rpict-pj" min="0" max="1" value="0.9" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <div class="accordion-header">General Switches<div class="accordion-chevron">▶</div></div>
                                    <div style="display:none;">
                                        <div class="grid grid-cols-2 gap-2 mt-2">
                                            <label class="flex items-center cursor-pointer"><input type="checkbox" id="rpict-i"><span class="ml-2 text-sm">Compute Irradiance (-i)</span></label>
                                            <label class="flex items-center cursor-pointer"><input type="checkbox" id="rpict-dv" checked><span class="ml-2 text-sm">Source Visible (-dv)</span></label>
                                            <label class="flex items-center cursor-pointer"><input type="checkbox" id="rpict-bv"><span class="ml-2 text-sm">Backface Visible (-bv)</span></label>
                                            <label class="flex items-center cursor-pointer"><input type="checkbox" id="rpict-w" checked><span class="ml-2 text-sm">Suppress Warnings (-w)</span></label>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                    <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                                    <div class="accordion-content" style="display: none;">
                                        </div>
                                </div>
                            </div>

                            <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                                <h4 class="text-base font-semibold mb-3">Execution</h4>
                                <div class="space-y-3">
                                    <button data-action="generate" class="btn btn-primary w-full">Generate Rendering Package</button>
                                    <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-center">Generates a .zip with scene geometry and run scripts.</p>
                                <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                    <div class="flex justify-between items-center mb-2">
                                        <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                        <button class="btn btn-xs btn-secondary" title="Copy to clipboard">Copy</button>
                                    </div>
                                    <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                            </div>
                        </div>
                    </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
                </template>

                <div id="lighting-energy-dashboard" class="hidden space-y-5 pt-4 border-t border-dashed border-[--grid-color]">
                    <h4 class="font-semibold text-xs uppercase text-[--text-secondary]">Lighting Energy Metrics</h4>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <h5 class="font-semibold text-sm">LPD</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="lpd-val">--</span> W/m²</p>
                        </div>
                        <div>
                            <h5 class="font-semibold text-sm">Annual Use</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="energy-val">--</span> kWh</p>
                        </div>
                        <div>
                            <h5 class="font-semibold text-sm">Savings</h5>
                            <p class="data-value font-mono text-lg mt-2"><span id="energy-savings-val">--</span> %</p>
                        </div>
                    </div>
                </div>

                <template id="template-recipe-dgp">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Daylight Glare Probability (DGP)</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <h4>Sky Definition (gensky)</h4>
                                <p class="info-box !mb-4">Define the sky for a specific moment. Location is taken from the Project Setup panel.</p>
                                <div class="grid grid-cols-3 gap-4">
                                    <div><label for="pit-month" class="label">Month</label><input type="number" id="pit-month" min="1" max="12" value="6"></div>
                                    <div><label for="pit-day" class="label">Day</label><input type="number" id="pit-day" min="1" max="31" value="21"></div>
                                    <div><label for="pit-time" class="label">Time (HH:MM)</label><input type="time" id="pit-time" value="14:30"></div>
                                </div>
                            </div>
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Daylight Glare Probability (evalglare)</h4>
                                <p class="info-box">Calculates glare from a 180° fisheye image. For accurate results, use high-quality rendering parameters. Viewpoint must be set to fisheye.</p>
                                <div class="param-section">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="evalglare-t">
                                        <span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Define Task Area (-t)<span class="info-icon">i<span class="info-popover">Defines a task area on the image to automatically determine the glare threshold based on the average luminance within that area. This is the recommended method.</span></span></span>
                                    </label>
                                </div>
                                <div class="param-section">
                                    <h5>Verification &amp; Output</h5>
                                    <div class="space-y-3 mt-2">
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" id="evalglare-c" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Create Check File (-c)<span class="info-icon">i<span class="info-popover">Generates a visual check image (e.g., check.hdr) with detected glare sources highlighted. Invaluable for verification.</span></span></span></label>
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" id="evalglare-d" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Detailed Output (-d)<span class="info-icon">i<span class="info-popover">Produces detailed output, listing the properties of each individual glare source found.</span></span></span></label>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                                <div class="accordion-content" style="display: none;">
                                     </div>
                            </div>

                            <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                                <h4 class="text-base font-semibold mb-3">Execution</h4>
                                <div class="space-y-3">
                                    <button data-action="generate" class="btn btn-primary w-full">Generate DGP Package</button>
                                    <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-center">Generates a .zip with scene geometry and run scripts.</p>
                                <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                    <div class="flex justify-between items-center mb-2">
                                        <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                        <button class="btn btn-xs btn-secondary" title="Copy to clipboard">Copy</button>
                                    </div>
                                    <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                                </div>
                            </div>
                        </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
                </template>

                <template id="template-recipe-df">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Daylight Factor</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="param-section">
                                <h4 class="text-base font-semibold">Daylight Factor</h4>
                                <p class="info-box">Calculates Daylight Factor. A standard calculation uses a CIE Overcast Sky, but other types are available for non-standard analysis.</p>
                                <div class="param-section">
                                    <h5>gensky Parameters for DF</h5>
                                    <div class="param-grid-sim mt-2">
                                        <div>
                                            <label class="label" for="df-sky-type">Sky Type</label>
                                            <select id="df-sky-type" class="w-full mt-1">
                                                <option value="-c" selected>Overcast (-c)</option>
                                                <option value="+s">Sunny w/ Sun (+s)</option>
                                                <option value="-s">Sunny w/o Sun (-s)</option>
                                                <option value="+i">Intermediate w/ Sun (+i)</option>
                                                <option value="-i">Intermediate w/o Sun (-i)</option>
                                                <option value="-u">Uniform (-u)</option>
                                            </select>
                                        </div>
                                        <div class="param-item">
                                            <div class="param-item-row">
                                                <label for="df-ground-refl" class="label">Ground Reflectance (-g)</label>
                                                <input type="number" class="param-input-num" id="df-ground-refl-num" step="0.01" min="0" max="1">
                                            </div>
                                            <input type="range" id="df-ground-refl" min="0" max="1" value="0.2" step="0.01">
                                        </div>
                                    </div>
                                    <div class="param-grid-sim mt-4">
                                        <div class="param-item">
                                            <div class="param-item-row">
                                                <label for="df-irrad" class="label">Diffuse Horizontal Irradiance (-B)
                                                    <span class="info-icon">i<span class="info-popover">To achieve a standard outdoor illuminance of 10,000 lux for DF calculations, a horizontal irradiance of <b>55.866 W/m²</b> is used with a CIE Overcast Sky. This may not apply to other sky types.</span></span>
                                                </label>
                                                <input type="number" class="param-input-num" id="df-irrad-num" step="0.001" min="0" max="200">
                                            </div>
                                            <input type="range" id="df-irrad" min="0" max="200" value="55.866" step="0.001">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                                <div class="accordion-content" style="display: none;">
                                     </div>
                            </div>

                            <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                                <h4 class="text-base font-semibold mb-3">Execution</h4>
                                <div class="space-y-3">
                                    <button data-action="generate" class="btn btn-primary w-full">Generate DF Package</button>
                                    <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-center">Generates a .zip with scene geometry and run scripts.</p>
                                <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                    <div class="flex justify-between items-center mb-2">
                                        <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                        <button class="btn btn-xs btn-secondary" title="Copy to clipboard">Copy</button>
                                    </div>
                                    <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                                </div>
                            </div>
                        </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
                </template>

                <template id="template-recipe-annual-3ph">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Annual Daylight (3-Phase)</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="param-section">
                                <h4 class="text-base font-semibold">Three-Phase Method Parameters (V T D S)</h4>
                                <p class="info-box">Decouples the light path into View (V), Transmission (T), Daylight (D) and Sky (S) matrices. </p>
                                <div class="param-section mt-4">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Phase 1: Sky Matrix (S) - gendaymtx</h5>
                                    <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                                </div>
                                <div class="param-section mt-4">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Phase 2: Transmission (T) - genBSDF</h5>
                                    <div><label class="label" for="bsdf-file">BSDF File (.xml)</label><input type="file" id="bsdf-file" accept=".xml" class="w-full text-sm"></div>
                                </div>
                                <div class="param-section mt-4">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Phase 3: V & D Matrices - rcontrib</h5>
                                    <p class="info-box !text-xs !py-2 !px-3">These are computationally intensive steps. Ambient parameters from the Advanced section will be used.</p>
                                </div>
                            </div>

                            <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                                <div class="accordion-content" style="display: none;">
                                     </div>
                            </div>

                            <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                                <h4 class="text-base font-semibold mb-3">Execution</h4>
                                <div class="space-y-3">
                                    <button data-action="generate" class="btn btn-primary w-full">Generate 3-Phase Package</button>
                                    <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-center">Generates a .zip with scene geometry and run scripts.</p>
                                <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                    <div class="flex justify-between items-center mb-2">
                                        <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                        <button class="btn btn-xs btn-secondary" title="Copy to clipboard">Copy</button>
                                    </div>
                                    <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                                </div>
                            </div>
                        </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
                </template>

                <template id="template-recipe-annual-5ph">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Annual Daylight (5-Phase)</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="param-section">
                                <h4 class="text-base font-semibold">Five-Phase Method Parameters</h4>
                                <p class="info-box">Extends the 3-Phase method for higher accuracy with complex fenestration by precisely modeling direct sun. Provide the core weather and BSDF files below.</p>
                                <div class="param-section mt-4">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Required User Inputs</h5>
                                    <p class="info-box !text-xs !py-2 !px-3 !mb-3">Specify the paths to the core input files. All other matrices will be generated by the script.</p>
                                    <div class="space-y-3">
                                        <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                                        <div><label class="label" for="bsdf-klems">Klems BSDF (T)</label><input type="file" id="bsdf-klems" accept=".xml" class="w-full text-sm"></div>
                                        <div><label class="label" for="bsdf-tensor">Tensor Tree BSDF (for Cds)</label><input type="file" id="bsdf-tensor" accept=".xml" class="w-full text-sm"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                                <div class="accordion-content" style="display: none;">
                                     </div>
                            </div>

                            <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                                <h4 class="text-base font-semibold mb-3">Execution</h4>
                                <div class="space-y-3">
                                    <button data-action="generate" class="btn btn-primary w-full">Generate 5-Phase Package</button>
                                    <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-center">Generates a .zip with scene geometry and run scripts.</p>
                                <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                    <div class="flex justify-between items-center mb-2">
                                        <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                        <button class="btn btn-xs btn-secondary" title="Copy to clipboard">Copy</button>
                                    </div>
                                    <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                                </div>
                            </div>
                        </div>
            <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
        </div>
                </template>

                <template id="template-recipe-imageless-glare">
                    <div class="floating-window ui-panel">
                        <div class="window-header">
                            <span>Recipe: Imageless Annual Glare</span>
                            <div class="window-controls">
                                <div class="window-icon-max"></div>
                                <div class="collapse-icon"></div>
                                <div class="window-icon-close"></div>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="param-section">
                                <p class="info-box">This recipe requires a "View Grid" to be defined in the Sensor Grid panel.</p>
                                <label for="quality-preset" class="label">Quality Preset</label>
                                <select id="quality-preset" class="w-full mt-1">
                                    <option value="draft">Draft (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="high">High (Accurate)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="param-section space-y-3">
                                <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                                <div><label class="label" for="occupancy-schedule">Occupancy Schedule (.csv) (Optional)</label><input type="file" id="occupancy-schedule" accept=".csv" class="w-full text-sm"></div>
                                <div class="param-item">
                                    <div class="param-item-row"><label for="glare-threshold" class="label">Glare Threshold (DGP)</label><input type="number" class="param-input-num" id="glare-threshold-num" step="0.01" min="0" max="1"></div>
                                    <input type="range" id="glare-threshold" min="0" max="1" value="0.4" step="0.01">
                                </div>
                                <div class="param-item">
                                    <label for="glare-autonomy-target" class="label">Spatial Glare Autonomy Target (%)</label>
                                    <input type="number" id="glare-autonomy-target" class="w-full mt-1" min="0" max="100" value="95">
                                </div>
                            </div>

                            <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                                <div class="accordion-content" style="display: none;">
                                     </div>
                            </div>

                            <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                                <h4 class="text-base font-semibold mb-3">Execution</h4>
                                <div class="space-y-3">
                                    <button data-action="generate" class="btn btn-primary w-full">Generate Imageless Glare Package</button>
                                    <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-center">Generates a .zip with scene geometry and run scripts.</p>
                                <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                    <div class="flex justify-between items-center mb-2">
                                        <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                        <button class="btn btn-xs btn-secondary" title="Copy to clipboard">Copy</button>
                                    </div>
                                    <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                                </div>
                            </div>
                        </div>
                    <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
                </div>
                    </template>
                  <template id="template-recipe-spectral-lark">
                  <div class="floating-window ui-panel">
                      <div class="window-header">
                          <span>Recipe: Spectral Analysis (Lark)</span>
                          <div class="window-controls">
                              <div class="window-icon-max"></div>
                              <div class="collapse-icon"></div>
                              <div class="window-icon-close"></div>
                          </div>
                      </div>
                      <div class="window-content">
                          <div class="param-section">
                              <h4 class="text-base font-semibold">Multi-Channel Spectral Simulation</h4>
                              <p class="info-box">Generates spectral irradiance and HDR images using the Lark methodology. Requires spectral data files for materials and light sources, which can be set in the Materials and Lighting panels.</p>
                          </div>

                          <div class="param-section">
                              <h4>Simulation Methods</h4>
                              <div class="space-y-2">
                                  <label class="flex items-center cursor-pointer"><input type="checkbox" id="lark-run-9ch-toggle" checked><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Run 9-Channel Spectral Simulation (High Accuracy)</span></label>
                                  <label class="flex items-center cursor-pointer"><input type="checkbox" id="lark-run-3ch-toggle"><span class="ml-3 label !text-gray-600 !uppercase-none !font-normal">Run 3-Channel Spectral Simulation (Faster)</span></label>
                              </div>
                          </div>

                          <div class="param-section">
                              <h4>Sky & Sun Definition (Common Inputs)</h4>
                              <div class="grid grid-cols-3 gap-4">
                                  <div><label for="lark-month" class="label">Month</label><input type="number" id="lark-month" min="1" max="12" value="6"></div>
                                  <div><label for="lark-day" class="label">Day</label><input type="number" id="lark-day" min="1" max="31" value="21"></div>
                                  <div><label for="lark-time" class="label">Time (HH:MM)</label><input type="time" id="lark-time" value="14:30"></div>
                              </div>
                              <div class="grid grid-cols-2 gap-4 mt-4">
                                  <div><label for="lark-dni" class="label">Direct Normal Irradiance (W/m²)</label><input type="number" id="lark-dni" min="0" value="750"></div>
                                  <div><label for="lark-dhi" class="label">Diffuse Horizontal Irradiance (W/m²)</label><input type="number" id="lark-dhi" min="0" value="150"></div>
                              </div>
                          </div>

                          <div class="param-section">
                              <h4>Spectral Data Files (Common Inputs)</h4>
                              <div class="space-y-3">
                                  <div><label for="lark-sun-spd" class="label">Sun Spectral Power Distribution (.spd)</label><input type="file" id="lark-sun-spd" accept=".spd,.txt" class="w-full text-sm"></div>
                                  <div><label for="lark-sky-spd" class="label">Sky Spectral Power Distribution (.spd)</label><input type="file" id="lark-sky-spd" accept=".spd,.txt" class="w-full text-sm"></div>
                              </div>
                          </div>

                          <div class="param-section">
                              <label for="quality-preset" class="label">Quality Preset</label>
                              <select id="quality-preset" class="w-full mt-1">
                                  <option value="draft">Draft (Fast)</option>
                                  <option value="medium" selected>Medium (Balanced)</option>
                                  <option value="high">High (Accurate)</option>
                                  <option value="custom">Custom</option>
                              </select>
                          </div>

                          <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                              <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                              <div class="accordion-content" style="display: none;">
                                  </div>
                          </div>

                          <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                              <h4 class="text-base font-semibold mb-3">Execution</h4>
                              <div class="space-y-3">
                                  <button data-action="generate" class="btn btn-primary w-full">Generate Spectral Package</button>
                                  <button data-action="run" class="btn btn-secondary w-full" disabled>Run Simulation(s)</button>
                              </div>
                              <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                  </div>
                          </div>
                      </div>
                      <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
                  </div>
            </template>
            <template id="template-recipe-sda-ase">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: sDA & ASE (LM-83)</span>
                        <div class="window-controls">
                            <div class="window-icon-max"></div>
                            <div class="collapse-icon"></div>
                            <div class="window-icon-close"></div>
                        </div>
                    </div>
                    <div class="window-content">
                        <div class="param-section">
                            <h4 class="text-base font-semibold">LM-83 Simulation Inputs</h4>
                            <p class="info-box">This recipe runs the full sDA/ASE workflow, including dynamic blind simulation. It generates two key results files: one for ASE (direct-only) and one for sDA (with shades operated).</p>
                            <div class="space-y-3 mt-4">
                                <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                                <div><label class="label" for="bsdf-open-file">BSDF - Blinds Open (.xml)</label><input type="file" id="bsdf-open-file" accept=".xml" class="w-full text-sm"></div>
                                <div><label class="label" for="bsdf-closed-file">BSDF - Blinds Closed (.xml)</label><input type="file" id="bsdf-closed-file" accept=".xml" class="w-full text-sm"></div>
                            </div>
                        </div>
                        <div class="param-section">
                            <h4 class="text-base font-semibold">Blind Operation Parameters</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="label" for="blinds-threshold-lux">Illuminance Threshold (lux)</label><input type="number" id="blinds-threshold-lux" value="1000" min="0" step="50" class="w-full mt-1"></div>
                                <div><label class="label" for="blinds-trigger-percent">Area Trigger (%)</label><input type="number" id="blinds-trigger-percent" value="2" min="0" max="100" step="1" class="w-full mt-1"></div>
                            </div>
                        </div>
                         <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                            <div class="accordion-header">Simulation Quality (Overrides)<div class="accordion-chevron">▶</div></div>
                            <div class="accordion-content" style="display: none;">
                                 </div>
                        </div>

                        <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                            <h4 class="text-base font-semibold mb-3">Execution</h4>
                            <button data-action="generate" class="btn btn-primary w-full">Generate sDA/ASE Package</button>
                            <div class="command-center hidden mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="font-semibold text-xs uppercase text-[--text-secondary]">Generated Script</h5>
                                    <button class="btn btn-xs btn-secondary" title="Copy to clipboard">Copy</button>
                                </div>
                                <textarea readonly class="w-full h-48 font-mono text-xs p-2 rounded bg-[--grid-color] border border-gray-500/50 resize-y"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
                </div>
            </template>

            <template id="template-recipe-en17037">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: EN 17037 Compliance Check</span>
                        <div class="window-controls">
                            <div class="window-icon-max"></div>
                            <div class="collapse-icon"></div>
                            <div class="window-icon-close"></div>
                        </div>
                    </div>
                    <div class="window-content">
                        <p class="info-box">This recipe runs the necessary simulations to check for compliance with the four pillars of the EN 17037 daylighting standard.</p>

                        <div class="param-section">
                            <label for="en17037-provision-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="en17037-provision-toggle" checked>
                                <h4 class="ml-3 font-semibold text-sm uppercase">1. Daylight Provision</h4>
                            </label>
                            <div id="en17037-provision-controls" class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <p class="text-xs text-gray-400">Uses Climate-Based Method 2. Requires an annual simulation.</p>
                                <div>
                                    <label for="en17037-provision-level" class="label">Target Performance Level</label>
                                    <select id="en17037-provision-level" class="w-full mt-1">
                                        <option value="minimum" selected>Minimum</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="param-section">
                            <label for="en17037-sunlight-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="en17037-sunlight-toggle" checked>
                                <h4 class="ml-3 font-semibold text-sm uppercase">2. Exposure to Sunlight</h4>
                            </label>
                            <div id="en17037-sunlight-controls" class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <p class="text-xs text-gray-400">Checks for direct sun access on a specific day.</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="en17037-sunlight-date" class="label text-xs">Reference Day</label>
                                        <input type="text" id="en17037-sunlight-date" class="w-full mt-1 flatpickr-input" placeholder="Select date...">
                                    </div>
                                    <div>
                                        <label for="en17037-sunlight-level" class="label text-xs">Target Duration</label>
                                        <select id="en17037-sunlight-level" class="w-full mt-1">
                                            <option value="minimum" selected>Minimum (1.5 hours)</option>
                                            <option value="medium">Medium (3.0 hours)</option>
                                            <option value="high">High (4.0 hours)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="param-section">
                            <label for="en17037-view-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="en17037-view-toggle" checked>
                                <h4 class="ml-3 font-semibold text-sm uppercase">3. View Out</h4>
                            </label>
                            <div id="en17037-view-controls" class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <p class="text-xs text-gray-400">Generates a fisheye image for manual verification of view quality.</p>
                                <div>
                                    <label for="en17037-view-level" class="label">Target Performance Level</label>
                                    <select id="en17037-view-level" class="w-full mt-1">
                                        <option value="minimum" selected>Minimum</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="param-section">
                            <label for="en17037-glare-toggle" class="flex items-center cursor-pointer w-full">
                                <input type="checkbox" id="en17037-glare-toggle" checked>
                                <h4 class="ml-3 font-semibold text-sm uppercase">4. Protection from Glare</h4>
                            </label>
                            <div id="en17037-glare-controls" class="space-y-3 pt-2 mt-2 border-t border-dashed border-[--grid-color]">
                                <p class="text-xs text-gray-400">Uses imageless annual DGP. Requires a 'View Grid' to be defined.</p>
                                 <div>
                                    <label for="en17037-glare-level" class="label">Target Performance Level</label>
                                    <select id="en17037-glare-level" class="w-full mt-1">
                                        <option value="minimum" selected>Minimum (DGP ≤ 0.45)</option>
                                        <option value="medium">Medium (DGP ≤ 0.40)</option>
                                        <option value="high">High (DGP ≤ 0.35)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                            <div class="accordion-header">Simulation Quality (Overrides)<div class="accordion-chevron">▶</div></div>
                            <div class="accordion-content" style="display: none;"></div>
                        </div>

                        <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                            <h4 class="text-base font-semibold mb-3">Execution</h4>
                            <div class="space-y-3">
                                <button data-action="generate" class="btn btn-primary w-full">Generate EN 17037 Package</button>
                                <button data-action="run" class="btn btn-secondary w-full" disabled>Run Compliance Check</button>
                            </div>
                        </div>
                    </div>
                    <div class="resize-handle-edge top"></div><div class="resize-handle-edge right"></div><div class="resize-handle-edge bottom"></div><div class="resize-handle-edge left"></div><div class="resize-handle-corner top-left"></div><div class="resize-handle-corner top-right"></div><div class="resize-handle-corner bottom-left"></div><div class="resize-handle-corner bottom-right"></div>
                </div>
            </template>

            <template id="template-recipe-en-illuminance">
                <div class="floating-window ui-panel">
                    <div class="window-header">
                        <span>Recipe: EN 12464-1 Illuminance</span>
                        <div class="window-controls"><div class="window-icon-max"></div><div class="collapse-icon"></div><div class="window-icon-close"></div></div>
                    </div>
                    <div class="window-content">
                        <p class="info-box">Verifies maintained illuminance ($E_m$) and uniformity ($U_0$) on the Task and Surrounding grids defined in the Sensor Grid panel.</p>
                        <div class="param-section">
                            <label for="quality-preset" class="label">Calculation Quality</label>
                            <select id="quality-preset" class="w-full mt-1">
                                <option value="draft">Draft (Fast)</option>
                                <option value="medium">Medium (Balanced)</option>
                                <option value="high" selected>Compliance (High Quality)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                            <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                            <div class="accordion-content" style="display: none;"></div>
                        </div>
                        <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                            <button data-action="generate" class="btn btn-primary w-full">Generate Illuminance Check Package</button>
                        </div>
                    </div>
                </div>
            </template>

        <template id="template-recipe-lighting-energy">
            <div class="floating-window ui-panel">
                <div class="window-header">
                    <span>Recipe: Lighting Energy Analysis</span>
                    <div class="window-controls"><div class="window-icon-max"></div><div class="collapse-icon"></div><div class="window-icon-close"></div></div>
                </div>
                <div class="window-content">
                    <p class="info-box">Runs an annual simulation using daylighting controls to estimate electric lighting energy usage and savings. This requires the same inputs as the sDA/ASE recipe.</p>
                    <div class="param-section">
                        <h4 class="text-base font-semibold">Simulation Inputs</h4>
                        <div class="space-y-3 mt-4">
                            <div><label class="label" for="weather-file">Weather File (.epw)</label><input type="file" id="weather-file" accept=".epw" class="w-full text-sm"></div>
                            <div><label class="label" for="bsdf-open-file">BSDF - Blinds Open (.xml)</label><input type="file" id="bsdf-open-file" accept=".xml" class="w-full text-sm"></div>
                            <div><label class="label" for="bsdf-closed-file">BSDF - Blinds Closed (.xml)</label><input type="file" id="bsdf-closed-file" accept=".xml" class="w-full text-sm"></div>
                        </div>
                    </div>
                    <div class="param-section">
                        <h4 class="text-base font-semibold">Blind Operation Parameters</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label" for="blinds-threshold-lux">Illuminance Threshold (lux)</label><input type="number" id="blinds-threshold-lux" value="1000" min="0" step="50" class="w-full mt-1"></div>
                            <div><label class="label" for="blinds-trigger-percent">Area Trigger (%)</label><input type="number" id="blinds-trigger-percent" value="2" min="0" max="100" step="1" class="w-full mt-1"></div>
                        </div>
                    </div>
                    <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                        <h4 class="text-base font-semibold mb-3">Execution</h4>
                        <button data-action="generate" class="btn btn-primary w-full">Generate Energy Analysis Package</button>
                    </div>
                </div>
            </div>
        </template>

        <template id="template-recipe-en-ugr">
            <div class="floating-window ui-panel">
                <div class="window-header">
                    <span>Recipe: EN 12464-1 UGR</span>
                        <div class="window-controls"><div class="window-icon-max"></div><div class="collapse-icon"></div><div class="window-icon-close"></div></div>
                    </div>
                    <div class="window-content">
                        <p class="info-box">Calculates the Unified Glare Rating (UGR) from the observer position defined in the Viewpoint panel.</p>
                        <div class="param-section">
                            <div><label for="ugr-limit" class="label">UGR Limit ($UGR_L$)</label><input type="number" id="ugr-limit" value="19" min="0" step="1" class="w-full mt-1"></div>
                        </div>
                        <div class="param-section">
                            <label for="quality-preset" class="label">Calculation Quality</label>
                            <select id="quality-preset" class="w-full mt-1">
                                <option value="draft">Draft (Fast)</option>
                                <option value="medium">Medium (Balanced)</option>
                                <option value="high" selected>Compliance (High Quality)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="accordion-item mt-4 pt-4 border-t border-dashed border-[--grid-color]">
                            <div class="accordion-header">Advanced Parameters (Overrides)<div class="accordion-chevron">▶</div></div>
                            <div class="accordion-content" style="display: none;"></div>
                        </div>
                        <div class="execution-section mt-4 pt-4 border-t-2 border-[--grid-color]">
                            <button data-action="generate" class="btn btn-primary w-full">Generate UGR Check Package</button>
                        </div>
                    </div>
                </div>
            </template>

        </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script type="importmap">
    {
        "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module" src="scripts/resultsManager.js"></script>
    <script type="module" src="scripts/annualDashboard.js"></script>
    <script type="module" src="scripts/hdrViewer.js"></script>
    <script type="module" src="scripts/lighting.js"></script>
    <script type="module" src="scripts/main.js"></script>
    <script type="module" src="scripts/ai-assistant.js"></script>
</body>
</html>